ar x iv 1 90 3 00 52 7 v 3 m at h a p 5 o ct 2 02 0 a solution to the monge transport problem for brownian martingales nassif ghoussoub young heon kim and aaron zeff palmer abstract we provide a solution to the problem of optimal transport by brownian martingales in general dimensions whenever the transport cost satisfies certain subharmonic properties in the target variable as well as a stochastic version of the standard twist condition frequently used in deterministic monge transport theory this setting includes in particular the case of the distance cost c x y x y we prove existence and uniqueness of the solution and characterize it as the first time brownian motion hits a barrier that is determined by solutions to a corresponding dual problem contents 1 introduction 1 2 a dual variational principle 5 3 a weakly compact set of d superharmonic functions in sobolev class 8 4 dual attainment in sobolev class 12 5 a stochastic twist condition 16 6 uniqueness of the monge solution optimal stopping as a hitting time 17 7 the case of the distance function 20 appendix a approximations 23 appendix b a proof of the monotonicity principle 24 references 25 1 introduction given a cost function c rd rd r the monge optimal transport problem seeks a map t rd rd that pushes forward a given probability measure to written as t while minimizing the total transport cost tc inf t rd c x t x dx 1 1 kantorovich 34 proposed the following linear relaxation of the monge problem which was even tually shown in 42 to have the same infimum provided c is continuous and is non atomic tc inf rd rd c x y dx dy 1 2 where is the set of probability measures on rd rd whose marginals are and in turn the last expression can also be written in terms of an optimal statistical correlation problem date october 7 2020 the first two authors are partially supported by the natural sciences and engineering research council of canada nserc msc 2010 subject classifications primary 49 60 secondary 52 2019 by the author 1 http arxiv org abs 1903 00527 v 3 2 nassif ghoussoub young heon kim and aaron zeff palmer between probability measures given by tc inf e c x y x y 1 3 where x means that the random variable x has as its distribution monge 40 originally formulated problem 1 1 with the distance cost c x y x y and a solution was provided more than 200 years later 18 1 11 48 brenier 10 on the other hand dealt with the important case of the squared distance c x y x y 2 which was extended by caffarelli 12 gangbo and mccann 22 gangbo 21 levin 36 and ma trudinger wang 38 to more general cost functions c that satisfy the so called twist condition namely the map y 7 xc x y is one to one for all x 1 4 this condition was shown to be sufficient to ensure that the minimizer of the relaxed problem 1 2 is indeed supported on the graph of a single valued map t hence solving the original problem 1 1 in the statistical terms of 1 3 the result means that the optimal random variables are perfectly dependent i e y t x a e we also note that optimal transport problems associated to cost functions of the form g x y where g is convex can be represented by ones given by the generating function of an associated lagrangian l i e 1 5 c x y inf 1 0 l t t t dt 0 x 1 y in this case optimizing maps are closely related to the corresponding hamiltonian dynamics e g benamou brenier 8 bernard buffoni 9 the martingale transport problem was motivated by questions of option pricing in mathematical finance see for example 31 15 29 it consists of a constrained version of 1 3 when the pair of random variables x y forms a one step martingale i e mc inf e c x y x y and e y x x 1 6 the martingale property on x y entails that w x w y is a real valued submartingale for any convex function w on rd this implies a necessary condition on the probability measures and for such a martingale pairing to exist namely that they are in convex order i e c which means w x dx w y dy for all convex functions w a remarkable theorem of strassen 46 states that the convex order between and is also suffi cient for the existence of a one step martingale starting at and ending at hence providing a martingale transport for problem 1 6 the martingale transport problem is by now well under stood in dimension one including the formulation of corresponding dual principles cases where the latter are attained as well as questions of uniqueness and structure of the optimal martingales in the primal problem see for example 31 15 29 4 5 7 the higher dimensional case however is less understood as could be seen in 24 where a solution for dimension d 2 is given in this paper we shall address the brownian martingale transport problem which involves a more particular class of martingales and can be formulated as pc inf e c b 0 b b 0 b 1 7 where bt t is brownian motion starting with distribution and ending at a stopping time such that b realizes the distribution note that here again this imposes in dimension d 2 an even more stringent condition on the pair namely that they are in subharmonic order i e sh which means w x dx w y dy for all subharmonic functions w this problem was originally proposed by skorokhod in one dimension 45 with 0 where he proved the existence of a randomized stopping time such that b where bt t is a brownian motion starting at 0 the existence of a nonrandomized stopping time in one dimension was established in 16 and 43 an alternative construction of a randomized stopping was given monge transport brownian martingale 3 by 44 for more general processes the existence of a nonrandomized stopping time in higher dimensions was established by baxter and chacon 2 and extended in 19 a thorough review of solutions to the skorokhod problem and its connections with optimal transport has been given in 41 another formulation of this problem similar to kantorovich s relaxation but which restricts the transport plans to follow brownian paths is the following pc inf bm rd rd c x y dx dy 1 8 where each bm is a probability measure on rd rd with marginals and satisfying x sh x for a e x where x is the disintegration of dx dy x dy dx again such transport plans can be seen as joint distributions of b 0 b where b 0 b and is a possibly randomized stopping time for the brownian filtration see for example 23 under the assumption that and have compact support the set bm is a weak compact set of measures in the banach space dual to the bounded continuous functions and problem 1 8 has an optimal solution bm however similar to the issue triggered by kantorovich s relaxation of 1 1 such a solution may very well correspond to a randomized stopping time a main objective of this paper is to figure out when there exists a true and unique optimal stopping time that solves the problem this problem is equivalent to the martingale problem in the one dimensional case a context addressed by henry labordere touzi 30 and others the duality theory and applications to math ematical finance were developed in 33 and 4 which also establish the existence and uniqueness of an optimal nonrandomized optimal stopping time under certain conditions motivated by the methods of standard mass transports in 6 beiglbo ck cox and huesmann further developed the duality theory and a monotonicity principle for problems with stochastic cost processes of the form inf e g b 0 b in particular they used this theory to solve the problem in the case g g where g is strictly convex resp concave by showing that the unique optimal stopping time is given by the classical root resp rost embedding which is the hitting time of a space time barrier the problem of the attainment of the dual problem remained a challenge in 5 the authors prove that a relaxed dual problem is attained when d 1 or costs of the form 1 7 and then the attainment of the original dual problem was established for d 1 in 7 by using pde methods dual attainment was extended for d 1 in 26 to the case where the cost is an integral along the path that is for problems of the form inf e 0 l t bt dt b 0 b 1 9 for these costs it is shown in 26 that the unique optimal stopping time is the hitting time of a space time barrier when l is strictly increasing resp decreasing our goal in this paper is to solve problem 1 7 in general dimensions for costs that only depend on the initial and final states and not on the path traveled between them and we make special note of the case where the cost is given by the euclidean distance c x y x y it is important to note that unlike standard mass transports problem 1 7 cannot be reduced to 1 9 nor to inf a e 0 l t xt at dt x 0 x 1 10 where xt r n solves the sde dxt f xt at dt dwt we mention that because at least in 1 9 the time monotonicity of the lagrangian cost enables one to construct an appropriate barrier set in space time as was done in 6 and 26 hence establishing both the uniqueness and the hitting time characterization of the optimal stopping a similar result was established in 23 in the case where the measures and the cost c x y are radially symmetric we also note that another advantage of the lagrangian formulation of the cost is the associated eulerian mass flow formulation to the optimal transport problem 8 9 which was also extended 4 nassif ghoussoub young heon kim and aaron zeff palmer to the free end case in both the deterministic 25 and stochastic cases 26 as long as the cost is of lagrangian type however this seminal approach cannot be used for the costs we are considering in this paper where we prove among other things the following result theorem see theorem 7 2 let and be two probability measures that are supported on an open bounded convex set o rd assuming sh and that they have continuous densities with respect to lebesgue measure then there is a unique optimal stopping time that minimizes inf e b 0 b b 0 b 1 11 moreover is only randomized at 0 while otherwise it is given by the hitting time 1 12 inf t 0 b 0 bt r for some measurable r o o we shall first establish the following weak duality formula for the primal problem 1 7 under the mere assumption that c c rd rd 1 13 pc dc sup lsc o o y dy o j x x dx where lsc o is the cone of all bounded lower semi continuous functions on o throughout the paper we will denote bxt as the brownian motion beginning with b x 0 x and we will use the restriction of stopping times to this set of paths without changing notation so that for continuous functions h c rd rd and stopping times e h b 0 b rd e h x bx dx the so called value function j is defined as j x y sup o e by c x b y 1 14 where o is the first exit time of the set o we point out two other useful characterizations of the value function j under some regularity assumptions on and c and for each fixed x o the function y 7 j x y is the unique viscosity solution to the obstacle problem for u c o u y y c x y for y o u y y c x y for y o u y 0 for y o u y 0 whenever u y y c x y as well as the unique minimizer of the variational problem min u h 1 o o u y 2 dy u c x u c x h 10 o we then assume the following condition on the cost y 7 c x y is subharmonic and d superharmonic i e 0 yc x y d 1 15 which will yield that the dual problem dc can actually be restricted to a weakly compact set of functions bd h 1 0 o that consists of bounded and nonpositive d superharmonic functions that vanish on o these functions are lower semicontinuous and satisfy a remarkable property of continuity along brownian paths see lemma 3 5 these properties of the maximizing set bd then guarantee that the dual problem 1 13 is attained by a sufficiently regular function see theorem 4 1 condition 1 15 on the cost can be weakened in several cases indeed while the distance cost c x y x y does not satisfy d superharmonicity at the singular points x y we can avoid this issue under the assumption that the supports of and are strictly disjoint we then use a localization argument to handle the general case without the disjointness assumption for this monge transport brownian martingale 5 important cost moreover the subharmonicity of y c x y can also be replaced by the condition thatm infx y o yc x y since in this case one can replace c with the subharmonic cost c x y c x y h y where h is any function in c o such that h y m on the other hand a one dimensional counterexample to the dual attainment problem in the case where 1 15 is not satisfied is given in 3 see 4 and 24 for related results for the issue of uniqueness we isolate a second condition on the cost which can be seen as a stochastic counterpart of the twist condition 1 4 it can be stated as follows for each pair of states x y and any stopping time for brownian motion starting at y e xc x b y xc x y 0 1 16 we therefore call it the stochastic twist condition we note that a related condition on cost functions was introduced in the one dimensional case in 32 as increasing resp decreasing variation swap kernel and in 30 as the martingale counterpart of the spence mirrlees condition and it reads as 1 17 cyyx x y 0 the stochastic twist condition enables us to prove that the optimal stopping time is unique and is characterized as the first hitting time of a barrier set determined by the dual optimizer see theorem 6 1 the delicate proof also uses the differentiability of the value function which we obtain from a lipschitz assumption on x 7 c x y as well as the dynamic programming principle defining j in particular the distance cost x y satisfies the stochastic twist condition when x 6 y a property that was used in 24 for the general martingale optimal transport problem and was realized to apply to the case of brownian martingales by tongseok lim we extend our results to this particular and important cost function in theorems 7 1 and 7 2 remark 1 1 the results in this paper including theorems 7 1 and 7 2 and the related results on the dual attainment theorem 4 1 hold in more general settings such as for brownian motion valued in a geodesically convex bounded domain o of a complete nonpositively curved riemannian manifold when the cost c is given by the riemannian distance d x y here the laplace operator is replaced with the laplace beltrami operator 27 note that the stochastic twist condition then holds for any differentiable riemannian distance while nonpositive curvature implies subharmonicity in fact convexity of y 7 d x y the proofs are adaptable from the euclidean case with additional technical complications which we do not address further the paper is organized as follows in section 2 we prove the weak duality principle 1 13 and reduce the problem to optimizing over the end potential by using a dynamic programming principle this gives a novel point of view for problem 1 7 in section 3 we introduce a remarkable set of d superharmonic functions bd and represent it as a weakly compact convex subset of h 1 0 o in section 4 we prove our first main result namely the attainment in the dual problem theorem 4 1 by showing that one can restrict the maximization of 1 13 to the set bd some of the key lemmas there use condition 1 15 in a crucial way this then yields a barrier set for the verification theorem theorem 4 7 section 5 discusses the key stochastic twist condition 1 16 and includes a few important examples section 6 contains the proof for uniqueness and the characterization of the optimal solution to 1 7 as a first hitting time theorem 6 1 the case of the distance cost is finally addressed in section 7 theorems 7 1 7 2 the appendix contains a couple of technical results used in sections 2 and 3 additionally we shall use our result on dual attainment to provide there a quick proof of a version of the monotonicity principle of beiglbo ck cox and huesmann 6 that is adapted to our setting 2 a dual variational principle duality is a key aspect of many optimization problems in our case we shall see that the dual problem to pc arises directly as the linear maximization problem d c sup j ac rd y dy rd j x x dx 2 1 6 nassif ghoussoub young heon kim and aaron zeff palmer with linear constraints ac j c rd c rd rd j x y y c x y and yj x y 0 2 2 where we understand the inequality yj x y 0 in the sense of viscosity the equivalence a probabilistic notions of superharmonic functions will be recalled in lemma 2 3 and later with a weak and variational notions in proposition 3 2 and lemma 3 3 define the operator v c x as v c x j y min j x y y c x y yj x y we can then understand ac as the set of pairs j such that for each x r d y 7 j x y is a supersolution of v c x j x y 0 in the sense of viscosity we assume that the measures and have support on a bounded open convex domain o in this case we can determine j in terms of as the minimal viscosity supersolution we call this the value function and it is given by j x y sup o e by c x b y 2 3 where b y t is the brownian motion with b y 0 y o is the exit time from o and the supremum is over all stopping times prior to o in the following we denote by lsc o the set of bounded lower semicontinuous functions on o recall the definition of brownian martingale plans between and as the finite measures on o o with marginals and that disintegrate as dx dy x dy dx in such a way that x sh x for a e x o we set bm to be the set of such transport plans i e bm 0 o o x sh x for a e x o 2 4 theorem 2 1 suppose that c c rd rd and and are probability measures with support in an open bounded and convex subset o of rd then pc d c dc sup lsc o o y dy o j x x dx 2 5 and there is bm such that pc o o c x y dx dy before giving the proof of theorem 2 1 we start by noting the relationships between the various formulations of our problem recall first the following correspondence between possibly random ized stopping times and subharmonic martingale measures while randomized stopping times have many equivalent representations it suffices to consider their law as probability measures on c r rd r that disintegrate with respect to wiener measure as a measure on r such that at t 0 ds is adapted to the filtration of the brownian motion the only topology we consider is the weak convergence of the probability law on c r rd r lemma 2 2 see for example theorem 2 1 in 23 let and be probability measures on o and let bt t denote brownian motion starting according to b 0 then 1 for each possibly randomized stopping time o satisfying b there is bm such that b 0 b 2 conversely for each bm there exists a randomized stopping time o such that b 0 b we shall need the following characterization for superharmonic lower semicontinuous functions we include a proof for completeness lemma 2 3 for lsc o the following are equivalent 1 x 0 in the sense of viscosity for all x o monge transport brownian martingale 7 2 for any stopping time o and all y o we have y e by 2 6 proof first we suppose that lsc o satisfies x 0 in the sense of viscosity for all x o there is then a sequence of smooth functions i c o with i in o and constants i such that limi i x x for all x o limi i 0 and i x 0 for x o i where o i is the set of points in o with distance from o greater than i see lemma a 1 or similar results in 20 13 47 for y o by b y o y and 2 6 holds for y o and any stopping time o we fix 0 such that y o and set o then by ito s lemma y lim i i y lim i e i b y 0 i b y t dt lim i e i b y e b y then taking 0 we have lim inf 0 e b y e lim inf 0 b y e by by lower semicontinuity of fatou s lemma and the continuity of brownian paths for the other direction 2 1 we consider w c 2 o that touches from below at y o i e w y y and w x x for all x o then for all stopping times o e w by w y e by y 0 which implies that w y 0 for w c 2 this completes the proof proof of theorem 2 1 we sketch the proof of pc d c as very similar results have appeared in 6 and 26 we assume and j are continuous unless stated otherwise the constraint that bm defined in 2 4 is equivalent to the measure on o o is a finite and nonnegative the second marginal of is or 0 sup rd y dy rd rd y dx dy for each x x is in subharmonic order with x and the first marginal is i e 0 sup j yj 0 rd rd j x y dx dy rd j x x dx thus we have inf bm rd rd c x y dx dy inf 0 sup sup j yj 0 rd rd c x y dx dy rd y dy rd rd y dx dy rd rd j x y dx dy rd j x x dx and the fenchel rockafellar duality theorem allows us to interchange the infimum and supremum this expression becomes pc sup sup j yj 0 inf 0 rd rd c x y y j x y dx dy rd y dy rd j x x dx d c 8 nassif ghoussoub young heon kim and aaron zeff palmer the attainment of a minimizer for pc is immediate from the compactness of probability measures in the weak topology and the definition of bm which makes it a weak closed convex set in the space of radon measures on o o to prove that d c dc sup lsc o o y dy o j x x dx we first show the inequality d c dc for that let bm be where the infimum of pc is attained and its representation by a randomized stopping time cf lemma 2 2 then for any lsc o o y dy o j x x dx e b j b 0 b 0 e b j b 0 b e c b 0 b pc d c where we have used the definition 2 3 of j hence dc d c for the other direction we consider j ac then j x y j x y for x y o o since by lemma 2 3 and the definitions 2 2 and 2 3 we have j x y sup o e by c x b y sup o e j x by j x y it follows that o y dy o j x x dx o y dy o j x x dx and d c dc this completes the proof 3 a weakly compact set of d superharmonic functions in sobolev class in this section we introduce the following convex set of functions bd which plays a key role in the sequel these are the lower semicontinuous d superharmonic functions that are non positive and zero on the boundary of o a key property will be that these functions can be equivalently defined as members of the sobolev class h 10 o that are non positive and have their laplacian bounded above by d weakly definition 3 1 let o be a bounded convex open subset of rd we say that a function lsc o is in the set bd if the following properties hold 1 y 0 for all y o 2 y 0 for all y o 3 is d superharmonic in the sense that for all stopping times o y e by d equivalently y d for all y o in the sense of viscosity by lemma 2 3 the functions in this class bd have a uniform lower bound following from the maximum principle indeed let uo be the solution to uo x 1 x o uo x 0 x o 3 1 equivalently uo y e o where o is the exit time for the brownian motion beginning at b y 0 y since y d we see that y e by o d o duo y d sup z o uo z 3 2 which provides a lower bound depending only on o and d we now prove a key property of bd namely that it can be identified with a closed convex bounded hence weakly compact subset of the sobolev class h 10 o equipped with the norm f 2 h 10 o o f x 2 dx monge transport brownian martingale 9 proposition 3 2 a function is in bd if and only if only if up to a set of lebesgue measure zero it satisfies 1 h 10 o 2 y 0 for a e y o 3 y d weakly in the sense that o y x d x dx 0 for all h 10 o such that 0 a e on o furthermore there is a constant m dependent only on d and o such that 3 3 h 10 o m for all bd in other words bd can be identified with a closed bounded convex subset of h 1 0 o proof first use lemma a 2 to fix a bounded convex domain o containing o such that we can approximate bd by smooth functions on o that satisfy limi i x x i x 0 and i x d for x o and i y 0 for y o notice that i x du o x for x o for u o defined similarly as 3 1 from the weak laplacian bound with i we get o i x 2 dx o d i x dx d 2 u o l 1 o hence there is a subsequence of i that converges weakly in h 1 o to an equivalence class of in h 10 o with 2 h 10 o d 2 u o l 1 o the properties in 2 and 3 follow as they are stable under weak convergence in h 1 o conversely if h 10 o satisfies d weakly and 0 we can easily check that the extension of the function duo to r d by zero is superharmonic in the sense that the average integral r 7 1 br y br y z duo z dz is monotonically decreasing in r it follows that has a representative that is lower semi continuous and d superharmonic in the sense of viscosity see for instance the notes 47 this representative is everywhere nonpositive and y duo y for all y o thus is zero on the boundary we have shown the lower semicontinuous representative of lies in bd completing the proof we now define the superharmonic envelope of a function h lsc o to be hsh y sup o e h by 3 4 we note that the definition of j in 2 3 means that y 7 j x y is the superharmonic envelope of y 7 y c x y we will require in the sequel a few results on superharmonic envelopes lemma 3 3 given h 10 o c 2 o then its superharmonic envelope sh as defined in 3 4 is the unique minimizer of the variational problem i e sh argmin o u y 2 dy u h 10 o u proof take h 10 o c 2 o and let h 10 o be the unique minimizer of the variational problem uniqueness follows from the strict convexity of u 7 u 2 the optimality of implies that satisfies 0 weakly see 35 as in the proof of proposition 3 2 we have that has a lower semicontinuous representative that satisfies x 0 for x o in the sense of viscosity and x x for x o this implies that sh y y for all y o since from lemma 2 3 sh y sup o e by sup o e by y 10 nassif ghoussoub young heon kim and aaron zeff palmer for any smooth superharmonic function h 10 o c 2 o greater than we have by the same argument as above sh it follows that sh bd for d supx o x use now proposition 3 2 to show that sh h 10 o and satisfies sh 0 weakly it follows that sh 2 h 10 o o sh y sh y dy o y sh y dy h 10 o sh h 10 o thus sh is a minimizer of the variational problem hence from uniqueness we have sh we shall need the following property of the norm of h 1 o which is dual to h 10 o lemma 3 4 let and be two stopping times such that o and suppose that b h 1 o then the distribution of b belongs to h 1 o and satisfies h 1 o h 1 o proof for each h 10 o c 2 o the superharmonic envelope sh satisfies sh h 10 o h 10 o by lemma 3 3 therefore o y dy o sh y dy o sh y dy h 1 o h 10 o here the second inequality is due to the subharmonic order sh and subharmonicity of sh this proves the lemma as smooth functions are dense in h 10 o the next lemma shows continuity of functions in class bd with respect to stopping times lemma 3 5 we consider a sequence of randomized stopping times i o that converge weakly in law to a randomized stopping time then if h bd we have 3 5 lim i e h b i e h b proof we first note that 3 6 lim inf i e h b i e h b follows as a consequence of the portmanteau theorem using the lower semicontinuity of h composed with the continuous paths of brownian motion to prove the opposite inequality 3 7 lim sup i e h b i e h b we use that h h 10 o to control larger times and that h is d superharmonic to control small times we fix 0 and select 0 such that 4 d and e h b 0 e h b 4 note that the latter is possible by 3 6 since lim 0 0 we decompose the expectation into two pieces 3 8 e h b i e h b i h b i e h b i the second term on the righthand side of 3 8 satisfies because of d superharmonicity of h that e h b i e h b 0 d e h b 2 we define o for the first term on the righthand side of 3 8 because i and i coincide on the set where i we have e h b i h b i e h b i h b monge transport brownian martingale 11 for b the distribution is in h 1 o by comparison with the heat kernel g on r d since by restricting to nonnegative test functions w and extending by zero outside of o h 1 o sup w 0 w h 1 0 o 1 e w b sup w 0 w h 1 0 o 1 e w b g h 1 o c we have that i and thus by lemma 3 4 for i b i and b i h 1 o c h 1 o c then weak convergence of i implies i in h 1 o and there is i such that for i i e h b i e h b 2 putting everything together we have that e h b i h b i e h b i h b e h b h b 2 e h b h b 2 thus we have shown that for i i e h b i e h b which implies 3 7 and completes the proof of 3 5 the above property of bd enables us to prove the following lemma regarding verification of hitting times we also include the case for c o lemma 3 6 assume that either h c o or that h bd and let h sh be its superharmonic envelope defined in 3 4 for fixed y o we let inf t hsh b y t h b y t the stopping time attains the supremum in the definition of hsh it also satisfies 1 h by h sh by 2 for any stopping time o we have h sh y e hsh b y proof case h c o let us first show that there exist stopping times i o such that h by i h sh b y i and i weakly define for each 0 the set h t h sh bt h bt 0 t where each is a point in the probability space note that hsh h 0 along o therefore for almost every there exists t with t h by the definition of thus the projection of h on has full measure by the section theorem in 14 there exists a stopping time such that h whenever and p 1 given a sequence i converging to zero we define i i o which has a subsequence converging weakly as desired using the continuity of h and hsh and the continuity of brownian paths we have e hsh by lim i e hsh b y i lim i e h b y i e h by the supremum of definition 3 4 is attained at a randomized stopping time by compactness 17 optimality of implies that hsh y e h by sup o e h by e hsh by since hsh by h b y we have h b y h sh by almost surely so furthermore h sh is superharmonic so we have e hsh by e h sh by 12 nassif ghoussoub young heon kim and aaron zeff palmer which implies hsh y e h by thus also attains the supremum of 3 4 which again implies that h by sup o e h by b y h sh by proving 1 finally for any stopping time o we have from the superharmonic property h sh y e hsh b y e h sh by h sh y which implies 2 and completes the proof in the case where h is continuous case h bd if now h is in bd the above proof is still valid thanks to lemma 3 5 this can be used to obtain an optimal stopping time that maximizes sup e h by since the expectation of h is then a weakly continuous function of the stopping times the same lemma can also be used to carry on the limit of i i to in the above proof 4 dual attainment in sobolev class in this section we prove one of the main results of the paper namely the attainment of the supremum in the dual problem this has been an elusive problem which has previously only been fully resolved for d 1 in 39 recall that we assume supp and supp are contained in a bounded convex open set o rd and by theorem 2 1 we have the dual problem in the form dc sup lsc o y dy j x x dx we now state our main result on dual attainment theorem 4 1 assume that c c o o and y 7 c x y is subharmonic and d superharmonic i e 0 yc x y d in the sense of viscosity and that sh as well as h 1 o there exists then bd that attains the maximum value of the dual problem i e dc o y dy o j x x dx 4 1 remark 4 2 as long as yc x y m we can form a problem with subharmonic cost c x y c x y h y with h solving h m the solutions to these two problems are equivalent in the sense that if is an optimizer for the cost c then h is an optimizer for the cost c furthermore for costs of the form c x y x y where 0 and d 2 a version of theorem 4 1 applies with the additional assumption that the support of and are disjoint the argument is given in theorem 7 1 for the case of the distance function i e 1 the subharmonicity condition yc x y 0 is however more essential than the d superharmonic property for example we have a counterexample to dual attainment in 3 see also 24 for the cost c x y x y before we prove the theorem 4 1 we prove a few lemmata that will allow us to utilize the weak compactness of the set bd in h 1 0 proposition 3 2 for the proof of dual attainment lemma 4 3 if is a probability measure on o and h 1 o then the map h 10 o 7 o j x x dx is convex and lower semicontinuous on bd proof we first prove the technical result that we may interchange the supremum and the expec tation to obtain o j x x dx sup o e b c b 0 b for the brownian motion where b 0 to see this equality fix 0 and consider a measurable selection x of stopping times for b x 0 x such that j x x e bx x c x b x x monge transport brownian martingale 13 integrate with respect to to get a stopping time for b 0 such that o j x x dx e b c b 0 b for the other direction note that any stopping time disintegrates as x for b x 0 x and e b c b 0 b o e bx x c x b x x dx o j x x dx now consider b 0 h 1 o from lemma 3 4 if o and b then h 1 o therefore for each o h 1 0 o 7 e b c b 0 b is linear and continuous this shows the desired convexity and lower semicontinuity as the map is given by the supremum of continuous linear functionals the next step is to show that the maximization of the dual problem dc can be restricted to the smaller set bd proposition 4 4 we assume that y 7 c x y is subharmonic and d superharmonic i e 0 yc x y d as well as sh then it holds that dc sup bd o y dy o j x x dx the proof of this proposition is done as two improvements to to maximize the dual value we wish to choose as large as possible while maintaining x j x y c x y for every x o which motivates the following lemma lemma 4 5 suppose y 7 h x y is d superharmonic for each x o 1 the function y inf z o h z y is d superharmonic 2 for h x y j x y c x y and if y 7 c x y is d superharmonic then is d superharmonic y y for all y o and j x y j x y for all x y o o proof for any y o and 0 there is z o such that y h z y hence for any stopping time o y h z y e h z by d e by d where we have used that y 7 h x y is d superharmonic and y h z y for all y o the first item 1 follows by letting 0 for the second part of the lemma we have that y 7 c x y j x y is d superharmonic since c is d superharmonic and j is superharmonic that y y is obvious from the fact that y j x y c x y for the last item in 2 observe that j j as j x y sup o e by c x b y sup o e by c x b y j x y by definition of we have that y j x y c x y thus we have that for all o e by c x b y e j x b y j x y and it follows that j j the second improvement of is slightly more subtle we make use of the assumption that sh so that subtracting a superharmonic function of y from both and j will not decrease the dual value in general subtracting a superharmonic function would violate the constraint that y 7 j x y is superharmonic but subtracting the superharmonic envelope of from j miraculously does not violate this constraint given that y 7 c x y is subharmonic proposition 4 6 assume that c c o o and for all x o y 7 c x y is subharmonic i e yc x y 0 then for each c o we have j sh x y j x y sh y for all x y o o 14 nassif ghoussoub young heon kim and aaron zeff palmer proof we fix x y in o o the proof that j sh x y j x y sh y is easy and does not need the assumption yc x y 0 indeed we let be a randomized stopping time that attains the supremum for j so that j x y e b y c x b y using e sh b y sh y we have j x y sh y e b y c x b y sh b y j sh x y the last inequality is due to the definition of j sh the reverse inequality is important for the proof of proposition 4 4 and requires the assumption yc x y 0 we let be a randomized stopping time attaining the supremum for j sh so that j sh x y e by sh by c x b y we consider the first hitting time inf t b y t sh b y t we can write e by sh by c x b y e b y sh b y c x b y e by b y sh by sh b y e c x by c x b y i ii iii for i use item 2 of lemma 3 6 and the definition of j to see i j x y sh y for iii by the assumption yc x y 0 we see that iii 0 for the term ii notice that if then by b y and sh by sh b y moreover by item 1 of lemma 3 6 if then b y sh b y recall that sh always therefore we can conclude that ii 0 all of these together imply that j sh x y j x y sh y as desired completing the proof we now have the necessary ingredients to prove proposition 4 4 which is the last component of the proof of theorem 4 1 proof of proposition 4 4 the inequality dc sup bd o y dy o j x x dx follows directly from the definitions of dc and bd as bd lsc o for the reverse inequality first notice that for each lsc o there exists a sequence of continuous functions i such that limi i x x x o for example one can consider the inf convolution as in the proof of lemma a 1 therefore it suffices to prove that for any c o we can modify it to bd such that o y dy o j x x dx o y dy o j x x dx we can then apply the modification to a maximizing sequence of dc to get another maximizing sequence but now from the class bd monge transport brownian martingale 15 improvement 1 0 on o and 0 in o we first modify to sh using the superharmonic envelope sh given in 3 4 we see that o y dy o j x x dx y sh y dy j x x sh x dx because sh is super harmonic and sh it is important to notice that from proposition 4 6 j sh j sh also notice that because o is compact the continuous function is uniformly continuous and so are sh and j sh improvement 2 d in o now modify the function sh further to y inf z o j sh z y c z y as in lemma 4 5 with h j sh c here is continuous on o following from uniform continuity of j sh and c from the lemma we have that is d superharmonic sh and j j sh then the last line in the above inequality is less than or equal to o y dy o j x x dx getting the desired inequality we also have that y 0 for all y since j sh x y c x y sup e by sh by c x b y c x y 0 and for y o y 0 since j sh x y c x y thus by definition this implies that bd this completes the proof proof of theorem 4 1 we use proposition 4 4 to find a sequence i bd such that dc lim i o i y dy o j i x x dx uniform boundedness of i h 10 o given by 3 3 of proposition 3 2 implies there is a weak limit h 10 o of i note also that such a weak limit preserves the property 0 as well as d in the weak sense so by the equivalence of proposition 3 2 we have bd since h 1 o and sh we have h 1 o from lemma 3 4 and lim i o i y dy o y dy on the other hand from the lower semicontinuity shown in lemma 4 3 we have lim i o j i x x dx o j x x dy which then implies o y dy o j x x dx dc since lsc o the above two inequalities are in fact equalities showing the identity 4 1 this completes the proof we now demonstrate the verification properties for how the dual optimizers pair with the primal minima we will use these general results to prove uniqueness of the optimal stopping times in section 6 after introducing the crucial assumption on the cost the stochastic twist condition in section 5 let be an optimizer of pc and let be the corresponding optimal randomized stop ping time notice that for the disintegration dx dy x dy dx the measure x describes the distribution of the stopped brownian paths bx the dual optimizers j in theorem 4 1 16 nassif ghoussoub young heon kim and aaron zeff palmer are useful tools for us to characterize this measure for example we have the following important property theorem 4 7 under the same assumptions as in theorem 4 1 the optimal brownian path stops at the contact set namely for a e x y o o j x y y c x y and in particular inf t j b 0 bt bt c b 0 bt furthermore if dx dy x dy dx satisfies 0 sh x sh x for each a e x then o o j x y dx dy o o j x y dx dy o j x x dx 4 2 if is a nonrandomized stopping time corresponding to then and for a e x and restricted to the paths with b 0 x e j x b x j x x 4 3 also for a e x y and the stopping time restricted to paths satisfying b y e j x b y j x y 4 4 in particular these hold for proof for satisfying dx dy x dy dx with x sh x sh x for each a e x from the superharmonic property of j we have the inequalities o o j x y dx dy o o j x y dx dy o j x x dx therefore from the obvious inequality j x y y c x y we see that o o c x y dx dy o o y j x y dx dy o y dy o o j x y dx dy o y dy o j x x dx strong duality theorem 4 1 implies that the first and the last end of these inequalities are the same making all the inequalities equalities in particular this implies that j x y y c x y for a e x y the equalities 4 2 also follow then the equalities 4 3 and 4 4 follow from 4 2 and the disintegration of with respect to respectively in other words o e j x b x dx o j x x dx and 4 3 follows since j x b x j x x and o o j x y dx dy o o e j x b y dx dy o o e j x y dx dy and 4 4 follows similarly 5 a stochastic twist condition we now start the discussion of our results on uniqueness and characterization of the optimal brownian stopping time in this section we give a stochastic version of the twist condition 1 4 on the cost in the deterministic optimal transport theory this condition will allow us to prove later that the optimal stopping time is uniquely given by the first hitting time to the contact set definition 5 1 we say that c satisfies the stochastic twist st condition at x y if for each stopping time o e xc x b y xc x y 0 5 1 monge transport brownian martingale 17 notice that this stochastic twist condition st is not a direct generalization of the usual twist condition in optimal transport theory in particular the quadratic cost c x y x y 2 does not satisfy st because x x y 2 2 x y therefore the equality in 5 1 holds for any 0 due to the martingale property we now collect some examples of costs that satisfy st our most important example of a cost satisfying st is the distance function c x y x y for dimensions d 2 and points x 6 y the gradient is xc x y x y x y sd 1 valued in the unit sphere in particular we have xc x y xc x y 1 and e xc x y xc x b y 1 for any stopping time 0 which implies st note that the same argument shows that any differentiable riemannian distance function d x y satisfies st since xd x y is always a unit tangent vector at x a more general class of costs with st can be described by the local condition for each x there exist convex functions fx such that y 7 fx xc x y is strictly superharmonic 5 2 in this case we have for 6 0 fx e xc x b y e fx xc x b y fx xc x y a simple subclass of the previous example are the separable costs c x y g x h y that satisfy g x 6 0 and y 7 h y is either strictly superharmonic or strictly subhar monic in either case xc x y g x h y and we select fx z g x z where the sign is positive if h is superharmonic and negative if h is subharmonic for cost functions that only satisfy y xc x y 6 0 for all x y o o a localized version of st holds i e there is 0 such that if 0 and 5 1 then 0 note however that in dimension one this condition is sufficient to imply st i e that y xc x y cyyx x y 0 which appears in 32 and 30 remark 5 2 one can also consider a version of the stochastic twist condition for martingale transport definition 5 3 we say that c satisfies the martingale twist mt condition at x y if for each probability measure such that y c for the convex order we have o xc x z dz xc x y y 5 3 the above examples for st hold for mt if we replace the superharmonicity subharmonicity with concavity convexity respectively in particular the distance cost c x y x y is mt and this property was crucially used in 24 to prove uniqueness and structure of optimal martingale transport under various conditions 6 uniqueness of the monge solution optimal stopping as a hitting time the stochastic twist condition st allows us to prove uniqueness of the optimal brownian martingale and characterize it as the first hitting time to a barrier set we will assume the technical assumption supp 0 and the simplifying structural assumptions that 0 which in most cases can be omitted by applying lemma 7 3 theorem 6 1 suppose in addition to the assumptions of theorem 4 1 that x 7 c x y is c 1 and c satisfies the stochastic twist condition st for all x y o o assume further that 18 nassif ghoussoub young heon kim and aaron zeff palmer leb supp 0 and 0 then there exists a unique optimal stopping time that is given by inf t j b 0 bt bt c b 0 bt 6 1 where is the dual optimizer of theorem 4 1 and j is the value function satisfying 1 14 we will need several technical lemmata that address differentiability issues for j x y in our proof of theorem 6 1 the dynamic programming principle for j allows us easily verify the following remarkable lipschitz continuity lemma 6 2 assume that for each y o we have that x 7 c x y lip k for some constant k 0 independent on y then for each y o x 7 j x y lip k proof this is an easy conclusion from the definition of j by stopping times 1 14 because x 7 e by c x b y lip k for each the supremum over those lipschitz functions is again lipschitz with the same lipschitz constant k the following two lemmas deal with the differentiability of two relevant integrals expected values we first verify harmonicity of y 7 j x y in a small neighborhood lemma 6 3 use the same assumptions and notation as in theorem 6 1 then for each x int supp y 7 j x y is harmonic in an open neighborhood around x proof for a e x int supp choose an open ball v x int supp centered at x with radius 0 such that v x 0 for each r let r be the first hitting time to vr x define u v x r as u y e j x b y because of markov property of the brownian motion u satisfies the mean value property so is harmonic recall that y 7 j x y is superharmonic therefore j x y u y for all y v x moreover because of our assumption 0 we have r 0 r for the optimal stopping of pc therefore from the verification theorem theorem 4 7 we see that for a e x j x x e j x b x r e j x b x 6 2 in the case r we have j x x u x then for other r 6 2 and the inequality j u imply that j x y u y for a e y v x now lower semi continuity of j and the inequality j u imply j x y u y for all y v x to have the harmonicity for all x int supp not just a e use the lipschitz continuity of x 7 j x y to extend this harmonicity to all x int supp this completes the proof lemma 6 4 use the same assumptions and notation as in theorem 6 1 let be an optimal stopping time of our problem pc let be any stopping time with satisfying e j x b x e bx c x b x for a e x 6 3 in particular the hitting time defined in 6 1 satisfies these from lemma 3 6 1 then for a e x the functions h 7 j x h x h 7 e j x h b x and h 7 e j x h b x are differentiable at h 0 and d dh h 0 j x h x 6 4 d dh h 0 e j x h b x e xc x b x d dh h 0 e j x h b x e xc x b x monge transport brownian martingale 19 proof from lemma 6 3 and the gradient estimates of harmonic functions the function y 7 j x y is locally lipschitz in an open neighborhood of each x int supp here the local lipschitz constant is uniform in x in a neighborhood since c is continuous and the function j is bounded in o o which follows from the boundedness of bd combining this with the fact x 7 j x y lip c from lemma 6 2 for each y we get the function x y 7 j is locally lipschitz on an open neighborhood n of the diagonal set x x x int supp contained in int supp int supp by rademacher s theorem j is differentiable a e in the same set by fubini s theorem and leb this implies that for a e x the function h 7 j x h y is differentiable at h 0 for a e y in an open neighborhood of x because of the assumptions supp 0 and leb we can without loss of generality assume that x int supp and the ball v x int supp and for all sufficiently small h the function y v x 7 j x h y is harmonic choose a stopping time such that for the first hitting time to the sphere v x and bx leb then from the bound x 7 j x y lip c and the dominated convergence theorem we see that d dh h 0 e j x h b x e d dh h 0 j x h b x in particular the derivative exists we now use the harmonicity of y v x 7 j x h y for sufficiently small h to see j x h x e j x h b x so h 7 j x h x is differentiable at h 0 as 0 and v x int supp we see that thus this order implies j x h x e j x h b x e j x h b x e bx c x h b x note that from theorem 4 7 in particular 4 3 we have j x x e j x b x e bx c x b x therefore at h 0 the above inequalities become equalities since j x h x e j x h bx and e bx c x h b x are both differentiable at h 0 we see that the function h 7 e j x h b x is differentiable at h 0 and all these have the same derivatives d dh h 0 j x h x d dh h 0 e j x h b x d dh h 0 e bx c x h b x d dh h 0 e c x h bx e xc x b x for it is not clear whether therefore to examine the derivative of the function e j x h b x we notice that j x h x e j x h b x e j x h b x with equality at h 0 because of 4 3 this shows that h 7 e j x h b x is differentiable at h 0 and d dh h 0 e j x h b x d dh h 0 e j x h b x moreover e j x h b x e bx c x h b x 20 nassif ghoussoub young heon kim and aaron zeff palmer and from the assumption on we have equality at h 0 this verifies d dh h 0 e j x h b x d dh h 0 e bx c x h b x d dh h 0 e c x h bx e xc x b x all together these complete the proof we now use the above lemmata to give the proof of theorem 6 1 proof of theorem 6 1 let denote the probability measure on o o corresponding to b that is bx x for a e x where x is the disintegration dx dy x dy dx fix a pair x y chosen a e in particular for x to satisfy the results of lemma 6 4 with then consider a small ball v y of radius 0 around y define a stopping time as if bx v y otherwise notice that satisfies and 6 3 e g from lemma 3 6 1 so that we can apply lemma 6 4 then 6 4 gives e xc x b x e xc x b x from this we see 0 1 p bx v y e xc x b x e xc x b x e xc x b x b x v y e xc x b x b x v y letting 0 we see that for restricted to the paths where y bx e xc x b y xc x y 0 for a e x y we apply the stochastic twist condition st in definition 5 1 and we get 0 since this holds for a e x y this implies completing the proof 7 the case of the distance function we now consider the distance cost c x y x y we focus on the multi dimensional case d 2 because for the 1 dimensional case d 1 our problem is equivalent to the martingale optimal transport and the uniqueness and structure of the optimal stopping is well known 4 31 32 33 we first get the following theorem as a corollary of theorem 6 1 where we assume the strict separation assumption supp supp to ignore the singularity at x y then a localization argument allows us to remove this disjointness of supports in theorem 7 2 where we show that there is a unique optimal randomized stopping time given by the hitting time of a barrier whenever 0 assuming that and have densities f c o and g c o respectively theorem 7 1 use the same assumptions as in theorem 6 1 except that c x y x y assume further that d 2 and supp supp then the following holds 1 there exists a constant d and bd such that j maximize the dual problem 2 there is a unique optimal stopping time that is given by inf t j b 0 bt bt b 0 bt 7 1 proof let be an optimal stopping time for the cost c x y x y we let 0 be such that x y for all x supp and y supp then we consider a smooth subharmonic function c x y x y such that c x y x y whenever x y this can be easily constructed since for d 2 x y 0 whenever x y 6 0 let d be the constant with 0 yc x y d monge transport brownian martingale 21 first observe that by construction of c and the separation of supp and supp by is also an optimal stopping time for the cost c and e c b 0 b e b 0 b we now consider the dual optimizers for the cost c namely j with bd obtained from theorem 4 1 here j is the value function with respect to c that is j x y sup e by c x by then from theorem 6 1 for given in 6 1 with respect to c and j this also proves uniqueness of on the other hand notice that because c x y x y j x y sup e by x b y j x y 7 2 therefore o y dy o j x x dx o y dy o j x x dx e c b 0 b e b 0 b this proves that the pair j is a dual optimizer for the cost x y and the above inequality is in fact an equality thus applying 7 2 we get j x y j x y for a e x y 7 3 where is the optimal subharmonic martingale measure corresponding to for a e x y 7 j x y is harmonic for y satisfying y x by lemma 6 3 so 7 3 and superharmonicity of j imply that j x y j x y for all y satisfying y x then we see that satisfies 7 1 this completes the proof theorem 7 2 for c x y y x and d 2 if sh and and have densities f c o and g c o then there is a unique optimal stopping time that is randomized only at time 0 the optimal stopping time is given by 0 with density g f and otherwise is the hitting time inf t 0 b 0 bt r for some r o o measurable we will first show that the overlapping mass if any of the probability measures and stays put under any optimal solution this was already shown in 23 by using the monotonicity principle of 6 we shall give here a direct proof without using that principle lemma 7 3 see 23 we use the assumptions and notation of theorem 7 2 except we suppose that the cost function c satisfies following conditions c is continuous and c x x 0 x c satisfies the triangle inequality c x y c x z c z y x y z while equality holds only when y is on the unique geodesic line segment in rd connecting x and z then any optimal randomized stopping time stops at time 0 with density f g i e e 1 0 o f x g x dx proof given an optimal randomized stopping time we let h be the density it stops at time 0 i e e 1 0 o h x dx notice that h f g we will prove the equality in the following we use the convention in definitions that the value of a quotient is 1 if the denominator vanishes 22 nassif ghoussoub young heon kim and aaron zeff palmer first define a randomized stopping time from the initial distribution so that follows the stopping rule of with probability density f f g of course it is possible to stop at time 0 for with a certain density and stops at time 0 otherwise namely the initial distribution of is b 0 is randomized at the initial point b 0 as with probability 1 f b 0 g b 0 f b 0 0 with probability f b 0 g b 0 f b 0 in particular for any continuous function we have e b e bx f x f x g x dx x f x g x dx 7 4 let be the final distribution of i e b as b has density by the construction of the distribution also has density say f observe that f f g we now define another randomized stopping time from the initial distribution so that it follows the stopping rule of with probability density f g and otherwise it stops at time 0 more precisely the initial distribution of is b 0 is randomized at the initial point b 0 as with probability f b 0 g b 0 f b 0 0 with probability 1 f b 0 g b 0 f b 0 we verify that b has the same final distribution as b to see this note that e b e bx f x g x dx x f x f x g x dx 7 5 here realizing x f x dx e b and using 7 4 we see that this equation implies e b e bx f x dx e b verifying the claim b b we now let be the randomized stopping time from the initial distribution that follows first then that is is the randomized stopping time on the random paths obtained by concatenating the random paths following the stopping rule of with the random paths following that of we have and that the final distribution of is the same as the final distribution of therefore b observe using the fact c x x 0 and 7 4 that e c b 0 b e c x bx f x f x g x dx similarly from the construction of and 7 5 e c b b e c b 0 b e c x bx f x g x dx this shows that e c b 0 b e c b b e c b 0 b 7 6 on the other hand from the optimality of and the fact that and have the same initial and final distributions and the triangle inequality of c we have e c b 0 b e c b 0 b e c b 0 b e c b b here all these inequalities become equalities due to 7 6 in particular we have the equality case of the triangle inequality where b is on the geodesic connecting b 0 and b which holds only if 0 or almost surely 7 7 monge transport brownian martingale 23 otherwise we would find that where 0 b b b b 0 for 0 and hence e b b b b 0 f 0 which cannot hold do to the martingale property of brownian motion we will analyze 7 7 to draw our conclusion for the random paths with 0 7 7 and the definition of implies so the point b lands at where 0 note that 0 with probability f b g b f b h b f b 1 f b g b f b 1 this implies that if 0 then h b f b therefore whenever f x h x it must be the case that h x g x becauseb x only when 0 this then implies that h x f x g x completing the proof proof of theorem 7 2 we first reduce the problem to the case where the measures and have disjoint supports then apply theorem 7 1 indeed from lemma 7 3 we have that the optimal stopping time stops at time 0 with density g f thus we only need to characterize when 0 we now show that if 0 then is given by which is the hitting time of a barrier first on the subset of the probability space where 0 is optimal for transporting the mass with density f g to with density g f these measures satisfy 0 and supp 0 we require one more step to reduce our setting to the case where the measures have strictly disjoint support so that we can apply theorem 7 1 we introduce as the restriction of to points where the distance to supp is greater than then we let be the stopping distribution of the restriction of to the initial distribution notice that is still optimal to this restriction applying theorem 7 1 we have that this restricted problem has a unique optimal hitting time equal to given by 7 1 this defines the set r whenever y x taking to zero we get that whenever 0 to prove that is unique we suppose that 1 and 2 are both optimal randomized stopping times by the argument above we have that both stop at t 0 with density g f and for t 0 are given by the hitting times 1 and 2 we form the randomized stopping time that stops at 1 with probability 1 2 and at 2 with probability 1 2 i e with brownian martingale measure 1 2 1 1 2 2 the same argument applies to show that if 0 then which is the hitting time to a barrier it follows that 1 2 because otherwise there is a finite probability of finding b 0 bt r 1 but b 0 bt 6 r 2 or vice versa which contradicts that is the hitting time of a barrier remark 7 4 notice that in theorem 7 2 the condition f g c o can be relaxed for example it suffices that g belongs to h 1 o outside the support of appendix a approximations we give a couple of approximation via inf convolution results discussed in 37 20 13 which are used in lemma 2 3 and proposition 3 2 for h lsc o we define the inf convolution as h y inf z o h z 1 2 y z 2 lemma a 1 given h lsc o we have that h is lipschitz and semiconcave if h d on o in the sense of viscosity and dist x o 2 4 h then h x d in the sense of viscosity furthermore h has a distributional hessian 2 h that is a matrix valued measure and satisfies h d in the weak sense for the open set y o dist y o 2 4 h in particular there is a sequence of functions hi c o such that hi x h x for x o and for each x o and 0 there exists i such that for i i we have hi x d and h x hi x 24 nassif ghoussoub young heon kim and aaron zeff palmer proof for each z y 7 h z 1 2 y z 2 is lipschitz with constant 1 diamo and if we subtract 1 2 y 2 it becomes concave these properties are inherited by the infimum suppose now that h y d in the sense of viscosity for all y o and dist x o 2 4 h then there is z o such that h x h z 1 2 x z 2 now suppose that w touches h x from below at x then we define y w x y z 1 2 x z 2 then we have that z w x 1 2 x z 2 h z and y h x y z 1 2 x z 2 h y thus using the viscosity property h d of h we have z d and since z w x this shows that h x d in the sense of viscosity it follows from semi concavity that the distributional hessian of h is a matrix valued measure furthermore it decomposes as 2 h m t where m 0 t l and m t if there was a point with density at x where tr t d we could construct a c 2 function near x satisfying d w x tr t x such that w x h x and w y h y thus for x satisfying dist x o 2 4 h we have h d in the weak sense finally for the smooth approximation we can define h x by extending h outside of the domain o and convolving with a smooth mollifier whose support shrinks as 0 note that h d we can then subtract a small constant so that h h but is converging uniformly as 0 from lipschitz property of h the result on smooth approximation follows by choosing both and sufficiently small where we use the fact that h h and from the lower semicontinuity of h lim inf 0 h h for each x this completes the proof for functions in bd the boundary condition gives a cleaner smooth approximation as follows lemma a 2 there is an open bounded convex set o depending only on o and d such that o o and for any 0 1 and h bd h satisfies h x 0 and h x d for x o and h y 0 for y o it follows that each h bd can be approximated pointwise by smooth functions satisfying the properties above in some open bounded convex set containing o proof for each h bd we extend it to r d by giving zero value on rd o notice that this extended function h using the same notation still satisfies h d in rd in the sense of viscosity define h y infz rd h z 1 2 y z 2 as h is bounded we can apply the same reasoning as in the proof of lemma a 1 to see that h x d for all x r d in the sense of viscosity also it clearly holds h h 0 consider a uniform bound m for functions on bd i e supx o uo x as in 3 2 from this observe that for y satisfying dist y o 2 4 m we have h y 0 a further convolution by a smooth bump function allows us to approximate h uniformly with smooth functions h i that also satisfy hi x d and h i 0 with support in a fixed convex bounded open domain o independent of individual h which contains o and y z 2 5 m for all y o and z o by also letting 0 point wise convergence of hi to h follows this completes the proof appendix b a proof of the monotonicity principle as a simple application of our dual attainment theorem 4 1 and 4 7 we now provide an alternative proof of the following version of the monotonicity principle of beiglbo ck cox and huesmann 6 adapted to our setting theorem b 1 see 6 with the same notation as in theorem 4 1 and 4 7 in particular we consider the disintegrated probability measure dx dy x dy dx such that 0 sh x sh x for each a e x and its corresponding randomized stopping time note that monge transport brownian martingale 25 for a e x y and a e x y it holds that if y y then the stopping time restricted to paths with b y satisfies c x y e c x b y c x y e c x b y proof notice that from theorem 4 7 we have for a e x y and a e x y j x y y c x y b 1 j x b y j x b x bx c x b x b y c x b y b 2 from the dynamic programming formulation of j we have j x y e b y c x b y b 3 it also follows from 4 4 that e j x b y j x y y c x y b 4 where the first equality follows from 4 3 and the inequality from the dynamic programming principle taking the expectation in b 2 we see that under the condition y y the left hand sides of b 1 b 2 are equal to the left hand sides of the inequalities b 3 and b 4 now subtract the sum of the two equations from the sum of the two inequalities and cancel the terms y and e b y to obtain 0 c x y e c x b y c x y e c x b y hence completing the proof remark b 2 the condition y y together with gives a version of the stop go pair of 6 our proof is similar in spirit to that of 28 where weak duality is used while we use the strong duality dual attainment under the additional assumption 0 yc x y d among others because of this last condition our monotonicity result does not completely replace that of 6 for the distance cost x y references 1 luigi ambrosio lecture notes on optimal transport problems in mathematical aspects of evolving interfaces funchal 2000 volume 1812 of lecture notes in math pages 1 52 springer berlin 2003 2 jr baxter rv chacon et al potentials of stopped distributions illinois journal of mathematics 18 4 649 656 1974 3 mathias beiglbo ck pierre henry laborde re and friedrich penkner model independent bounds for option prices a mass transport approach finance and stochastics 17 3 477 501 2013 4 mathias beiglbo ck and nicolas juillet on a problem of optimal transport under marginal martingale con straints ann probab 44 1 42 106 2016 5 mathias beiglbo ck marcel nutz nizar touzi et al complete duality for martingale optimal transport on the line the annals of probability 45 5 3038 3074 2017 6 mathias beiglboeck alexander mg cox and martin huesmann optimal transport and skorokhod embedding inventiones mathematicae 208 2 327 400 2017 7 mathias beiglboeck tongseok lim and jan ob lo j dual attainment for the martingale transport problem arxiv e prints page arxiv 1705 04273 may 2017 8 jean david benamou and yann brenier a computational fluid mechanics solution to the monge kantorovich mass transfer problem numerische mathematik 84 3 375 393 2000 9 patrick bernard and boris buffoni optimal mass transportation and mather theory journal of the european mathematical society 9 1 85 121 2007 10 yann brenier polar factorization and monotone rearrangement of vector valued functions communications on pure and applied mathematics 44 4 375 417 1991 11 luis caffarelli mikhail feldman and robert mccann constructing optimal maps for monge s transport problem as a limit of strictly convex costs journal of the american mathematical society 15 1 1 26 2002 12 luis a caffarelli allocation maps with general cost functions in partial differential equations and applications volume 177 of lecture notes in pure and appl math pages 29 35 dekker new york 1996 13 michael g crandall hitoshi ishii and pierre louis lions user s guide to viscosity solutions of second order partial differential equations bulletin of the american mathematical society 27 1 1 67 1992 26 nassif ghoussoub young heon kim and aaron zeff palmer 14 claude dellacherie and paul andre meyer probabilities and potential volume 29 of north holland mathematics studies north holland publishing co amsterdam new york north holland publishing co amsterdam new york 1978 15 yan dolinsky and h mete soner martingale optimal transport and robust hedging in continuous time prob ability theory and related fields 160 1 391 427 oct 2014 16 lester e dubins on a theorem of skorohod the annals of mathematical statistics 39 6 2094 2097 1968 17 gerald a edgar annie millet and louis sucheston on compactness and optimality of stopping times in martingale theory in harmonic analysis and banach spaces pages 36 61 springer 1982 18 lawrence c evans and wilfrid gangbo differential equations methods for the monge kantorovich mass trans fer problem volume 653 american mathematical soc 1999 19 neil falkner on skorohod embedding in n dimensional brownian motion by means of natural stopping times in se minaire de probabilite s xiv 1978 79 pages 357 391 springer 1980 20 isamu fukuda hitoshi ishii masayoshi tsutsumi et al uniqueness of solutions to the cauchy problem for ut u u u 2 0 differential and integral equations 6 6 1231 1252 1993 21 wilfrid gangbo habilitation thesis universite de metz available at http people math gatech edu gangbo publications habilitation pdf 1995 22 wilfrid gangbo and robert j mccann the geometry of optimal transportation acta mathematica 177 2 113 161 1996 23 nassif ghoussoub young heon kim and tongseok lim optimal brownian stopping between radially sym metric marginals in general dimensions arxiv e prints november 2017 24 nassif ghoussoub young heon kim and tongseok lim structure of optimal martingale transport plans in general dimensions annals of probability 47 1 109 164 2019 25 nassif ghoussoub young heon kim and aaron zeff palmer optimal transport with controlled dynamics and free end times siam journal on control and optimization 56 5 3239 3259 2018 26 nassif ghoussoub young heon kim and aaron zeff palmer pde methods for skorokhod embeddings arxiv e prints https arxiv org pdf 1807 10347 pdf 2018 27 alexander grigor yan analytic and geometric background of recurrence and non explosion of the brownian motion on riemannian manifolds bulletin of the american mathematical society 36 2 135 249 1999 28 gaoyue guo xiaolu tan and nizar touzi on the monotonicity principle of optimal skorokhod embedding problem siam j control optim 54 5 2478 2489 2016 29 p henry labordere model free hedging a martingale optimal transport viewpoint chapman and hall crc financial mathematics series crc press 2017 30 pierre henry labordere and nizar touzi an explicit martingale version of the one dimensional brenier theorem finance and stochastics 20 3 635 668 july 2016 31 david hobson the skorokhod embedding problem and model independent bounds for option prices in paris princeton lectures on mathematical finance 2010 pages 267 318 springer 2011 32 david hobson and martin klimmek model independent hedging strategies for variance swaps finance and stochastics 16 4 611 649 2012 33 david hobson and martin klimmek robust price bounds for the forward starting straddle finance and stochastics 19 1 189 214 2015 34 leonid v kantorovich on the translocation of masses in dokl akad nauk ussr ns volume 37 pages 199 201 1942 35 david kinderlehrer and guido stampacchia an introduction to variational inequalities and their applications volume 31 siam 1980 36 vladimir levin abstract cyclical monotonicity and monge solutions for the general monge kantorovich problem set valued analysis 7 1 7 32 1999 37 pierre louis lions optimal control of diffusion processes and hamilton jacobi bellman equations part 2 vis cosity solutions and uniqueness communications in partial differential equations 8 11 1229 1276 1983 38 xi nan ma neil s trudinger and xu jia wang regularity of potential functions of the optimal transportation problem archive for rational mechanics and analysis 177 2 151 183 2005 39 jan oblo j mathias beiglboeck tongseok lim dual attainment for the martingale transport problem arxiv 1705 0427 2017 40 gaspard monge me moire sur la the orie des de blais et des remblais histoire de l acade mie royale des sciences de paris 1781 41 jan ob lo j the skorokhod embedding problem and its offspring probability surveys 1 321 392 2004 42 aldo pratelli on the equality between monge s infimum and kantorovich s minimum in optimal mass trans portation in annales de l institut henri poincare b probability and statistics volume 43 pages 1 13 no longer published by elsevier 2007 43 david h root the existence of certain stopping times on brownian motion the annals of mathematical statistics 40 2 715 718 1969 44 hermann rost the stopping distributions of a markov process inventiones mathematicae 14 1 1 16 1971 45 a v skorokhod studies in the theory of random processes translated from the russian by scripta technica inc addison wesley publishing co inc reading mass 1965 monge transport brownian martingale 27 46 volker strassen the existence of probability measures with given marginals the annals of mathematical statistics pages 423 439 1965 47 luis sylvestre viscosity solutions of elliptic equations lecture notes in second chicago summer school in analysis 2015 http math uchicago edu luis preprints viscosity solutions pdf 48 neil s trudinger and xu jia wang on the monge mass transfer problem calc var partial differential equations 13 1 19 31 2001 nassif ghoussoub and aaron zeff palmer department of mathematics university of british columbia vancouver v 6 t 1 z 2 canada email address nassif math ubc ca azp math ubc ca young heon kim department of mathematics university of british columbia vancouver v 6 t 1 z 2 canada center for mathematical challenge korea institute for advanced study seoul korea email address yhkim math ubc ca http math uchicago edu luis preprints viscosity solutions pdf 1 introduction 2 a dual variational principle 3 a weakly compact set of d superharmonic functions in sobolev class 4 dual attainment in sobolev class 5 a stochastic twist condition 6 uniqueness of the monge solution optimal stopping as a hitting time 7 the case of the distance function appendix a approximations appendix b a proof of the monotonicity principle references