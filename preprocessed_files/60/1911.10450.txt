a singular stochastic control approach for optimal pairs trading with proportional transaction costs haipeng xing department of applied mathematics and statistics state university of new york stony brook ny 11794 usa xing ams sunysb edu abstract optimal trading strategies for pairs trading have been studied by models that try to find either optimal shares of stocks by assuming no transaction costs or optimal timing of trading fixed numbers of shares of stocks with transaction costs to find optimal strategies which determine optimally both trade times and number of shares in pairs trading process we use a singular stochastic control approach to study an optimal pairs trading problem with proportional transaction costs assuming a cointegrated relationship for a pair of stock log prices we consider a portfolio optimization problem which involves dynamic trading strategies with proportional transaction costs we show that the value function of the control problem is the unique viscosity solution of a nonlinear quasi variational inequality which is equivalent to a free boundary problem for the singular stochastic control value function we then develop a discrete time dynamic programming algorithm to compute the transaction regions and show the convergence of the discretization scheme we illustrate our approach with numerical examples and discuss the impact of different parameters on transaction regions we study the out of sample performance in an empirical study that consists of six pairs of u s stocks selected from different industry sectors and demonstrate the efficiency of the optimal strategy keywords free boundary problem pairs trading stochastic control trading strategies transaction costs transaction regions 1 ar x iv 1 91 1 10 45 0 v 1 q fi n t r 2 4 n ov 2 01 9 1 introduction pairs trading is one of proprietary statistical arbitrage tools used by many hedge funds and investment banks it is a short term trading strategy that first identifies two stocks whose prices are associated in a long run equilibrium and then trades on temporary deviations of stock prices from the equilibrium though paris trading is a simple market neutral strategy it has been used and discussed extensively by industrial practitioners in the last several decades see detailed discussion in vidyamurthy 2004 whistler 2004 ehrman 2006 lai and xing 2008 and reference therein besides its wide practice in financial industry pairs trading also draws much attention from academic researchers for instance gatev et al 2006 examined the risk and returns of pairs trading using daily data collected from the u s equity market and concluded that the strategy in general produces profit higher than transaction costs to investigate the pairs trading strategy analytically elliott et al 2005 modeled the spread of returns as a mean reverting process and proposed a trading strategy based on the model this motivates subsequent researchers to formulate pairs trading rules as stochastic control problems for an ornstein uhlenbeck ou process and a correlated stock price process in particular mudchanatongsuk et al 2008 assumed the log relationship between a pair of stock prices follows a mean reverting process and considered a self financing portfolio strategy that only allows positions that were long in one stock and short in the other with equal dollar amounts they then formulated a portfolio optimization based stochastic control problem and obtained the optimal solution to this control problem in closed form via the corresponding hamilton jacobi bellman hjb equation relaxing the equal dollar constraint tourin and yan 2013 extended mudchanatongsuk et al 2008 s approach and study pairs trading strategies with arbitrary amounts in each stock without any transaction costs instead of deriving the optimal weight of stocks in pairs trading another line of study on pairs trading strategies fixes the number of traded shares for each stock during the entire trading process and considers only the optimal timing of trades in the presence of fixed or proportional transaction costs specifically leung and li 2015 studies the optimal timing to open or close the position subject to fixed transaction costs and the effect of stop loss level under the ou process by constructing the value function directly zhang and zhang 2008 song and yan 2013 and ngo and pham 2016 studied the optimal pairs trading 2 rule that is based on optimal switching among two buy and sell or three buy sell and flat regimes with a fixed commission cost for each transaction and solve the problem by finding viscosity solutions to the associated hjb equations quasi variational inequalities lei and xu 2015 studied the optimal pairs trading rule of entering and exiting the asset market in finite horizon with proportional transaction cost for two convergent assets note that although transaction costs are considered in these strategies since the number of traded shares of stocks are fixed during the entire trading period these strategies are still far from traders practical experience in reality to bridge the gap between choosing optimal weight of shares and deciding optimal trading times in pairs trading we use a singular stochastic control approach to study an optimal pairs trading problem with proportional transaction costs which allows us choosing not only optimal weight but also optimal trading times during the trading process for convenience we assume the same diffusion and urnstein uhlenbeck processes for one stock and its spread with the other stock as those in mudchanatongsuk et al 2008 however different from mudchanatongsuk et al 2008 who used a trading rule which requires to short one stock and long the other in equal dollar amounts we consider a delta neutral rule under which the ratio of traded shares for two stocks is fixed and this fixed ratio is determined by the cointegration relationship of two stocks hence when the number of shares of one stock is determined based on the rule of delta neutral the number of shares for the other stock is also determined besides the weight of shares need to be optimally chosen we also assume a proportional transaction cost for each trade and hence the optimal times of trading also needs to be decided as the overall transaction cost based on the above assumption depends on both trading times and the numbers of shares in each trade we compute the terminal utility of wealth over a fixed horizon and formulate the problem of choosing optimal trading times and the number of shares as a singular stochastic control problem we derive the hamilton jacobi bellman equations for this problem and show that the value function of the problem is the unique viscosity solution of a quasi variational inequality we further argue that the quasi variational inequality is equivalent to a free boundary problem so that the state space consisting of one stock price and its spread with the other stock can be naturally divided into three transaction regions long the first stock and short the second short the first and long the second and no transaction the implied transaction regions can help us determine 3 not only optimal times of each transaction but also the optimal number of shares in each transaction to compute the boundaries of these transaction regions we develop a numerical algorithm that is based on discrete time dynamic programming to solve the equation for the negative exponential utility function and show that the numerical solution converges to the unique continuous time solution of the problem to investigate the performance of the optimal trading strategies implied by the transac tion regions we carry out both simulation and empirical studies specifically we study the time varying transaction regions or trading boundaries for a specific set of model param eters and investigate the impact of variations of model parameters on transaction regions and performance of the optimal strategy for comparison purpose we also consider a bench mark strategy which is based on the deviation of the spread from its long term mean and is popular among practitioners in both simulation studies and real data analysis we show that the optimal trading strategy performs better than the benchmark strategy the rest of the paper is organized as follows section 2 first formulates the model and then derive the hamilton jacobi bellman equations associated with the singular stochastic control problems it shows the existence and uniqueness of the viscosity solution for the va rational inequalities which are equvalent to the portfolio optimization problem and reduces the problem into a free boundary problem section 2 also consider the optimal trading prob lem with exponential utility functions in section 3 we discretize the free boundary problem and propose a disctete time dynamic programming algorithm we also demonstrate that the solution of the discretized problem converges to the viscosity solution of the variational inequalities sections 4 and 5 provide simulation and empircal studies of the model and the optimal trading strategy and compare its performance with a benchmark trading strategy some concluding remarks are given in section 6 4 2 a pairs trading problem with proportional transac tion costs 2 1 model specification consider a pair of two stocks p and q and let p t and q t denote their prices at time t respectively we assume that the price of stock p follows a geometric brownian motion dp t p t dt p t db t 1 where and are the drift and the volatility of stock p and b t is a standard brownian motion defined on a filtered probability space and but specified later denote x t the difference of the logarithms of the two stock prices i e x t log q t log p t log q t p t 2 we assume that the spread follows an ornstein uhlenbeck process dx t x t dt dw t 3 where 0 is the speed of mean reversion and is the long term equilibrium level to which the spread reverts we assume that b t w t is a two dimensional brownian motion defined on a filtered probability space ft p and the instantaneous correlation coefficient between b t and w t is i e e dw t db t dt 4 the above assumptions are same as those in mudchanatongsuk et al 2008 with these assumptions we can express the dynamics of q t as dq t x t 1 2 2 q t dt q t db t q t dw t 5 in the presence of proportional transaction costs the investor pays 0 p q 1 and 0 p q 1 of the dollar value transacted on purchase and sale of the underlying stocks p and q denote lp t and mp t two nondecreasing and non anticipating processes and represent the cumulative number of shares of stock p bought or sold respectively within 5 the time interval 0 t 0 t t let yp t be the number of shares held in stock p i e yp t lp t mp t and similarly we define lq t mq t and yq t lq t mq t for stock q denote g t the dollar value of the investment in bond which pays a fixed risk free rate of r then the investor s position in two stocks and the bond is driven by dyp t dlp t dmp t dyq t dlq t dmq t 6 and dg t rg t dt bpp t dmp t aqq t dlq t bqq t dmq t app t dlp t 7 where ai 1 i and bi 1 i for i p q we then need to choose a rule to determine the number of shares of stocks p and q bought or sold at time t note that mudchanatongsuk et al 2008 assumed no transaction cost and considered the strategy that always shorts one stock and longs the other in equal dollar amount i e p t dlp t q t dmq t 0 or p t dmp t q t dlq t 0 at time t lei and xu 2015 and ngo and pham 2016 considered a delta neutral strategy that always long one share of a stock and short one share of the other stock i e dyp t dyq t 1 or dyp t dyq t 1 at time t here we also consider a delta neutral strategy that requires the total of positive and negative delta of two assets is zero hence it suggests that the number of shares of stock p bought or sold at time t are same as the number of shares of stock q sold or bought i e dlp t dmq t dmp t dlq t 8 equation 8 implies that dyq t dyp t at any time t comparing to lei and xu 2015 and ngo and pham 2016 we remove the constraint dyp t dyq t 1 or 1 and allow yp t yq t to be a control variable using equations 5 and 8 the dynamics of g t in equation 7 can be simplified as dg t rg t dt ap bqex t p t dlp t bp aqex t p t dmp t 9 the process lp t mp t together with our delta neutral strategy provides us an admissible trading strategy for convenience we denote t g 0 the set of admissiable trading strategies 6 that an investor starts at time zero with amount g 0 of the investment in bond and zero hold ings in two stocks i e yp 0 yq 0 0 which indicates that the numbers of shares held in stocks p and q at time t are yp t and yp t respectively for nonational convenience we omit the subscript of yp t and denote yp t as y t in our discussion then equations 1 3 6 and 9 compose the market model in the time interval 0 t which describes a stochastic process of p t x t yp t g t in r r r r denote the terminal value of the pairs trading portfolio by j x t p t y t note that under our assumption y t indicates that the investor s positions in stocks p and q are y t and y t respectively then the liquidated value of the portfolio is j p t x t y t a p t x t y t 1 y t 0 a p t x t y t 1 y t 0 10 where a p x bp aqex p a p x ap bqex p furthermore if the investment in bond at terminal time t is g t the terminal wealth of the investor is given by g t j p t x t y t suppose that the investor s utility u r r is a concave and increasing function with u 0 0 we assume that the investor s goal is to maximize the expected utility of terminal wealth under the market model 1 3 6 and 9 v t p x y g sup lp t mp t t g 0 e u g t j p t x t y t p t p x t x yt y g t g 11 furthermore given trading strategies lp mp the total trading cost incurred over t t can be expressed as c lp mp t t t t er t u a p u x u dlp u t t er t u a p u x u dmp u j p t x t y t 12 and the total profit over t t is c lp mp t t 7 2 2 the hamilton jacobi bellman equations and free boundary problems we now derive the hamilton jacobi bellman hjb equations associated with the stochastic control problems for the utility maximization problem 11 consider a class of trading strategies such that lp t and mp t are absolutely continuous processes given by lp t t 0 l u du mp t t 0 m u du where l u and m u are positive and uniformly bounded by then 1 3 6 and 9 provides us a system of stochastic differential equations with controlled drift and the bellman equation for a value function denoted by v is l 1 ov sup 0 lt mt l 1 bv lt l 1 sv mt 0 for t p x y g 0 t r r r r in which the operators l b and s are defined as l 1 o t x x p p rg g 1 2 2 2 x 2 p 2 p x 1 2 2 p 2 2 p 2 l 1 b y ap bqex t p t g l 1 s y bp aqex t p t g the optimal trading strategy is then determined by considering the following three possible cases i buying stock p and sell stock q at the same rate l t i e m t 0 when l 1 bv 0 l 1 sv 0 13 ii selling stock p and buy stock q at rate m t i e l t 0 when l 1 bv 0 l 1 sv 0 14 iii doing nothing i e l t m t 0 when l 1 bv 0 l 1 sv 0 15 8 note that the case l 1 bv 0 and l 1 sv 0 can not occur as all value functions are increasing functions of g the above argument shows that the optimization problem 11 is a free boundary prob lem in which the optimal trading strategy is defined by the inequalities i ii and iii for a given value function besides the state space 0 t r r r r is partitioned into buy sell and no transaction regions for stock p which are characterized by inequalities 13 14 and 15 respectively for sufficiently large the state space remains divided into a buy region b a sell region s and a no transaction region n for stock p which are correspondingly the sell region the buy region and the no transaction region for stock q due to equation 8 obviously the buy and sell regions for stock p are disjoint as it is not optimal to buy and sell the same stock at the same time we denote the boundaries between the no transaction region n and the buy and sell regions b and s as b and s respectively let the class of admissible trading strategies becomes t g 0 we can guess that the state space is still divided into three regions a region of buying p and selling q a region of selling p and buying q and a no transaction region then the optimal trading strategy requires an immediate move to the boundaries of buy or sell regions if the state is in the buy region b or the sell region s actually we can obtain equations that each of the value functions should satisfy as follows i in region b of buying p and selling q the value function remains constant along the path of the state dictated by the optimal trading strategy and therefore for y 0 v t p x y g v t p x y y g ap bqex p y 16 where y is the number of shares of stock p bought and stock q sold by the investor y can be any positive value up to the number required to take the state to b so letting y 0 in 16 yields l 1 bv 0 17 ii similarly in region s of selling p and buying q the value function obeys the following equation for y 0 v t p x y g v t p x y y g bp aqex p y 18 9 where y is the number of shares of stock p sold and stock q bought by the investor y can be any positive value up to the numer required to take the state to s so letting y 0 in 18 yields l 1 sv 0 19 iii in the no transaction region the value function obeys the same set of equations obtained for the class of absolutely continuous trading strategies and therefore the value function is given by l 1 ov 0 20 and the pair of inequalities shown above in 15 also hold note that due to the continuity of the value function if it is known in the no transaction region it can be determined in both the buy and sell regions by 17 and 19 respectively in the buy region b l 1 sv 0 and in the sell region s l 1 bv 0 also from the two pairs of inequailities 13 and 14 we may conjecture that l 1 ov in 20 is negative in both the buy region b and the sell region s therefore the above set of equations can be summarized as the following fully nonlinear partially differential equations pde min l 1 bv l 1 sv l 1 ov 0 21 for t p x y g 0 t r r r r note that the above discussion also yields the following free boundary problem for the singular stochastic control value function l 1 bv 0 in b l 1 sv 0 in s l 1 ov 0 in n v t p x y g u g j p x y 22 we next show that the value function given by 11 is a constrained viscosity solution of the variational inequality 21 on 0 t r r r r and it is the unique bounded constrained viscosity solution of 21 the proof is given in the appendix theorem 1 the value function v t p x y g is a constrained viscosity solution of 21 on 0 t r r r r 10 theorem 2 let u be a bounded upper semicontinuous viscosity subsolution of 21 and v a bounded from below lower semicontinuous viscosity supersolution of 21 such that u t x v t x for all x r r r r then u v on 0 t r r r r 2 3 optimal trading with exponential utility functions we next assume that the investor has the negative exponential utility function u z 1 exp z 23 where is the constant absoluate risk aversion cara parameter such that u z u z for equation 21 this utility function can reduce much of computational effort and is easy to interpret note that for the utility function 23 the definition of the value function 11 can be expressed as v t p x y g 1 exp ger t t h t p x y 24 where h t p x y is a convex nonincreasing continuous function in y and defined by h t p x y inf lp t mp t t g 0 e exp j p t x t y t p t p x t x y t y 1 v t p x y 0 plug 24 into 21 and define the following operators for h t p x y on 0 t r r r l 2 oh h t x h x p h p 1 2 2 2 h x 2 p 2 h p x 1 2 2 p 2 2 h p 2 l 2 bh h y er t t a p x h l 2 sh h y er t t a p x h then 21 is transformed into the following pde for h t p x y min l 2 bh l 2 sh l 2 oh 0 25 with the following boundary conditions h t p x y exp j p x y 11 correspondingly the free boundary problem 22 becomes l 2 oh 0 y yb t p x ys t p x l 2 bh 0 y yb t p x l 2 sh 0 y ys t p x h t p x y exp j p x y 26 in which yb t p x and ys t p x are the buy and sell boundaries for stock p respectively note that the function h t p x y is evaluated in the four dimensional space 0 t r r r furthermore this suggests that while t ut wt is inside the no transaction region the dynamics of h t u w y is driven by a two dimensional standard brownian motions zt t 0 and wt t 0 with correlation in the buy and sell regions it follows from 26 that h t p x y exp er t t a p x y yb t p x h t p x yb t p x y yb t p x h t p x y exp er t t a p x y ys t p x h t p x ys t p x y ys t p x 3 discretization and a numerical algorithm the solution of the pde 21 or 25 can be obtained by turning the stochastic differential equations 1 3 6 and 9 into markov chains and then applying the discrete time dynamic programming algorithm the discrete state is x p x g whose elements denote time price of stock p spread number of shares of stock p and amount in the bank in a discrete space the value function denoted by v are given a value at the final time by using the boundary conditions for the continuous value functions over the discrete subspace p x g and then they are estimated by proceeding backward in time by using the discrete time algorithm as in the continuous time case this algorithm is the same for both value functions and is derived below for a value function denoted by v p x g where is a discretization parameter which depends on the discrete time interval t if t and the resolution of the axis are sent to zero then the above discrete value function converges to a viscosity subsolution and a viscosity supersolution of the pde 21 therefore all the discrete value functions converge to their continuous counterparts this is due to the uniqueness of the viscosity solution 12 consider an evenly spaced partition of the time interval 0 t 2 n where t n and two evenly spaced partitions of the space intervals z 0 2 and w 0 2 the grids p is defined by z via the following transformation pi exp 1 2 2 t zi t 27 note that the sde 3 implies that the aymptotic distribution of x t is normal 2 2 we define grid x by xj 2 wj 28 denote i i for i 1 n 1 the dynamics 1 and 3 of p t and x t implies the following transition density for p i x i p i 1 x i 1 p i x i n logp i 12 2 1 x i 2 2 29 we also note that the discrete time equation for the amount in the bank g is g i 1 g i exp r given the grid defined above the discrete time dynamic programming principle is in voked and the following discretization scheme is proposed for pde 21 v i p i x i g i max v i p i x i g i ap bqex i p i v i p i x i g i bp aqex i p i e v i 1 p i 1 x i 1 g i 1 30 where 0 is a real constant and i 0 n 1 this scheme is based on the principle that the investor s policy is the choice of the optimum transaction we next show that as the discretization parameter 0 the solution v of 30 converges to the value function v or equivalently to the unique constrained viscosity solution of 21 theorem 3 the solution v of 30 converges locally uniformly as 0 to the unique continuous constrained viscosity solution of 21 13 for the exponential utility function u z 1 exp z the value function v can be expressed as 24 its discretization scheme is given by v i p i x i g i 1 exp g i er t i h i p i x i then the discretization scheme 30 can be reduced to h i p i x i min fb p i x i h i p i x i fs p i x i h i p i x i e h i 1 p i 1 x i 1 31 where fb p i x i exp a p i x i e r t i fs p i x i exp a p i x i er t i 4 simulation studies 4 1 buy and sell regions we use the numerical algorithm proposed in section 3 to studies the buy and sell boundaries of the pairs trading strategy our study focuses on two aspects of the problem the first is the property of buy and sell boundaries or no transaction regions for a given set of model parameters and the other is the impact of different model parameters on the shape of buy and sell boundaries without loss of the generality we assume the time horizon t 1 and p 0 1 in all our simulation studies we first consider a baseline scenario the parameter values in the baseline scenario are 0 2 0 4 0 1 1 0 15 0 5 r 0 01 5 and p q p q 0 0005 for convenience we label the setting of the baseline parameter values as scenario 1 or s 1 we discretize the state space t p x y g and use the developed markov chain approximation to solve the discretized optimization problem figure 1 shows the buy and sell surfaces of s 1 at time t 0 05 0 35 0 65 and 0 95 to better read the figure we also show in figures 2 and 3 the buy and sell boundaries of s 1 at prices p 0 845 1 095 1 400 2 108 and x 0 023 0 092 0 157 0 266 respectively these points are chosen such that they correspond to the 24 48 72 and 96 quantiles of the 14 distribution of p t and asymptotic distribution of x t respectively we find the following from these figures first at a given time and a given price level the no transaction region becomes narrower when the spread gets larger and the no transaction region moves from the negative to the positive when the spread turns from the negative to the positive for example at t 0 05 and p t 0 845 the no transaction region changes from 9 4 8 0 at x t 0 023 to 4 6 3 4 at x t 0 092 0 7 0 2 at x t 0 157 and 3 2 3 7 at x t 0 266 second at a given time and a given spread level the no transaction region becomes narrower when the price p t gets larger and the no transaction region moves up when the price becomes larger for instance at t 0 05 and x t 0 023 the no transaction region changes from 9 4 8 0 at p t 0 845 to 6 8 5 6 at p t 1 095 4 9 3 9 at p t 1 400 and 2 7 2 0 at p t 2 108 note that the movement of the no transaction region with respect to price change but with a fixed spread level is relatively smaller than that with respect to spread change but with a fixed price level third when time ellapses from 0 to 1 the no transaction region moves upward for instance at the fixed price spread level p t x t 1 095 0 092 the no transaction intervals at t 0 05 0 35 0 65 and 0 95 are 2 6 1 6 2 1 1 2 1 5 0 7 and 0 8 0 2 respectively we then discuss the impact of different parameter values on the buy and sell boundaries or no transaction regions besides the parameter values in s 1 we now consider other 18 sets of parameter values labeled as scenarios 2 19 in each of scenarios 2 19 all parameters values are same as those in s 1 except one parameter is changed as the specification see table 1 that summarizes parameter values in all 19 scenarios for example scenario 2 uses parameter values 0 1 and assume all other parameters r and p q p q have same values as those in s 1 we discretize the state space t p x y g and use the developed markov chain approximation to solve the discretized optimization problem for scenarios 2 19 to compare the buy and sell boundaries or no transaction regions among different scenarios we plot the buy and sell boundaries over time at four fixed points p 1 x 1 0 9 0 09 p 2 x 2 0 9 0 12 p 3 x 3 1 5 0 09 and p 4 x 4 1 5 0 12 respectively figures 4 12 demonstrate variations of the buy and sell boundaries over time for different values of r p q p q respectively in each figure we plot the buy and sell boundaries for p i x i i 1 2 3 4 on the top left top right bottom left and bottom right respectively we also use the solid dashed dotted lines to represent 15 table 1 parameter values of different scenarios s 1 0 2 0 4 0 1 1 0 15 0 5 r 0 01 5 and p q p q 0 0005 s 2 0 1 s 8 0 8 s 14 r 0 005 s 3 0 3 s 9 1 2 s 15 r 0 03 s 4 0 2 s 10 0 1 s 16 3 s 5 0 6 s 11 0 2 s 17 8 s 6 0 05 s 12 0 2 s 18 p q p q 0 0001 s 7 0 3 s 13 0 6 s 19 p q p q 0 0010 the baseline value the smaller value the larger value of the parameter under comparison figure 4 suggests that when increases the buy and sell boundaries move downward at all four points figure 5 indicates that when increases the buy and sell boundaries move upward at p 1 x 1 and p 2 x 2 but move downward at p 3 x 3 and p 4 x 4 figure 6 shows that when increases the buy and sell boundaries move downward at all four points figure 7 indicates that when increases the buy and sell boundaries move downward and the magnitude of such movement is larger at p 1 x 1 than the other three points figure 8 shows that when increases the buy and sell boundaries move upward at p i x i i 1 2 3 but move downward at p 4 x 4 figure 9 suggests that when the correlation changes from the negative to the positive the buy and sell boundaries move downwards at p 1 x 1 and p 2 x 2 but move upward at p 3 x 3 and p 4 x 4 figure 10 indicates that variations of interest rate r have little impact on the buy and sell boundaries figure 11 shows that when the risk aversion parameter increases the buy and sell boundaries move upward at p i x i i 1 2 3 but move downward at p 4 x 4 figure 12 suggests that when the transaction cost increases the center of the no transaction region seems not change but the region gets wider 4 2 performance of the strategy we also perform simulation studies to investigate the performance of the optimal trading strategy for comparision purpose we also consider a benchmark strategy which is analogous 16 to the relative value arbitrage strategy used in gatev et al 2006 and based on standard deviation of the spread specifically the strategy opens a position when the spread exceeds twice of the standard deviation of the spread process and closes the position when either price converges or the maturity is reached as the benchmark strategy doesn t specify the number of shares of stocks that should be bought or sold we assume that the number of shares of stocks traded each time is one we simulate the price process pt and the spread process xt to compare the performance of the benchmark strategy and our strategy in scenarios s 1 s 19 assume that t 1 and we discretize the time interval 0 1 as 0 01 0 02 0 99 1 so that we have 100 trading periods for each scenario we simulate 1000 paths of pt xt t 0 0 01 0 99 1 p 0 1 and for each simulated path pt xt we implement the benchmark strategy and the optimal strategy at t 0 01 0 02 0 99 and close the position at t 1 let i b o represent the benchmark and the optimal strategies respectively for each realized trading strategies denote n i as the number of trades i e buy and sell among the 100 trading periods and pl i c i lp mp 0 1 the total profit made during the trading process note that the benchmark strategy trades only one share of stock each time while the number of shares of stocks in the optimal strategy are optimally chosen based on the buy and sell regions we define ps i as the the average profit or loss generated from the maximum number of shares of stocks during the trading process that is ps i c i lp mp 0 1 maxt y i t where y i t is the number of shares of stock p at t 0 01 0 02 0 99 table 2 summarizes the mean and standard error of n i pl i and ps i i o b for 1000 paths in each scenario we note that the total numbers of trades n o in the optimal strategy range from 45 736 to 55 821 for s 1 s 17 and increases or decreases significantly when the transaction costs decreases or increases in s 18 and s 19 in comparison to this the total numbers of trades n b in the benchmark strategy are much smaller essentially between 1 and 2 this suggests the benchmark strategy is much more conservative than the optimal strategy for the realized profit over the trading period pl o is much larger than pl b as the optimal strategy can choose to buy or sell the optimal number of shares of stock pairs while the benchmark strategy only buy or sell one share of stock pair ps o and ps b remove the impact of number of shares of traded stocks and provide the average earning per traded stock and we notice that ps o still significantly higher than ps b 17 table 2 performance of strategies n o pl o ps o n b pl b ps b s 1 52 289 247 0 349 019 0 048 004 1 094 084 0 005 002 0 005 002 s 2 53 218 241 0 389 020 0 051 004 1 094 084 0 006 002 0 006 002 s 3 51 348 253 0 318 019 0 046 004 1 094 084 0 004 002 0 004 002 s 4 52 999 208 0 378 019 0 054 003 1 094 084 0 007 002 0 007 002 s 5 51 896 275 0 326 019 0 040 005 1 094 084 0 003 004 0 003 004 s 6 49 299 235 0 357 020 0 032 003 1 094 084 0 003 002 0 003 002 s 7 54 233 262 0 344 019 0 064 005 1 094 084 0 008 003 0 008 003 s 8 55 821 304 0 359 021 0 062 006 1 094 084 0 005 003 0 005 003 s 9 45 736 254 0 266 016 0 046 003 1 094 084 0 005 002 0 005 002 s 10 46 347 292 0 228 016 0 042 005 1 052 083 0 004 002 0 004 002 s 11 57 689 212 0 489 022 0 053 003 1 206 084 0 007 002 0 007 002 s 12 46 774 248 0 325 015 0 065 003 1 140 086 0 008 001 0 008 001 s 13 53 516 245 0 361 020 0 045 004 1 140 087 0 006 002 0 006 002 s 14 54 027 232 0 579 032 0 048 004 1 094 084 0 005 002 0 005 002 s 15 50 031 266 0 219 012 0 049 004 1 094 084 0 005 002 0 005 002 s 16 52 300 247 0 347 019 0 048 004 1 094 084 0 005 002 0 005 002 s 17 52 261 247 0 357 019 0 050 004 1 094 084 0 006 002 0 006 002 s 18 73 801 286 0 339 019 0 045 004 1 094 084 0 006 002 0 006 002 s 19 42 996 222 0 339 019 0 049 004 1 094 084 0 004 002 0 004 002 5 real data studies we test our model with real market data in this section we present the sample and explain our methodology first and then show the results and discussion a key step of implementing pairs trading strategy is to select two stocks for pairs trading gatev et al 2006 illustrate how this can be done by using stock price data an alternative to this approach is to use fundamentals analysis to select two stocks that have almost the same risk factor exposures see vidyamurthy 2004 in this study we consider a hybrid of these two approaches specifically we restrict two stocks p and q to belong to the same industry sector table 3 lists six pairs of stocks selected from four different sectors for each pair of stocks p and q we compute the spread by regressing log price of stock q on the log price of stock p and the fitted values of the regression is considered as the transformed price of p figure 13 shows six pairs of the original prices of q and transformed prices of p 18 table 3 six pairs of stocks selected from different industries sector stock q stock p consumer goods apple inc aapl procter gamble co pg consumer goods coca cola co ko pepsico inc pep technology alphabet inc class a googl microsoft corporation msft technology at t inc t verizon communications inc vz industrial goods boeing corporation ba general electric company ge financial goldman sachs group inc gs jpmorgan chase co jpm over time we then apply the optimal strategy and the benchmark strategy in section 4 2 to test the out of the sample performance specifically we use the past three years of the historical data of each pair to estimate the model parameter and run unit root test to conclude if the spread xt is a stationary process if xt is not stationary we do not implement any strategies otherwise we implement both the optimal strategy and the benchmark strategy note that the optimal strategy can optimally choose the number of shares of stocks in each trade while we still trade one unit of stock in the benchmark strategy table 4 shows the number of trades n i the accumulated profit in u s dollars at maturity pl i and the average profit per traded share ps i over two testing periods for i o the optimal strategy and i b the benchmark strategy table 4 suggests that the benchmark strategy is much more conservative than the optimal strategy besides the average profits per traded share ps o of the optimal strategy are much larger than that of the benchmark strategy except for the stock pair ko pep 6 concluding remark the problem of optimal pairs trading has been studied by many academic researchers and financial practitioners existing models and methods try to find either the optimal shares of stocks by assuming no transaction costs or the optimal timing of trading fixed number of shares of stocks with transaction costs to find optimal pairs trading strategies which 19 table 4 performance of strategies pairs year n o pl o ps o n b pl b ps b aapl pg 2014 58 8 56 2 173 0 0 0 2015 70 25 439 3 91 0 0 0 ba ge 2014 97 27 866 1 292 0 0 0 2015 165 168 543 1 982 20 0 455 0 455 t vz 2014 127 77 908 2 158 2 0 603 0 603 2015 131 115 587 2 883 0 0 0 googl msft 2015 103 94 271 6 734 8 1 623 1 623 2016 135 65 957 6 296 0 0 0 gs jpm 2015 100 7 654 0 195 6 2 54 2 54 2016 200 94 542 2 375 8 1 66 1 66 ko pep 2015 142 37 51 0 675 22 10 154 10 154 2016 165 217 878 4 059 4 5 983 5 983 determine optimally both the trade time and the number of shares during the trading process we investigate an optimal pairs trading problem with proportional transaction costs using an approach that is based on maximization of the expected utility of terminal wealth we transform the problem into a singular stochastic control problem and argue that the value function of the problem is unique viscosity solution of a nonlinear quasi variational inequality we further show that the viscosity solution is equivalent to a free boundary problem for the singular stochastic control value function to solve the singular stochastic control problem associated with utility maximization and compute the value function and transaction regions we develop a dynamic programming based numerial algorithm to compute the solution in simulation studies we illustrate the numerical algorithm and investigate the impact of model parameters on the optimal trading strategies or the transaction regions we also demonstrate the out of sample performance of the optimal strategy via an empirical study which consists of six pairs of u s stocks from different industry sectors there are several directions in which our approach needs further investigation first our approach can be easily extended for nonexponential utility functions in such a case the optimization problem involves five instead of four variables the numerial algorithm 20 in our paper needs to be modified to adapt for five variables second our approach can be extended to solve the optimal cointegration trading which involves n stocks with m cointegration relationship third many empirical studies suggest that stock price processes can be better approximated by incorporating jumps using the framework and algorithms developed in xing et al 2017 the method developed here can be extended to the case that price processes follow geometric jump diffusion processes in such a case the value function of the corresponding variational inequalities involve integro differential equations which can be solved by extending our numerical algorithm acknowledgement the author s research is supported by national science foundation dms 1612501 references d ehrman the handbook of pairs trading strategies using equities options and futures john wiley and sons new jersey 2006 r elliott j van der hoek and w malcom pairs trading quantitative finance 5 271 276 2005 e gatev w n goetzmann and k g rouwenhorst pairs trading performance of a relative value arbitrage rule the review of financial studies 19 797 827 2006 t z lai and h xing statistical models and methods for financial markets springer new york 2008 y lei and j xu costly arbitrage through pairs trading journal of economic dynamics and control 56 1 19 2015 t leung and x li optimal mean reversion trading with transaction costs and stop loss exit international journal of theoretical and applied finance 18 1550020 2015 s mudchanatongsuk j primbs and w wong optimal pairs trading a stochastic ap proach american control conference ieee 2008 21 m ngo and h pham optimal switching for the pairs trading rule a viscosity solutions approach journal of mathematical analysis and applications 441 403 425 2016 q song and r yan an optimal pairs trading automatica 49 3007 3014 2013 a tourin and r yan dynamic pairs trading using the stochastic control approach journal of economic dynamics and control 37 1972 1981 2013 g vidyamurthy pairs trading quantitative methods and analysis john wiley and sons new york 2004 m whistler trading pairs capturing profits and hedging risk with statistical arbitrage strategies john wiley and sons new york 2004 h xing y yu and t w lim european option pricing under geometric levy processes with proportional transaction costs journal of computational finance 21 101 127 2017 h zhang and q zhang trading a mean reverting asset buy low and sell high automatica 44 1511 1518 2008 appendix proof of theorems proof of theorem 1 in our case the state x is s x where x p x y g let x 0 s 0 p 0 x 0 y 0 g 0 it follows that there exists an optimal trading strategy dictated by the pair of processes l p t m p t where x 0 t t p 0 t x 0 t y 0 t g 0 t is the optimal trajectory with x 0 s 0 x 0 i first we prove that v is a viscosity subsolution of 21 on 0 t r r r r for this we must show that for all smooth functions x such athat v x x has a local maximum at x 0 the following inequaility holds min b x 0 s x 0 l x 0 0 32 without loss of generality we assume that v x 0 x 0 and v on 0 t r r r r we argue by contradiction if the arguments inside the operator of 32 satisfy b x 0 0 and s x 0 0 then there exists 0 such that l x 0 from 22 the fact that is smooth the above inequalities become b x 0 s x 0 and l x where x t p x y g b x 0 a neighborhood of x 0 in lemma 1 it is shown that x 0 t has no jumps p a s at x 0 x 0 s 0 hence defined by inf t s 0 t x 0 t b x 0 is positive p a s and therefore the integral along x 0 t s 0 dt e s 0 b x 0 t dl t e s 0 s x 0 t dm t e s 0 l x 0 t dt e i 1 e i 2 e i 3 33 where l t m t is the optimal trading strategy at x 0 applying ito s formula to x where the state dynamics are given by 1 6 we get e x 0 x 0 e i 1 e i 2 e i 3 34 since v x x for all x b x 0 and v x 0 x 0 33 and 34 yield e v x 0 v x 0 e i 1 e i 2 e i 3 v x 0 s 0 dt which violates the dynamic programming principle together with the optimality of l t m t therefore at least one of the arguments inside the minimum operator of 32 is nonpositive and hence the value function is a viscosity subsolution of 21 ii in the second part of the proof we show that v is a viscosity supersolution of 21 for this we must show that for all smooth functions x such that v x x has a local minimum at x 0 the following inequaility holds min b x 0 s x 0 l x 0 0 35 where without loss of generality v x 0 x 0 and v x x on 0 t r r r r in this case we prove that each argument of the minimum operator of 35 is nonnegative consider the trading strategy l t l 0 0 s 0 t t and m t 0 s 0 t t by the dynamic pogramming principle v s 0 p 0 x 0 y 0 g 0 v s 0 p 0 x 0 y 0 l 0 g ap bqex 0 p 0 l 0 23 this inequality holds for s p x y g as well and by taking the left hand side to the right hand side dividing by l 0 and sending l 0 0 we get b x 0 0 similary by using the trading strategy l t 0 s 0 t t and m t m 0 0 s 0 t t the second argument inside the minimum operator is found to be nonnegative finally consider the case where no trading is applied by the dynamic programming principle e v xd 0 t v s 0 p 0 x 0 y 0 g 0 36 where xd 0 t is the state trajectory of starting at s 0 when m t l t 0 s 0 t t given by 1 6 as xd 0 t t p t x t y 0 g t and xd 0 t b x 0 therefore by applying ito s rule on s x b y g inequality 36 yields e t s 0 l xd 0 d 0 and by letting t s 0 the third argument inside the minimumm operator is found to be nonnegative this complete the proof lemma 1 assume that b x 0 0 and denote the event that the optimal trajectory x 0 t has a jump of size along the direction 0 0 0 1 ap bqex 0 p 0 by a assume that the state after the jump is s 0 p 0 x 0 y 0 ap bqex 0 b 0 b x 0 then b x 0 p a 0 37 therefore p a 0 similarly if s x 0 0 then the optimal trajectory has no jumps along the direction 0 0 0 1 bp aqex 0 p 0 p a s at x 0 proof by the principle of dynamic programming v s 0 p 0 x 0 y 0 g 0 e v s 0 p 0 x 0 y 0 ap bqex 0 b 0 a v s 0 p 0 x 0 y 0 ap bqex 0 b 0 dp a v s 0 p 0 x 0 y 0 g 0 dp and therefore a s 0 p 0 x 0 y 0 ap bqex 0 b 0 s 0 p 0 x 0 y 0 g 0 dp 0 24 since v x x for all x b x 0 and v x 0 x 0 therefore lim sup 0 a s 0 p 0 x 0 y 0 ap bqex 0 p 0 s 0 p 0 x 0 y 0 g 0 dp 0 and by fatou s lemma a lim sup 0 s 0 p 0 x 0 y 0 ap bqex 0 b 0 s 0 p 0 x 0 y 0 g 0 dp 0 which implies 37 proof of theorem 3 let v t p x y g v p x y g if t y z p x y g if t t and v x lim y x inf 0 v y and v x lim y x sup 0 v y 38 where x t p x y g we will show that v x and v x are a viscosity supersolution and a viscosity subsolution of 21 respectively combining this with the uniquesness of the viscosity solution of 21 yields v x v x on 0 t r r r r the opposite inequality is true by the definition of v x and v x and therefore v x v x v x which together with 38 also implies the local uniform convergence of v to v note that we only prove that v is a viscosity supersolution of 21 as the arguments for v is identical let x 0 be a local minimum of v on 0 t r r r r for c 1 2 0 t r r r r without loss of generality we may assume that x 0 is a strict local minimum that v x 0 x 0 and that 2 sup v outside the vall b x 0 r r 0 where v x x 0 then there exist sequences n r and yn 0 t r r r r such that n 0 yn x 0 v n yn v x 0 yn if a global minimum point of v nj 25 let hn v n then hn 0 and v nj x x hn x for any x 0 t r r r r 39 to show that v is a viscosity supersolution of 21 it suffices to show that min b x 0 s x 0 l x 0 0 40 let yn si pn xn yn gn where si i i n and y n n n n denote y 0 n n pn xn yn gn y 1 n n pn xn n n gn ap bqexn pn n y 2 n n pn xn n n gn bp aqexn pn n then v n y 0 n max v n y 1 n v n y 2 n e v n y 0 n 1 now we look at the following three cases case 1 it holds that v n y 0 n v n y 1 n then 39 implies that v n y 0 n y 1 n v n y 0 n y 0 n and therefore 0 lim inf n y 1 n y 0 n n lim inf 0 y 1 0 y 0 0 x 0 y ap ex 0 t p 0 t x 0 g case 2 it holds that v n y 0 n v n y 2 n arguing similarly to case 1 we get 0 x 0 y bp aqex 0 t p 0 t x 0 g case 3 it holds that v n y 0 n e v n y 0 n 1 then 39 implies that v n y 0 n e y 0 n 1 v n y 0 n y 0 n 1 and therefore 0 lim inf n y 0 n 1 y 0 n n lim inf 0 y 0 1 y 0 0 l x 0 combining the results in cases 1 3 yields 40 and the proof is complete 26 figure 1 buy and sell boundaries of the baseline scenario s 1 at different times 27 figure 2 buy and sell boundaries of at prices pt 0 845 top left 1 095 top right 1 400 bottom left and 2 108 bottom right and different times 28 figure 3 buy and sell boundaries of at spread xt 0 023 top left 0 092 top right 0 157 bottom left and 0 266 bottom right and different times 29 figure 4 buy and sell boundaries of at fixed prices p i x i i 1 2 3 4 for 0 1 dashed 0 2 solid 0 3 dotted 30 figure 5 buy and sell boundaries of at fixed price p i x i i 1 2 3 4 for 0 2 dashed 0 4 solid 0 6 dotted 31 figure 6 buy and sell boundaries of at fixed price p i x i i 1 2 3 4 for 0 05 dashed 0 1 solid 0 3 dotted 32 figure 7 buy and sell boundaries of at fixed price p i x i i 1 2 3 4 for 0 8 dashed 1 solid and 1 2 dotted 33 figure 8 buy and sell boundaries of at fixed price p i x i i 1 2 3 4 for 0 1 dashed 0 15 solid and 0 2 dotted 34 figure 9 buy and sell boundaries of at fixed price p i x i i 1 2 3 4 for 0 2 dashed 0 5 solid and 0 6 dotted 35 figure 10 buy and sell boundaries of at fixed price p i x i i 1 2 3 4 for r 0 005 dashed 0 01 solid and 0 03 dotted 36 figure 11 buy and sell boundaries of at fixed price p i x i i 1 2 3 4 for 3 dashed 5 solid and 8 dotted 37 figure 12 buy and sell boundaries of at fixed price p i x i i 1 2 3 4 for p q p q 0 0001 dashed 0 0005 solid and 0 0010 dotted 38 figure 13 orignal solid and transformed dashed prices of six pairs of stocks 39 1 introduction 2 a pairs trading problem with proportional transaction costs 2 1 model specification 2 2 the hamilton jacobi bellman equations and free boundary problems 2 3 optimal trading with exponential utility functions 3 discretization and a numerical algorithm 4 simulation studies 4 1 buy and sell regions 4 2 performance of the strategy 5 real data studies 6 concluding remark