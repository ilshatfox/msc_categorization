backward and forward wasserstein projections in stochastic order young heon kim and yuan long ruan abstract we study metric projections onto cones in the wasserstein space of probability measures defined by stochastic orders dualities for backward and forward projections are established under general conditions dual opti mal solutions and their characterizations require study on a case by case basis particular attention is given to convex order and subharmonic order while backward and forward cones possess distinct geometric properties strong con nections between backward and forward projections can be obtained in the convex order case compared with convex order the study of subharmonic or der is subtler in all cases brenier strassen type polar factorization theorems are proved thus providing a full picture of the decomposition of optimal cou plings between probability measures given by deterministic contractions resp expansions and stochastic couplings our results extend to the forward con vex order case the decomposition obtained by gozlan and juillet which builds a connection with caffarelli s contraction theorem a further noteworthy ad dition to the early results is the decomposition in the subharmonic order case where the optimal mappings are characterized by volume distortion proper ties to our knowledge this is the first time in this occasion such results are available in the literature contents 1 introduction 2 2 linear stochastic order 7 3 duality the compact case 9 4 duality the general case 14 5 convex order projections 24 6 dual attainment for convex order projections 27 7 characterization of convex order projections 30 8 backward projection versus forward projection 33 9 subharmonic order projections 37 10 dual attainment for subharmonic order projections 38 11 characterization of subharmonic order projections 43 appendix a c transforms 46 appendix b convergence of subharmonic functions 47 date october 12 2021 2020 mathematics subject classification primary 49 60 secondary 52 key words and phrases optimal transport wasserstein projection stochastic order contrac tion expansion yhk is partially supported by the natural sciences and engineering research council of canada nserc as well as exploration grant from the new frontiers in research fund nfrf ylr is partially supported by the national natural science foundation of china nsfc 2021 by the author 1 ar x iv 2 11 0 04 82 2 v 1 m at h p r 1 0 o ct 2 02 1 2 young heon kim and yuan long ruan references 49 1 introduction stochastic ordering of distributions is ubiquitous in probability and statistics depending on its context of application the order of distributions are determined according to their behavior under a given groupa of test functions two probability measures are called increasing in a stochastic order defined by a if they satisfy d 6 d for all a convex order and subharmonic order are two frequently used stochastic orders which corresponds respectively to a being the set of convex functions and subhar monic functions the larger the test set a is the stronger the stochastic order becomes so subharmonic order is more restrictive than convex order there are also many other widely used stochastic orders e g in one dimension an increasing concave order is defined by increasing concave functions 28 stochastic ordering of high dimensional distributions can also be defined according to the orderings of their one dimensional projections 16 stochastic ordering of multiple distributions is defined similarly 17 we refer to 35 for a full account of various stochastic orders and their applications in operations research and economics etc stochastic order is a functional way to characterize the properties of couplings between a pair of probability measures strassen theorem shows that convex order relationship is equivalent to the existence of a martingale coupling 36 this is generalized to subharmonic order which is proved to be necessary and sufficient for the existence of a brownian martingale 20 generalizations to other stochastic orders are also considered 10 strassen theorem is the starting point of many recent studies on optimal martingale transport and its applications in mathematical finance 8 19 skorokhod embedding and related topics 7 21 22 despite its wide applications stochastic ordering is usually hard to implement in practice for one thing sampling probability measures via naive simulation is costly for another discretizing probabilities in a given stochastic order is tricky since stochastic order relation is usually unstable i e discretized measures could easily violate the original stochastic order this has been observed on the level of convex order a large amount of research has been devoted to the stability issues of optimal martingale transport under some conditions in one dimension it is stable 6 26 29 but not in high dimensions 12 these issues have become a great hindrance to the numerical pursuits of stochastic orders as a general tool of sampling probability measures in stochastic order we propose to study wasserstein projections onto the cones defined by a given stochastic order one such projection for convex order was employed by gozlan and juillet 24 to obtain a martingale version of brenier s polar factorization 11 note that brenier s motivation for the investigation of polar factorization was to address the instability issues in the numerical study of perfect incompressible fluids we intend to report numerical benefits offered by wasserstein projections in a separate article in the current article we instead build the necessary mathematical framework required of downstream applications and demonstrate its uses in exploring the properties of optimal mappings between probability measures wasserstein projection 3 for any probability measures and cost function c we define the wasserstein transport cost as tc inf x y c x y d x y we also write tk tc if c x y x y k k 1 and denote wk tk 1 k given a pair of probability measures and a stochastic order determined by a function class a we study projections onto backward cone with vertex and forward cone with vertex specifically the backward cone pa 6 is the set of probability measures less than w r t the stochastic order defined by a the forward cone pa 6 is the set of probability measures greater than w r t the stochastic order defined by a the projection problems we have in mind is defined w r t the wasserstein transport cost tc for a given cost function c x y 1 1 backward projection inf pa 6 tc 1 2 forward projection inf pa 6 tc the word backward emphasizes the fact that the projection we look for locates in the direction backward in time axis relative to the vertex of the cone similarly the word forward emphasizes the fact that the projection we look for locates in the direction forward in time axis relative to the vertex of the cone these are illustrated in figure 1 backward cone pa 6 forward cone pa 6 forward projection backward projection figure 1 illustration of backward and forward projections onto cones defined by stochastic order a dotted line indicates the direction of increasing stochastic order we first present the dual theorems for backward and forward projections 4 young heon kim and yuan long ruan theorem 1 let x y be locally compact polish spaces given p x p y a cost function c x y and a defining function class a associated with a stochastic order the following dualities hold under appropriate conditions 1 backward duality theorem 4 3 1 3 inf pa 6 tc sup u x ud y d where u x y 6 c x y with u continuous and a 2 forward duality theorem 4 4 1 4 inf pa 6 tc sup v x d y vd where x v y 6 c x y with a and v continuous the duality theorems for wasserstein projections given by theorem 1 include as a special case the classical kantorovich duality this happens when the stochastic order becomes degenerate see remark 4 9 another special case is the duality for backward convex order projection this is previously proved by first establishing the equivalence between backward convex order projection and the weak optimal trans port introduced in 25 and then using the duality theorem for the weak optimal transport in one dimension the equivalence is proved in 24 then generalized to higher dimensions 34 under the condition that has a density w r t the lebesgue measure the general case is proved in 23 and 1 the duality for weak optimal transport is proved in 25 and 4 via different approaches in the compact case it is also proved in 2 without using measurable selection theorems it is worth noting that in proving the backward duality 1 3 in theorem 1 we do not rely on weak optimal transport or other indirect reformulation via the method described in the last paragraph the approach taken here is direct and general enough to handle all linear stochastic orders definition 2 1 at the same time the way we handle stochastic orders is more in line with the perspective of strassen theorem and has not been studied in the current context in appearance the backward duality 1 3 and the forward duality 1 4 look so famililar that people might unconsciously fall under the illussion that backward and forward projections are conjugate or even equivalent to each other but actu ally their relationship depends critically on the defining class a except in some special situations there is no immediate connection between backward and forward projection for general stochastic orders this will be explained in detail in section 8 in fact in the most promising case i e the convex order case the difference is already promient in numerical computation 1 and it is observed that compared with the forward convex order projection the backward convex order projection is easier to manage due to its natural connection with the weak optimal transport such a connection is not available for forward convex order projection the defining class a determines the admissible functions of the dual thus gives properties of the projections specific to a we now focus on the convex order and the subharmonic order where we obtain interesting geometric properties of the optimal mappings such as contraction and expansion we summarize the main results about convex order projections as below notations are defined later wasserstein projection 5 theorem 2 let p 2 rd c x y x y 2 denote by t 2 pcx 6 d 2 pcx 6 the optimal primal dual values of the backward convex order projec tion and respectively t 2 pcx 6 d 2 pcx 6 of the forward convex order projec tion then under appropriate conditions we have the following 1 the duality for backward convex order projection t 2 pcx 6 d 2 pcx 6 and the duality for forward convex order projection t 2 pcx 6 d 2 pcx 6 2 the optimal dual value for backward convex order projection is attained the orem 6 1 and the optimal mapping from to the unique projection is charac terized by convex contraction definition 7 1 and theorem 7 4 3 the optimal dual value for forward convex order projection is attained theorem 6 2 and the optimal mapping from to the unique projection is characterized by convex expansion definition 7 2 and theorem 7 6 4 the optimal mappings for backward and forward convex order projections are inverse to each other theorem 8 3 and corollary 8 5 item 1 is an instance of theorem 1 enriched with desirable traits for convex order projections see theorem 5 3 dual attainment in item 2 and 3 are key results item 2 is originally given by gozlan and juillet 23 this gives the backward decomposition given two probability measures there is a transport plan between them given by the gradient map of a convex contraction followed by a martingale coupling this establishes a link with the celebrated caffarelli s contraction theorem 15 see also 30 and 18 if is a log concave perturbation of the gaussian measure then the optimal transport map from to is given by the gradient of a convex function which is a contraction in the language of item 2 the optimal map is a contraction when the projection to the backward cone is equal to item 3 is novel and it reinforces the link with caffarelli s contraction theorem by showing a forward decomposition given two probability measures there is a transport plan between them given by a martingale coupling followed by an expansion map which is the gradient of a convex function item 3 is a natural companion to item 2 however it is not a straightforward result since the backward and forward convex order cone have distinct geometric properties for example one is geodesically convex in the wasserstein space p 2 rd while the other is not see section 8 the properties of backward and forward mapping and their relation in item 4 are remarkable however it seems to be unique to the convex order case in one dimension these properties are obtained by 1 5 via methods specific to one dimension theorem 2 immediately prompts one to ask whether similar results hold for other stochastic orders whether the projections can be characterized in some spe cial way in particular giving a link to caffarelli s contraction type results we are able to obtain a result similar to theorem 2 for subharmonic order notice that subharmonic order is stronger than the convex order therefore the corresponding cones become much smaller for example in rd d 2 there is no subharmonic order between discrete measures this makes us expect weaker properties for the projection mappings than in the convex order case these weaker properties are 6 young heon kim and yuan long ruan also natural in view of theorem 1 since the class a consists of subharmonic func tions that are less special than convex functions indeed in the following theorem the characterizations of the projection mappings are given by what we call lapla cian contraction and expansion which resembles a linearized version of the convex contraction and expansion theorem 3 given supported in a bounded smooth domain c x y x y 2 denote by t 2 psh 6 d 2 psh 6 the optimal primal dual values of the back ward subharmonic order projection and respectively t 2 psh 6 d 2 psh 6 of the forward subharmonic order projection then under appropriate conditions we have the following 1 the duality for backward sbharmonic order projection t 2 psh 6 d 2 psh 6 and the forward sbharmonic order projection t 2 psh 6 d 2 psh 6 2 the optimal dual value for backward subharmonic order projection is attained theorem 10 1 and the optimal mapping from to the unique projection is characterized by laplacian contraction definition 11 1 and theorem 11 5 3 the optimal dual value for forward subharmonic order projection is attained theorem 10 5 and the optimal mapping from to the unique projection is characterized by laplacian expansion definition 11 2 and theorem 11 7 moreover the forward projection mapping say 0 is a volume increasing map in particular if is absolutely continuous then the forward projection 0 is also absolutely continuous and their densities with the same notation satisfy 0 x 6 x a e x this theorem seems to be the first occasion in the literature where a connection is made between contraction type properties of optimal mappings and the subhar monic order thus with brownian martingales the volume increasing property of the forward projection mapping in item 3 of theorem 3 is remarkable and it gives a weaker counterpart to the convex order case it seems a similar property is not available for the backward subharmonic order projection item 2 and 3 show that optimal couplings between two probability measures are composed by laplacian contraction or expansion and a brownian martingale transport they also raise a natural question when would the projection of onto psh 6 be equal to and respectively the projection of onto psh 6 be equal to answering these questions may give caffarelli s contraction type results for a large class of measures beyond the known cases the dual attainment is usually nontrivial there is no one size fits all approach to it the situation for subharmonic order is subtler than convex order convex functions enjoy many vital properties under c transforms but almost all these properties break in the case of subharmonic order this has led to a series of diffi culties both in the proof of attainment and characterization of optimal mappings moreover the crucial double convexification trick is unfortunately unavailable for subharmonic order projections we will discuss more in section 10 acknowledgement we would like to express our sincere thanks to alphabeti cally ordered luigi ambrosio zhen qing chen alessio figalli mathav murugan wasserstein projection 7 and edwin a perkins for the insightful discussions while the paper was in prepa ration notation x polish space with slight abuse of notation metric on this space is written as x i e the distance from a reference point which we do not explictly specify if x a separable banach space then x is the norm on x when no confusion arises we write for simplicity m x m x nonnegative finite radon measures on x mk x mk x nonnegative measures with finite k th moment m 0 x m x m 0 x m x p x p ac x probability measures on x which are absolutely continuous w r t the reference measure of x pk x p ac k x probability measures in p x p ac x with finite k th moment p 0 x p x p ac 0 x p ac x the set of probability couplings with marginals and a the defining class of a stochastic order acx stands for the defining class of convex order and ash for subharmonic order 6 a is smaller than in the stochastic order defined by a pak 6 the backward cone pak 6 pk y 6 a the subscripts k are omitted and written pa 6 if the underlying space is bounded pak 6 the forward cone pak 6 pk x 6 a the subscripts k are omitted and written pa 6 if the underlying space is bounded c 0 x the set of smooth functions with compact support in x c 0 x continuous functions which go to zero at infinity cb x bounded continuous functions sb x bounded measurable functions cb k x k 0 continuous functions with growth no more than x k c 0 k x k 0 continuous functions with asymptotic order o x k sb k x k 0 measurable functions with growth no more than x k g the legendre fenchel dual of a function g ge the subharmonic envelope of a function g 2 linear stochastic order the stochastic orders we are interested in are those which are characterized by a class of admissible functions we call them linear stochastic orders the term linear is used to emphasize the sort of problems our method can be applied to definition 2 1 let a be a nonempty class of measurable functions which form a convex cone 1 if f a then af a a 0 2 if f g a then af 1 a g a 0 6 a 6 1 8 young heon kim and yuan long ruan a measure m x is smaller than m x in the linear stochastic order defined by a denoted by 6 a if have equal mass and 2 1 fd 6 fd for all f a such that both integrals exist in the extended sense the class a is called the defining class of the associated stochastic order note by definition 0 a hereafter with slight abuse of notation we will use a defining class a to mean both the function class itself and the stochastic order associated with it we simply call a a linear stochastic order here are a few examples of linear stochastic orders example 2 2 on the real line the usual stochastic order is defined by the set of all increasing functions increasing convex order corresponds to the set of all increasing convex functions these can also be generalized to consider the so called m convex order with m 1 being an integer defined by the set of functions whose m th derivative is nonnegative example 2 3 in arbitrary dimension two commonly encountered stochastic or ders are convex order and subharmonic order which are respectively defined by the set of all lower semicontinuous convex functions and the set of all subharmonic functions the two notions coincide in one dimension example 2 4 when the defining class a is the set of all bounded continuous functions the associated stochastic order becomes degenerate in this special case we call it a trivial order measures in trivial order are identical in these examples the set of admissible functions for which 2 1 is equality con tains nontrivial elements for m convex order 2 1 is equality for all polynomials with degree no greater than m 1 for convex order 2 1 is equality for all for linear functions for subhamronic order 2 1 becomes equality for all for harmonic functions these could be useful for performing normalizations on the admissible class the following representation of linear stochastic order is straightforward lemma 2 5 let a be a defining function class as defined in definition 2 1 as sume that 1 1 a let m x then 2 2 sup f a x fd x fd 0 6 a otherwise remark 2 6 the assumption 1 1 a ensures that 2 3 and are of equal mass in some situations the constraint 2 3 can be implied from other accompanying constraints if this is the case then we a priori know that the measures have identical mass thus the assumption 1 1 a in lemma 2 5 can be omitted 2 1 backward and forward projection we investigate two types of wasser stein projections associated with a given linear stochastic order a backward projection given p x p y define the backward convex cone 2 4 pa 6 p y 6 a wasserstein projection 9 consisting of measures in p y which are smaller than in the linear stochastic order a the backward projection of onto the cone pa 6 is defined as any pa 6 which attains tc pa 6 inf pa 6 tc i e the transportation cost between and pa 6 forward projection the forward convex cone denoted by 2 5 pa 6 p x 6 a is the set of measures in p x which are greater than in the linear stochastic order a the forward projection of onto pa 6 is any p a 6 which attains tc pa 6 inf pa 6 tc i e the transportation cost between pa 6 and 2 2 compact vs non compact case when we mention the projection prob lems we use the term compact case to mean the underlying spaces x and y are compact not just that the measures have compact supports correspondingly the term non compact case or general case means x and y are not necessarily compact it is important to note that the set pa 6 given by 2 5 is a subset of p x all measures in pa 6 live in x therefore forward projection where x is a proper subset of the underlying space and forward projection where x equal the underlying space are different take rd if x is only a proper subset of rd then tc pa 6 optimizes over all admissible measures sitting in x measures not in x are not admissible to the optimization if x equals rd then tc pa 6 optimizes over all admissible measures without restrictions on where they locate so it is preferable to be aware of this distinction when dealing with forward projection this distinction for backward projection does not exist however see e g lemma 8 1 3 duality the compact case the rigorous proof of the duality in the general case where the underlying space is not necessarily compact is delicate and requires additional preparations com pared with the general case the compact case is less restrictive in the assumptions and requires minimal preparations in the proof so we first deal with the compact case in this section the general case will be the topic of the next section starting with the compact case also helps the reader grasp the main idea more easily 3 1 backward projection the following simple lemma is very useful lemma 3 1 let x y be polish spaces and p x then for any m y m x y sup u v ud vd u x v y d x y 0 p y otherwise where the supremum runs over u v cb x cb y 10 young heon kim and yuan long ruan we define the class of bounded measurable functions on x sb x u bounded measurable theorem 3 2 let x y be compact polish spaces p x p y c x y 7 0 be lower semicontinuous and a be a defining function class as defined in definition 2 1 assume that a and a cb define the same stochastic order i the backward duality holds tc pa 6 sup u v c cb x ud y d where v c is the set of measurable functions u such that 3 1 a and u x y 6 c x y x y ii the alternative form of backward duality holds tc pa 6 sup a cb x qc d y d where 3 2 qc x inf y y y c x y in both forms i and ii a cb can be relaxed to a sb remark 3 3 here we loosely write v c cb to mean couples u v c with all functions in the slots belonging to cb the same writing applies similarly through out the article unless it is necessary to use full notation proof the proof proceeds through several steps in step 1 and step 2 we show that 3 3 tc pa 6 sup u v vc l 1 sb sb x ud y d where vc is the collection of triples u v of measurable functions such that 3 4 u x v y 6 c x y x y and 3 5 a and v y 6 y y the duality remains true if 3 4 is replaced with 3 6 u x v y 6 c x y a e x y upon obtaining this duality we then conclude the proof of the theorem in step 3 1 to prove 3 3 we first show that sup vc cb x ud y d 6 sup vc l 1 sb sb x ud y d 6 tc pa 6 only the second inequality needs explanation for pa 6 u v vc l 1 sb sb we have p y and v are bounded hence vd d wasserstein projection 11 exist and are finite then we can write x ud y d x ud y vd y vd y d 6 x ud y vd y d y d 6 x ud y vd 6 x y c x y d the first inequality uses 3 5 the second inequality uses the fact a sb and the stochastis order relationship the third inequality uses 3 4 now tak ing infimum over pa 6 and supremum over u v vc l 1 sb sb we obtain sup vc l 1 sb sb x ud y d 6 tc pa 6 clearly we get the same result if 3 4 is replaced with 3 6 since 3 6 implies u x v y 6 c x y a e x y for any pa 6 2 next we prove the duality 3 7 tc pa 6 sup u v vc cb x ud y d for this we introduce the functionals g p cb x y 7 0 p x y c x y otherwise h q cb y 7 0 q y 0 otherwise i p q cb x y cb y 7 y d x ud p x y v y u x for some u v cb q y y v y for some a cb otherwise note i is convex in view of the definition of a i is well defined indeed suppose p x y v 1 y u 1 x v 2 y u 2 x x y q y 1 y v 1 y 2 y v 2 y x y then for some constant a r u 1 u 2 a v 1 v 2 a 1 2 a hence y 1 y d y x u 1 x d x y 2 y d y x u 2 x d x 12 young heon kim and yuan long ruan showing that the definition of i does not depend on the way p x y and q x are split straightforward calculations yield the legendre transforms of the above functionals g sup p cb x y p c x y p x y d x y x y c x y d x y m x y otherwise h sup q cb y q 0 y q y d y 0 m y otherwise i sup u v cb a cb x y v y u x d x y x u x d x y y d y y y d y y v y d y sup u v cb a cb x y v y u x d x y x u x d x y v y d y y y d y y y d y 0 pa 6 otherwise in the calculation of g the assumption on the cost function c is used the last equality in i uses lemma 3 1 lemma 2 5 and the assumption that a and a cb define the same stochastic order let p q g p h q p q i p q since 0 a cb we can set y 0 v y 1 u x 2 and define p 0 v y u x 1 q 0 y v y 1 then p 0 q 0 is in the effective domain of and p 0 q 0 0 p 0 q 0 2 moreover is obviously continuous at p 0 q 0 we are then in a position to invoke fenchel rockafellar theorem 38 theorem 1 9 inf p q p q p q sup plugging in early calculations we obtain 3 7 which together with step 1 proves the duality 3 3 3 finally we show that the duality 3 3 leads to the dualities of the theorem it is easy to see that for any triple u v vc cb u is an admissible pair in v c cb on the other hand for any u v c cb the triple u is in vc cb hence 3 8 sup u v vc cb x ud y d sup u v c cb x ud y d wasserstein projection 13 the lhs of 3 8 equals tc pa 6 by step 2 hence the duality in i follows to see the alternative duality form in ii we first note that sup u v vc cb x ud y d 6 sup a cb x qc d y d on the other hand following the idea of step 1 we have that sup a cb x qc d y d 6 tc pa 6 therefore in view of step 2 the proof of ii is completed 3 2 forward projection now we derive the duality formula for forward projec tion theorem 3 4 let x y be compact p x p y c x y 7 0 be lower semicontinuous and a be a defining function class as defined in definition 2 1 assume that a and a cb define the same stochastic order i the foward duality holds tc pa 6 sup v u c cb x d y vd where u c is the set of measurable functions v such that 3 9 a and x v y 6 c x y x y ii the alternative form of forward duality holds tc pa 6 sup a cb x d y qc d where 3 10 qc y sup x x x c x y in both forms i and ii a cb can be relaxed to a sb proof the proof is similar to the backward case theorem 3 2 we only indicate the difference as before the proof of the theorem boils down to the intermediate duality tc pa 6 sup u v vc sb sb l 1 x d y vd where uc is the collection of triples u v of measurable functions such that 3 11 u x v y 6 c x y x y and 3 12 a and x 6 u x x the duality remains true if 3 11 is replaced with u x v y 6 c x y x a e y this is proved in 2 steps 1 similar to step 1 in the proof of theorem 3 2 we have sup uc cb d vd 6 sup uc sb l 1 l 1 d vd 6 tc pa 6 14 young heon kim and yuan long ruan 2 next we have tc pa 6 sup u v uc cb x d y vd this is proved by following the same lines as in step 2 of theorem 3 2 except that the functional i is now defined as i p q cb x y cb x 7 y vd x d p x y v y u x for some u v cb q x u x x for some a cb otherwise 4 duality the general case in the previous section we have proved the duality formulas for backward and forward projection in the case the underlying spaces x y resp x y are compact at first sight one might think that the proof there can be carried out easily to the general case e g rd the typical cutting and gluing technique would be the first to appear in our mind a careful thinking however reveals the difficulty in such an approach the reason lies in the special structure of measures in stochastic order which makes it hard to localize another obstacle comes from the function spaces if we use c 0 instead of cb in this case the function i in theorem 3 2 and theorem 3 4 would be useless since the decomposition of p x y as the sum of functions of individial variables is possible only in a trivial way the admissible set a adds a further layer of difficulty it renders both the spaces c 0 and cb useless in the general case since those spaces are not large enough to accommodate nontrivial test functions in a consider for instance the convex order defined by the set of all convex functions there are no non constant convex functions in cb rd we introduce appropriate function spaces to address these issues 4 1 the space cb k and its dual cb k let x be a locally compact polish space let k 0 be an integer we introduce the function space cb k x defined by cb k x u c x u 1 x k cb x with the norm u b k sup x x u x 1 x k then c 0 k x u c x u 1 x k c 0 x is a closed subspace of cb k x its topological dual space is identified with the space of finite borel measures with k th moment i e c 0 k x mk m x 1 x k m x we denote by mk the set of nonnegative measures in mk wasserstein projection 15 we also introduce sb k x u measurable u 1 x k sb x clearly when k 0 cb 0 x resp c 0 0 x sb 0 x reduces to the usual space cb x resp c 0 x sb x in addition if x is bounded then c 0 k x c 0 x cb k x cb x sb k x sb x for k 0 the following crucial lemmas provide decomposition and representation of con tinuous linear functionals on cb k lemma 4 1 let k 0 be an integer and x y be locally compact compact polish spaces let l be a nonnegative continuous functional on cb k x y then l r where mk x y and r a nonnegative continuous linear functional sup ported at infinity i e 4 1 r u 0 u c 0 k x y proof the proof is similar to 38 lemma 1 24 lemma 4 2 let x y be locally compact compact polish spaces and k 0 let m x pk y be borel probabilities if l cb k x y is nonnegative such that for all u cb k x v cb k y 4 2 l u v x u x d y v y d then pk x l pk x y and l note the assumption is that is a nonnegative measure it is part of the con clusion that is a probability of k th moment proof 1 when k 0 or both x and y are bounded thus cb k reduces to cb this is 38 lemma 1 25 2 now consider k 1 and either x or y is unbounded say x is unbounded to simplify notation we assume w l g that the origin 0 is in x and y so that we can use 0 as the reference point for the metrics on x and y in vew of lemma 4 1 we can write l r where mk x y and r a nonnegative continuous linear functional sup ported at infinity in the sense of 4 1 to complete the proof it suffices to show that r 0 let an be an increasing compact sets of x such that an int an 1 and nan x by urysohn s lemma there are continuous functions an x c 0 x satisfying 0 6 an x 6 1 an x is 1 on an 0 on a c n 1 clearly an x is an increasing sequence of functions and an x 1 since k 1 and one of the underlying spaces is unbounded cb x c 0 k x y therefore r vanishes on cb x by 4 1 taking u cb x v 0 as test functions we have that x y u x d l u x u x d u cb x 16 young heon kim and yuan long ruan if we substitute u with un x an x x k x cb x n 1 we get x y un x d x un x d n 1 it follows by monotone convergence theorem that 4 3 x y x kxd x x kxd since mk x y this indicates that has k th moment i e mk x analogously we have cb y c 0 k x y and 4 4 x y y ky d y y ky d now taking u x kx v y k y as test functions in 4 2 we get x y x kx y k y d r x kx y k y x x kxd y y ky d this together with 4 3 and 4 4 implies r x kx y k y 0 from these we conclude that r 0 indeed for any u cb k x y there exist constants a 0 b 0 such that a x kx y k y b 6 u x y 6 a x kx y k y b note 1 c 0 k x y therefore when r acts on the first and last term of the above inequalities they all vanish since r is nonnegative we see that r u a x kx y k y b 0 which yields r u 0 and r a x kx y k y b u 0 which yields r u 6 0 hence r u 0 u cb k x y 3 now we know l mk x y the remaining proof is similar to lemma 3 1 4 2 general duality for wasserstein projections there is one caveat before we prove the general duality the stochastic cones we defined earlier in 2 4 and 2 5 do not explicitly require moments of measures this will not cause problems in the compact case since moments of the probabilities exist automatically however we have to make this requirement precise in the general case so we retain similar notation of the cones but make it more precise for the general duality that the cones are contained in the space of probability measures with k th moment i e for pk x pak 6 pk y 6 a and for pk y pak 6 pk x 6 a wasserstein projection 17 whenever the underlying spaces in question are bounded the moments are not relevent the subscripts k will be omitted so that they are consistent with the notations introduced earlier theorem 4 3 backward duality let x y be locally compact polish spaces j k 0 be integers pj x pj y and a be a defining function class as defined in definition 2 1 assume that a 1 a and a cb k define the same stochastic order a 2 the cost c x y is nonnegative lower semicontinuous and there exist 0 and r such that c x y 1 x kx y k y x y then we have the following i let v c be defined in 3 1 then tc pak 6 sup u v c cb k x ud y d ii let qc be defined in 3 2 then tc pak 6 sup a cb k x qc d y d in both i and ii a cb k can be relaxed to a sb k proof since the a probability measure on a polish space has compact support we may assume in the following that x y are compact we would like to follow the steps as in theorem 3 2 the conclusion of the theorem follows easily once we can prove tc pak 6 sup u v vc cb k x ud y d sup u v vc l 1 sb k sb k x ud y d where vc is defined through 3 4 3 5 in contrast with theorem 3 2 the correct domain for the functionals and is cb k x y c 0 y however if we take a look at the functionals g h defined in theorem 3 2 we would soon realize that they are never continuous in c 0 y with the supremum norm induced by cb y to fix this problem we employ a usual perturbation trick to circumvent this difficulty given 1 2 0 we define g 1 p cb k x y 7 0 p x y c x y 1 otherwise h 2 q c 0 y 7 0 q y 2 otherwise i p q cb k x y c 0 y 7 y d x ud p x y v y u x for some u v cb k q y y v y for some a cb k otherwise 18 young heon kim and yuan long ruan note i is convex well defined and nontrivial we have the following g 1 l sup p cb k x y p c 1 l p sup p cb k x y p c l p 1 which is unless l cb k x y is nonnegative h sup q c 0 y q 2 y q y d 2 m y otherwise i l sup u v cb k a cb k l v y u x x u x d x y y d y y y v y d sup u v cb k a cb k l v y u x y v y d x u x d x y y d y y d y by virtue of lemma 4 2 i l 0 if and only if 6 a and l when this happens we have pk y and l pk x y therefore i l 0 pa 6 l otherwise let p q g 1 p h 2 q p q i p q to complete the proof it remains to show that there exists p 0 q 0 cb k x y c 0 y such that p 0 q 0 p 0 q 0 and is continuous at p 0 q 0 define 0 y 0 v 0 y 0 u 0 x 1 a x kx b where a b are constants to be determined later clearly 0 a cb k u 0 v 0 cb k set p 0 x y v 0 y u 0 x q 0 y 0 y v 0 y x y then p 0 1 a x kx b cb k x y q 0 0 c 0 y a neighbourhood u p 0 q 0 of p 0 q 0 in cb k x y c 0 y is given by all functions p q cb k x y c 0 y satisfying p p 0 b k q q 0 b sup x y x y p x y p 0 x y 1 x x y y k sup y y q y q 0 y it follows that for any p q u p 0 q 0 p x y p 0 2 k 1 x kx y k y 1 a 2 k 1 x kx 2 k 1 y ky b x y and q x y q 0 x y wasserstein projection 19 now choose 1 0 2 0 b 0 large a 0 0 small such that 2 1 a 2 k 1 1 2 k 1 and b 1 with these constants and the assumption on the cost function c we see that p c 1 q 2 p q u p 0 q 0 hence p q 0 p q u p 0 q 0 therefore p 0 q 0 0 and is continuous at p 0 q 0 moreover since are probabilities with finite k th moments p 0 q 0 i p 0 q 0 now we can invoke fenchel rockafellar theorem to get the conclusion of the the orem in particular if the total transport cost tc pak 6 is finite then we obtain inf l pk x y pk y l 6 a l c 1 2 sup u v cb k a cb k u x v y 6 c x y 1 y v y 2 x ud y d the rhs equals sup u v cb k a cb k u x v y 6 c x y 1 2 y v y 0 x ud y d sup u v vc cb k x ud y d 1 2 therefore the duality is proved upon cancelling 1 2 from both sides the duality for forward projection can be proved as theorem 4 3 we leave its proof to the reader theorem 4 4 forward duality let x y be locally compact polish spaces j k 0 be integers pj x pj y and a be a defining function class as defined in definition 2 1 assume that a 1 a and a cb k define the same stochastic order a 2 the cost c x y is nonnegative lower semicontinuous and there exist 0 and r such that c x y 1 y kx x k y x y then we have the following i let u c be defined in 3 9 then tc pak 6 sup v u c cb k x d y vd ii let qc be defined in 3 10 then tc pak 6 sup a cb k x d y qc d in both i and ii a cb k can be relaxed a sb k 20 young heon kim and yuan long ruan the assumption a 2 on the cost function of the duality theorems theorem 4 3 and theorem 4 4 might not be the most general one but it already includes impor tant examples encountered in applications if the underlying spaces are bounded then a 2 is automatic in the general case the following example shows that all power functions satisfy this assumption example 4 5 let k 1 be an integer h s 0 7 0 be a continuous function such that mh inf s a h s sk 0 for some a 0 then the cost function c x y h x y on rd rd satisfies assumption a 2 of theorem 4 3 resp theorem 4 4 in particular the quadratic cost c x y x y 2 satisfies assumption a 2 with k 1 or 2 proof we show that assumption a 2 of theorem 4 3 is satisfied by the cost func tion c x y h x y the proof for theorem 4 4 is similar let 0 1 consider f x y h x y 1 x k y k with a change of variable z x y we can rewrite the function as f z y h z 1 z y k y k since we only need a lower bound of f and it is bounded from below when y 0 or z 0 we may assume y 6 0 and z 6 0 in the following using triangle inequality we have f z y h z 1 z y k y k y k h z z k z k y k 1 z y 1 k we distinguish two scenarios s 1 z y 1 12 s 2 z y 1 6 12 or 12 6 z y 6 32 in scenario s 1 we have f z y y k 1 2 k in scenario s 2 if z a then f z y y k mh 2 k if z a then y 6 2 z 2 a thus f z y y k 2 a k therefore we can choose 0 small such that mh 2 k 0 and 1 2 k 0 then in all cases the function f is bounded from below by 2 a k we make a few remarks concerning backward projection theorem 4 3 and for ward projection theorem 4 4 wasserstein projection 21 remark 4 6 theorem 4 3 and theorem 4 4 do not assume the transportation costs tc pak 6 tc pak 6 are finite therefore the optimal projections and optimal couplings are generally nonnegative linear functionals on cb or cb k as can be seen from the proof however once the transportation costs are finite then they become true probabilties in pk under mild conditions of the cost function the transportation costs are finite consider for example k 1 pk rd pk rd and there is a 0 such that 0 6 c x y 6 a x k y k since pak 6 0 6 tc pak 6 6 tc inf rd rd c x y d x y 6 a rd rd x k y k d x y a rd x kd rd y kd the same estimate holds for forward projection tc pak 6 remark 4 7 it is part of fenchel rockafellar theorem that once the optimal transportation costs are finite then the optimal values tc pa 6 tc pa 6 tc pak 6 tc pak 6 etc are attained remark 4 8 in the duality theorems the requirement a sb k cannot be further relaxed to a l 1 because at some point of the proof we will need to integrate w r t to the free marginal i e the projection if is only known to be integrable w r t the fixed marginal then there is not enough information to ensure the integration of w r t to the free marginal exists however for backward projection it is possible to further relax a sb k to a l 1 x d and f for some f sb k when this relaxed condition holds then for any pak 6 6 a we have f d 6 d 6 d which implies d is finite similarly for forward projection it is possible to further relax a sb k to a l 1 y d and 6 g for some g sb k remark 4 9 if a defines a trivial order see example 2 4 and k 0 then the dualities of wasserstein projections reduce to the classical kantorovich duality remark 4 10 if the defining classes a 1 a 2 a 1 sb k a 2 sb k define the same stochastic order then they give equal optimal dual value take backward projection for exmaple sup a 1 sb k x qc d y d sup a 2 sb k x qc d y d 22 young heon kim and yuan long ruan this follows from the proof of the duality formula and the fact that these defining classes produce the same stochastic order cones i e pa 1 k 6 p a 2 k 6 the same is true for forward projections it is worth noting that it is not immediately obvious that running the supremum over different sets should result in equal optimal dual value the following theorem gives the relationship between optimal primal solutions and optimal dual solutions of wasserstein projections theorem 4 11 let x y be locally compact polish spaces k 0 be an integer pk x pk y and a be a defining function class as defined in definition 2 1 i assume that the conditions of theorem 4 3 are satisfied let be the opti mizer for tc pak 6 and suppose a l 1 d is an optimal dual solution for backward projection of theorem 4 3 which is bounded from below by some function in sb k then d d in particular is an optimal potential for tc ii assume that the conditions of theorem 4 4 are satisfied let be the opti mizer for tc pak 6 and suppose a l 1 d is an optimal dual solution for forward projection of theorem 4 4 which is bounded from above by some function in sb k then d d in particular is an optimal potential for tc proof we only prove i the proof of ii is similar in view of remark 4 8 the integral d is finite then using the optimality of and we obtain tc tc pak 6 qc d d qc d d d d 6 tc d d 6 tc the first inequality is due to the fact that qc is an admissible pair for the transportation tc the second inequality follows from the fact that 6 a 4 3 uniqueness now we turn to the uniqueness of the projections if the cones pak 6 p a 6 are convex along wasserstein geodesics then the uniqueness would be immediate however except in a few special situations these cones are generally not convex along wasserstein geodesics that being said the uniqueness of the projection can still be obtained using the convexity of these cones under linear interpolation the case of convex order projection is proved in 1 the proof follows the classical strict convexity argument theorem 4 12 uniqueness let k 0 x y be convex subsets of rd pk x pk y and a be a defining function class as defined in definition 2 1 the cost wasserstein projection 23 function c x y h x y for some strictly convex function h rd 7 0 if p ack x and the transport cost of the backward projection is finite then the projection exists and is unique similarly if p ack y then forward projection exists and is unique proof we consider forward projection and x y rd other cases are proved similarly assume that p ack rd and the transport cost of the forward projec tion is finite in view of remark 4 7 the forward projection exists let 0 1 be forward projections of onto pak 6 i e tc 0 tc 1 tc pak 6 denote by i i 0 1 be the optimal coupling between i and then for s 0 1 fixed 4 5 s 1 s 0 s 1 is a coupling between s 1 s 0 s 1 and since pak 6 is convex under linear interpolation s pak 6 hence tc pak 6 6 tc s 6 rd rd c x y d s 1 s rd rd c x y d 0 s rd rd c x y d 1 1 s tc 0 stc 1 tc pak 6 it follows that tc pak 6 tc s rd rd c x y d s i e s is a forward projection of onto p a k 6 and s is the optimal coupling between s and since is absolutely continuous w r t the lebesgue measure for each i 0 s 1 there exists a unqiue optimal mapping ti from to i i e d i x y ti y x d y i 0 s 1 in view of 4 5 ts y 1 s t 0 y st 1 y a e y we claim that t 0 y ts y t 1 y for a e y otherwise we would have due to the strict convexity of the cost that tc pak 6 tc s rd c ts y y d rd c 1 s t 0 y st 1 y y d 1 s rd c t 0 y y d s rd c t 1 y y d 1 s tc 0 stc 1 tc pak 6 which is a contradiction therefore t 0 y x d y ts y x d y t 1 y x d y it follows 0 s 1 are equal thus have equal first marginals i e 0 s 1 24 young heon kim and yuan long ruan 5 convex order projections this section is devoted to convex order projections and their duality theorems definition 5 1 convex order given two probabilities p 1 rd we call smaller than in convex order denoted by 6 cx if the inequality 5 1 d 6 d holds for all real valued convex function such that both integrals of w r t exist in the extended sense the following lemma gives several equivalent definitions of convex order lemma 5 2 let p 1 rd regarding the inequality 5 1 the following statements are equivalent i 5 1 holds for any lower semicontinuous proper convex function such that both integrals exist in the extended sense ii 5 1 holds for any lower semicontinuous proper convex function which is bounded from below iii 5 1 holds for any convex function which is lipschitz continuous proof 1 first prove i and ii are equivalent it suffices to show ii implies i let be any lower semicontinuous proper convex function such that both integrals w r t exist in the extended sense then for k 6 0 the function max k is convex and bounded from below hence d 0 max k d max k d 6 max k d d 0 max k d note 0 max k d 0 max k d are finite if d then from the above inequality we infer that d since both integrals of w r t exist in the extended sense it follows that d d in this case 5 1 holds trivially with both sides equal to in the other extreme case where d and d 5 1 holds trivially too it remains to consider the case where d d in this case we can let k and use monotone convergence theorem to obtain 0 max k d 0 d 0 max k d 0 d it follows that d 6 d therefore i holds in all cases 2 for the equivalence between ii and iii it suffices to show iii implies ii consider any lower semicontinuous proper convex function on rd since is lower semicontinuous there is a sequence of n lipschitz convex functions n which increase to in a pointwise manner as n note n l 1 d l 1 d n wasserstein projection 25 then using monotone convergence theorem we obtain that satisfies 5 1 thus ii is proved define acx proper convex lower semiconitnuous note that for any p 1 rd and any proper convex function the integral d always exists in the extended sense this results from the fact that is sup ported by a linear function thus min 0 d this together with lemma 5 2 indicates that the three defining classes acx acx sb 1 acx sb 2 produce the same convex order relation instead of acx we can also use the following class to get the same convex order acx lb acx bounded from below note we have 5 2 acx cb 1 acx sb 1 convex lipschitz let k 1 the backward and forward convex order cones are denoted by pcxk 6 pk rd 6 cx and pcxk 6 pk rd 6 cx in view of lemma 5 2 the defining classes acx acx sb 1 acx lb etc give the same convex order cones 5 1 the duality theorems now we state the dualities for backward and forward convex order projections theorem 5 3 let p 2 rd p 2 rd i for k 1 2 the duality for backward convex order projection holds t 2 pcx 1 6 t 2 pcx 2 6 sup acx cb k rd q 2 d rd d sup acx l 1 d rd q 2 d rd d where 5 3 q 2 x inf y rd y x y 2 ii for k 1 2 the duality for forward convex order projection holds t 2 pcx 1 6 t 2 pcx 2 6 sup acx cb k rd d rd q 2 d where 5 4 q 2 y sup x rd x x y 2 note in both i and ii the optimal values are equal regardless of k moreover acx cb k can be relaxed to a sb k 26 young heon kim and yuan long ruan proof the dualities for individual k are obtained by invoking theorem 4 3 and theorem 4 4 to see that the optimal values are equal regardless of k 1 2 we proceed as below 1 we prove that pcx 1 6 p cx 2 6 whence t 2 pcx 1 6 t 2 pcx 2 6 since pcx 2 6 p cx 1 6 so it suffices to prove the opposite includsion for any p 1 rd and 6 cx we have rd d 6 rd d for all acx sb 2 since p 2 rd we can take as the convex function y 2 to obtain rd y 2 d 6 rd y 2 d which shows that p 2 rd therefore pcx 1 6 p cx 2 6 2 that acx cb k in the backward duality can be relaxed to acx l 1 d follows from remark 4 8 and the fact that real valued convex functions are supported by linear functions this completes the proof of item i 3 we prove that 5 5 t 2 pcx 1 6 t 2 pcx 2 6 the idea of step 1 does not apply here in general we only have pcx 2 6 p cx 1 6 whence t 2 pcx 1 6 6 t 2 pcx 2 6 to show the reverse inequality we prove that there exists pcx 2 6 such that 5 6 t 2 t 2 pcx 1 6 which indicates t 2 pcx 2 6 6 t 2 t 2 pcx 1 6 therefore once 5 6 is established the proof of 5 5 would be completed note this actually yields a direct proof of the existence for t 2 pcx 1 6 t 2 pcx 2 6 to prove 5 6 first note in view of remark 4 6 t 2 pcx 1 6 is finite let n pcx 1 6 be a minimizing sequence for t 2 pcx 1 6 then the sequence t 2 n is bounded by some constant m 0 by w 2 triangle inequality rd x 2 d n t 2 n 0 6 w 2 n w 2 0 2 6 2 t 2 n t 2 0 6 2 m rd x 2 d n here 0 is the dirac measure concentrated at the origin by virtue of markov in equality the sequence n is tight see e g 9 therefore there exists a subsequence ni converging weakly to some probability meanwhile sup i x r x d ni 6 sup i 1 r x r x 2 d ni 6 1 r sup n rd x 2 d n 0 as r wasserstein projection 27 by 38 theorem 7 12 ii w 1 ni 0 as i hence for any g sb 1 rd gd n rd gd as n using lemma 5 2 and 6 n we infer that 6 cx moreover has second order moment indeed by virtue of layer cake theorem 31 p 26 1 13 rd x 2 d ni 2 0 t ni x t dt since ni converges weakly to lim i ni x t x t for a e t now using fatou lemma rd x 2 d 2 0 t x t dt 6 lim inf i 2 0 t ni x t dt lim inf i rd x 2 d ni 6 sup n rd x 2 d n hence p 2 rd therefore pcx 2 6 p cx 1 6 finally we show that is optimal for t 2 pcx 1 6 let n n be the optimal couplings for t 2 n since ni pcx 1 6 converges weakly to we may assume that ni converges weakly to some for any r 0 rd rd x y 2 r d x y lim i rd rd x y 2 r d ni x y 6 lim i rd rd x y 2 d ni x y t 2 pcx 1 6 sending r and using monotone convergence theorem rd rd x y 2 d x y 6 t 2 pcx 1 6 since pcx 1 6 this shows is an optimal coupling which achieves t 2 pcx 1 6 thus 5 6 is satisfied remark 5 4 from the proof of theorem 5 3 any projection onto pcx 1 6 is also a projection onto pcx 2 6 and vice versa the same is true for p cx 1 6 and p cx 2 6 6 dual attainment for convex order projections in this section we will prove the attainment of the optimal dual value associ ated with backward convex order projection and forward convex order projection characterization of these optimal dual potentials will be given in the following section these are tackled by combining the treatments in the classical optimal transportation with duality formulas proved in the earlier sections 28 young heon kim and yuan long ruan 6 1 backward projection theorem 6 1 let p 2 rd p 2 rd then for each k 1 or 2 there is a convex function 0 acx l 1 d with values in r which achieves the optimal dual value d 2 pcxk 6 sup acx sb k q 2 d d where q 2 is defined in 5 3 if both and have compact supports then there exists a lipschitz convex optimal dual solution moreover d 2 pcx 1 6 d 2 pcx 2 6 proof using the equivalence between backward convex order projection and weak optimal transport it is proved in 23 proposition 1 1 that t 2 pcx 1 6 d 2 lb pcx 1 6 sup acx lb sb 1 rd q 2 d rd d the optimal dual value d 2 lb pcx 1 6 is attained at some 0 acx l 1 d with values in r note in general 0 might not be a member of acx sb 1 it is also proved that if both and have compact supports then 0 can be chosen to be lipschitz convex in view of theorem 5 3 t 2 pcx 1 6 d 2 pcx 1 6 d 2 pcx 2 6 hence the same function 0 which attainsd 2 lb pcx 1 6 also achievesd 2 pcx 1 6 and d 2 pcx 2 6 therefore 0 is the desired function we look for 6 2 forward projection the next result is about the attainment of forward convex order projection the proof combines a preliminary trick with the strategy used in the proof of 23 theorem 1 2 theorem 6 2 let p 2 rd p 2 rd then for each k 1 or 2 there exists a convex function 0 acx cb 2 which satisfies 0 6 x 2 and achieves the optimal dual value d 2 pcxk 6 sup acx sb k d q 2 d where q 2 is defined in 3 10 moreover d 2 pcx 1 6 d 2 pcx 2 6 proof that the two optimal dual values are equal is a result of theorem 5 3 the proofs of attainment for k 1 and 2 are similar but note that the function which achieves d 2 pcx 1 6 might not be in sb 1 here we only give proof for k 2 1 we first show that the optimization can be restricted to a 0 cx sb 2 where a 0 cx acx q 2 q 2 q 2 0 0 indeed first recall remark 4 6 the optimal dual value is finite under the conditions of the theorem if acx sb 2 is such that q 2 is identically then the dual value is since the integral d is finite so we can avoid these functions in wasserstein projection 29 the supremum in d 2 pcx 2 6 for any acx sb 2 such that q 2 is not identically there is y 0 rd depending on for which q 2 y 0 let x inf y rd q 2 y x y 2 q 2 q 2 x then x 6 q 2 y 0 x y 0 2 x since is convex and 6 we see that acx cb 2 by a 3 we have q 2 y q 2 q 2 q 2 y q 2 y whence x q 2 q 2 x q 2 q 2 x so d q 2 d 6 d q 2 d 6 d 2 pcx 2 6 the last inequality is due to acx sb 2 so it is admissible to the supremum in d 2 pcx 2 6 moreover adding a constant to will not change the difference of the integrals we may assume that q 2 0 0 therefore we have proved d 2 pcx 2 6 sup a 0 cx sb 2 d q 2 d 2 let n a 0 cx sb 2 be a maximization sequence for d 2 pcx 2 6 write n q 2 n then n q 2 n with n 0 0 we assume without loss of generality that yd 0 first we have an upper bound uniform in n on n 6 1 n x q 2 n x inf y n y x y 2 6 x 2 next we will obtain a pointwise lower bound uniform in n on n since x 2 n x 2 sup y x y 1 2 y 2 n y is convex we get by jensen inequality x 2 n x 6 x 2 n x d where x xd it follows that n x x 2 x 2 n x d x 2 n x d n y d x 2 d n y d note n x d n y d is bounded 30 young heon kim and yuan long ruan since n is convex n y d n yd n 0 0 therefore n x is bounded from below using the convexity of n and 6 1 we get n x 6 1 2 n 2 x x 1 2 n x 6 1 2 2 x x 2 1 2 n x it follows that 6 2 n x 1 2 n x 1 2 2 x x 2 in view of 6 1 and the fact that n x is bounded from below we have n x is bounded for each x therefore we may assume up to a subsequence that n x 0 x x where 0 x is a convex function now we show 0 is the optimal dual solution we look for clearly 0 acx cb 2 note 6 3 n y n x x y 2 x y hence lim inf n n y 0 x x y 2 x y so lim inf n n y sup x 0 x x y 2 q 2 0 y note n is bounded from above by a integrable function ref 6 1 and n is bounded from below by a common integrable quadratic function ref 6 2 and 6 3 therefore using fatou lemma d 2 pcx 2 6 lim n n x d n y d 6 lim sup n n x d lim inf n n y d 6 0 x d q 2 0 y d 6 d 2 pcx 2 6 so 0 is the optimal solution we look for unlike the backward case in theorem 6 1 requiring and to have compact supports does not ease the way to find a more regular optimal dual solution this results from the major difference between backward and forward projection which we will discuss in section 8 7 characterization of convex order projections in this section we present results on the characterization of optimal mappings for backward and forward convex order projections the optimal mappings possess special properties which we call convex contraction and convex expansion these are consequences of the duality and attainment obtained in previous sections recall that the legendre transform of a function is denoted by wasserstein projection 31 definition 7 1 convex contraction let be a proper lower semicontinuous convex function we call a convex contraction if for some proper function such that d 2 id in the sense of distribution definition 7 2 convex expansion let be a proper lower semicontinuous convex function we call a convex expansion if for some proper function such that d 2 6 id in the sense of distribution remark 7 3 that is a convex contraction is equivalent to d 2 6 id indeed in view of lemma a 2 if is a convex contraction then d 2 6 id conversely if is a proper lower semicontinuous convex function such that d 2 6 id then using again lemma a 2 d 2 id now so is a convex contraction similarly that is a convex expansion is equivalent to d 2 id the definition of convex contraction and expansion through legendre transforms is natural and consistent with the subharmonic order setting see definition 11 1 definition 11 2 and remark 11 3 7 1 backward projection the following characterization of optimal mapping for backward convex order projection is proved in 23 theorem 1 2 theorem 2 1 we include them and restated in our terms for readers convenience theorem 7 4 suppose that p 2 rd p 2 rd and acx l 1 d is the optimizer of the dual d 2 pcx 1 6 obtained in theorem 6 1 let 0 y 1 2 y 2 y then i 0 c 1 rd is a convex contraction ii 0 is the unique projection of onto p cx 1 6 theorem 7 5 let p 2 rd p 2 rd then the following are equivalent i the projection of onto pcx 1 6 coincides with ii there exists a convex contraction such that note in view of the step 1 in the proof of theorem 5 3 pcx 1 6 p cx 2 6 so we can also replace pcx 1 6 with p cx 2 6 in the above theorems 7 2 forward projection a key feature of our duality formulation of the wasser stein projection in stochastic order is that the property of the optimal dual solution is inherited from the defining class of the stochastic order e g the convexity in the convex order case the optimal dual solution if exists not only gives rise to the optimal mapping to the projection theorem 4 11 but also produces special properties of the optimal mapping moreover our duality formula allows us to handle the backward and forward case in a unified manner the backward convex order projection in the previous theorem yields a special optimal mapping a con vex contraction the next theorem will give us the exact opposite of the backward case a convex expansion note that we even have a very precise relation between the optimal mappings of the backward and forward convex order projections they are actually inverse to each other which is somewhat surprising see section 8 theorem 7 6 suppose that p 2 rd p ac 2 rd and acx cb 2 is the optimizer of the dual d 2 pcx 2 6 obtained in theorem 6 2 let 0 x 1 2 x 2 1 2 x 32 young heon kim and yuan long ruan then i 0 is a convex expansion in addition 0 is uniformly convex ii 0 is the unique projection of onto p cx 2 6 proof by theorem 4 12 the forward projection is unique let be the unique forward convex order projection and such that t 2 pcx 2 6 t 2 x y 2 d x y by theorem 5 3 the optimality of and theorem 4 11 x y 2 d x y x d q 2 y d x d q 2 y d x q 2 y d x y hence x y 2 x q 2 y d x y 0 since the integrand is nonnegative we have 7 1 x y 2 x q 2 y a e x y using lemma a 1 7 2 q 2 y 2 0 y y 2 where 0 x 1 2 x 2 1 2 x since q 2 is convex for convex we get from 7 2 that 0 is uniformly convex and d 2 0 id thus 0 is a convex expansion remark 7 3 finally combining 7 1 and 7 2 we have x y 2 x 2 0 y y 2 a e x y which can be rewrite as x y 0 x 0 y a e x y since q 2 l 1 y d it is finite for a e y hence 0 is finite for a e y this together with the absolute continuity of implies that 0 is a e differentiable and x 0 y a e y therefore x 0 y a e x y this shows that 0 is the unique projection of onto p cx 2 6 in contrast to theorem 7 6 we need to assume the absolute continuity of to ensure the uniqueness of the forward projection in theorem 7 6 this results from the difference in the geometric properties of backward and forward convex order cones see section 4 3 and section 8 it turns out the properties of the potential given in theorem 7 6 are also opti mal the follow complements the corresponding result of backward convex order projection given in theorem 7 5 wasserstein projection 33 theorem 7 7 let p 2 rd p ac 2 rd then the following are equivalent i the projection of onto pcx 2 6 coincides with ii there exists a convex expansion such that proof 1 that i implies ii follows from theorem 7 6 and lemma a 2 2 suppose that there exists a convex expansion such that let x x 2 2 x since is a convex expansion hence is convex in addition by lemma a 2 c 1 is 1 lipschitz thus has at most quadratic growth therefore acx cb 2 since is convex y y y y a e y noting is absolutely continuous w r t the lebesgue measure we get y y y y a e y therefore t 2 6 y y 2 d y 2 d 2 y y d y 2 d x 2 d 2 y y d y 2 d x 2 2 x d 2 y y 2 d using the definition of and applying lemma a 2 to the term we continue writing t 2 6 x d q 2 y d 6 sup g acx sb 2 g x d q 2 g y d d 2 pcx 2 6 6 sup g l 1 d g x d q 2 g y d t 2 this shows that is an optimizer of the dual i e d 2 pcx 2 6 x d q 2 y d hence by theorem 7 6 the image which is by assumption is the pro jection of onto pcx 2 6 therefore we have proved that the projection of onto pcx 2 6 is 8 backward projection versus forward projection in appearance the backward and forward duality formulas correspond to the two forms of classical kantorovich duality where one can go from one form to the other through a c transform people might thus be tempted to think that the backward duality and forward duality for wasserstein projections can be bridged by a c transform as in the classical case hence are equivalent in some sense this however is not true in general simply because the defining class a might not be invariant under the c transforms qc and qc that being said the case of convex order is an exception the backward and forward convex order projections are indeed equivalent in an appropriate sense this result is somewhat surprising since even 34 young heon kim and yuan long ruan in the convex order case although the backward cone is geodesically convex the forward cone is not see example 8 2 8 1 supports of measures in convex order for any two measures in convex order their supports informally speaking are increasing with convex order this implies that for backward projection problem 1 1 the support of the backward projection is implicitly known to be contained in the support of forward projection does not enjoy this property this is made precise in the following simple result for which we provide a proof for completeness lemma 8 1 let p rd and 6 cx then clconv supp clconv supp where clconv denotes the closure of the convex hull of a given set proof suppose to the contrary that the conclusion is not true then there exists a nonempty open ballb x 0 such that b x 0 0 and b x 0 clconv supp then there is a linear function l x which strictly separates clconv supp and b x 0 l x 0 x b x 0 l x 0 x clconv supp consider the convex function x max l x 0 x rd it is easy to see that x d 0 x d this contradicts the assumption that 6 cx 8 2 convexity of the cones given p 2 rd we discuss the geodesic convexity of the backward cone pcx 2 6 and forward cone p cx 2 6 in view of 3 proposition 9 3 2 pcx 2 6 is convex along generalized geodesics hence also convex along geodesics the forward cone pcx 2 6 on the other hand is generally not geodesically convex as illustrated by the example below which is inpired by 12 a b b a 1 2 1 2 1 4 1 4 1 4 1 4 1 2 1 2 figure 2 probabilities solid red and blue in convex order example 8 2 let probability supported on solid red balls in figure 2 and probability supported on solid blue balls in figure 2 wasserstein projection 35 1 2 1 2 1 4 1 4 1 4 1 4 1 2 1 2 figure 3 the optimal transport from the probability on red balls to the one on blue balls cirles indicate displacement interpolation consider the cone pcx 2 6 clearly p cx 2 6 in figure 2 the indicated distance b is larger than a when the wasserstein distance between and is computed it is easy to see that the optimal path to transport to is along the dotted red lines as shown in figure 3 where an intermmediate displacement interpolation say s with s 0 1 is given and supported on the red circles in figure 3 the closure of the convex hull of supp s is indicated by shaded area which does not include clconv supp in view of lemma 8 1 the relation 6 cx s does not hold in other words s is not in the cone p cx 2 6 therefore p cx 2 6 is not geodesically convex 8 3 relation between backward and forward solution in the following we show that the backward and forward convex order projection costs are equal and the optimal backward and forward mappings are inverse to each other given the fact that the backward and forward convex order cones possess distinct geometric properties as we have already seen the equality and inverse relations are surprising theorem 8 3 let p 2 rd p 2 rd then t 2 pcx 2 6 d 2 pcx 2 6 d 2 pcx 2 6 t 2 pcx 2 6 moreover the following are true i let f acx cb 2 be the optimal dual solution for forward projection ob tained in theorem 6 2 then q 2 f acx l 1 d is an optimal dual solution for backward projection ii let b acx l 1 d be the optimal dual solution for backward projection obtained in theorem 6 1 then q 2 b acx sb 2 is an optimal dual solution for forward projection proof it suffices to verify that 8 1 d 2 pcx 2 6 d 2 pcx 2 6 recall the dualities in theorem 5 3 8 2 d 2 pcx 2 6 sup acx l 1 d q 2 d d and 8 3 d 2 pcx 2 6 sup acx sb 2 d q 2 d 36 young heon kim and yuan long ruan since for acx sb 2 q 2 is convex thus bounded from below by its supporting plane hence q 2 d is bounded from below since q 2 d would not contribute to the supremum in 8 3 we can restrict to those acx sb 2 such that q 2 d is finite i e q 2 l 1 d therefore we can write 8 4 d 2 pcx 2 6 sup acx sb 2 q 2 l 1 d d q 2 d then for any admissible to the supremum of 8 4 it is legitimate to substitute with q 2 in the supremum of 8 2 and write 8 5 d 2 pcx 2 6 q 2 q 2 d q 2 d d q 2 d since runs over all functions admissible to the supremum of 8 4 we get d 2 pcx 2 6 d 2 pcx 2 6 on the other hand for any acx l 1 d q 2 is convex and is a e finite thus q 2 acx sb 2 so it is legitimate to substitute with q 2 in the supremum of 8 3 and write 8 6 q 2 d d 6 q 2 d q 2 q 2 d 6 d 2 pcx 2 6 since this holds for any acx l 1 d we have d 2 pcx 2 6 6 d 2 pcx 2 6 thus 8 1 is proved to see i and ii we note that by the optimality of f d 2 pcx 2 6 fd q 2 f d since the dual value is finite and f acx cb 2 q 2 f acx l 1 d so we can insert f into 8 5 to saturate the inequalities therefore q 2 f is an optimal solution for d 2 pcx 2 6 similarly b acx l 1 d implies q 2 b acx sb 2 therefore we can substitute b into 8 6 to see that q 2 b is optimal for d 2 pcx 2 6 remark 8 4 either following the same argument as above or using the above result together with theorem 5 3 we have d 2 pcx 1 6 d 2 pcx 1 6 although theorem 8 3 is proved for quadratic cost c x y 2 it is easy to generalize to other convex cost functions of the form c h x y the equality tk pcxk 6 tk pcxk 6 with k 1 is proved in 1 using a different method based on the primal formulations of the projection problems in one dimension it is shown there that the optimal mappings for backward and forward convex order projections are inverse to each other the following result confirms these properties on the optimal mappings in general dimensions and sheds more lights on the deep connection between backward and forward convex order projection wasserstein projection 37 corollary 8 5 let p 2 rd p ac 2 rd the optimizer of t 2 pcx 2 6 and the optimizer of t 2 pcx 2 6 there exists a real valued convex function c 1 such that moreover p ac 2 rd proof let f be the optimal dual solution of the forward convex order projection obtained in theorem 6 2 recall that f is convex continuous and f 6 x 2 by theorem 8 3 q 2 f is an optimal dual solution for backward convex order projection by virtue of theorem 7 6 the unique projection of onto pcx 2 6 is given by 0 where 8 7 0 x 1 2 x 2 1 2 f x in particular d 2 0 id now according to theorem 7 4 the unique projection of onto pcx 2 6 is given by 0 where 8 8 0 y 1 2 y 2 1 2 q 2 f y substituting 8 7 into 8 8 we obtain 0 y 1 2 y 2 1 2 q 2 x 2 2 0 x y 1 2 y 2 1 2 sup x rd x 2 2 0 x x y 2 0 y let 0 then is the desired real valued convex function furthermore 0 is uniformly convex so the forward projection under the mapping is absolutely continuous and c 1 remark 8 6 convexity is crucial in the proof of theorem 8 3 and corollary 8 5 we do not expect other stochastic orders e g the subharmonic order to have the above equality and the inverse relation between backward and forward projection 9 subharmonic order projections in this section we consider another important instantce of stochastic order i e subharmonic order definition 9 1 an upper semicontinuous function with values in is subharmonic on an open set x if the sub mean value inequality x 0 6 1 d r br x 0 d r holds for any ball br x 0 contained in x where d r is the surface area of the ball br x 0 if a function satisfies the above sub mean value properties but not necessar ily upper semicontinuous then it is called almost subharmonic this terminology is justified by the fact that every almost subharmonic function equals an upper semicontinuous subharmonic function almost everywhere 37 38 young heon kim and yuan long ruan definition 9 2 subharmonic order let x rd be a convex bounded open set and p x we call smaller than in subharmonic order denoted by 6 sh if the inequality 9 1 x d 6 x d holds for all subharmonic cb x subharmonic order is sufficient to induce a brownian transport between and see e g 20 proposition 3 4 by performing convolutions with smooth radial kernels each subharmonic function can be approximated in any compact subsets of x by decreasing sequence of smooth subharmonic functions similar to lemma 5 2 one can also restrict the integrands of 9 1 to those which are bounded from below define ash subharmonic bounded from below for notational simplicity the domain of definition for functions in ash is not ex plicitly specified and will be clear from the context let p x p y define the backward and forward subharmonic order cone psh 6 p y 6 sh and psh 6 p x 6 sh 9 1 the duality theorems theorem 9 3 let x y rd be bounded convex open subsets p x p y then i for backward subharmonic order projection it holds that t 2 psh 6 sup ash cb y x q 2 d y d ii for forward subharmonic order projection it holds that t 2 psh 6 sup ash cb x x d y q 2 d here q 2 q 2 are defined in theorem 5 3 in both i and ii ash cb can be relaxed to a sb proof the proof is completed by applying theorem 4 3 and theorem 4 4 to the defining class ash cb 10 dual attainment for subharmonic order projections obtaining a solution in the required subharmonic function class with appropri ate regularity is challenging one difficulty lies in the definition of subharmonic function to determine whether or not a function is subharmonic one usually needs to test sub mean value property over spheres or balls this implicitly uses lebesgue measure as a reference in the dualities of subharmonic order projec tions subharmonic functions have to interact with arbitrary probability measures wasserstein projection 39 to be able to traverse from an arbitrary probability measure to the lebesgue mea sure assumptions such as absolute continuity bounds away from zero are usually unavoidable another property missing from subharmonic functions involves the transforms q 2 q 2 these transforms preserve convexity which plays a key role in the convex order case however q 2 q 2 not always preserve subharmonicity for general subharmonic functions subharmonicity is only preserved by q 2 in sub domain this is proved by 32 in alexandrov space which includes euclidean space as a special case 13 example 4 2 1 therefore the double convexification trick which we use in the attainment for convex order projections no longer work in the subharmonic order case despite these difficulties we are able to obtain optimal dual solutions for subhar monic order projections and a weak parallel of the convex contraction and expan sion which we call laplacian contraction and laplacian expansion see definition 11 1 and definition 11 2 we will first prove attainment of the duality the method used here seems to have the weakest assumptions on the measures 10 1 backward projection theorem 10 1 let x y be bounded convex open subsets of rd p x and p ac y assume that the density of is bounded away from zero in y then there exists 0 ash l 1 y d which is bounded from below such that d 2 psh 6 sup ash cb y x q 2 d y d 6 x q 2 0 x d y 0 y d denote by the backward subharmonic order projection of onto psh 6 if in ad dition 10 1 y 0 y d 6 y 0 y d then 0 achieves the optimal dual value proof since t 2 psh 6 is finite ref remark 4 6 the optimal dual d 2 psh 6 is finite we can also write 10 2 d 2 psh 6 sup ash cb y x q 2 q 2 q 2 x d y y d let n ash cb y be a maximizing sequence and denote n q 2 q 2 n since the measures sit in a compact set containing both x and y the cost function is lipschitz continuous there thus n and q 2 n are lipschitz continuous with a common lipschitz constant inherited from the cost function when necessary we can regard these functions as defined on y and x by extending them to the boundaries by adding constant s we may assume without loss of generality that min y y n y 0 n now it is readily seen that n is uniformly bounded in y it follows that q 2 n is also uniformly bounded in x therefore the sequence n and so q 2 n are 40 young heon kim and yuan long ruan uniformly bounded and equicontinuous hence by arzela ascoli theorem we may suppose that it holds uniformly that n 0 and q 2 n q 2 0 as n where 0 is lipschitz continuous on y hence x q 2 n x d x q 2 0 x d as n it follows that q 2 n d is bounded so we obtain from 10 2 and the bounded ness of the optimal dual value that nd is bounded note 10 3 0 6 n y 6 n y y by assumption there exists a 0 0 such that a 0 y n y dy 6 y n y d which implies ndy n dy is bounded then by lemma b 1 there exists a subharmonic function 0 l 1 y dy such that up to a subsequence 10 4 n y 0 y a e y it follows that n y 0 y a e y by fatou lemma lim inf n y n y d y 0 y d therefore 0 l 1 y d using 10 3 10 4 0 6 0 y 6 0 y a e y since 0 is continuous and 0 is upper semicontinuous we obtain 0 6 0 y 6 0 y y thus the subharmonic function 0 is bounded from below and we obtain d 2 psh 6 lim n x q 2 n x d y n y d 6 lim sup n x q 2 n x d lim inf n y n y d x q 2 0 x d y 0 y d 6 x q 2 0 x d y 0 y d if 0 satisfies 10 1 then the above inequality continues as x q 2 0 x d y 0 y d 6 d 2 psh 6 therefore the optimal dual value is attained at 0 wasserstein projection 41 remark 10 2 the assumption 10 1 is added because a priori the subharmonic function 0 ash l 1 y d may not satisfy the submartingale inequality unless further informations are available in our context is generated by a stopped brownian motion which has initial distribution and stays in y hence one might think that the assumption 10 1 is redundant however there are examples showing the submartingale inequality might fail even though the brownian motion is stopped before it exits y here is an example due to zhen qing chen let y be the 2 dimensional unit ball up to a conformal transform we can reduce y to the upper half space h z x y r 2 y 0 and consider the poisson kernel for h z x y 1 y x 2 y 2 denote by a the hitting time of the parabolic curve y ax 2 a 0 by the brownian motion wz 0 t emanating from z 0 0 1 r 2 since the origin 0 0 is polar for wz 0 t it is almost surely never reached therefore a is strictly less than the exit time h of h note z 6 a on hence e wz 0 a 6 a 1 e wz 0 0 for a small i e the submartingale inequality fails for the harmonic function one can also modify this example to make a similar counterexample where the distribution of the stopped brownian motion has a density with a positive lower bound 10 2 forward projection this section deals with the dual attainment of the forward projection in contrast to theorem 10 1 we will get a lipschitz continuous optimal dual solution for the forward projection recall that for convex cost c the c transforms qc and qc defined by 3 2 3 10 preserves convexity this has played a crucial role in our proof of the dual attainment in the convex order case however analogous preservation prop erty does not hold for subharmonic functions to address this issue we introduce a composite of the c transforms with the operation of taking subharmonic envelopes given g c x on a connected open set x of rd its subharmonic envelope is defined as 10 5 ge sup subharmonic 6 g it is well known that ge c x if x is convex and g c x then ge c x definition 10 3 for a function g we write qce g as the subharmonic envelope of qc g lemma 10 4 let a r the cost c x y is bounded from below and admit a modulus of continuity assume that all functions as a result of the c transforms are defined on bounded domains then for any subharmonic function on a bounded open set x rd with values in a qc qc qce qc qce qceqc qce proof assume without loss of generality that the cost c is nonnegative for any function g a on x it is easy to see that qc g a and qc g is bounded from below so it makes sense to consider subharmonic envelopes of these functions as a result of qc and qc transforms recalling a 1 a 2 we have qc qc 6 qc qc 42 young heon kim and yuan long ruan it follows that i qc qce 6 ii qce qc note in obtaining ii the fact that is subharmonic is used while in obtaining i the subharmonicity of is not used now applying qc on both sides of ii we have qc qce qc qc since qc is bounded from below we may replace with qc in i and obtain qc qce qc 6 qc therefore qc qc qce qc simiarly applying qce on both sides of i qceqc qce 6 qce since qce is subharmonic qce cannot take we may then replace with qce in ii to get qceqc qce qce therefore qce qceqc qce lemma 10 4 is crucial for the dual attainment for forward subharmonic order projection it enables us to use a verison of double convexification trick note that the optimal solution in this case is lipschitz and subharmonic theorem 10 5 let x y be bounded convex open subsets of rd p ac x and p y then there exists 0 ash lip x which achieves the supremum of the dual value d 2 psh 6 sup ash cb x x d y q 2 d proof in view of lemma 10 4 and theorem 9 3 d 2 psh 6 sup ash cb x d y q 2 q 2 e q 2 d 6 sup ash cb x q 2 e q 2 d y q 2 q 2 e q 2 d sup a 1 sh cb x d y q 2 d 6 d 2 psh 6 where a 1 sh q 2 e q 2 for some ash ash let n a 1 sh sb be a maximizing sequence i e n q 2 e q 2 n for some n ash note that similar to theorem 10 1 q 2 n and q 2 q 2 n are lipschitz continuous with a common lipschitz constant inherited from the cost function in view of 14 theorem 2 or 33 n and q 2 n are lipschitz continuous with a common lipschitz constant now we can assume without loss of generality that max x n x 0 n wasserstein projection 43 therefore the sequence n and thusq 2 n are uniformly bounded and equicontinuous by arzela ascoli theorem we may suppose that it holds uniformly that n 0 q 2 n q 2 0 where 0 is a lipschitz continuous subharmonic function it follows that y q 2 n y d y q 2 0 y d therefore d 2 psh 6 lim n x n x d y q 2 n y d x 0 x d y q 2 0 y d 6 d 2 psh 6 the last inequality uses the fact that 0 ash cb thus 0 is an optimal dual solution and if we repeat the inequalities at the beginning of the proof then we can see that 0 satisfies 0 q 2 e q 2 0 it seems a similar proof cannot be applied to the backward dual attainment using the operator q 2 e defined similarly to q 2 e definition 10 3 to make the trick work we will need the idenity q 2 q 2 q 2 e q 2 however in general we only have q 2 q 2 q 2 q 2 11 characterization of subharmonic order projections in parallel with section 7 we show that the optimal mappings for backward and forward subharmonic order projecitons are characterized by laplacian contraction and laplacian expansion definition 11 1 laplacian contraction let be a proper lower semicon tinuous convex function we call a laplacian contraction if for some proper function such that is bounded from below and d in the sense of distribution definition 11 2 laplacian expansion let be a proper lower semicontinu ous convex function we call a laplacian expansion if for some proper function such that is bounded from below and 6 d in the sense of distribu tion remark 11 3 note the definition of laplacian contraction and laplacian expan sion are consistent with that of the convex contraction and convex expansion defined in section 7 and the use of legendre transform instead of the function itself is es sential for subharmonic order case while d 2 id implies d 2 6 id lemma a 2 it is not generally true that id implies 6 id laplacian expansion has a simple but significant geometric consequence lemma 11 4 let be a laplacian expansion then the map satisfies detd 2 x 1 a e x this explains the term expansion since the mapping increases volumes more over if absolutely continuous w r t the lebesgue measure then so is in addition still using to denote their respective densities x 6 x a e x 44 young heon kim and yuan long ruan proof let be a function such that is bounded from below and 6 d 1 first consider the case where is convex an important observation is that from the arithmetic geometric inequality we have for convex detd 2 x 1 d 6 1 d x a e x here we used the almost second order differentiability of convex functions then 6 d implies 11 1 detd 2 x 1 d 6 1 a e x recall that is equivalent to e 1 e d x for any measurable e where 1 e denotes the inverse image of e we infer from 11 1 that e f if is absolutely continuous then so is still using to denote their respective density we then have x 6 x a e x which means the target density gets smaller than the source under the mapping 2 now consider the case where the convexity of is not sassumed note the function is convex and we have x 6 x on s x x x moreover which is nothing but is the inverse map almost surely to if a point x is mapped by the optimal map from to outside of the contact set s then the point x belongs to the set where is not differentiable and this set has zero mass so zero mass under by absolute continuity therefore what happens outside the contact set s does not affect the densities as a result we can replace with in step 1 and follow the same argument there to conclude the same result for a similar argument does not work in the laplacian contraction case since we cannot use the arithmetic geometric inequality as above 11 1 backward projection theorem 11 5 let x y be bounded convex open subsets of rd p x and p ac y assume that the conditions of theorem 10 1 are satisfied and ash l 1 y d is the optimal dual solution for d 2 psh 6 obtained there then the unique projection of onto psh 6 is given by 0 where 0 y 1 2 y 2 1 2 y proof we skip the proof since it is similar to theorem 7 6 only note that since q 2 l 1 x d it is finite for a e x hence 0 is finite for a e x then we can use the absolute continuity of to infer the desired conclusion wasserstein projection 45 theorem 11 6 let x y be bounded convex open subsets of rd p x and p ac y assume that the conditions of theorem 10 1 are satisfied consider the following statements i the projection of onto psh 6 is ii there is a laplacian contraction such that we always have that i implies ii if in ii is such that cb and d then ii implies i proof that i implies ii follows from 11 5 to see the reverse implication we note by definition of laplacian contraction there is a function such that is bounded from below d and define y 2 y y 2 2 y y 2 then is continuous and subharmonic by assumption using the convexity of we can write x x x x a e x therefore similar to theorem 7 7 we have t 2 6 x 2 2 x d 2 y y 2 d q 2 x d y d is subharmonic by ii 6 sup g ash cb q 2 g x d g y d 6 t 2 which shows that is an optimizer of d 2 psh 6 then the desired conclusion follows 11 2 forward projection theorem 11 7 let x y be bounded convex open subsets of rd p ac x and p y assume that ash lip x is the optimal dual solution for d 2 psh 6 obtained in theorem 10 5 then the unique projection of onto psh 2 6 is given by 0 where 0 x 1 2 x 2 1 2 x we omit the proof since it is similar to theorem 7 6 theorem 11 8 let x y be bounded convex open subsets of rd p ac x and p y consider the following statements i the projection of onto psh 6 is ii there is a laplacian expansion such that we always have that i implies ii if in ii is such that cb and 6 d then ii implies i proof that i implies ii follows from 11 7 to see the reverse implication we note by definition of laplacian expansion there is a function such that is bounded from below 6 d and define x x 2 2 x x 2 2 x then the rest of the proof follows as in theorem 11 6 46 young heon kim and yuan long ruan appendix a c transforms we recall a few properties of the c transforms qc and qc qc g x inf y y g y c x y qc g y sup x x g x c x y it is well known that qc preserves lipschitz continuity convexity and concavity since qc g qc g qc has the same properties as qc moreover for any function g y 7 r a 1 qc qc g 6 g and for any function g x 7 r a 2 qc qc g g in particular a 3 qc g qc qc qc g qc g qc qc qc g when c x y x y 2 the c transforms are written q 2 q 2 lemma a 1 let g be a function defined in a subset of rd the following identities hold i for x rd q 2 g x x 2 2 g 0 x where g 0 y 1 2 y 2 1 2 g y ii for y rd q 2 g y 2 g 0 y y 2 where g 0 x 1 2 x 2 1 2 g x proof straightforward calculations yield q 2 g x inf y g y x y 2 inf y g y y 2 2 x y x 2 x 2 2 sup y x y 1 2 y 2 1 2 g y x 2 2 g 0 x similarly q 2 g y sup x g x x y 2 sup x g x x 2 2 x y y 2 2 sup x x y 1 2 x 2 1 2 g x y 2 2 g 0 y y 2 lemma a 2 let g rd 7 r be a function i if 1 2 x 2 g x is convex then g y 1 2 y 2 is convex ii if g y 1 2 y 2 is convex then 1 2 x 2 g x is convex iii if g is a lower semicontinuous proper convex function then 1 2 x 2 g x is convex if and only if g y 1 2 y 2 is convex wasserstein projection 47 in either case of iii we have g c 1 in matrix form iii can be rewritten as d 2 g 6 id if and only if d 2 g id second order derivatives of convex functions are understood in distributional sense and id is the d d identity matrix proof i and ii follow from the straighforward calculations q 2 x 2 2 g y sup x x 2 2 g x x y 2 2 g y y 2 and q 2 2 g y 2 x inf y 2 g y y 2 x y 2 x 2 2 g x if g is a lower semicontinuous proper convex function then g g so iii follows from ii if either case of iii is true then g y g y 1 2 y 2 1 2 y 2 is uniformly convex hence g g c 1 appendix b convergence of subharmonic functions the following result is adapted from 27 theorem 4 1 9 to serve its purpose in our setting lemma b 1 let x be a connected open subset of rd and n a sequence of subhar monic functions such that x n dx is bounded by some constant a 0 then up to a subsequence n converges almost surely to a subharmonic function l 1 x dx in the usual sense of definition 9 1 proof 1 by identifying l 1 x dx with a subset of m x we may assume that n converges weakly to some m x since n is subharmonic n is a non negative distribution thus a nonnegative measure by 27 theorem 2 1 7 hence we may also assume that n converges weakly to some nonnegative distribution 0 then for any c 0 x x d x lim n x ndx lim n x ndx x d x therefore 0 in the sense of distribution by 27 theorem 4 1 8 is a subharmonic function l 1 loc x dx in the usual sense of definition 9 1 2 let br x 6 r 0 and 0 6 c 0 rd be a radially symmetric function supported in b 1 such that 1 given a compact set k x we claim that as n b 1 n x x uniformly for x k by assumption b 2 n dx 6 a sup x c 0 k where k is the compact set given by k b is small so that k x since n converges to the function in distribution it follows that b 3 dx 6 a sup x c 0 k 48 young heon kim and yuan long ruan let 0 since k is compact there is a finite net knet xj j 1 n k satisfying for each x k there is a xj 0 knet such that 2 a sup z rd x z xj 0 z 6 2 this is feasible since is uniformly continuous on rd for each xj knet we have n xj n z xj z dz z xj z dz hence there is n 0 such that n xj xj 6 2 for j 1 n n n 0 therefore for x k n n 0 and some xj 0 knet depending on x n x x 6 n x x n xj 0 xj 0 2 n z z x z xj 0 z dz 2 6 2 a sup z rd x z xj 0 z 2 6 note the second inequality is due to the fact that z 7 x z xj 0 z is a function in c 0 k so that b 2 b 3 apply 3 let k c 0 x such that 0 6 k 6 1 and k 1 on k let 0 and 0 be smaller than the distance between x and supp k by the definition of in step 2 and the subharmonicity n x n x x x x k together with b 1 this implies that for large n x n x 0 x x 0 x k then for x k n x x 6 n x x k x 6 x n x k x x x k x x n x k x x x k x therefore lim sup n k n dx 6 2 x kdx sending 0 0 we obtain n in l 1 k dx since k is an arbitrary compact set it follows that n in l 1 loc x dx 4 since the open set x can be covered by a countable number of closed balls on each of these balls we may extract a subsequence of n which converges almost wasserstein projection 49 surely to utilizing a diagonal precedure we obtain that up to a subsequence n converges to almost surely by fatou lemma lim inf n x n dx x dx hence l 1 x dx references 1 aure lien alfonsi jacopo corbetta benjamin jourdain et al sampling of probability mea sures in the convex order by wasserstein projection annales de l institut henri poincare probabilite s et statistiques 56 2020 no 3 1706 1729 2 j j alibert guy bouchitte and thierry champion a new class of costs for optimal transport planning european journal of applied mathematics 30 2019 no 6 1229 1263 3 luigi ambrosio nicola gigli and giuseppe savare gradient flows in metric spaces and in the space of probability measures springer science business media 2008 4 julio backhoff veraguas mathias beiglbo ck and gudmun pammer existence duality and cyclical monotonicity for weak transport costs calculus of variations and partial differential equations 58 2019 no 6 1 28 5 julio backhoff veraguas mathias beiglbo ck gudmund pammer et al weak monotone re arrangement on the line electronic communications in probability 25 2020 6 julio backhoff veraguas and gudmund pammer stability of martingale optimal transport and weak optimal transport arxiv preprint arxiv 1904 04171 2019 7 mathias beiglbo ck alexander mg cox and martin huesmann optimal transport and sko rokhod embedding inventiones mathematicae 208 2017 no 2 327 400 8 mathias beiglbo ck pierre henry laborde re and friedrich penkner model independent bounds for option prices a mass transport approach finance and stochastics 17 2013 no 3 477 501 9 patrick billingsley convergence of probability measures john wiley sons 2013 10 malcolm bowles and nassif ghoussoub mather measures and ergodic properties of kantorovich operators 2019 http www birs ca nassif papers download bowles ghoussoub 11 08 19 bowles ghoussoub 11 08 19 pdf 11 yann brenier polar factorization and monotone rearrangement of vector valued functions communications on pure and applied mathematics 44 1991 no 4 375 417 12 martin bru ckerhoff and nicolas juillet instability of martingale optimal transport in dimen sion d 2 arxiv preprint arxiv 2101 06964 2021 13 dmitri burago iu d burago yuri burago sergei ivanov sergei v ivanov and sergei a ivanov a course in metric geometry vol 33 american mathematical soc 2001 14 la caffarelli the obstacle problem revisited journal of fourier analysis and applications 4 1998 no 4 383 402 15 luis a caffarelli monotonicity properties of optimal transportation and the fkg and related inequalities communications in mathematical physics 214 2000 no 3 547 563 16 ori davidov and shyamal peddada the linear stochastic order and directed inference for multivariate ordered distributions annals of statistics 41 2013 no 1 1 17 hammou el barmi and hari mukerjee inferences under a stochastic ordering constraint the k sample case journal of the american statistical association 100 2005 no 469 252 261 18 max fathi nathael gozlan and maxime prodhomme a proof of the caffarelli contraction theorem via entropic regularization calculus of variations and partial differential equations 59 2019 no 96 19 alfred galichon pierre henry labordere nizar touzi et al a stochastic control approach to no arbitrage bounds given marginals with an application to lookback options the annals of applied probability 24 2014 no 1 312 336 20 nassif ghoussoub young heon kim and tongseok lim optimal brownian stopping when the source and target are radially symmetric distributions siam journal on control and optimization 58 2020 no 5 2765 2789 21 nassif ghoussoub young heon kim and aaron zeff palmer pde methods for optimal sko rokhod embeddings calculus of variations and partial differential equations 58 2019 no 3 1 31 http www birs ca nassif papers download bowles ghoussoub 11 08 19 bowles ghoussoub 11 08 19 pdf http www birs ca nassif papers download bowles ghoussoub 11 08 19 bowles ghoussoub 11 08 19 pdf 50 young heon kim and yuan long ruan 22 a solution to the monge transport problem for brownian martingales the annals of probability 49 2021 no 2 877 907 23 nathael gozlan and nicolas juillet on a mixture of brenier and strassen theorems proceed ings of the london mathematical society 120 2020 no 3 434 463 24 nathael gozlan cyril roberto paul marie samson yan shu prasad tetali et al charac terization of a class of weak transport entropy inequalities on the line annales de l institut henri poincare probabilite s et statistiques 54 2018 no 3 1667 1693 25 nathael gozlan cyril roberto paul marie samson and prasad tetali kantorovich dual ity for general transport costs and applications journal of functional analysis 273 2017 no 11 3327 3405 26 gaoyue guo jan ob lo j et al computational methods for martingale optimal transport problems annals of applied probability 29 2019 no 6 3311 3347 27 lars ho rmander the analysis of linear partial differential operators i springer science business media 1980 28 tobias johnson and matthew junge stochastic orders and the frog model annales de l institut henri poincare probabilite s et statistiques 54 2018 no 2 1013 1030 29 nicolas juillet stability of the shadow projection and the left curtain coupling annales de l institut henri poincare probabilite s et statistiques 52 2016 no 4 1823 1843 30 young heon kim and emanuel milman a generalization of caffarelli s contraction theorem via reverse heat flow mathematische annalen 354 2012 no 3 827 862 31 elliott h lieb michael loss et al analysis volume 14 of graduate studies in mathematics american mathematical society 2001 32 anton petrunin harmonic functions on alexandrov spaces and their applications electronic research announcements of the american mathematical society 9 2003 no 17 135 141 33 yuanlong ruan regularity of subharmonic envelope in preparation 34 paul marie samson concentration of measure principle and entropy inequalities convexity and concentration 2017 pp 55 105 35 moshe shaked and j george shanthikumar stochastic orders springer science business media 2007 36 volker strassen the existence of probability measures with given marginals the annals of mathematical statistics 36 1965 no 2 423 439 37 edward szpilrajn remarques sur les fonctions sousharmoniques annals of mathematics 1933 588 594 38 ce dric villani topics in optimal transportation american mathematical soc 2003 university of british columbia vancouver canada email address yhkim math ubc ca beihang university beijing china email address ruanyl buaa edu cn