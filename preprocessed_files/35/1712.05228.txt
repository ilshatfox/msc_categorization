isogeometric shape optimization for nonlinear ultrasound focusing markus muhr vanja nikolic barbara wohlmuth and linus wunderlich technical university of munich department of mathematics chair of numerical mathematics boltzmannstra e 3 85748 garching germany abstract the goal of this work is to improve focusing of high intensity ul trasound by modifying the geometry of acoustic lenses through shape opti mization the shape optimization problem is formulated by introducing a tracking type cost functional to match a desired pressure distribution in the focal region westervelt s equation a nonlinear acoustic wave equation is used to model the pressure field we apply the optimize first then discretize approach where we first rigorously compute the shape derivative of our cost functional a gradient based optimization algorithm is then developed within the concept of isogeometric analysis where the geometry is exactly represented by splines at every gradient step and the same basis is used to approximate the equations numerical experiments in a 2 d setting illustrate our findings 1 introduction high intensity focused ultrasound hifu has become a powerful medical tool in recent years and a research area under active development as a non invasive thera peutic technology it is used for breaking up kidney stones by lithotripsy 43 56 64 and it is currently involved in various stages of clinical trials for treatments of cancer in different organs including the kidney liver prostate and brain 2 29 37 38 63 focusing in ultrasound applications is achieved geometrically with lenses or spherical focusing arrays of piezoelectric transducers see 36 and figure 1 for ge ometry description such setups can naturally benefit from shape optimization we can find the shape of the lens or the transducer surface which results in a desired pressure distribution around the focal point the lens design has been quite often determined by heuristic laboratory based approaches 46 49 65 the goal of the present work is to improve the focusing of high intensity ultrasound by employing a shape optimization approach to modify geometry of a focusing lens the use of high power ultrasound sources enhances nonlinear effects in the wave propagation inducing the formation of a sawtooth shape of the wave and generation of higher harmonics when the focused acoustic wave propagates toward the focal point its amplitude increases in a nonlinear fashion shape optimization for prob lems depending on linear partial differential equations is a well explored topic see for instance 24 66 for results concerned with analysis in the continuous setting and works 23 41 54 which tackle numerical aspects investigations of nonlinear problems are not as common we refer for example to 21 for the treatment of an optimal design problem in nonlinear magnetostatics and 3 for optimization of 1991 mathematics subject classification primary 35 49 secondary 49 q 10 35 l 05 key words and phrases shape optimization wave equation nonlinear acoustics isogeometric analysis focused ultrasound corresponding author vanja nikolic 1 ar x iv 1 71 2 05 22 8 v 1 m at h o c 1 4 d ec 2 01 7 2 markus muhr vanja nikolic barbara wohlmuth and linus wunderlich instationary navier stokes flow results on gradient based shape optimization for problems depending on second order hyperbolic equations are mainly restricted to the analysis with some numerical results available for linear problems in 45 an optimal design problem governed by a linear damped one dimensional wave equation was investigated results on optimal design for the support of the control for the 2 d linear wave equation can be found in 44 in 52 shape sensitivity analysis was provided for the problem of optimizing the shape of the acoustic lens the case of ultrasound focusing by a concave array of transducers was treated analytically in 34 first steps toward numerical shape optimization for linear ultrasound were made in 61 numerical treatment of the shape optimization problems for nonlinear ultrasound has to the authors best knowledge been missing up to now another goal of the present work is to investigate shape optimization subject to nonlinear waves within the concept of isogeometric analysis isogeometric analysis iga was introduced by hughes et al in 9 27 the idea behind iga is that the non uniform rational b spline nurbs basis used to model geometry is also used as a basis for the desired solution the idea of using spline functions for the approximation of partial differential equations can even be found in earlier works see e g 25 and references therein however with iga geometry and analysis always go hand in hand which is convenient especially for shape optimization nu merical isogeometric shape optimization has been by now applied to a number of linear problems arising in fluid mechanics 53 electromagnetic scattering 51 and structural mechanics 6 39 62 while foundations of a mathematical framework for shape optimization problems within isogeometric analysis were laid out in 19 20 in comparison to classical shape optimization methods shape optimization based on the isogeometric approach offers several advantages even complex geometries can be represented precisely by multi patch nurbs geometries and the output of the optimization can then directly be exported to a computer aided design cad sys tem in addition nurbs bases can easily achieve higher order of global regularity than classical finite element bases lens focal point fluid excitator focal point fluid piezoelectric transducers figure 1 sketches of different ultrasound focusing approaches left focusing by a lens right focusing by an array of transducers placed on a curved surface nonlinear ultrasound focusing 3 the rest of the paper is organized as follows in section 2 we formulate the shape optimization problem together with its underlying nonlinear wave equation section 3 contains basics of shape calculus and provides a result on continuity of the state with respect to domain perturbations that will be needed to formally compute the derivative section 4 is then dedicated to the calculation of the shape derivative of the cost function in section 5 we give a brief overview of the isogeometric analysis and then introduce the numerical schemes we use to solve our state and adjoint problems the shape optimization algorithm is presented in section 6 finally in section 7 we illustrate the efficiency of our algorithm through several numerical experiments 2 problem setting to properly capture the nonlinear propagation behavior see figure 2 we have to employ a model of nonlinear acoustic for computing the pressure field there is a number of so called weakly nonlinear models in nonlinear acoustics obtained as a one equation approximation of the compressible navier stokes system in the present work we will employ a classical model the westervelt equation to compute the acoustic pressure u u c 2 u b u 2 k u 2 uu in the equation c denotes the speed of sound in the medium and b the diffusivity the strong b damping in the model accounts for the energy losses that occur due to viscosity and thermal conductivity of the medium the coefficient k is given by k 1 c 2 1 1 2 b a where is the mass density here the parameter of nonlinearity b a accounts for the nonlinear pressure density relation up to second order and indicates the strength of the nonlinearity of a medium values of b a for different nonlinear fluids and gases are given for example in 59 a detailed derivation of the model from the governing equations and an overview of well established acoustic models can be found for instance in 10 36 0 0 02 0 04 0 06 0 08 0 1 0 12 80 60 40 20 0 20 40 60 80 linear wave nonlinear wave figure 2 formation of a saw tooth pattern of a nonlinear wave in a channel setting with a sinusoidal excitation signal compared to a linear wave propagation 4 markus muhr vanja nikolic barbara wohlmuth and linus wunderlich typically in ultrasound applications the acoustic lens is immersed in an acoustic fluid let rd d 1 2 3 be a fixed bounded domain with lipschitz bound ary and l its subdomain representing the lens such that l and l has lipschitz boundary l see figure 3 we denote by f l the part of the domain representing the fluid region l f then represents the interface between l and f the magneto mechanical excitation will be modeled by neumann boundary con ditions on the part of the boundary denoted n u n g on n where n represents the outer unit normal to an important issue in acoustics is how to truncate an open domain problem to a bounded domain rd d 1 2 3 without causing spurious reflections of the waves in this work we will employ the zero order enquist majda absorbing boundary conditions 13 u c u n 0 on a where a n denotes the part of the boundary with absorbing conditions prescribed in what follows we will denote by nl the unit outer normal to the lens domain l restriction of a function v to i will be denoted by vi where i l f and jvk vl vf will stand for the jump over the interface the acoustic pressure can be calculated via the following initial boundary value problem u div c 2 u div b u 2 k u 2 uu in l f juk 0 on r c 2 u nl b u nl z 0 on u n g on n u c u n 0 on a u u t 0 0 0 1 the coefficients are assumed to be piecewise constant functions i e 2 c x l x cl 1 l x cf b x l x bl 1 l x bf k x l x kl 1 l x kf cl f 0 bl f 0 kl f r k 2 l k 2 f 6 0 where l is the indicator function of l throughout the paper we assume that t 0 t with a finite time horizon t in order to simplify the presentation and in accordance with ultrasound applications we have set the initial conditions to zero nonlinear ultrasound focusing 5 nl l d f n a a a figure 3 domain consisting of lens l and fluid f we will study the variational form of 1 given by find u x h 2 0 t l 2 h 1 0 t h 1 such that t 0 u c 2 u b u 2 k u 2 uu dx ds t 0 a cu b c u dx ds t 0 n c 2 g bg dx ds 0 for all test functions x l 2 0 t h 1 and u u t 0 0 0 3 2 1 on the well posedness of 3 westervelt s equation is a strongly damped quasilinear wave equation an interesting feature of the model becomes more evi dent when rewritten as 1 2 ku u c 2 u b u 2 ku 2 if u 1 2 k the equation degenerates which means that special attention in the analysis has to be paid to obtaining a bound in the l norm for the pressure to keep it away from 1 2 k typically this is resolved by a higher regularity result and an embedding e g h 2 l together with appropriate energy estimates for details we refer to various papers 32 33 34 47 dealing with well posedness of this model with constant coefficients under different boundary conditions going forward we assume that problem 3 is well posed locally in time and space assumption 1 we assume that there exists m 0 and a final time t 0 such that under sufficiently regular boundary data g problem 3 has a unique solution 6 markus muhr vanja nikolic barbara wohlmuth and linus wunderlich u u where 4 u u x u c 0 t l w 1 0 t h 1 tr a u h 1 0 t l 2 a u u t 0 0 0 u l 2 0 t l 2 m u l 0 t l 2 m u l 2 0 t l 2 m u l 0 t l a 1 2 k l well posedness of the problem 3 with constant coefficients c b k 0 was shown to hold in 34 theorem 2 with a solution u u l 0 t h 3 2 s s 0 1 2 however well posedness in the case of piecewise constant coefficients is to the authors best knowledge still an open problem the main difficulty is that the h 3 2 s regularity in space which is employed to avoid degeneracy is too high to achieve when the normal derivative of the pressure is allowed to jump as is the case in our problem note that the last condition in 4 is imposed to ensure that the degeneracy of the model is avoided in practice this condition is easily fulfilled since the coefficient k is quite small for instance in water k 1 5 10 9 s 2 m kg whereas the maximal pressure values in hifu applications typically do not exceed 80 mpa 5 36 49 this will be reflected in our numerical experiments as well 2 2 the shape optimization problem we will consider a shape optimization problem of the following form min u l j u l s t e u l 0 u u l oad 5 with u defined as in 4 for the objective function we choose an l 2 tracking type functional j u l t 0 u ud 2 d dx ds 6 with d being a fixed bounded lipschitz domain d f where the pressure distributions should match see figure 3 the constraint is given by e u l x x t 0 u c 2 u b u 2 k u 2 uu dx ds t 0 a cu b c u dx ds t 0 n c 2 g bg dx ds we assume that the desired pressure ud l 2 0 t l 2 h 1 0 t h 1 where h 1 denotes the dual space of h 1 together with the assumed regularity of the state we have u ud l 2 0 t l 2 the set of admissible domains oad can be defined as oad l l l is open and lipschitz with uniform lipschitz constant lo it can be shown that this set is compact with respect to the hausdorff metric cf 24 theorem 2 4 10 nonlinear ultrasound focusing 7 remark 1 from the point of view of applications it is crucial that the target pressure is reached around the focal point which is why we demand that the acoustic pressure achieves prescribed values in a fixed subregion d this means that our cost functional is compactly supported the class of shape optimization problems with an l 2 d tracking cost functional subject to poisson equation with either dirichlet or neumann data are well investigated and known to be ill posed 14 15 22 the problems were proven to be unstable by considering the shape hessian and showing that it is not strictly h 1 2 coercive at the critical domain in our setting however the fixed domain d does not intersect the domain l subject to optimization the numerical experiments we conducted were shown to be effective without any regularization which is why we do not introduce it here 2 3 the adjoint problem since we will use the adjoint approach to compute the shape derivative here we investigate the adjoint problem given by the very weak in time form eu u l p x x t 0 j u dxds with x j u u ud 2 d the weak form of the adjoint problem is then given by t 0 1 2 ku p c 2 p b p dx ds t 0 a cp b c p dxds 2 t 0 u ud d dx ds for all x l 2 0 t h 1 with p p t t 0 0 7 proposition 1 let assumption 1 on well posedness of the state problem hold then for sufficiently small final time t 0 and m 0 with m as in 4 problem 7 has a unique solution p p h 2 0 t l 2 w 1 0 t h 1 tr a h 1 0 t l 2 a proof by time reversal p t p t t u t u t t u d t ud t t we can obtain a forward problem with initial conditions p p t 0 0 0 well posedness of a forward problem obtained in that way but with coefficients assumed to be constant c b k 0 was proven in 34 corollary 7 the proof is based on a fixed point argument together with galerkin faedo approximations in space and lower and higher order energy estimates by closely inspecting the proof we see that the well posedness result still holds with our piecewise constant coefficients assumed to be as in 2 3 shape calculus in order to define the shape derivative we take the well established approach of murat and simon 48 where changing domains are described by transformations of a reference domain to this end we introduce a fixed vector field c 1 1 rd 8 markus muhr vanja nikolic barbara wohlmuth and linus wunderlich with supp d and a family of transformations f 7 rd given by perturbations of the identity mapping f id r 8 there exists 0 0 such that for 0 f and f is a c 1 1 diffeomor phism cf 30 we define the perturbed lens as l f l and the perturbed lens boundary as f then is lipschitz continuous cf 26 theorem 4 1 and l for 0 due to assumptions on the boundary of and subdomain d remain fixed as changes for 0 0 we consider also the transported problem on the domain with the perturbed lens l e u l x x 0 with u u t 0 0 0 under assumption 1 on well posedness of the problem on the reference domain the transported problem has a unique solution the eulerian derivative of j at l in the direction of the vector field is defined as dj u l lim 0 1 j u l j u l it is said that the functional j is shape differentiable at l if dj u l exists for all c 1 1 rd and defines a continuous linear functional on c 1 1 rd since the shape derivative defines a linear and bounded functional according to the riesz representation theorem it has a unique representative in a hilbert space this representative is commonly referred to as the shape gradient i e the gradient is defined as the solution of j h dj u l h this allows a certain freedom in choosing the hilbert space h and in turn the descent direction a comparison of l 2 and weighted h 1 scalar products defined on the boundary can be found in 12 in the present work we will consider the common case h l 2 l for sufficiently small we then bring back the transported solution to the domain with the fixed lens by introducing u x t u f x t which will satisfy 9 t 0 1 2 ku u c 2 a u a ba u a 2 k u 2 i dx ds t 0 a cu b c u dx ds t 0 n c 2 g bg dx ds 0 for all x where we have employed the following notation i det df a df t nonlinear ultrasound focusing 9 with df being the jacobian of the transformation f note that we have made use of the fact that f vanishes on n a to end up with the boundary terms in 9 in what is to follow we will rely on some useful properties of f which we for the convenience of the reader recall here lemma 3 1 31 66 there exists 0 0 such that the mapping f defined by 8 has the following properties for 0 0 7 f c 1 0 0 c 1 rd 7 a c 0 0 c rd d 7 f 1 c 0 0 c 1 rd 7 i c 1 0 0 c furthermore it holds d d f 0 d d f 1 0 d d df 0 d d d df 1 0 d d a t 0 d d d i 0 div d d a 0 d t from lemma 3 1 it follows that there exist 0 1 2 0 such that 10 0 0 i x 1 for x 0 0 a l 2 0 0 note that we have used the fact that i det df 0 on for sufficiently small when applying the transformation of integrals formula to obtain 9 3 1 an auxiliary result on ho lder continuity we will compute the shape derivative of our pressure tracking shape functional by the so called variational ap proach introduced in 31 this method avoids the condition of shape differentia bility of the state variable by replacing it with ho lder continuity with respect to domain perturbations although the derivation of the volume representation of the shape derivative is analogous to the one presented in 52 we include it here for the sake of complete ness we remark however that the computation of the boundary representation of the shape derivative differs from 52 due to different boundary conditions influ encing piece wise regularity of the solution and a lack of nonlinear damping in the present model which allows for simplifications of the final derivative expression by employing the transformation of integrals formula it can be shown that u is uniformly bounded with respect to i e 11 u l 2 0 t l 2 0 d l 0 u l 2 0 t l 2 0 d l 0 m u l 0 t l 2 1 0 u l 0 t l 2 1 0 m u l 2 0 t l 2 1 0 u l 2 0 t l 2 1 0 m for all 0 0 with 0 being the lower bound of i as given in 10 similarly we have u l 0 t l u l 0 t l a 1 2 k l 10 markus muhr vanja nikolic barbara wohlmuth and linus wunderlich let us define x z w 1 0 t l 2 h 1 0 t h 1 z t 0 z t 0 0 tr a z l 0 t l 2 a theorem 3 2 under assumption 1 the solution of problem 3 is ho lder contin uous with exponent 1 2 with respect to domain perturbations i e it holds lim 0 u u 2 x 0 12 proof we begin by noting that the difference z u u satisfies 13 t 0 1 2 ku z c 2 z b z 2 k u u z 2 kz u dxds t 0 a cz b c z dx ds f u l x x for all x l 2 0 t h 1 where the right hand side is given by f u l x x t 0 i 1 1 2 ku u 2 k i 1 u 2 c 2 i 1 a u a a i u a u a i b i 1 a u a a i u a u a i dxds testing 13 by z 0 t x then leads to 1 2 1 2 ku t z t 2 dx 1 2 c 2 z t 2 dx 1 2 t 0 b z 2 dxds t 0 a c z 2 dxds 1 2 a b c z 2 dx t 0 2 k z z u u u z 2 dxds f u l z 0 t x x 2 k l c h 1 l 4 2 u l 2 0 t l 2 z l 0 t h 1 z l 2 0 t h 1 u l 0 t l 2 u l 0 t l 2 z 2 l 2 0 t h 1 f u l z 0 t x x in the last estimate we have made use of the continuous embedding h 1 l 4 cf 11 corollary 4 53 with the embedding constant c h 1 l 4 for further estimating the terms in the last line we employ z l 0 t h 1 t z l 2 0 t h 1 since z t 0 z t 0 0 to conclude that for sufficiently small m and final time t it holds 14 z 2 x c f u l z 0 t x x nonlinear ultrasound focusing 11 for some sufficiently large c 0 that does not depend on we can estimate the terms on the right hand side in 14 as follows 15 f u l z 0 t x x i 1 l 1 2 k l a u l 2 0 t l 2 z l 2 0 t l 2 2 k l c h 1 l 4 2 u 2 l 2 0 t h 1 z l 0 t l 2 i 1 l 22 a i l 1 2 c 2 l u l 2 0 t l 2 b l u l 2 0 t l 2 z l 2 0 t l 2 where a is defined as in 4 and 2 as in 10 recalling that u 0 0 we can further derive z l 2 0 t l 2 t z l 0 t l 2 u l 2 0 t l 2 t t u l 2 0 t l 2 which together with uniform boundedness of u in the sense of 11 leads to 16 f u l z 0 t x x c a m t i 1 l a i l z x by combining 16 with estimate 14 and then employing the properties of the mapping f from lemma 3 1 we first conclude that 17 lim 0 z x 0 secondly we divide 14 by 6 0 and then it remains to show that lim 0 f u l z 0 t x x 0 this now follows from estimate 16 lemma 3 1 and 17 4 shape derivative of the cost function next we will make use of the tools of shape calculus and the continuity result of the previous section to compute the shape derivative we will begin by calculating the derivative of j in terms of the volume integral over the whole domain which is sometimes regarded as the weak shape derivative proposition 2 let assumption 1 on the well posedness of the state problem hold and let ud l 2 0 t l 2 h 1 0 t h 1 the volume representation of the shape derivative of j at l in the direction of c 1 1 rd where supp d is given by 18 dj u l t 0 c 2 ut b u t d t p d p dx ds t 0 1 2 ku u p c 2 u p b u p 2 k u 2 p div dx ds 12 markus muhr vanja nikolic barbara wohlmuth and linus wunderlich proof by recalling the definition of the shape derivative and the fact that supp d together with the continuity result of theorem 3 2 we arrive at dj u l lim 0 1 t 0 u u 2 ud u u d dxds lim 0 1 t 0 2 u ud u u d dxds note that the last integral appears as the right hand side in the adjoint problem 7 when the test function is u u we employ again the notation z u u recalling that z t 0 z t 0 0 and p t t p t t 0 testing the adjoint problem 7 with z l 2 0 t h 1 and integrating by parts with respect to time leads to t 0 2 u ud d z dxds t 0 1 2 ku p z c 2 p z b p z dx ds t 0 a cp b c p z dxds t 0 1 2 ku z p c 2 z p b z p 4 ku z p 2 ku z p dx ds t 0 a cz b c z p dxds f u l p x x t 0 2 k z 2 z z p dxds where in the last line we have then also used the weak form 13 satisfied by z due to the continuity result of theorem 3 2 lim 0 1 t 0 2 k z 2 z z p dxds lim 0 1 t 0 2 k z z p dxds 0 and our computations reduce to dj u l lim 0 1 f u l p x x thanks to theorem 3 2 and lemma 3 1 it is straightforward to verify that lim 0 1 f u l p x x lim 0 1 f u l p x x 19 by employing lemma 3 1 again we can directly compute the limit on the right hand side of 19 which leads to the expression 2 4 0 1 imposing stronger regularity assumptions according to the hadamard zole sio structure theorem 66 theorem 3 5 when j u l and the domain are smooth enough the shape derivative can be represented in the form dj u l g x nl dx to be able to express the derivative in terms of an integral over the boundary of the lens we have to impose stronger assumptions with respect to regularity of u p nonlinear ultrasound focusing 13 ud and domains l f from this point on let l f be of class c 1 1 moreover we introduce the following assumption assumption 2 we assume that the state and the adjoint variable are sufficiently regular in space on each of the subdomains i e 20 u u u u l f h 1 0 t m l f p p p p l f h 1 0 t m l f where m is the linear space induced by the norm w m w h 1 w l 2 w n h s for some s 0 1 2 let us recall a useful identity that generalizes integration by parts inm which we will employ to transform expression 18 lemma 4 1 34 lemma 6 let r 3 be a domain of class c 1 1 for u v m and c 1 1 rd the following identity holds 21 idiv d d t u v dx u v v u dx u n v v n u dx u v n dx where n denotes the outer unit normal to we are now ready to state the main result theorem 4 2 let l and f be c 1 1 regular let assumption 1 on the well posedness of the state problem hold as well as assumption 2 on regularity of solutions to the state and the adjoint problems the shape derivative of j at l in the direction of the deformation field c 1 1 rd where supp d f l is then given by 22 dj u l t 0 2 j k kuu p j c 2 k ul pf j b k u l pf tnl dx ds where denotes the interface between l and f proof under assumption 2 we can rewrite the expression 18 for the weak shape derivative as the sum of integrals over l and f and directly apply formula 21 to the terms containing u p and u p the remaining terms containing div can be dealt with by employing integration by parts with respect to time and space 23 t 0 1 2 ku u p 2 k u 2 p div dx ds t 0 1 2 ku u p div dx ds t 0 j 1 2 ku u p k nl dx ds t 0 1 2 ku u p dx ds 14 markus muhr vanja nikolic barbara wohlmuth and linus wunderlich here we have also made use of the fact that u u t 0 p p t t 0 0 the last term in 23 can be further rewritten as t 0 1 2 ku u p dx ds t 0 1 2 ku u 2 ku 2 p 1 2 ku p u dx ds in this way we transform 18 into dj u l i l f t 0 i 1 2 kiui u i c 2 i ui bi u i 2 kiu 2 i pi dx ds i l f t 0 i 1 2 kiui p i c 2 i pi bi p i ui dx ds t 0 r 1 2 ku u p c 2 u p b u p z nl dx ds t 0 r c 2 u b u nl p z dx ds t 0 r c 2 p b p nl u z dx ds the first two sums on the right hand side vanish and we are left with 24 dj u l t 0 r 1 2 ku u p c 2 u p b u p z nl dx ds t 0 r c 2 u b u nl p z dx ds t 0 r c 2 p b p nl u z dx ds it is possible to slightly simplify expression 24 mimicking the steps taken in 30 section 3 2 if we denote by the tangential derivative then due to the interface conditions on it holds 25 r u z r p z 0 r c 2 u nl b u nl z r c 2 p nl b p nl z 0 hence we have the following identity r c 2 u b u nl p z r c 2 u nl p nl b u nl p nl z nl as well as r c 2 p b p nl u z r c 2 u nl p nl b u nl p nl z nl nonlinear ultrasound focusing 15 by plugging these identities into 24 and making use of juu p k 0 the derivative reduces to dj u l t 0 2 j k kuu p j c 2 u p b u p c 2 u nl p nl b u nl p nl z tnl dx ds furthermore due to conditions 25 on the interface and again the fact that u u t 0 0 0 and p p t t 0 0 it holds t 0 j c 2 k u p j b k u p r c 2 u nl p nl b u nl p nl z tnl dxds 1 2 t 0 j c 2 k ul pf uf pl j b k u l pf u f pl tnl dxds which helps us further to obtain dj u l t 0 2 j k kuu p 1 2 j c 2 k ul pf uf pl 1 2 j b k u l pf u l pf tnl dx ds lastly we can make use of the fact that again due to interface conditions 24 it holds t 0 j c 2 k ul pf j b k u l pf tnl dxds t 0 j c 2 k uf pl j b k u f pl tnl dxds which finally leads to 22 5 isogeometric analysis in this section we give a brief overview of basic concepts of isogeometric analysis which will be used to solve our state and adjoint problems and set the notation for future use for an in depth study of the isogeometric approach we refer the reader to classical literature 9 57 60 5 1 basics of b splines and nurbs 5 1 1 univariate b splines we begin by introducing a knot vector in one dimen sion 0 1 n l 1 1 where l is the polynomial order and n is the number of basis functions used to construct the b spline curve as knot values are allowed to repeat let us also introduce z 1 m as a knot vector without any repetitions z partitions 16 markus muhr vanja nikolic barbara wohlmuth and linus wunderlich the parameter space 0 1 into elements we will denote by bi q i 1 d b splines defined on recursively b i 0 x 1 if i x i 1 0 otherwise b i q x x i i q x b i q 1 x i q 1 x i q 1 i 1 b i 1 q 1 x l 1 2 3 where in case one of the denominators is zero the contribution is assumed to be zero and omitted the spline space can then be introduced as sq span b i q x i 1 d 5 1 2 multivariate b splines multivariate splines are defined as a tensor product of univariate b splines for every parametric direction s 1 d we introduce the number ns of univariate b spline functions the open knot vector s and the knot vector without repetitions zs to simplify exposition we assume that the degree l is the same in all directions then we can define multivariate knot vectors as follows 1 2 d z z 1 z 2 zd z forms a mesh of the parametric domain 0 1 d we define multivariate b spline functions for each multi index i i i i 1 id as follows b i q x b i 1 q x 1 b id q x d and the corresponding spline space is given by sl span b i q i i 5 1 3 nurbs going one step further nurbs are then introduced as rational functions of b spline functions this creates a possibility to exactly represent var ious geometries including conic sections which makes them especially popular in computer aided design cad for a set of positive weights wi i i we define the nurbs functions as n i q x wib i q x r i wrb r q x note that b splines are obtained as special cases of nurbs when all weights are equal 5 1 4 nurbs geometries for a given set of control points ci rd i i we can define a nurbs surface d 2 or a nurbs solid d 3 by taking a linear combination of nurbs basis functions g x i i cin i q x the nurbs geometry is then defined as g we note that in isogeometric analysis one map g takes the patch from the parameter space to the physical space however from an implementational point of view it still makes sense to speak about elements in which the domain gets divided through z since nonlinear ultrasound focusing 17 for instance quadrature nodes can then be defined in a uniform way for all the elements 5 2 description of the computational lens fluid domain in the multipatch setting in our numerical experiments we will assume that the problem is sym metric with respect to the y axis through the center of the lens hence it suffices to only discretize half of the domain and use symmetry boundary conditions at the y axis in practical examples computational domains are often described with several patches in our case the full half domain is decomposed into nptc 7 patches j j 1 nptc six of which represent water and one the lens region see figure 4 it is assumed that nptc j 1 j and j are assumed to be disjoint every patch has one map g j j 1 nptc which maps the parametric domain to the physical one since the pressure u is continuous across the interface but its normal derivative is not we assume that the meshes and the control points coincide on the interface and impose strong c 0 but not c 1 continuity between patches furthermore this assumption holds in every optimization step i e for every updated geometry 1 2 3 4 5 6 7 w b s k p r l x y figure 4 patches used for the discretization the lens domain is given by patch 3 5 3 numerical treatment of the state problem we will employ a semi discrete method where we discretize the space using a galerkin finite element scheme and formulate the problem for continuous time the main principle of isogeometric analysis is that the nurbs basis which we used to exactly model our domain also serves as the basis for the solution space of our numerical method following 1 in each patch j we define a discrete space v j h span n j i q n j i q g j 1 i i j j 1 nptc 18 markus muhr vanja nikolic barbara wohlmuth and linus wunderlich the discrete domain on the whole space will consist of continuous functions which restricted on each domain belong to v j h in other words we seek an approximate solution uh such that uh t vh v c v j v j h j 1 nptc t 0 t remark 2 one has to distinguish between a patch wise and a global set of degrees of freedom within an individual patch the numerical solution has the form uh j x t i i j n j i q x u i t if two patches are glued together due to our assumptions on coinciding control points and meshes it is possible to identify degrees of freedom with each other and also to add their respective ansatz functions for example when using two rectangular patches of 3 3 degrees of freedom each and aligning them on one common boundary we would have to identify the three degrees of freedom of that boundary of patch 2 with the respective degrees of freedom of patch 1 giving a total of 15 instead of 9 9 18 global degrees of freedom this approach ensures global continuity and hanging nodes are avoided in this global set of ansatz functions one introduces a new global numbering of degrees of freedom and calls the set of all global ansatz functions after identification on all interfaces i such that the global numerical solution can be written in the following way uh x t i i ni q x u i t where the ni q are the global ansatz functions after identification let us denote coefficients of a function u in the global nurbs basis by u u 1 u 2 undof t where time dependency is omitted for notational convenience after discretizing both state and domain with nurbs we arrive at the following semidiscrete for mulation of our state problem mu cu ku t u u t u u f a 1 u a 2 u u 0 0 u 0 0 26 where mass damping and stiffness matrices are defined by 1 computing m m 1 m 2 m 3 0 m 4 0 m 5 m 6 m 7 with m j j 1 nptc being the patch wise mass matrices defined by m j m j i 1 i 2 m j i 1 i 2 n i 1 n i 2 detdg j dx nonlinear ultrasound focusing 19 where dg j denotes the jacobian dg j t the inverse transposed of the patch wise mappings g j and we have omitted polynomial degree q of basis functions to simplify notation 2 secondly identifying degrees of freedom at interfaces by adding the respec tive rows and columns in the global matrix m for instance at the interface between patch 1 and 2 we add the rows corresponding to interface degrees of freedom of patch 2 to the respective ones of patch 1 and then remove them from the global matrix proceeding analogously with the columns and repeating the process for all interfaces we obtain m from m this corresponds to transforming m via m etm e where e is a rectangular matrix that only consists of ones and zeros we proceed in the same manner to obtain the damping matrix c and stiffness matrix k with the only difference being their patch wise definitions compared to the mass matrix i e c j c j i 1 i 2 c j i 1 i 2 b dg j t n i 1 dg j t n i 2 detdg j dx k j k j i 1 i 2 k j i 1 i 2 c 2 dg j t n i 1 dg j t n i 2 detdg j dx remark 3 even though the isogeometric approach does not rely on individual elements and hence mass and stiffness matrices can analytically be calculated as above via integrals over the whole parametric domain it is still more convenient to adopt the notion of elements from classical fea to the support boundaries of the individual nurbs basis functions that are given by z this speeds up the computation as the integrals are only evaluated over parts of the domain where the respective basis functions do not vanish in this sense one can also reformulate the definition of m j c j and k j in terms of the assembly operator known from classical finite elements with n j e being the number of such elements per patch m j n j e e 1 m j i 1 i 2 m j i 1 i 2 e ni 1 ni 2 detdg j dx c j n j e e 1 c j i 1 i 2 c j i 1 i 2 e b dg j t n i 1 dg j t n i 2 detdg j dx k j n j e e 1 k j i 1 i 2 k j i 1 i 2 e c 2 dg j t n i 1 dg j t n i 2 detdg j dx in the same way also the tensor t is defined as the global structure after interface identification of degrees of freedom of the patch wise tensors t j u n j e e 1 t j i 1 i 2 u t j i 1 i 2 u e 2 kn i 1 n i 2 ndof j i 3 1 n i 3 u i 3 detdg j dx 20 markus muhr vanja nikolic barbara wohlmuth and linus wunderlich and the right hand side vector and the matrices corresponding to the absorbing conditions are patch wise given as f j n j e e 1 f j i f j i en n i c 2 fg g j bf g g j dg j t n detdg j dx a j 1 n j e e 1 a j 1 i 1 i 2 a j 1 i 1 i 2 ea cf n i 1 n i 2 dg j t n detdg j dx a j 2 n j e e 1 a j 2 i 1 i 2 a j 2 i 1 i 2 ea cf bf n i 1 n i 2 dg j t n detdg j dx which are then as shown for m before put together into global structures f a 1 and a 2 by interface identification of degrees of freedom 5 4 time stepping scheme due to the nonlinear nature of our problem the higher harmonics of the fundamental frequency of the initial wave will grow with the distance from the source in numerical algorithms cutting off higher harmonics is known to cause spurious oscillations at the shock peaks this is often regarded as the gibbs phenomenon we tackle this issue by employing the generalized scheme for time stepping introduced first by chung and hulbert in 7 the generalized method allows to control the level of numerical dissipation of high frequencies with minimal unwanted damping in the low frequency range in this way the high frequency modes which are insufficiently resolved by the spatial or the temporal discretization are eliminated let 0 t 0 t 1 tm t be a given uniform partition of the time domain and let us define the time step as t tn 1 tn the method applied to the semi discrete equation 26 yields the modified equation 27 mu n 1 m cu n 1 f kun 1 f t u n 1 f u n 1 f t un 1 f u n 1 f fn 1 f a 1 u n 1 f a 2 u n 1 m where u n 1 m 1 m u n 1 mu n u n 1 f 1 f u n 1 f u n un 1 f 1 f un 1 fun and fn 1 f f 1 f tn 1 f tn note that we have adopted a mid point approach for the nonlinearities in 27 morover the classical newmark relations 50 are used un 1 un t u n 1 1 2 t 2 1 2 u n 2 u n 1 u n 1 u n t 1 u n u n 1 which will be numerically realized as a predictor corrector algorithm when m f 0 the time stepping reduces to the standard newmark scheme relations among parameters m f and that guarantee stability and desired dissipation levels are given in 16 for systems with nonlinear internal forces involving u but nonlinear ultrasound focusing 21 not its time derivatives adopting the strategy from 28 36 we define predictors for un 1 and u n 1 as follows upred un tu n t 2 2 1 2 u n u pred u n 1 tu n and the effective mass matrix m 1 m m 1 f tc 1 f t 2 k which leads to the following system 28 m u n 1 1 f upred fun c 1 f u pred f u n fn 1 f t u n 1 f u n 1 f t un 1 f u n 1 m a 1 u n 1 f a 2 u n 1 m the system 28 is nonlinear so we have to solve it by an iterative scheme fol lowing 36 we will employ a fixed point iteration with respect to the second time derivative note that the effective mass matrix remains unchanged during the time stepping an lu decomposition can therefore be performed once in the first time step while in subsequent steps matrix inversion is avoided algorithm 1 solving the state problem 1 t 0 n 0 2 un 0 u n 0 m u n fn cu n kun 3 compute the effective mass matrix 4 m 1 m m 1 f tc 1 f t 2 k 5 while t t do 6 perform predictor step 7 upred un tu n t 2 2 1 2 u n 8 u pred u n 1 tu n 9 0 10 u n 1 upred 11 u n 1 u pred 12 while u 1 n 1 u n 1 u 1 n 1 tolu do 13 solve the algebraic system of equations m u 1 n 1 fn 1 f k 1 f upred fun c 1 f u pred f u n t u n 1 f u n 1 f t u n 1 f u n 1 m a 1 u n 1 f a 2 u n 1 m 22 markus muhr vanja nikolic barbara wohlmuth and linus wunderlich 14 perform corrector step 15 u 1 n 1 upred t 2 u 1 n 1 16 u 1 n 1 u pred tu 1 n 1 17 7 1 18 end 19 n 7 n 1 t 7 t t 20 end 5 5 numerical treatment of the adjoint problem for solving the adjoint problem we will use the same nurbs space and the same time discretization as for the state solver let us denote by ud u 1 d u 2 d u ndof d t the coefficients of the target pressure ud in the nurbs base and by ud n the coef ficients at time step n after discretizing also the adjoint state with nurbs we obtain the semidiscrete formulation of our adjoint problem m t u p cp kp 2 md u ud a 1 p a 2 p p t 0 p t 0 29 the matrices m c k and tensor t in 29 are defined in the same way as for the state problem note that the integral appearing on the right hand side in the weak formulation 7 of the adjoint problem only needs to be numerically evaluated on the focal region d therefore in order to define the matrix md we first introduce md j m d j i 1 i 2 m d j i 1 i 2 n i 1 n i 2 detdg j d g j dx where j 1 nptc compared to m j now we only integrate over the part of d where the pressure is tracked this is expressed by the use of the characteristic function d taking the value 1 within d and 0 elsewhere we define md md 1 md 2 md 3 0 md 4 0 md 5 md 6 md 7 the matrix md is then obtained from md by again performing interface iden tification of degrees of freedom as it has been already done for the global mass damping and stiffness matrices although the adjoint problem is linear the modified mass matrix m t u is nonlinear ultrasound focusing 23 time dependent and thus would have to be inverted in every time step of our nu merical solver to avoid this computationally expensive step the adjoint problem is also solved iteratively the time stepping is performed backward in time by a newmark predictor corrector scheme to obtain p and thus ph as the solution the newmark parameters p and p for the adjoint problem are chosen in such a way that second order of accuracy is achieved algorithm 2 solving the adjoint problem 1 t t n number of time steps 2 p n 0 p n 0 p n 0 3 compute the effective mass matrix 4 m m p t c p t 2 k 5 while t 0 do 6 perform predictor step 7 p pred p n t p n t 2 2 1 2 p p n 8 p pred p n 1 p t p n 9 f n 1 2 m d un 1 u d n 1 10 0 11 p n 1 ppred 12 p n 1 p pred 13 res mp n 1 cp kp f n 1 t ud n 1 p n 1 a 1 p n 1 a 2 p n 1 14 while res tolp do 15 solve the algebraic system of equations m p 1 n 1 f n 1 cp pred kppred t ud n 1 p n 1 a 1 p n 1 a 2 p n 1 perform corrector step 16 p 1 n 1 p pred p t 2 p 1 n 1 17 p 1 n 1 p pred p t p 1 n 1 18 res mp 1 n 1 cp 1 kp 1 f n 1 t ud n 1 p 1 n 1 a 1 p 1 n 1 a 2 p n 1 19 7 1 20 end 21 n 7 n 1 t 7 t t 22 end 24 markus muhr vanja nikolic barbara wohlmuth and linus wunderlich 6 shape optimization algorithm having seen how to numerically solve the state and the adjoint problem we can now move to the general form of our optimization algorithm with step size control algorithm 3 shape optimization algorithm 1 input initial lens geometry 0 l 2 s 0 3 while sl is not optimal and s smax do 4 solve the state problem on the domain with lens sl 5 solve the adjoint problem on the domain with lens sl 6 compute the shape gradient 7 update geometry sl 7 s 1 new l with a descent step 8 if j s 1 new l j s l then 9 accept the new geometry s 1 l s 1 new l 10 if previous step did not need to be repeated then 11 make the step size larger 12 end 13 proceed to the next step s 7 s 1 14 else 15 decrease the step size 16 if stepsize tolstep then 17 stop accept the current geometry as the final one 18 else 19 goto 7 repeat with the current descent step 20 end 21 end 22 end the optimality condition in line 3 will in practice be realized by testing if the norm of the shape gradient at the current step is sufficiently small i e below a certain tolerance level tolgrad relative to the gradient norm at the first step we also introduce smax as the maximal number of gradient steps lines 8 to 21 in algorithm 4 describe the step size control where the new ge ometry is accepted if it is better than the previous one in the sense of the value of the cost function if not the update is repeated with a smaller descent step we introduce a lower step size bound tolstep so that the search for a smaller step can be stopped after a certain number of attempts when the cost and gradient norm don t decrease significantly anymore however if the newly obtained geometry is better than the previous one and there was no repetition of the previous step we allow the current descent step to become larger 6 1 updating geometry let us reflect on step 7 of algorithm 3 where the ge ometry is updated within the isogeometric approach shapes are easily changed by moving control points in our solver we restrict ourselves to a 2 d setting where nonlinear ultrasound focusing 25 control points corresponding to the lens boundary are treated as design variables we denote by i l the set of indices of degrees of freedom contributing to the boundary of the lens i e i l i i ni q l 6 0 in every optimization step control points ci xi yi i i l are moved in the y direction while they remain fixed in the x direction according to ynewi yi dj u h ph l ni q l ey 30 where is the current descent step and ey 0 1 t since we identify degrees of freedom on the interfaces the fluid boundaries common with the lens ones are moved in the same way whereas the others remain fixed in 30 we emphasized the dependence of the shape gradient on the solution of the adjoint problem when uh is the exact solution of the state and ph of the adjoint problem then dj uh ph l dj u l 6 1 1 extending the boundary changes to the interior after updating the lens boundary the internal control points of the lens and other patches are recomputed using the coons patch approach 58 let us denote the updated control points by cnewi xi y new i the updated boundary curves of for instance the lens patch are given by ltop x 1 i i l cnewi n i q x 1 1 lbottom x 1 i i l cnewi n i q x 1 0 lleft x 2 i i l cnewi n i q 0 x 2 lright x 2 i i l cnewi n i q 1 x 2 each mapping the parametric interval 0 1 to the respective boundary in the phys ical space a coons surface is then computed as a combination of the following three surfaces two ruled nurbs surfaces by linear interpolation of opposite boundary curves l 1 x 1 x 2 1 x 2 lbottom x 1 x 2 ltop x 1 l 2 x 1 x 2 1 x 1 lleft x 2 x 1 lright x 2 the bilinear nurbs surface interpolating between the corner points b x 1 x 2 1 x 1 1 x 2 g 0 0 1 x 1 x 2 g 0 1 x 1 1 x 2 g 1 0 x 1 x 2 g 1 1 the new patch mapping gnew is then defined as gnew x 1 x 2 l 1 x 1 x 2 l 2 x 1 x 2 b x 1 x 2 for simplicity we have omitted the index j of the current patch in notation above for instance g is used instead of g j to denote the current nurbs mapping we note that the construction of the coons patch can be motivated purely geometrically and is hence independent of the chosen coordinate frame 26 markus muhr vanja nikolic barbara wohlmuth and linus wunderlich remark 4 in the present work we do not employ tools to avoid mesh tangling since in our numerical experiments this unwanted effect was never present one possibility would be to use relative positioning when control points are moved only in the y direction as suggested in 19 7 numerical experiments we will now test our algorithm in two different scenarios in the first one we validate our code by creating artificial pressure data with a known goal shape for the lens and then trying to get back to that goal shape by starting the optimization process with a different lens geometry in the second scenario the goal shape will not be known and the target pressure distribution will be given analytically in both cases we will perform experiments with linear b splines where iga and classical fem coincide as well as quadratic splines in all the experiments we will keep the lens corner point fixed i e the shape will be pinned at the right corner the numerical results presented here have been obtained with the help of the geopdes package in matlab 17 7 1 coefficient values for all the performed tests the fluid is taken to be water the values of physical parameters in typical media can be found for instance in 18 59 the coefficients used in the experiments are provided in table 1 table 1 physical parameter values fluid lens cf 1500 m s cl 1100 m s bf 6 10 9 m 2 s bl 4 10 9 m 2 s f 1000 kg m 3 l 1250 kg m 3 b a 5 b a 4 the sound diffusivity in fluid bf and in lens bl are quite small relative to the am plitudes in the acoustic pressure field their influence on the damping of the wave was proven to be neglectable in all our numerical experiments 7 2 excitation for the source condition we consider a modulated sinusoidal wave cf 42 chapter 2 g g 0 e t 8 2 sin t in this way our waveform resembles the short tone bursts used in medical ultra sound practices while still being continuous in time and space we set the source amplitude value to be g 0 4 109 pa and frequency f 70 khz the angular fre quency is then given by 2 f figure 5 shows the propagation of the signal in an exemplary lens setting to ward the end of the geometry the steepening due to the nonlinear effects can be observed which is also where the focal point is assumed to be and where high pressure values are required nonlinear ultrasound focusing 27 figure 5 nonlinear wave propagation in the lens setting with steepening toward the end of the geometry the black lines in the picture show the position of the lens 7 3 test 1 exact solution since the analytical solution of our problem is not known we will generate artificial data for testing purposes using the same solver to generate data and then to invert the problem is known as committing the inverse crime 8 since it can cause unrealistically good solutions to avoid the inverse crime we produce the synthetic pressure data on a domain with lens shape l by solving the forward problem on a staggered grid compared to the grid that is used for the optimization process and pollute it with random gaussian noise of 2 of the maximal pressure amplitude l is then taken to be the exact lens shape and the artificially produced data the target pressure distribution ud 7 3 1 domain measures in the forthcoming numerical experiments we will use several lens shapes as initial 0 l and goal domains l table 2 lists all the specific measurements 28 markus muhr vanja nikolic barbara wohlmuth and linus wunderlich table 2 lens measurements l upper straight l upper curved l both perturbed l both down l gauss l 0 12 m l 0 12 m l 0 12 m l 0 12 m l 0 12 m b 0 05 m b 0 05 m b 0 05 m b 0 05 m b 0 05 m k 0 06 m k 0 06 m k 0 06 m k 0 06 m k 0 06 m w 0 04 m w 0 04 m w 0 04 m w 0 04 m w 0 04 m p 0 02 m p 0 015 m p 0 016 m p 0 021 m p 0 025 m s 0 09 m s 0 09 m s 0 09 m s 0 09 m s 0 09 m r 0 04 m r 0 04 m r 0 042 m r 0 037 m r 0 035 m the geometry parameters are diagrammed in figure 4 the curved lens boundaries are always chosen to be arc segments with horizontal tangents at the point belonging to the axis of symmetry unless stated otherwise the subregion d where the pressure should match ud is taken to be patch number 6 of our computational domain 7 3 2 spatial discretization table 3 specifies the number of degrees of freedom used in the numerical experiments table 3 spatial grid sizes spatial degrees of freedom linear nurbs quadratic nurbs ndofx 46 ndofx 48 ndofy 181 ndofy 185 ndof 7976 ndof 8484 here ndofx denotes the number of degrees of freedom in x direction and ndofy in y direction of the computational domain the overall number of degrees of freedom is denoted by ndof such a fine mesh is necessary to cope with the nonlinear effects in the focal region it amounts to about 35 elements in y direction per fundamental wavelength with this refinement we have 36 design control points for the upper as well as for the lower lens boundary 7 3 3 time stepping the time resolution as well as the generalized parameters used when solving the state problem are given in table 4 for the adjoint solver only the parameters p and p are relevant nonlinear ultrasound focusing 29 table 4 time integration and numerical parameter values time discretization method parameter tolerances final time t 90 s 0 75 0 45 tolu 10 6 ndoft 3801 p 0 5 p 0 25 tolp 10 8 t 23 684 ns m 1 2 f 1 3 tolgrad 10 4 such a fine time step is again needed to resolve the nonlinear behavior this refine ment amounts to about 600 time samples per fundamental time period around 7 iterations per time step were necessary to achieve convergence in the forward problem with the tolerance tolu in the adjoint solver typically 8 iterations were conducted to converge to a solution with the residual tolerance tolp 7 3 4 only upper lens boundary moving in our first test we fix the lower lens boundary to be already at its target position and only perturb the upper boundary to see if the algorithm can retrieve the goal shape in this simple setting for the initial shape we choose the one with a straight upper boundary 0 l l upper straight the goal shape is given by l l upper curved this is a thinner shape than the initial one so the upper boundary should move downward in order to reach its goal the exact domain measurements are given in table 2 let us introduce the discrete shape gradient j sl where s denotes the current gradient step as j sl dj uh sl ni q l ey i i l containing the discrete sensitivities of all boundary control points we are inter ested in the relative change of the cost functional j sl j 0 l and the relative change of the norm of the shape gradient j sl j 0 l over the course of optimization a scaling factor depending on the computational domain and the norm of the shape gradient has to be introduced to the descent step size to ensure that geom etry changes lead to a feasible lens shape i e a shape which is still contained within the domain and does not intersect itself its order of magnitude is taken to be 10 3 j sl we take the lower bound for the descent step to be tolstep 10 8 figure 6 depicts the final lens shape finall together with the initial shape 0 l and the desired goal shape l in figure 7 the evolution of the relative change of the cost over the course of optimization is plotted as well as the relative change of the norm of the shape gradient the cost starting from j 0 l 2 2762 10 5 30 markus muhr vanja nikolic barbara wohlmuth and linus wunderlich 0 0 005 0 01 0 015 0 02 0 025 0 03 0 035 0 04 0 045 0 035 0 04 0 045 0 05 0 055 0 06 0 065 0 07 final shape goal shape initial shape figure 6 final lens shape together with initial and goal shapes 5 10 15 20 25 0 0 2 0 4 0 6 0 8 1 5 10 15 20 25 0 0 2 0 4 0 6 0 8 1 figure 7 left relative cost change versus the number of gradi ent steps right norm of the shape gradient was reduced to j finall 2 7234 10 3 corresponding to a decrease of around 98 8 similarly the norm of the shape gradient was reduced by 99 99 of its initial value j 0 l 2 1886 10 7 we observe that the cost function and the geometry change rapidly in the beginning and then very little closer to the optimal shape such behavior is common for gradient flows see for instance 12 furthermore it can be observed that the cost values don t change significantly after the first 10 steps hence a termination criterion that would stop the algorithm sooner can be employed as a way of measuring errors in the lens shape we introduce the mean l 2 shape error cf 55 error 2 1 i l i i l ygoal i yi 2 nonlinear ultrasound focusing 31 5 10 15 20 25 0 0 5 1 1 5 2 2 5 10 3 figure 8 l 2 error over the course of optimization figure 8 shows the decay of this error versus the number of gradient steps 7 3 5 both lens boundaries moving for our second experiment we allow both the upper and lower lens boundary to move we start with an initial lens geometry 0 l l both perturbed where both lens boundaries are perturbed with respect to the goal shape unlike the previous case now the initial shape has to expand in order the match the target lens the exact domain measurements are again given in table 2 we will first as before perform tests where linear nurbs are used to obtain the synthetic data and then to solve the problem secondly we will employ quadratic nurbs to obtain the artificial pressure data and then solve the shape optimization problem in figures 9 12 we show the same quantities of interest as in the first example 0 0 005 0 01 0 015 0 02 0 025 0 03 0 035 0 04 0 045 0 035 0 04 0 045 0 05 0 055 0 06 0 065 0 07 final shape goal shape initial shape 0 0 005 0 01 0 015 0 02 0 025 0 03 0 035 0 04 0 045 0 035 0 04 0 045 0 05 0 055 0 06 0 065 0 07 final shape goal shape initial shape figure 9 final lens shape together with initial and target shape left linear nurbs right quadratic nurbs they exhibit a similar behavior the cost functional its gradient as well as the shape errors decay rapidly within the first few steps while almost no changes happen 32 markus muhr vanja nikolic barbara wohlmuth and linus wunderlich once the shape is close to its goal when using the linear nurbs the cost functional decreased by 97 85 of its initial value going from j 0 l 1 532 10 5 to j finall 3 298 103 the values are very similar in the quadratic nurbs case see figure 10 5 10 15 0 0 2 0 4 0 6 0 8 1 5 10 15 0 0 2 0 4 0 6 0 8 1 figure 10 relative change of the cost over the course of opti mization left linear nurbs right quadratic nurbs 5 10 15 0 0 2 0 4 0 6 0 8 1 5 10 15 0 0 2 0 4 0 6 0 8 1 figure 11 norm of the shape gradient over the course of opti mization left linear nurbs right quadratic nurbs 5 10 15 0 0 5 1 1 5 10 3 5 10 15 0 0 5 1 1 5 10 3 figure 12 l 2 shape error over the course of optimization left linear nurbs right quadratic nurbs nonlinear ultrasound focusing 33 7 3 6 local but not global minimum the third experiment with artificial data demonstrates that the final shape obtained with our algorithm does not necessarily have to be a global minimum we start with the initial lens with a straight upper boundary 0 l l upper straight and take the target lens to be l l both down see table 2 ideally both lens boundaries should move down during optimization in order to reach the target shape however it seems that our initial lens is already close to a local minimum the final shape is similar to the initial one and represents a local but not a global minimum however the decrease in cost is still significant going from j 0 l 1 388630 10 4 to j finall 3 200507 10 3 which amounts to a reduction of about 76 95 of the initial value the experiment was conducted with the linear nurbs the lens shapes and the relative change of the cost function are given in figure 13 0 0 01 0 02 0 03 0 04 0 05 0 03 0 035 0 04 0 045 0 05 0 055 0 06 0 065 0 07 final shape goal shape initial shape 1 2 3 4 5 6 7 0 0 2 0 4 0 6 0 8 1 figure 13 left initial final and goal shape the final shape is a local but not a global minimum right relative cost decay 7 4 test 2 unknown solution we now proceed to the case where the goal shape is not known we assume the desired focal point to be on the axis of symme try with coordinates 0 yfp t and associate with it the desired pressure distribution ud finding an adequate analytical expression for the nonlinear target pressure dis tribution is challenging ideally ud should assign high pressure values to the region around the focal point and low values elsewhere we will employ a stationary gauss ian centered around 0 yfp t with a scaling factor in the order of magnitude of the maximal pressure amplitude within the computational domain ud x y t a exp 1 2 x y yfp 1 x y yfp t here denotes the covariance matrix diag 2 x 2 y 34 markus muhr vanja nikolic barbara wohlmuth and linus wunderlich with parameters x 0 02 y 0 004 the y coordinate of the focal point is given by yfp 0 105 and the amplitude of the gaussian by a 6 107 having in mind a realistic shape for the focusing lens we will include an addi tional stopping criterion in the algorithm that will stop the optimization process if an update would lead to a shape being thinner than some tolerance 0 0 005 0 01 0 015 0 02 0 025 0 03 0 035 0 04 0 03 0 035 0 04 0 045 0 05 0 055 0 06 0 065 0 07 reference lens figure 14 reference lens that marks the minimal thickness pos sible to manufacture a constant thickness tolerance over the width of the lens would already fail in the first gradient step since the thickness of the lenses is zero at the tip to determine a lower thickness limit that varies over the width of the lens we set up a reference lens which represents the thinnest lens design that is possible to manufacture see figure 14 if the newly computed lower and upper lens boundary do not fulfill the minimal thickness condition at all control points we reduce the descent step size until either the minimal thickness limit is matched again for all control points or until the step size undergoes a lower bound in which case the algorithm terminates we will use a reference lens which has two arcs as upper and lower boundaries the arcs have horizontal tangents at the point on the axis of symmetry and a width on the axis of 0 01 see figure 14 the thickness constraint is given by dmin 0 0 04 r dmin x 0 0263 0 06082 x 2 0 04452 x 2 the result of the optimization process with the given method and parameters is shown in figure 15 the initial shape is l gauss specified in table 2 the domain d over which the pressure is tracked was chosen to be d 0 0 015 0 1 0 11 figure 15 shows the results of the optimization process with linear and quadratic nurbs where we took the lower bound for the descent step size to be tolstep 10 3 for the employed mesh sizes we refer again to table 3 where we note that the numbers of degrees of freedom are of the same order of magnitude in both linear and quadratic nurbs cases we notice a decrease of the cost functional by 0 89 1 15 of its initial value the small decrease is likely caused by using a stationary gaussian as the desired pressure distribution which our moving pressure wave can hardly fit to future research should include other objective functions which would not require an analytically given target pressure distribution for instance nonlinear ultrasound focusing 35 0 0 01 0 02 0 03 0 04 0 03 0 035 0 04 0 045 0 05 0 055 0 06 0 065 0 07 0 075 0 08 linear nurbs quadratic nurbs initial shape 2 4 6 8 10 12 14 0 988 0 99 0 992 0 994 0 996 0 998 1 linear nurbs quadratic nurbs figure 15 left initial and final lens shape right relative cost decay versus the number of gradient steps maximizing acoustic pressure in a certain area the resulting final shapes although similar still differ we would like to compare which shape performs better we observe that the quadratic nurbs give a better relative decay of the cost functional see figure 15 in order to test if the quadratic nurbs found a better shape we will bring the two shapes into the same setting first we interpolate the final quadratic nurbs shape into the linear nurbs space and compute the cost values secondly we reverse the process and represent the linear final shape with quadratic nurbs and compute the cost in this quadratic nurbs space the resulting values of the cost functionals are listed in table 5 confirming that the quadratic nurbs perform better in both cases by around 0 235 in figure 16 snapshots of the pressure wave propagation with the final quadratic nurbs shape are shown table 5 cost comparison with final lens shapes interpolated into the optimization with linear nurbs space quadratic nurbs space linear nurbs j 2 937255 107 j 2 933371 107 quadratic nurbs j 2 930353 107 j 2 926472 107 finally we take the optimal quadratic lens interpolated into the linear nurbs space as the initial geometry and restart the optimization algorithm in the linear nurbs setting the results of this post processing optimization given in figure 17 confirm that this lens is already a local minimum the algorithm performs 3 steps resulting in a cost reduction of only 0 0729 of its starting value with no visible changes to the shape of the lens the steps that the algorithm needed to take are likely due to the approximation error made by reducing the degree of the nurbs curve 36 markus muhr vanja nikolic barbara wohlmuth and linus wunderlich figure 16 pressure wave propagation with the final lens shape using quadratic nurbs 0 0 01 0 02 0 03 0 04 0 03 0 035 0 04 0 045 0 05 0 055 0 06 0 065 0 07 0 075 0 08 final geometry initial geometry 1 1 5 2 2 5 3 0 9992 0 9993 0 9994 0 9995 0 9996 0 9997 0 9998 0 9999 1 figure 17 left no visible changes between the initial and final lens in the post processing optimization right cost decay by 0 0729 of its starting value nonlinear ultrasound focusing 37 8 conclusion and outlook we have developed a gradient based algorithm to find a locally optimal shape of an acoustic lens in nonlinear ultrasound applications the shape derivative of the pressure tracking cost functional was first rigorously derived by employing a variational approach the algorithm was then numerically realized within the iso geometric concept where geometries can be exactly represented in every gradient step due to the nonlinear nature of the problem and high source frequencies a very fine mesh and time discretization had to be employed increasing the com putational complexity numerical experiments show that the quadratic nurbs perform better with respect to the final lens shape than the linear ones reinforcing the potential of isogeometric shape optimization there are many possible directions for further research combining linear and higher order nurbs in optimization in a clever way could result in a more efficient algorithm future research should also include considerations of different objec tive functionals where an analytical expression for the target pressure distribution would not be needed exploring other acoustic models for nonlinear ultrasound propagation is of interest as well finally from the point of view of applications it is important to numerically tackle a 3 d setting with even higher source frequencies which would require developing a high performance computational framework acknowledgments the authors gratefully acknowledge the funds provided by the deutsche forschungs gemeinschaft under the grant numbers wo 671 11 1 and wo 671 15 1 within the priority programme spp 1748 references 1 l beira o da veiga a buffa g sangalli and r va zquez mathematical analysis of variational isogeometric methods acta numerica 23 5 157 287 2014 2 a blana n walter s rogenhofer and w f wieland high intensity focused ultrasound for the treatment of localized prostate cancer 5 year experience urology 63 2 297 300 2004 3 c brandenburg f lindemann m ulbrich and s ulbrich advanced numerical methods for pde constrained optimization with application to optimal design in navier stokes flow constrained optimization and optimal control for partial differential equations springer basel 257 275 2012 4 g j brereton and b a bruno particle removal by focused ultrasound journal of sound and vibration 173 5 683 698 1994 5 m s canney bailey l a crum v a khokhlova and o a sapozhnikov acoustic characterization of high intensity focused ultrasound fields a combined measurement and modeling approach the journal of the acoustical society of america 124 4 2406 2420 2008 6 s cho and s h ha isogeometric shape design optimization exact geometry and enhanced sensitivity structural and multidisciplinary optimization 38 1 53 70 2009 7 j chung and g m hulbert a time integration algorithm for structural dynamics with improved numerical dissipation the generalized method journal of applied mechanics 60 2 371 375 1993 8 d colton and r kress integral equation methods in scattering theory wiley new york 1983 9 j a cottrell t j r hughes and y bazilevs isogeometric analysis toward integration of cad and fea john wiley sons 2009 10 d g crighton model equations of nonlinear acoustics annual review of fluid mechanics 11 1 11 33 1979 11 f demengel g demengel and r ern functional spaces for the theory of elliptic partial differential equations london uk springer 2012 38 markus muhr vanja nikolic barbara wohlmuth and linus wunderlich 12 g dogan p morin r h nochetto and m verani discrete gradient flows for shape optimization and applications computer methods in applied mechanics and engineering 196 37 3898 3914 2007 13 b engquist and a majda absorbing boundary conditions for the numerical evaluation of waves proceedings of the national academy of sciences 74 5 1765 1766 1977 14 k eppler and h harbrecht coupling of fem and bem in shape optimization numerische mathematik 104 1 47 68 2006 15 k eppler h harbrecht and r schneider on convergence in elliptic shape optimization siam journal on control and optimization 46 1 61 83 2007 16 s erlicher l bonaventura and o s bursi the analysis of the generalized method for nonlinear dynamic problems computational mechanics 28 2002 17 c de falco a reali and r va zquez geopdes a research tool for isogeometric analysis of pdes advances in engineering software 42 12 1020 1034 2011 18 d l folds speed of sound and transmission loss in silicone rubbers at ultrasonic frequencies the journal of the acoustical society of america 56 4 1295 1296 1974 19 d fu eder a v vuong and b simeon fundamental aspects of shape optimization in the context of isogeometric analysis computer methods in applied mechanics and engineering 286 39 313 331 2015 20 d fu eder and b simeon algorithmic aspects of isogeometric shape optimization in b ju ttler and b simeon editors isogeometric analysis and applications 2014 183 207 springer 2015 21 p gangl u langer a laurain h meftahi and k sturm shape optimization of an electric motor subject to nonlinear magnetostatics siam journal on scientific computing 37 6 b 1002 b 1025 2015 22 h harbrecht analytical and numerical methods in shape optimization mathematical meth ods in the applied sciences 31 18 2095 2114 2008 23 j haslinger and p neittaanma ki finite element approximation for optimal shape material and topology design john wiley sons 1996 24 a henrot and m pierre variation et optimisation de formes une analyse ge ome trique springer science business media 48 2006 25 k ho llig finite element methods with b splines siam 2003 26 s hofmann m mitrea and m taylor geometric and transformational properties of lips chitz domains semmes kenig toro domains and other classes of finite perimeter domains the journal of geometric analysis 17 4 593 647 2007 27 t j r hughes j a cottrell and y bazilevs isogeometric analysis cad finite elements nurbs exact geometry and mesh refinement computer methods in applied mechanics and engineering 194 4135 4195 2005 28 j hoffelner h landes m kaltenbacher and r lerch finite element simulation of non linear wave propagation in thermoviscous fluids including dissipation ieee transactions on ultrasonics ferroelectrics and frequency control 48 3 779 786 2001 29 e maloney and j h hwang emerging hifu applications in cancer therapy international journal of hyperthermia 31 3 302 309 2015 30 k ito k kunisch and g peichl variational approach to shape derivatives for a class of bernoulli problems journal of mathematical analysis and applications 314 1 126 149 2006 31 k ito k kunisch and g peichl variational approach to shape derivatives esaim control optimisation and calculus of variations 14 3 517 539 2008 32 b kaltenbacher and i lasiecka well posedness of the westervelt and the kuznetsov equation with nonhomogeneous neumann boundary conditions aims proceedings 763 773 2011 33 b kaltenbacher i lasiecka and s veljovic well posedness and exponential decay for the westervelt equation with inhomogeneous dirichlet boundary data progress in nonlinear dif ferential equations and their applications 60 357 387 2011 34 b kaltenbacher and g peichl sensitivity analysis for a shape optimization problem in lithotripsy evolution equations and control theory eect 5 399 430 2016 35 b kaltenbacher and s veljovic sensitivity analysis of linear and nonlinear lithotripter mod els european journal of applied mathematics 22 1 21 43 2010 36 m kaltenbacher numerical simulations of mechatronic sensors and actuators springer berlin 2004 nonlinear ultrasound focusing 39 37 j e kennedy high intensity focused ultrasound in the treatment of solid tumors nature reviews cancer 5 4 321 327 2005 38 j e kennedy f wu g r ter haar f v gleeson r r phillips m r middleton and d cranston high intensity focused ultrasound for the treatment of liver tumors ultrasonics 42 1 931 935 2004 39 j kiendl r schmidt r wu chner and k u bletzinger isogeometric shape optimization of shells using semi analytical sensitivity analysis and sensitivity weighting computer methods in applied mechanics and engineering 274 1 148 167 2014 40 d kuhl and m a crisfield energy conserving and decaying algorithms in nonlinear struc tural mechanics international journal for numerical methods in engineering 45 569 599 1999 41 e laporte and p le tallec numerical methods in sensitivity analysis and shape optimiza tion springer science business media 2012 42 y s lee numerical solution of the kzk equation for pulsed finite amplitude sound beams in thermoviscous fluids phd thesis the university of texas at austin 1993 43 d lee n koizumi k ota s yoshizawa a ito y kaneko y matsumoto and m mitsuishi ultrasound based visual serving system for lithotripsy intelligent robots and systems 877 882 2007 44 a mu nch optimal design of the support of the control for the 2 d wave equation a numerical method international journal of numerical analysis and modeling 5 2 331 351 2008 45 f maestre a mu nch and p pedregal a spatio temporal design problem for a damped wave equation siam journal on applied mathematics 68 1 109 132 2007 46 j g mancini a neisius n smith g sankin g m astroza m e lipkin w n simmons g m preminger and p zhong assessment of a modified acoustic lens for electromagnetic shock wave lithotripters in a swine model the journal of urology 190 3 1096 1101 2013 47 s meyer and m wilke optimal regularity and long time behavior of solutions for the west ervelt equation applied mathematics optimization 64 2 257 271 2011 48 f murat and s simon etudes de problems d optimal design lecture notes in computer science 41 54 62 1976 49 a neisius n b smith g sankin n j kuntz j f madden d e fovargue s mitran m e lipkin w n simmons g m preminger and p zhong improving the lens design and performance of a contemporary electromagnetic shock wave lithotripter proceedings of the national academy of sciences 111 13 e 1167 e 1175 2014 50 n m newmark a method of computation for structural dynamics journal of engineering mechanics asce 85 67 94 1959 51 d m nguyen a evgrafov and j gravesen isogeometric shape optimization for scattering problems progress in electromagnetics research b 45 117 146 2012 52 v nikolic and b kaltenbacher sensitivity analysis for shape optimization of a focusing acoustic lens in lithotripsy applied mathematics and optimization 76 2 261 301 2017 53 p nortoft and j gravesen isogeometric shape optimization in fluid mechanics struct mul tidisc optim 48 909 925 2013 54 a paganini numerical shape optimization with finite elements phd thesis eth zu rich 2016 55 s h park j w yoon d y yang and y h kim optimum blank design in sheet metal forming by the deformation path iteration method international journal of mechanical sci ences 41 10 1217 1232 1999 56 r f paterson e barret t m siqueira t a gardner j tavakkoli v v rao n t sanghvi l cheng and a l shalhav laparoscopic partial kidney ablation with high intensity focused ultrasound the journal of urology 169 1 347 351 2003 57 l piegl and w tiller the nurbs book springer 1997 58 x qian and o sigmund isogeometric shape optimization of photonic crystals via coons patches computer methods in applied mechanics and engineering 200 25 2237 2255 2011 59 t d rossing ed springer handbook of acoustics springer 2014 60 l schumaker spline functions basic theory 3 rd edition cambridge university press cambridge 2007 61 s veljovic shape optimization and optimal boundary control for high intensity focused ul trasound hifu phd thesis university of erlangen nuremberg 2009 62 w a wall m a frenzel and c cyron isogeometric structural shape optimization com puter methods in applied mechanics and engineering 197 33 2976 2988 2008 40 markus muhr vanja nikolic barbara wohlmuth and linus wunderlich 63 f wu w z chen j bai j z zou z l wang h zhu and z b wang pathologi cal changes in human malignant carcinoma treated with high intensity focused ultrasound ultrasound in medicine biology 27 8 1099 1106 2001 64 s yoshizawa t ikeda a ito r ota s takagi and y matsumoto high intensity fo cused ultrasound lithotripsy with cavitating microbubbles medical biological engineering computing 47 8 851 860 2009 65 p zhong n smith n w simmons and g sankin a new acoustic lens design for electro magnetic shock wave lithotripters aip conference proceedings 1359 1 42 47 2011 66 j p zole sio and m c delfour shapes and geometries metrics analysis differential calculus and optimization siam 2011 e mail address muhr ma tum de e mail address vanja nikolic ma tum de e mail address wohlmuth ma tum de e mail address linus wunderlich ma tum de mailto muhr ma tum de mailto vanja nikolic ma tum de mailto wohlmuth ma tum de mailto linus wunderlich ma tum de 1 introduction 2 problem setting 2 1 on the well posedness of 2 2 the shape optimization problem 2 3 the adjoint problem 3 shape calculus 3 1 an auxiliary result on h lder continuity 4 shape derivative of the cost function 5 isogeometric analysis 5 1 basics of b splines and nurbs 5 2 description of the computational lens fluid domain in the multipatch setting 5 3 numerical treatment of the state problem 5 4 time stepping scheme 5 5 numerical treatment of the adjoint problem 6 shape optimization algorithm 6 1 updating geometry 7 numerical experiments 7 1 coefficient values 7 2 excitation 7 3 test 1 exact solution 7 4 test 2 unknown solution 8 conclusion and outlook acknowledgments references