ar x iv 1 10 7 30 98 v 1 m at h n a 1 5 ju l 20 11 reactionkinetics a mathematica package with applications ii computational problems when building a reaction kinetics package a l nagya 1 2 d pappc 3 j to tha b 1 2 adepartment of analysis budapest university of technology and economics egry j u 1 budapest hungary h 1111 blaboratory for chemical kinetics of the institute of chemistry eo tvo s lora nd university budapest hungary cdepartment of industrial engineering and management sciences northwestern university 2145 sheridan road room c 210 evanston il 60208 abstract treating a realistic problem in any field of reaction kinetics raises a series of problems we review these illustrated with examples using reactionkinetics a mathematica based package keywords kinetics numerical analysis simulation parameter identification decomposition of overall reactions combustion 1 introduction in part i of our paper to th et al 2011 we have formulated the requirements for a reaction kinetics package to be useful for a wide circle of users in the present part ii we enumerate the major problems aris ing when writing and using such a package it turns out that the solution of some problems is far from being trivial 2 parsing as we mentioned in the first part of our paper at the very beginning of application of computers to chemical kinetics the problem arouse how to construct the induced kinetic differen tial equation of a reaction without making to much errors the corresponding author email addresses nagyal math bme hu a l nagy dpapp iems northwestern edu d papp jtoth math bme hu j to th 1 partially supported by the hungarian national scientific foundation no 84060 2 this work is connected to the scientific program of the development of quality oriented and harmonized r d i strategy and functional model at bme project this project is supported by the new sze chenyi plan project id ta mop 4 2 1 b 09 1 kmr 2010 0002 3 partially supported by the cost action cm 901 detailed chemical ki netic models for cleaner combustion best thing is if the chemist provides the reaction steps and the program creates the induced kinetic differential equations auto matically if the kinetics is supposed to be of the mass action type if it is not then reaction rates should also be provided by the user as our program is based on a modern mathematical program package often called by the misnomer computer algebra sys tem there is no limitation as to the size of the reaction to be handled see the lendvay example in our previous paper con fer this with the quite typical restriction has the capabilities for handling up to 590 differential equations it may be instructive to cite the code building the right hand side of the induced kinetic differential equation of the reaction note that reversibility is not assumed m m 1 m r x m kr m m 1 m r x m r 1 2 r given the matrices of molecularities the vector of reac tion rate coefficients k kr r r 1 and the concentration vector c the right hand side of the kinetic ode gets an exceedingly transparent form in coding as well k times c where notice that both dot and componentwise products are preprint submitted to chemical engineering science september 24 2018 http arxiv org abs 1107 3098 v 1 used the reaction step vector r where ex presses as the effect of the rth reaction step 3 combinatorics in reaction kinetics graphs of many types are useful and used though it is not quite obvious how to visualize them to be the most informative for users especially concerning to large mechanisms hence we accept the representations offered by mathematica the volpert graph is one of the widely applied graphs in re action kinetics which proved to be a good tool to investigate problems emerging e g in the theory of kinetic ordinary dif ferential equations it is a directed bipartite graph with species and reaction steps as its vertices and with m r edges from the vertex representing species x m into the vertex represent ing reaction step r and with m r edges from the vertex rep resenting reaction step r into the vertex representing species x m e rdi and to th 1989 at the same time this is the graph one can see in textbooks on biochemistry in metabolic maps or at mackie workshops without any additional advantage they can also be called petri nets mart nez and silva 1982 a model of glycolysis is a built in reaction of our program pack age therefore having got it we can easily draw its volpert graph which turns out to be not so much different from the one used in textbooks on biochemistry see figure 3 4 linear diophantine equations complex reactions occur via pathways of simple elemen tary reaction steps it is a common problem that the overall or global reaction is measured and one would like to reconstruct the underlying network of simple reaction steps by simple here one may mean reaction steps of order not higher than two let us consider an example kova cs et al 2004 we start form the overall description of the permanganate oxalate reaction 2 mno 4 6 h 5 c 2 h 2 o 4 2 mn 2 8 h 2 o 10 co 2 the following steps lead to its the decompositions to elemen tary steps 1 3 bpg gadp gadp 1 3 bpg dhap gadp dhap gadp dhap f 1 6 bp dhap gadp f 1 6 bp dhap gadp f 1 6 bp 2 pg h 2 o pep h 2 o pep 2 pg 2 pg 3 pg 3 pg 3 pg 2 pg pep 2 pg volpert graph or petri net atp glc adp g 6 p h adp g 6 p h atp glc g 6 p f 6 p f 6 p f 6 p g 6 p atp f 6 p adp f 1 6 bp f 1 6 bp gadp nad pi 1 3 bpg h nadh 1 3 bpgnadh gadp nad pi 1 3 bpg adp 3 pg atp 3 pg adp pep atp pyr pyr pep figure 1 the volpert graph or petri net of a glycolysis model 2 h 2 c 2 o 4 hc 2 o 4 h c 2 o 2 4 mn 2 mnc 2 o 4 mno 4 mno 2 mn 3 co 2 h 2 o co 2 mno 2 h 2 c 2 o 4 mn c 2 o 4 mn c 2 o 4 2 mnc 2 o 4 mno 4 h mnc 2 o 2 4 mno 3 mnc 2 o 2 4 mno 3 h 2 h mno 2 h 2 c 2 o 4 table 1 species of the permanganate oxalic acid reaction according to kova cs et al 2004 species with initially positive concentration are typeset bold 1 determine the combinatorially possible species and select from those the chemically acceptable ones 2 determine the combinatorially possible reaction steps which are simple in the above sense and select from those the chemically acceptable ones 3 find those representations of the given overall reaction which are chemically acceptable as we have seen in part i of our paper the second and third steps reduce to the solution of linear diophantine equations the authors of kova cs et al 2004 worked with 19 species including four hypothetical transient species made up of four atomic constituents and charge these are listed in table 1 the corresponding atomic matrix see part i is a 5 19 matrix to generate all combinatorially feasible elementary reactions 2 19 19 2 209 systems need to be solved the results give 1022 combinatorially feasible elementary steps based on chemical evidence a large number of them were eliminated leaving 673 elementary reactions the same computational results were reproduced in papp and vizva ri 2006 where further combinatorial analy sis revealed that only 297 of the previously generated elemen tary reactions may be part of decompositions and that 3 of the species cannot be generated during the reaction this analysis takes into account which five species are present initially in the reaction based on experiments and is an adaptation of the in dexing process by volpert 1972 it is perhaps worth mention ing that the result in this specific example is not sensitive to the assumption on the initial species the same elementary steps and species remain if every non complex species is assumed to be present initially in the vessel decompositions of the overall reaction can be obtained via the solution of another linear diophantine system of equations with the above analysis the dimensions of this system are re duced to 16 297 the generation of decompositions can be further accelerated by preprocessing simple analysis using lin ear programming shows that every decomposition consists of at least 15 steps and that two elementary steps take part in ev ery decomposition one of them with a coefficient of at least four after this preprocessing it is possible to find all decom positions of 15 17 steps and thousands of more complex de compositions from which chemically acceptable ones can be selected we refer the reader to the two papers cited above for details of these computations and a review of a number of algorithms for the solution of linear diophantine equations all of these algorithms and the various methods of combinatorial analysis mentioned above are now built in to our program 5 numerics 5 1 stiffness one of the major problems when solving initial value prob lems describing chemical reactions is as in general stiffness the situation when the reaction proceeds along more than one time scales reaction rates of different steps are of different mag nitude then the codes meet the dilemma if they choose a small step size then the numerical solution will need much time if they take a too long step size then interesting phe nomena occurring in the time evolution of the fast species will be lost starting with gear gear 1992 and butcher butcher and cash 1990 many methods fulfilling the require ments of the chemist have been elaborated and built in into pro gram packages the following example show that such an in sertion has been carried out especially successfully in the case of mathematica the robertson problem robertson 1966 a 0 04 b 2 b 3 107 b c b c 104 a c 3 1 2 1 1 1 1 1 1 1 a bb a 2 b b c c b c a c figure 2 the volpert graph of the robertson model is a popular benchmark problem of stiff type because there is a nine order of magnitude difference between the reaction rate coefficients to make matters worse the solution is required on the time interval 0 1011 figure 5 1 shows its volpert graph no matter what the values of the reaction rate coefficients are the derivatives of the concentrations sum up to zero meaning that total mass is conserved one way to verify this fact is to execute the following total righthandside robertson k 1 k 2 k 3 which gives 0 cf the concentrations are calculated numerically as simply as usual with our built in function concentrations concentrations robertson 0 04 3 107 104 1 0 0 0 1011 also the numerical method is good enough to conserve mass figure 5 1 let us see the individual concentrations of species a and c us ing the logarithmic time scale figure 5 1 but what about the species b see figure 5 1 one of our colleagues dr r horva th was so kind as to solve the same problem using matlab the same results were obtained within the same cpu time but much less automati cally 0 200 000 400 000 600 000 800 000 1 106 time 0 999995 1 000000 1 000010 1 000010 total conc mass conserved figure 3 the total mass in the robertson model finally we remark that a symbolic approach to unveil stiff ness when it does not manifest itself on the surface has been given by prof goldshtein at the conference and see also bykov et al 2008 5 0 5 10 loghtimel 0 2 0 4 0 6 0 8 1 0 conc a decreasing c increasing figure 4 species a and c in the robertson model 5 2 bifurcations a usual method to show that oscillatory solutions exist in the induced kinetic differential equation of a reaction is to apply the well known andronov hopf bifurcation theorem visualizing 4 5 0 5 10 loghtimel 5 10 6 0 00001 0 000015 0 00002 0 000025 0 00003 0 000035 conc the quantity of the intermedier b is so small that we were unable to see it in the previous figures figure 5 species b in the robertson model the effect of the change of the parameters is really simple using the manipulate command of mathematica see also the last example in the first part of our paper if you are interested how easily this can be done you might have a look at the demon stration by va rdai and to th in fact the method used there is based on particular ideas and has not as yet been built in into our program package handling general models 6 symbolic methods symbolic solutions are easier to find nowadays still it is a hard problem even in the case of stationary points see our previous paper the most interesting developments are expected in these fields e g how to find automatically the equivalence of some kind of different kinetic models mendez and femat 2011 how to show the possibility or im possibility of transforming one dynamics into another by say orthogonal transformations to th and ha rs 1986 a using per haps the theory of algebraic invariants of differential equa tions halmschlager et al 2004 how to find a minimal model with given properties within a class of reactions wilhelm 2009 to th and ha rs 1986 b given an induced kinetic differ ential equation how to find a reaction with a given structure szederke nyi 2010 szederke nyi and hangos 2011 etc 7 stochastic simulation in reaction kinetics it has always been obvious from the the oretical point of view that in the case of small systems see e g ara nyi and to th 1977 and systems operating around an unstable stationary state e g models of chirality see e g baraba s et al 2010 are better described with the standard continuous time discrete state stochastic model of chemical re actions see e g e rdi and to th 1989 chaptr 5 however it turned out to be much more relevant only recently as with the development of analytical techniques it became possible to measure individual molecules that is the reason why simula tion of the stochastic model forms a relevant part of our pro gram package here we are considering only the usual continuous time dis crete state model which is a markovian jump process denote by x t the number of species present in the system at time t now our investigated process is defined to evolve in time so that the law p rr takes place in t t h x t r x t h h h 1 is fulfilled where h 0 if h 0 and j s r 1 2 r are a kind of combinatorial functions of the vector of num bers of species similar to but slightly different from the prod uct of powers kurtz kinetics involving also the reaction rate coefficients from this assumption one can easily determine the infinitesimal generator of this markov process from which the kolmogorov forward and backward equations as well as the master equation are obtained however our formulation is equivalent to the following explicit representation x t x 0 r r 1 zr t 0 r x s ds r 2 where the zr s are independent unit rate poisson processes note that there are many known stochastic simulation algo rithms for the presented problem but we intend to summarize only a few of them namely the direct method sipos et al 1974 a b let x r r 1 r x and suppose t 0 is given then the initialization step is x 0 x 0 rm t 0 then the algorithm works as follows 5 while t t randomchoice r x t x t r 1 2 r rr r 1 2 r s randomvariate exponentialdistribution x t x t s x t t t s notice that the idea of the direct method relies on the def inition 1 also there exists several variants e g first reac tion method and improvements of this early method see e g gibson and bruck 2000 in what follows we briefly present the approximation methods which have their roots in formula 2 at the heart of these kinds of methods is the leap con dition that is choose to be small enough so that the change in the state in t t causes no relevant change for the r s again the initialization step is x 0 x 0 rm t 0 then the algorithm works as follows while t t choose so as to satisfy the leap condition do pr randomvariate poissondistribution r x t r 1 r x t s x t r r 1 pr x t x t pr t t if we take pr x t x t pr pr then we get the ex plicit leaping method if pr x t x t pr pr r x t r x t we are led to the implicit leaping method if we set pr x t x t pr pr 2 r x t 2 r x t then what we get is the trapezoidal leaping method cao and petzold 2005 rathinam et al 2003 however these methods may also be considered as the stochas tic analogues of certain numerical schemes applied for ordinary differential equations choosing the appropriate has turned out to be a non trivial task it is also a challenging problem to avoid negative population for x t in the simulation process see cao et al 2005 especially these last methods are used to handle stiff problems where typically implicit approaches give the most appropriate results these and several other algo rithms have also been implemented into our program package we also included conversion of units functions which provide an elegant way to compare the solution of the induced kinetic differential equation with the results of the stochastic simula tion process which is considered to be taking place in a certain volume in figure 7 we can see this comparison on the example of brusselator model a k 1 x x k 2 y 2 x y k 3 3 x x k 4 p where a and p are external species 0 2 4 6 8 time 500 1000 1500 conc species x y figure 6 stochastic brusselator model is considered with reaction rate coeffi cients k 1 1 92 k 2 5 76 k 3 5 6 k 4 4 8 and initial conditions x 0 500 y 0 720 the noisy curve describes the evolution of the stochastic model where the volume is 10 21 dm 3 in figure 7 one can see the behaviour of the autocatalator model a k 1 x x k 2 y x 2 y k 3 3 y y k 4 p where again a and p are external species 6 0 10 20 30 40 50 60 70 time 10 20 30 40 50 number of species species x y figure 7 stochastic autocatalator model with reaction rate coefficients k 1 110 2 k 2 0 094 k 3 0 011 k 4 90 34 where the initial conditions x 0 15 y 0 80 were considered 8 estimation methods 8 1 based on the deterministic model estimating the reaction rate coefficients or even the arrhe nius parameters k 0 n and a in the formula k t k 0 t n exp a rt see nagy and t 2011 based on measurements is a kind of art here we only make a few remarks first of all mathematica gives the possibility to obtain esti mates seemingly without any kind of iteration it is capable using the numerical solution of a differential equation in the same way as an explicitly given function let us start from the deterministic model of the reaction 2 x k 1 k 2 x where k 1 0 33 and k 2 0 72 with the following initial concentration of x x 0 2 let us generate experimental data from the numerical solution and add a small amount of error end 7 sol first x ndsolve x t 0 33 x t 2 0 72 x t x 0 2 x t end times n range 0 5 end 5 data transpose times sol times randomreal 01 5 end 1 then the model needed by the function findfit findfit data model a b x a 0 7 b 0 2 x is defined in the following way model a b model a b first x ndsolve x t b x t a x t 2 x 0 2 x t end as a result we get 0 344129 0 75174 instead of 0 33 0 72 not a bad result but certainly this is only a toy example the agreement between the measurements and the fitted model is quite good see figure 8 1 a systematic inves tigation of similar and further estimation procedures for more complicated models is in progress 1 2 3 4 5 6 2 05 2 10 2 15 no worse fitting ever figure 8 fitted model and data we also mention that a method similar to simulated anneal ing applied to the determination of arrhenius parameters of re action rate coefficients has also been elaborated nagy et al 2011 8 2 based on the stochastic model based on the stochastic model one can obtain estimates in different ways if we are able to collect data on the individ ual changes of the molecules what is not so impossible in these days then we can have maximum likelihood estimates what is more even equilibrium fluctuations might be enough to esti mate the parameters e rdi and to th 1989 subsection 5 8 7 7 another approach is to use a kind of implicit linear regression hangos and to th 1988 methods elaborated to estimate pa rameters of mass communication can also be adapted to the goals of reaction kinetics see kova cs 9 visualization no external package is needed to provide camera ready fig ures for papers in any of the following forms eps jpg pdf bmp gif wmf etc see a delicate example on figure 9 figure 9 the deterministic brusselator model plotting in 2 d using manipulate in which one can change the initial conditions in real time us ing the locator object 10 discussion further plans we allow non mass action type kinetics even now therefore it does not seem to be a hard task to include temperature de pendence so important in the case of modelling e g atmo spheric chemistry and combustion surely reaction diffusion equations should also be treated in full generality including symbolic treatment as well the reduction of the number of variables is also a very important topics see e g to th et al 1997 finally please visit the website demonstrations wolfram com and look for the demonstra tions of attila la szlo nagy and judit va rdai 10 1 acknowledgments the authors thank the cooperation with dr r horva th many of the participants of mackie 2011 contributed with in centive ideas further requirements criticism and problems to be solved are wanted references p ara nyi and j to th a full stochastic description of the michaelis menten reaction for small systems acta biochimica et biophysica hungarica 12 4 375 388 1977 b baraba s j to th and g pa lyi stochastic aspects of asymmetric autocataly sis and absolute asymmetric synthesis the journal of mathematical chem istry 48 2 457 489 2010 j c butcher and j r cash towards efficient runge kutta methods for stiff systems siam journal on numerical analysis 27 3 753 761 1990 v i bykov v gol dshtein and u maas simple global reduction technique based on decomposition approach combustion theory and modelling 12 2 389 405 2008 y cao and l petzold trapezoidal leaping formula for the stochastic simula tion of biochemical systems proceedings of foundations of systems biology in engineering pages 149 152 2005 y cao d t gillespie and l petzold avoiding negative populations in ex plicit poisson leaping the journal of chemical physics 123 5 2005 p e rdi and j to th mathematical models of chemical reactions theory and applications of deterministic and stochastic models princeton university press 1989 c w gear invariants and numerical methods for odes physica d 60 303 310 1992 m a gibson and j bruck efficient exact stochastic simulation of chemical systems with many species and many channels the journal of physical chemistry a 104 9 18761889 2000 a halmschlager l szenthe and j to th invariants of kinetic dif ferential equations volume 1 pages 1 14 szeged 2004 url http www emis de journals ejqtde 7 714 html proc 7 th coll qualitative theory of diff equ k m hangos and j to th maximum likelihood estimation of reaction rate constants computers and chemical engineering 12 2 3 135 139 1988 b kova cs an intensity estimation method for inhomogeneous point processes and its application in reaction kinetics and telecommunications submitted 8 demonstrations wolfram com http www emis de journals ejqtde 7 714 html k kova cs b vizva ri m riedel and j to th computer assisted study of the mechanism of the permanganate oxalic acid reaction physical chemistry chemical physics 6 6 1236 1242 2004 j mart nez and m silva a simple and fast algorithm to obtain all invariants of a generalized petri net in c girault and w reisig editors selected papers from the first and the second european workshop on application and theory of petri nets pages 301 310 springer verlag london uk 1982 j m mendez and r femat dynamic equivalence in tangent spaces from vector fields of chemical reaction networks chemical engineering science pages 2011 submitted a l nagy b szabo t tura nyi and j to th 2011 in preparation t nagy and tura nyi t uncertainty of arrhenius parameters international journal of chemical kinetics 43 7 359 378 july 2011 d papp and b vizva ri effective solution of linear diophantine equation sys tems with an application in chemistry the journal of mathematical chem istry 39 1 15 31 2006 m rathinam l r petzold y cao and d t gillespie stiffness in stochastic chemically reacting systems the implicit leaping method the journal of physical chemistry a 119 24 12784 12794 2003 h h robertson the solution of a set of reaction rate equations pages 178 182 thompson book co 1966 t sipos j to th and p e rdi stochastic simulation of complex chemical re actions by digital computer i the model react kinet catal lett 1 1 113 117 1974 a t sipos j to th and p e rdi stochastic simulation of complex chemical reac tions by digital computer ii applications react kinet catal lett 1 2 209 213 1974 b g szederke nyi computing sparse and dense realizations of reaction kinetic systems the journal of mathematical chemistry 47 551 568 2010 g szederke nyi and k m hangos finding complex balanced and detailed balanced realizations of chemical reaction networks the journal of mathe matical chemistry 49 1163 1179 2011 j to th and v ha rs orthogonal transforms of the lorenz and ro ssler equations physica 19 d pages 135 144 1986 a j to th and v ha rs specification of oscillating chemical models starting form a given linearized form theor chim acta 70 143 150 1986 b j to th g li h rabitz and a s tomlin the effect of lumping and expand ing on kinetic differential equations siam journal of applied mathematics 57 1531 1556 1997 j to th a l nagy and d papp reactionkinetics a mathematica pack age with applications i requirements for a reaction kinetics package chem ical engineering science 2011 this issue j va rdai and j to th hopf bifurcation in the brusselator http demonstrations wolfram com hopfbifurcationinthebrusselator from the wolfram demonstrations project a i volpert differential equations on graphs mat sb 88 130 578 588 1972 t wilhelm the smallest chemical reaction system with bistability bmc systems biology 3 90 9 pages 2009 9 1 introduction 2 parsing 3 combinatorics 4 linear diophantine equations 5 numerics 5 1 stiffness 5 2 bifurcations 6 symbolic methods 7 stochastic simulation 8 estimation methods 8 1 based on the deterministic model 8 2 based on the stochastic model 9 visualization 10 discussion further plans 10 1 acknowledgments