discrete adjoints for accurate numerical optimization with application to quantum control discrete adjoints for accurate numerical optimization with application to quantum control n anders peterssona fortino m garciab austin e copelandc ylva l rydind jonathan l duboise acenter for applied scientific computing llnl livermore ca 94550 usa bdepartment of applied mathematics cu boulder co 80309 usa cdepartment of mathematics smu dallas tx 75205 usa ddepartment of information technology uu 751 05 uppsala sweden equantum coherent device physics group llnl livermore ca 94550 usa abstract this paper considers the optimal control problem for realizing logical gates in a closed quantum system the quantum state is governed by schro dinger s equation which we formulate as a time dependent hamiltonian system in terms of the real and imaginary parts of the state vector the system is discretized with the sto rmer verlet scheme which is a symplectic partitioned runge kutta method our main theoretical contribution is the derivation of a compatible time discretization of the adjoint state equation such that the gradient of the discrete objective function can be calculated exactly at a computational cost of solving two schro dinger systems independently of the number of parameters in the control functions a parameterization of the control functions based on b splines with built in carrier waves is also introduced the carrier waves are used to specify the frequency spectra of the control functions while the b spline functions specify their envelope and phase this approach allows the number of control param eters to be independent of and significantly smaller than the number of time steps for integrating schro dinger s equation we consider hamiltonians that model the dynamics of a superconducting multi level qudit and present numerical examples of how the proposed tech nique can be combined with the interior point l bfgs algorithm from the ipopt package for realizing quantum gates in a set of test cases the pro posed algorithm is shown to compare favorably with qutip pulse optim and grape tensorflow keywords optimal control partitioned runge kutta method discrete adjoint quantum computing corresponding author email addresses petersson 1 llnl gov n anders petersson fortino garcia colorado edu fortino m garcia acopeland mail smu edu austin e copeland ylva rydin it uu se ylva l rydin dubois 9 llnl gov jonathan l dubois preprint submitted to elsevier november 20 2020 ar x iv 2 00 1 01 01 3 v 2 qu an t ph 1 9 n ov 2 02 0 1 introduction a key challenge for realizing the potential of quantum computing lies in determining the most efficient and accurate route to controlling the quantum states in a quantum device this challenge stems from the fact that current quantum computing systems unlike classical computers do not have a fixed set of logical gates predetermined in hardware instead the execution of a quantum algorithm is carried out by first devising a set of classical control functions that are then applied to the quantum computing hardware to guide the quantum states through a series of quantum logical operations 16 reducing the time required for a quantum gate to be realized is critical for near term quantum computing because it enables the computation to finish before the quantum state collapses to a classical state rendering the results meaningless to mitigate this problem quantum optimal control techniques have been developed to produce customized control pulses that minimize the execution time for complicated gates that directly map onto a physical system 20 optimizing the control functions for realizing quantum gates is a optimal control problem where the objective function measures the infidelity of the gate transformation constrained by schro dinger s equation governing the evolution of the quantum states for superconducting circuits it is also important to suppress leakage into highly energetic states 13 leading to an optimal con trol problem in mayer lagrange form our approach builds upon the works of hager 9 sanz serna 19 and ober blo baum 18 hager 9 first showed how the hamiltonian structure in an optimization problem can be utilized to calcu late the gradient of the objective function hager considered the case in which the state equation is discretized by one runge kutta scheme with the adjoint state equation discretized by another runge kutta scheme it was found that the discrete gradient can be calculated exactly if the pair of runge kutta meth ods satisfy the requirements of a symplectic partitioned runge kutta method further details and generalizations are described in the review paper by sanz serna 19 ober blo baum 18 extended hager s approach to the case where the state equation itself is a hamiltonian system that is discretized by a partitioned runge kutta scheme for autonomous state equations it was shown that the compatible discretization of the adjoint state equation is another partitioned runge kutta scheme in the quantum optimal control problem the schro dinger state equation is a time dependent hamiltonian system to ensure long time numerical accuracy it is appropriate to discretize it using a symplectic time integration method 10 for this purpose we use the sto rmer verlet method which can be written as a partitioned runge kutta scheme based on the trapezoidal and implicit mid point rules our main theoretical contribution is the generalization of ober blo baum s 18 work to the case of a time dependent hamiltonian system we show that the compatible method for the adjoint state equation resembles a par titioned runge kutta scheme except that the time dependent matrices must be 2 evaluated at modified time levels logical gates in a closed quantum system can be viewed as linear reversible mappings vg from an initial state to a final state where the reversibility implies that the mapping vg must be unitary v g vg i to introduce the quantum control problem we start by discussing the case where the unitary transformation is defined in the entire n dimensional state space such that it can be represented by a unitary matrix vg cn n a more general case is described in section 2 in the following we will replace the ket notation 16 of the state vector 0 0 1 1 n 1 n 1 by the vector notation 0 e 0 1 e 1 n 1 en 1 which is more common in the computational mathematics literature 1 the elements in the state vector are complex probability amplitudes and the squared magnitude of the amplitudes sum to unity i e 22 1 to account for all admissible initial data in the hilbert space cn we consider the evolutions from the canonical basis vectors ej for j 0 1 n 1 the time dependent control functions are expanded in terms of a finite number of basis functions such that the control functions are determined by the finite dimensional parameter vector rd this leads to schro dinger s equation in matrix form for the n n complex valued solution operator matrix u t du dt ih t u 0 0 t t u 0 in h h 1 here in is the n n identity matrix and h t is the hamiltonian matrix in which the time dependence is parameterized by as a result the solu tion operator matrix depends implicitly on through schro dinger s equation due to linearity the solution for general initial conditions satisfies t u t 0 the goal of the quantum control problem is to determine the parameter vector such that the time dependence in the hamiltonian matrix leads to a solution of schro dinger s equation that minimizes the difference between the target gate matrix vg and u t here we measure the difference by the commonly used target gate infidelity 11 13 14 15 20 j 0 ut 1 1 n 2 tr u t vg 2 ut u t 2 because ut and vg are unitary tr u tvg n and j 0 0 note that the target gate infidelity is sensitive to relative phase differences between the columns of ut and vg but is invariant to global phase differences between ut and vg the quantum control problem is a constrained optimization problem where in the basic setting the gate infidelity 2 is minimized under the constraints that the solution operator matrix satisfies schro dinger s equation 1 and the 1 here ej represents the jth canonical basis vector in which the jth element is one and all other elements are zero 3 amplitudes of the control functions determined by the parameter vector do not exceed prescribed limits for a discussion of the solvability of the quantum control problem see for example borzi et al 3 while not a restriction of our approach we exemplify our technique on hamiltonians that model the dynamics of a superconducting qudit a qubit with more than two energy levels we represent the state vector in the energy basis in which the system hamiltonian matrix is diagonal in the laboratory frame of reference the hamiltonian matrix is modeled by hlab t aa a a 2 a a aa f t a a 3 here a and a are the lowering and raising matrices see appendix a a 0 is the fundamental resonance frequency a 0 is the self kerr coefficient and f t is a real valued control function that depends on the parameter vector to slow down the time scales in the state vector the problem is transformed to a rotating frame of reference see appendix a in which the hamiltonian matrix satisfies h t a 2 a a aa p t a a iq t a a 4 where p t and q t are the real valued control functions in the rotating frame of reference the control functions in the two frames are related by f t 2 p t cos at 2 q t sin at 5 several numerical methods for the quantum control problem are based on the grape algorithm 12 in this case schro dinger s equation is discretized in time using the second order accurate magnus scheme 10 in which the hamil tonian matrix is evaluated at the midpoint of each time step a stair step approximation of the control functions is imposed such that each control func tion is constant within each time step thus the time step determines both the numerical accuracy of the dynamics of the quantum state and the num ber of control parameters with q control functions m time steps of size h the control functions are thus described by m times q parameters j k the propagator in the magnus method during the jth time step is of the form exp ih h 0 k k jhk in general the matrices h 0 and hk do not com mute leading to an integral expression for the derivative of the propagator with respect to the parameters which is needed for computing the gradient of the objective function in the original grape method this integral expression is approximated by the first term in its taylor series expansion leading to an approximate gradient that is polluted by an o h 2 error as the gradient be comes smaller during the optimization the approximation error will eventually dominate the numerical gradient which may hamper the convergence of the optimization algorithm a more accurate way of numerically evaluating the 4 derivative of the time step propagator can be obtained by retaining more terms in the taylor series expansion or by using a matrix commutator expansion 5 more recently the grape algorithm has been generalized to optimize objec tive functions that include a combination of the target gate infidelity integrals penalizing occupation of forbidden states see section 2 and terms for im posing smoothness and amplitude constraints on the control functions here automatic differentiation is used for computing the gradient of the objective function 13 however the number of control parameters is still proportional to the number of time steps which may become very large when the duration of the gate is long or the quantum state is highly oscillatory as an alternative to calculating the gradient of the objective function by solving an adjoint equation backwards in time the gradient can be calculated by differentiating schro dinger s equation with respect to each parameter in the control function leading to a differential equation for each component of the gradient of the state vector this approach implemented in the goat algo rithm 15 allows the gradient of the objective function to be calculated exactly but requires d 1 schro dinger systems to be solved when the control functions depend on d parameters this makes the method computationally expensive when the number of parameters is large using the stair stepped approximation of the control functions often leads to a large number of control parameters which may hamper the convergence of the grape algorithm the total number of parameters can be reduced by instead expanding the control functions in terms of basis functions by using the chain rule the gradient from the grape algorithm can then be used to calculate the gradient with respect to the coefficients in the basis function expansion this approach is implemented in the grafs algorithm 14 where the control functions are expanded in terms of slepian sequences gradient free optimization methods can also be applied to quantum optimal control problems these methods do not rely on the gradient to be evaluated and are therefore significantly easier to implement however the convergence of these methods is usually much slower than for gradient based techniques unless the number of control parameters is very small one example of a gradient free methods for quantum optimal control is the crab algorithm 4 many parameterizations of quantum control functions have been proposed in the literature for example cubic splines 7 gaussian pulse cascades 6 fourier expansions 22 and slepian sequences 14 this paper presents a different approach based on parameterizing the control functions by b spline basis func tions with carrier waves see figure 1 our approach relies on the observation that transitions between the energy levels in a quantum system are triggered by resonance at frequencies which often can be determined by inspection of the system hamiltonian the carrier waves are used to specify the frequency spec tra of the control functions while the b spline functions specify their envelope and phase we find that this approach allows the number of control parameters to be independent of and significantly smaller than the number of time steps for integrating schro dinger s equation the remainder of the paper is organized as follows in section 2 we gen 5 figure 1 an example of three quadratic b spline basis functions with carrier wave frequencies 0 2 eralize the optimization problem to the case of target gates that are defined in a subspace of the entire state space in section 3 we first introduce the real valued formulation of schro dinger s equation followed by a presentation of the symplectic sto rmer verlet time stepping method written as a partitioned runge kutta scheme to achieve an exact gradient of the discrete objective function in section 4 we derive the discrete adjoint time integration method this method resembles a partitioned runge kutta scheme except that the time dependent matrices are evaluated at modified time levels the solution of the discrete adjoint equation is used to efficiently calculate all components of the gradient of the discrete objective function the parameterization of the control functions using b splines with carrier waves is presented in section 5 section 6 presents a numerical example of how the proposed technique can be combined with the interior point l bfgs algorithm 17 from the ipopt package 21 to realize multi level qudit gates important properties of the optima are exposed by analyzing the eigenvalues of the hessian the proposed algorithm has been implemented in the juqbox package written in the julia 2 programming lan guage in section 7 we compare its performance to two variants of the grape algorithm concluding remarks are given in section 8 2 generalized gates in quantum computing applications it is common to define gate transforma tions in a subspace of the entire possibly infinite dimensional state space in which the evolution of higher energy states is not relevant for the gate trans formation but if left uncontrolled may lead to leakage of probability in the following let the subspace of interest contain e 0 essential states and let g n e 0 denote the number of guard states the guard states that correspond to the highest energy levels in the model are often called forbidden states 13 in the case of one qudit oscillator we can always order the elements in the state vector such that they correspond to increasing energy levels the 6 schro dinger equation governs the evolution of all energy levels in the state vec tor including the guard levels but the unitary gate transformation is only defined in the subspace of the essential states this requirement leads us to define the target gate transformation matrix according to v vg 0 cn e vg ce e v g vg ie 6 let the state vector j t cn satisfy the schro dinger equation d j dt ih t j 0 0 t t j 0 ej 7 for j 0 1 e 1 the solution operator matrix u t and the target gate matrix v are rectangular with n rows and e columns u t 0 t 1 t e 1 t v d 0 d 1 de 1 8 the decomposition 6 implies that the last g rows of dj must be zero the matrix overlap function rv ut in 2 generalizes in a straightforward way to unitary gates that are defined in the subspace resulting in the target gate infidelity function j 1 ut 1 1 e 2 sv ut 2 sv ut e 1 j 0 j t dj 2 9 where 2 is the 2 vector scalar product the population of the guard states can be measured by the objective function j 2 u 1 t t 0 e 1 j 0 j t w j t 2 dt 10 here w is a diagonal n n positive semi definite weight matrix the elements in w are zero for all essential states and are positive for the guard states the elements of w are typically larger for higher energy levels in the model for the quantum control problem with guard states we formulate the opti mization problem as min g j 1 ut j 2 u 11 du dt ih t u 0 0 t t u 0 e 0 e 1 ee 1 12 min q max q 1 2 d 13 in the special case of zero guard states j 2 u 0 because w 0 thus the above formulation applies to both the cases with and without guard states i e when g n e 0 7 3 real valued formulation a real valued formulation of schro dinger s equation 7 is given by u v s t k t k t s t u v fu u v t fv u v t u 0 v 0 gu gv 14 where u re v im k re h s im h because the matrix h is hermitian kt k and st s note that the matrix s is unrelated to the matrix overlap function sv the real valued formulation of schro dinger s equation is a time dependent hamiltonian system corresponding to the hamiltonian functional h u v t uts t v 1 2 utk t u 1 2 vtk t v 15 in general s t 6 0 which makes the hamiltonian system non separable in terms of the real valued formulation the columns of the solution operator matrix in 8 satisfy u u 1 iv 1 u 2 iv 2 ue ive here uj vj satisfy 14 subject to the initial conditions guj ej and g v j 0 the columns in the target gate matrix v correspond to v du 1 id v 1 d u 2 id v 2 d u e id v e d u j re dj d v j im dj using the real valued notation the objective function 11 can be written g 1 1 e 2 sv ut 2 1 t e 1 j 0 t 0 uj t wuj t 2 vj t wvj t 2 dt 16 where sv ut e 1 j 0 uj t d u j 2 vj t d v j 2 i e 1 j 0 vj t d u j 2 uj t d v j 2 17 3 1 time integration let tn nh for n 0 1 m be a uniform grid in time where h t m is the time step also let un u tn and vn v tn denote the numerical 8 solution on the grid we use a partitioned runge kutta prk scheme 10 to discretize the real valued formulation of schro dinger s equation u 0 gu v 0 gv 18 un 1 un h s i 1 bui n i vn 1 vn h s i 1 bvi n i 19 n i fu un i v n i tn c u i h n i fv un i v n i tn c v i h 20 un i un h s j 1 auij n j v n i vn h s j 1 avij n j 21 here s 1 is the number of stages the stage variables un i and v n i are set in a bold font to indicate that they are unrelated to the solution operator matrix u t and the target gate matrix v the sto rmer verlet scheme is a two stage prk method s 2 that is symplectic time reversible and second order accurate 10 it combines the trapezoidal and the implicit midpoint rules with butcher coefficients au 11 a u 12 0 a u 21 a u 22 1 2 av 11 a v 21 1 2 av 12 a v 22 0 22 bu 1 b u 2 1 2 cu 1 0 c u 2 1 b v 1 b v 2 1 2 cv 1 c v 2 1 2 23 3 2 time step restrictions for accuracy and stability the accuracy in the numerical solution of schro dinger s equation is essen tially determined by how well the fastest time scale in the state vector is re solved on the grid in time the analysis of the time scales in the solution of schro dinger s equation is most straightforward to perform in the complex valued formulation 7 there are two fundamental time scales that must be resolved in the solution of schro dinger s equation the first corresponds to how quickly the control functions must vary in time to trigger the desired transitions between the energy levels in the quantum system this time scale is determined by the transition frequencies in the system hamiltonian which follow as the difference between its consecutive eigenvalues in the hamiltonian model 4 the angular transition frequencies between the essential energy levels are j j a j 0 e 1 24 the second time scale is due to the harmonic oscillation of the phase in the state vector it can be estimated by freezing the time dependent coefficients in the hamiltonian matrix at some time t t and considering schro dinger s equation with the time independent hamiltonian matrix h h t the n n matrix h is hermitian and can be diagonalized by a unitary transformation h x x x x in diag 1 2 n 9 where the eigenvalues k are real by the change of variables x the solution of the diagonalized system follows as k t e i kt k 0 corresponding to the period k 2 k the shortest period thus follows from the spectral radius of h h maxk k to estimate the time step for the sto rmer verlet method we require that the shortest period in the solution of schro dinger s equation must be resolved by at least cp time steps taking both time scales into account leads to the time step restriction h 2 cp max h maxj j 25 the value of cp that is needed to obtain a given accuracy in the numerical solution depends on the order of accuracy the duration of the time integration as well as the details of the time stepping scheme for second order accurate methods such as the sto rmer verlet method acceptable accuracy for engineering applications can often achieved with cp 40 with the sto rmer verlet method we note that the time stepping can become unstable if cp 2 corresponding to a sampling rate below the nyquist limit after freezing the coefficients the hamiltonian 4 becomes h a 2 a a aa p a a iq a a p p t q q t we can estimate the spectral radius of h cn n using the gershgorin circle theorem 8 because h is hermitian all its eigenvalues are real as a result its spectral radius can be bounded by h a 2 n 1 n 2 p q n 1 hence it is the largest value of p q that determines the time step given the parameter vector the control functions are bounded by p maxt p t and q maxt q t where the maximum is evaluated for times 0 t t thus using the estimate h a 2 n 1 n 2 p q n 1 26 in 25 guarantees that the time dependent phase in the state vector is resolved by at at least cp time steps per shortest period if the optimization imposes amplitude constraints on the parameter vector max those constraints can be used to estimate the time step before the optimization starts this allows the same time step to be used throughout the iteration and eliminates the need to recalculate the spectral radius of h when changes 10 our implementation of the sto rmer verlet scheme was verified to be second order accurate it was also found to give approximately the same accuracy as the second order magnus integrator 10 when the same time step was used in both methods data not shown to conserve space 4 discretizing the objective function and its gradient in this section we develop a discretize before optimize approach in which we first discretize the objective function and then derive a compatible scheme for discretizing the adjoint state equation which is used for computing the gradient of the objective function as was outlined in the introduction our approach builds upon the works of hager 9 sanz serna 19 and ober blo baum 18 4 1 discretizing the objective function the sto rmer verlet scheme can be written in terms of the stage variables un i v n i by substituting n i n i from 20 into 19 u 0 gu v 0 gv 27 un 1 un h 2 snu n 1 sn 1 u n 2 knv n 1 kn 1 v n 2 28 vn 1 vn h 2 kn 1 2 un 1 un 2 sn 1 2 v n 1 v n 2 29 and into 21 un 1 un 30 un 2 un h 2 snu n 1 sn 1 u n 2 knv n 1 kn 1 v n 2 31 v n 1 vn h 2 kn 1 2 u n 1 sn 1 2 v n 1 32 v n 2 vn h 2 kn 1 2 u n 1 sn 1 2 v n 1 33 here sn s tn sn 1 2 s tn 0 5 h etc because s t 6 0 the scheme is block implicit note that un 1 un 2 and v n 1 v n 2 v tn 1 2 o h 2 the numerical solution at the final time step provides a second order accurate approximation of the continuous solution operator matrix ut which we denote uth it is used to approximate the matrix overlap function sv ut in 17 sv h uth e 1 j 0 umj d u j 2 vmj d v j 2 i e 1 j 0 vmj d u j 2 umj d v j 2 34 which is then used as the first part of the discrete objective function j 1 h uth 1 1 e 2 sv h uth 2 35 11 the integral in the objective function 16 can be discretized to second order accuracy by using the runge kutta stage variables j 2 h u v h t e 1 j 0 m 1 n 0 1 2 u n 1 j wu n 1 j 2 1 2 u n 2 j wu n 2 j 2 v n 1 j wv n 1 j 2 36 based on the above formulas we discretize the objective function 16 according to gh jh u th u v jh uth u v j 1 h uth j 2 h u v 37 here u th u and v represent the time discrete solution of the sto rmer verlet scheme for a given parameter vector we note that gh can be eval uated by accumulation during the time stepping of the sto rmer verlet scheme 4 2 the discrete adjoint approach the gradient of the discretized objective function can be derived from first order optimality conditions of the corresponding discrete lagrangian in this approach let nj n j be the adjoint variables and let m n i j n n i j be lagrange multipliers we define the discrete lagrangian by lh u v u v m n jh uth u v e 1 j 0 u 0 j g u j 0 j 2 v 0 j g v j 0 j 2 6 k 1 t kj 38 the first two terms in the sum enforce the initial conditions 27 the terms t 1 j and t 2 j enforce the time stepping update formulas 28 29 in the sto rmer verlet scheme t 1 j m 1 n 0 un 1 j u n j h 2 snu n 1 j sn 1 u n 2 j knv n 1 j kn 1 v n 2 j n 1 j 2 39 t 2 j m 1 n 0 vn 1 j v n j h 2 kn 1 2 u n 1 j u n 2 j sn 1 2 v n 1 j v n 2 j n 1 j 2 40 the terms t 3 j to t 6 j enforce the relations between the stage variables 30 33 using the lagrange multipliers m n i j and n n i j see appendix b for details 12 to derive the discrete adjoint scheme we note that the discrete lagrangian 38 has a saddle point if lh nj lh nj lh n n i j lh m n i j 0 41 lh unj lh vnj lh u n i j lh v n i j 0 42 for n 0 1 m i 1 2 and j 0 1 e 1 here the set of conditions in 41 result in the sto rmer verlet scheme 27 33 for evolving unj v n j u n i j v n i j forwards in time the set of conditions in 42 result in a time stepping scheme for evolving the adjoint variables nj n j backwards in time as is made precise in the following lemma lemma 1 let lh be the discrete lagrangian defined by 38 furthermore let unj v n j u n i j v n i j satisfy the sto rmer verlet scheme 27 33 for a given parameter vector then the set of saddle point conditions 42 are satisfied if the lagrange multipliers nj n j are calculated according to the reversed time stepping scheme mj jh umj mj jh vmj 43 nj n 1 j h 2 n 1 j n 2 j 44 nj n 1 j h 2 n 1 j n 2 j 45 for n m 1 m 2 0 because st s and kt k the slopes satisfy n 1 j snx n j kn 1 2 y n 1 j 2 h jh u n 1 j 46 n 2 j sn 1 x n j kn 1 2 y n 2 j 2 h jh u n 2 j 47 n 1 j knx n j sn 1 2 y n 1 j 2 h jh v n 1 j 48 n 2 j kn 1 x n j sn 1 2 y n 2 j 2 h jh v n 2 j 49 where the stage variables are given by xnj n 1 j h 2 n 2 j 50 y n 2 j n 1 j 51 y n 1 j n 1 j h 2 n 1 j n 2 j 52 13 proof the lemma follows after a somewhat tedious but straightforward calcu lation shown in detail in appendix b corresponding to the continuous schro dinger equation 14 the adjoint state equation without forcing is s t k t k t s t f t f t 53 where we used that st s and kt k corollary 1 the time stepping scheme 44 52 without forcing is a con sistent approximation of the continuous adjoint state equation 53 it can be written as a modified partitioned runge kutta method where the butcher coef ficients are a 11 a 21 1 2 a 12 a 22 0 a 11 a 12 0 a 21 a 22 1 2 54 b 1 b 2 1 2 b 1 b 2 1 2 55 corresponding to the implicit midpoint rule for the equation and the trapezoidal rule for the equation in 53 the modifications to the partitioned runge kutta scheme concerns the formulae for the slopes 46 49 because of the time levels at which the matrices k and s are evaluated it is not possible to define butcher coefficients c i and c i such that n i j f x n i j y n i j tn c i h n i j f x n i j y n i j tn c i h proof see appendix c only the matricesk and s depend explicitly on in the discrete lagrangian when the saddle point conditions 41 and 42 are satisfied we can therefore calculate the gradient of gh by differentiating 38 gh r lh r r 0 1 e 1 this relation leads to the following lemma lemma 2 let lh be the discrete lagrangian defined by 38 assume that unj v n j u n i j v n i j are calculated according to the sto rmer verlet scheme for a given parameter vector furthermore assume that nj n j x n j y n i j satisfy the adjoint time stepping scheme in lemma 1 subject to the terminal conditions mj 2 e 2 re sv h d u j im sv h d v j mj 2 e 2 re sv h d v j im sv h d u j 14 and the forcing functions jh u n 1 j h t wu n 1 j jh u n 2 j h t wu n 2 j jh v n 1 j h t wv n 1 j jh v n 2 j 0 then the saddle point conditions 41 and 42 are satisfied and the gradient of the objective function 37 is given by gh r h 2 e 1 j 0 m 1 n 0 s nu n 1 j s n 1 u n 2 j k n k n 1 v n 1 j x n j 2 k n 1 2 u n 1 j s n 1 2 v n 1 j y n 1 j 2 k n 1 2 u n 2 j s n 1 2 v n 1 j y n 2 j 2 56 where s n s r tn k n 1 2 k r tn 1 2 etc proof see appendix d as a result of lemma 2 all components of the gradient can be calculated from unj v n j u n i j v n 1 j and the adjoint variables n j n j x n j y n i j the first set of variables are obtained from time stepping the sto rmer verlet scheme forward in time while the second set of variables follow from time stepping the adjoint scheme backward in time we can avoid storing the time history of unj v n j u n i j v n 1 j by using the time reversibility of the sto rmer verlet scheme however in order to do so we must first calculate the terminal conditions umj v m j by evolving 27 33 forwards in time the time stepping can then be reversed and the gradient of the objective function 56 can be accumulated by simultaneously time stepping the adjoint system 44 52 backwards in time 5 quadratic b splines with carrier waves let a t and t be real valued amplitude and phase functions of time by taking the control functions in the rotating frame hamiltonian 4 to be p t a t cos t q t a t sin t the relation 5 results in the laboratory frame control function f t 2 a t cos at t 57 we expand the amplitude function in a set of basis functions bk d 1 k 1 and start by considering the case of one carrier wave we make the ansatz a t d 1 k 1 bk t k 15 where k are real coefficients by defining the phase as k t t k p t d 1 k 1 bk t k cos t k d 1 k 1 bk t 1 k cos t 2 k sin t q t d 1 k 1 bk t k sin t k d 1 k 1 bk t 1 k sin t 2 k cos t where 1 k k cos k 2 k k sin k in the laboratory frame the resulting control function becomes f t 2 d 1 k 1 bk t k cos a t k the case with one carrier wave is straightforward to generalize to multiple frequencies nf 1 this leads to a laboratory frame control function with a spectrum that can be precisely specified to match the transition frequencies of the system f t 2 nf 1 d 1 k 1 bk t k cos a t k the total number of control parameters becomes d 2 nfd 1 which equals the size of the parameter vector here nf is the number of frequencies and d 1 1 is the number of basis functions per frequency in this paper we use the quadratic b spline basis see figure 1 to represent the amplitude and phase of the control functions here each basis function is a piecewise quadratic polynomial in time it is the lowest order b spline function that has at least one continuous derivative we define the basis functions on a uniform grid in time tm m 1 5 m 1 d 1 t d 1 2 58 each basis function bm t is centered around t tm and is easily expressed in terms of the scaled time parameter m t t tm 3 bm t b m t b 9 8 9 2 9 2 2 1 2 1 6 3 4 9 2 1 6 1 6 9 8 9 2 9 2 2 1 6 1 2 0 otherwise 59 note that bm t is only non zero in the interval t tm 1 5 tm 1 5 thus for any fixed time t a control function will only get contributions from at most three b spline basis functions this property allows the control functions to be evaluated very efficiently 16 figure 2 a b spline control function p t without carrier wave 1 0 and nf 1 here the black dashed line is the control function and the solid colored lines are the individual b spline basis functions scaled by 1 m 1 in this case d 1 6 6 numerical optimization our numerical solution of the optimal control problem is based on the gen eral purpose interior point optimization package ipopt 21 this open source library implements a primal dual barrier approach for solving large scale non linear programming problems i e it minimizes an objective function subject to inequality barrier constraints on the parameter vector because the hessian of the objective function is costly to calculate we use the l bfgs algorithm 17 in ipopt which only relies on the objective function and its gradient to be evaluated inequality constraints that limit the amplitude of the parameter vector are enforced internally by ipopt the routines for evaluating the objective function and its gradient are im plemented in the julia programming language 2 which provides a convenient interface to ipopt given a parameter vector the routine for evaluating the objective function solves the schro dinger equation with the sto rmer verlet scheme and evaluates gh by accumulation the routine for evaluating the gradient first applies the sto rmer verlet scheme to calculate terminal condi tions for the state variables it then proceeds by accumulating the gradient gh by simultaneous reversed time stepping of the discrete adjoint scheme and the sto rmer verlet scheme these two fundamental routines together with functions for setting up the hamiltonians estimating the time step setting up constraints on the parameter vector post processing and plotting of the results have been implemented in the software package juqbox which was used to generate the numerical results below the adjoint gradient implementation has been verified against a centered finite difference approximation of the discrete objective function by perturbing each component of the parameter vector to further verify our implementation we also calculated the discrete gradient by differentiating the sto rmer verlet 17 scheme with respect to each component of the parameter vector this gradient agreed with the adjoint gradient to within 11 12 digits data not shown to conserve space 6 1 a cnot gate on a single qudit with guard levels to test our methods on a quantum optimal control problem we consider realizing a cnot gate on a single qudit with four essential energy levels and two guard levels the qudit is modeled in the rotating frame of reference using the hamiltonian 4 with fundamental frequency a 2 4 10336 ghz and self kerr coefficient a 2 0 2198 ghz we parameterize the two control functions using b splines with carrier waves and choose the frequencies to be 1 0 2 a and 3 2 a in the rotating frame these frequencies correspond to transitions between the ground state and the first exited state the first and second excited states and the second and third excited states we discourage population of the fourth and fifth excited states using the weight matrix w diag 0 0 0 0 0 1 1 0 in j 2 h see 10 we use d 1 10 basis functions per frequency and control function resulting in a total of d 60 parameters the amplitudes of the control functions are limited by the constraint max 1 r d r max 60 we set the gate duration to t 100 ns and estimate the time step using the technique in section 3 2 to guarantee at least cp 40 time steps per period we use m 8 796 time steps corresponding to h 1 136 10 2 ns as initial guess for the elements of the parameter vector we use a random number generator with a uniform distribution in 0 01 0 01 in figure 3 we present the convergence history with the two parameter thresholds max 2 4 mhz and 3 mhz respectively we show the objective function g decomposed into j 1 h and j 2 h together with the norm of the dual infeasibility g z that ipopt uses to monitor convergence see 21 for details for the case with max 2 3 mhz ipopt converges well and needs 126 iteration to reduce the dual infeasibility to 10 5 which was used as convergence criteria however when the parameter constraint is relaxed to max 2 4 mhz the convergence of ipopt stalls after about 100 iterations and is terminated after 200 iterations for the converged solution with parameter constraint max 2 3 mhz the two parts of the objective function are j 1 h 1 47 10 4 and j 2 h 4 72 10 5 corresponding to a trace fidelity greater than 0 9998 the population of the guard states remains small for all times and initial conditions in particular the forbidden state 5 has a population that remains below 4 04 10 7 see figure 4 the optimized control functions are shown in figure 5 and the popu lation of the essential states corresponding to the four initial conditions of the cnot gate are presented in figure 6 even though the dual infidelity does not reach the convergence criteria with the parameter threshold max 2 4 mhz the resulting control functions give a very small objective function here j 1 h 8 56 10 5 and j 2 h 4 15 10 5 18 figure 3 convergence of the ipopt iteration for the cnot gate with the parameter con straint max here max 2 4 mhz left and max 2 3 mhz right figure 4 the population of the forbidden state 5 as function of time for the four initial conditions of the cnot gate here max 2 3 mhz figure 5 the rotating frame control functions p t blue and q t orange for realizing a cnot gate with d 1 10 basis function per carrier wave and three carrier wave frequencies here max 2 3 mhz 19 figure 6 the population of the states 0 blue 1 orange 2 green and 3 purple as function of time for each initial condition of the cnot gate here max 2 3 mhz corresponding to a trace fidelity greater than 0 9999 the population of the forbidden state 5 has a population that remains below 3 39 10 7 6 2 the hessian of the objective function the numerical results shown in figure 3 illustrate that the convergence prop erties of the optimization algorithm depend on the parameter constraints to gain clarity into the local landscape of the optima we study the hessian of the objective function let the optima correspond to the parameter vector based on the adjoint scheme for calculating the gradient we can approximate the elements of the hessian matrix using a centered finite difference approxima tion 2 gh j k 1 2 gh j ek gh j ek lj k 61 for j k 1 2 d to perform this calculation the gradient must be evalu ated for the 2 d parameter vectors ek because the objective function and the parameter vector are real valued the gradient and the hessian are also real valued due to the finite difference approximation the matrix l is only ap proximately equal to the hessian the accuracy in l is estimated in table 1 by studying the norm of its asymmetric part which is zero for the hessian based on this experiment we infer that 10 6 is appropriate to use for approximat ing the hessian in 61 to eliminate spurious effects from the asymmetry in the l matrix we study the spectrum of its symmetric part ls 0 5 l l t because it is real and symmetric it has a complete set of eigenvectors and all eigenvalues are real 20 0 5 l lt f 0 5 l lt f 10 4 4 95 103 1 99 10 4 10 5 4 95 103 2 01 10 6 10 6 4 95 103 1 46 10 6 10 7 4 95 103 1 47 10 5 table 1 the frobenius norm of the symmetric and asymmetric parts of the approximate hessian l for the case max 2 3 0 mhz figure 7 the eigenvalues of the symmetric part of the approximate hessian 0 5 l lt evaluated at the optima for the parameter thresholds max 2 4 mhz blue triangles and max 2 3 mhz orange circles the positive eigenvalues are shown on a log scale on the left and the small eigenvalues are shown on a linear scale on the right the eigenvalues of the hessian are shown in figure 7 for both values of the parameter threshold max two properties of the spectra are noteworthy first a few eigenvalues are negative this may be an artifact related to the elements of the parameter vector that are close to their bounds as a result the landscape of the objective function may not be accurately represented by the corresponding components of the hessian the second interesting property is that the 15 largest eigenvalues are significantly larger than the rest this indicates that the control functions are essentially described by the 15 eigenvec tors associated with those eigenvalues as a result the objective function varies much faster in those directions than in the directions of the remaining 45 eigen vectors and this may hamper the convergence of the optimization algorithm in that subspace however most of those 45 eigenvalues become larger when the parameter threshold is reduced from max 2 4 mhz to max 2 3 mhz this indicates that the constraints on the parameter vector have a regulariz ing effect on the optimization problem and may explain why the latter case converges better see figure 3 7 comparing juqbox with qutip pulse optim and grape tf the qutip pulse optim package is part of the qutip 11 framework and implements the grape algorithm in the python language the grape tf code 21 tf is short for tensorflow 1 is also implemented in python and provides an enhanced implementation of the grape algorithm as described by leung et al 13 it is callable from qutip and shares a similar problem setup with the pulse optim function to compare the juqbox code with pulse optim and grape tf we consider a set of swap gates these gates transform the ground state 0 to excited state d and vice versa the transformation can be described by the unitary matrix vg 0 0 0 1 0 1 0 0 0 0 1 0 1 0 0 0 c d 1 d 1 62 which involves e d 1 essential states to evaluate how much leakage occurs to higher energy levels we add one guard forbidden level g 1 and evolve a total of n d 2 states in schro dinger s equation as before the guard level is left unspecified in the target gate transformation we consider implementing the swap gates on a multi level qudit that can be described by the fundamental frequency a 2 4 8 ghz and the self kerr coefficient a 2 0 22 ghz we apply the rotating wave approximation where the angular frequency of the rotation is a resulting in the hamiltonian model 4 as a realistic model for current superconducting quantum devices we impose the control amplitude restrictions maxt p t c maxt q t c c 2 9 mhz 63 in the rotating frame of reference 7 1 setup of simulation codes qutip pulse optim can minimize the target gate fidelity g 1 but does not suppress occupation of higher energy states thus it does not minimize terms of the type g 2 as a proxy for g 2 we append one additional energy level to the simulation and measure its occupation as an estimate of leakage to higher energy states in pulse optim the control functions are discretized on the same grid in time as schro dinger s equation and no smoothness conditions are imposed in our tests we use a random initial guess for the parameter vector grape tf discretizes the control functions on the same grid in time as schro dinger s equation it minimizes an objective function that consists of a number of user configurable parts in our test we minimize the gate infidelity g 1 and the occupation of one guard forbidden energy level similar to g 2 to smooth the control functions in time the objective function also contains ad ditional terms to minimize their first and second time derivatives the various 22 parts of the objective function are weighted together by user specified coeffi cients the gradient of the objective function is calculated using the automatic differentiation ad technique as implemented in the tensorflow package in our tests we use a random initial guess for the control vector in juqbox we trigger the first d transition frequencies in the hamiltonian by using d carrier waves in the control functions with angular frequencies k k 1 a k 1 2 nf nf d similar to pulse optim and grape tf a pseudo random number generator is used to construct the initial guess for the parameter vector the pulse optim and juqbox simulations were run on a macbook pro with a 2 6 ghz intel icore 7 processor to utilize the gpu acceleration in tensorflow the grape tf simulations were run on one node of the pascal machine at liv ermore computing where each node has an intel xeon e 5 2695 v 4 processor with two nvidia p 100 gpus 7 2 numerical results a swap gate where the control functions meet the control amplitude bounds 63 can only be realized if the gate duration is sufficiently long furthermore the minimum gate duration increases with d for each value of d we used numerical experiments to determine a duration td such that at least two of the three simulation codes could find a solution with a small gate infidelity for juqbox we used the technique in section 3 2 with cp 80 to obtain the number of time steps the number of control parameters follow from d 2 nfd 1 where nf d equals the number of carrier wave frequencies and d 1 is the number of b splines per control functions here d 1 10 for d 3 4 5 and d 1 20 for d 6 for pulse optim and grape tf we calculate the number of time steps based on the shortest transition period corresponding to the highest transition frequency in the system we then use 40 time steps per shortest transition period to resolve the control functions for both grape methods there are 2 control parameters per time step the main simulation parameters are given in table 2 optimization results for the pulse optim grape tf and juqbox codes are presented in tables 3 4 and 5 the pulse optim code generates piecewise con stant control functions that are very noisy and may therefore be hard to realize experimentally to obtain a realistic estimate of the resulting dynamics we interpolate the optimized control functions on a grid with 20 times smaller time step and use the mesolve function in qutip to calculate the evolution of the system from each initial state we then evaluate the gate infidelity using the evolved states at the final time denoted by g 1 in table 3 since the control functions from grape tf and juqbox are significantly smoother we report the target gate fidelities as calculated by those codes for the 0 3 0 4 and 0 5 swap gates all three codes produce control functions with very small gate infidelities we note that the population of the guard level d 1 2 is about an order of magnitude larger 23 time steps parameters d td ns juqbox grape juqbox grape 3 140 14 787 4 480 60 8 960 4 215 37 843 7 568 80 15 136 5 265 69 962 11 661 100 23 322 6 425 157 082 22 441 240 44 882 table 2 gate duration number of time steps m and total number of control parameters d in the 0 d swap gate simulations the number of time steps and control parameters are the same for pulse optim and grape tf d g 1 d 1 2 p mhz q mhz iter cpu s 3 4 35 e 6 9 41 e 3 9 00 9 00 38 30 4 3 91 e 5 1 20 e 2 9 00 9 00 93 108 5 1 57 e 4 8 77 e 3 9 00 9 00 215 385 6 1 76 e 3 4 48 e 2 9 00 9 00 246 894 table 3 qutip pulse optim results for 0 d swap gates note the larger infidelity and guard state population for d 6 d g 1 d 1 2 p mhz q mhz iter cpu s 3 8 76 e 6 4 03 e 3 6 98 8 83 78 2 062 4 1 52 e 5 3 39 e 3 6 87 6 54 128 10 601 5 2 80 e 5 1 78 e 3 7 21 7 62 161 28 366 6 4 89 e 1 2 33 e 5 0 73 0 74 93 81 765 table 4 grape tf results for 0 d swap gates note the very large infidelity for d 6 these simulations used two nvidia p 100 gpus to accelerate tensorflow d g 1 d 1 2 p mhz q mhz iter cpu 3 2 71 e 5 1 92 e 3 7 59 8 99 177 55 4 4 91 e 5 1 23 e 3 7 78 5 33 166 151 5 4 95 e 5 1 25 e 3 7 42 7 24 173 291 6 7 41 e 6 4 41 e 3 4 55 5 39 229 1255 table 5 juqbox results for 0 d swap gates 24 with pulse optim than with juqbox the guard level population from grape tf are somewhere in between the most significant difference between the results occur for the d 6 swap gate here the grape tf code fails to produce a small gate infidelity after running for almost 23 hours and the pulse optim code results in a gate fidelity that is about 2 orders of magnitude larger than juqbox while pulse optim and juqbox require comparable amounts of cpu time to converge the grape tf code is between 50 100 times slower despite the gpu acceleration we proceed by analyzing the optimized control functions and take the 0 5 swap gate as a representative example in this case the relevant transition frequencies in the laboratory frame of reference are fk 1 2 a k a k 0 1 2 3 4 64 to compare the optimized control functions we evaluate the corresponding laboratory frame control function using 5 and study its fourier spectrum results from the pulse optim grape tf and juqbox simulations are presented in figure 8 we first note that pulse optim produces a significantly noisier control function compared to the other two codes the control function from grape tf is significantly smoother even though its spectrum includes some noticeable peaks at frequencies that do not correspond to transition frequencies in the system the juqbox simulation results in a laboratory frame control function where each peak in the spectrum corresponds to a transition frequency in the hamiltonian 8 conclusions in this paper we have developed numerical methods for optimizing control functions for realizing logical gates in a closed quantum system the quantum state is governed by schro dinger s equation which is a time dependent hamil tonian system to ensure long time numerical accuracy we discretize it using the symplectic sto rmer verlet method which can be written as a partitioned runge kutta scheme our main theoretical contribution is the derivation of a compatible time discretization of the adjoint state equation such that the gra dient of the discrete objective function can be calculated exactly this scheme generalizes ober blo baum s 18 methods to the case of a time dependent hamil tonian system we have also introduced a parameterization of the control functions based on b splines with built in carrier waves the carrier waves are used to spec ify the frequency spectra of the control functions while the b spline functions specify their envelope and phase this approach allows the number of control parameters to be independent of and significantly smaller than the number of time steps for integrating schro dinger s equation our numerical solution of the optimal control problem is based on the general purpose interior point opti mization package ipopt 21 which implements a primal dual barrier approach 25 a qutip pulse optim b grape tf c juqbox figure 8 magnitude of the fourier spectrum of the laboratory frame control function for the 0 5 swap gate 26 for minimizing the objective function subject to amplitude constraints on the parameter vector we optimized the control functions for a cnot gate with two guard states resulting in a gate trace fidelity greater than 0 9999 having a moderate number of control parameters enabled us to study the spectrum of the hessian of the objective function at an optima we found that imposing tighter bounds on the parameter vector results in a hessian with larger eigenvalues and thus improves the convergence of the optimization algorithm the performance of the proposed algorithm implemented in a code called juqbox was compared with two implementations of the grape algorithm qutip pulse optim 11 and grape tensorflow 13 juqbox was found to pro duce significantly smoother control functions than qutip pulse optim while using about the same computational resources juqbox was also found to run about 50 100 times faster than grape tensorflow in future work it would be interesting to study if the convergence proper ties of the optimization algorithm can be improved by modifying the objective function we also intend to generalize our approach to solve optimal control problem for open quantum systems acknowledgment we would like to thank prof daniel appelo for bringing the sto rmer verlet method to our attention this work was supported in part by llnl laboratory directed research and development project 20 erd 028 and in part by doe office of advanced scien tific computing research oascr under the advanced research in quantum computing arqc program award 2019 llnl scw 1683 this work performed under the auspices of the u s department of en ergy by lawrence livermore national laboratory under contract de ac 52 07 na 27344 this is contribution llnl jrnl 800457 appendix a the hamiltonian in a rotating frame of reference in the laboratory frame of reference the hamiltonian matrix for a single superconducting qudit can be modeled by h t aa a a 2 a a aa f t a a a 1 here a 0 and a are given real constants and f t is a real valued function of time that depend on the parameter vector furthermore a is the lowering matrix a 0 1 0 2 0 n 1 0 27 and the raising matrix a is its adjoint conjugate transpose to derive the rotating frame transformation we consider the time dependent change of variable t r t t r r i we have r r h hr after some algebra the schro dinger equation 7 and the identity rr r r gives ih t h t r t h t r t ir t r t a 2 the rotating frame of reference is introduced by taking the unitary transforma tion to be r t exp i at a a a a 0 1 2 n 1 r r i aa a a 3 from a 2 and a 3 the first term in the hamiltonian a 1 is canceled by the term ir t r t furthermore a a aa a a 2 a a and both a a and a a 2 commute with r t after noting that ra r ei ata the transformed hamiltonian can be written h t a 2 a a 2 a a f t e i ata ei ata a 4 to slow down the time scales in the control function we want to absorb the highly oscillatory factors exp i at into f t because the control function f t is real valued this can only be done in an approximate fashion we make the ansatz f t 2 p t cos at 2 q t sin at p iq exp i at p iq exp i at a 5 where p t and q t are real valued functions after some algebra the trans formed hamiltonian a 4 becomes h t a 2 a a 2 a a p a a iq a a p iq exp 2 i at a p iq exp 2 i at a the rotating frame approximation follows by ignoring the terms that oscillate with twice the frequency exp 2 i at resulting in the transformed schro dinger 28 system j i hd h c t j j 0 ej a 6 hd a 2 a a aa h c t p t a a iq t a a a 7 here hd is called the drift hamiltonian when a a the state vector varies on a significantly slower time scale in the rotating frame than in the laboratory frame in the remainder of the paper the schro dinger equation is always solved under the rotating frame approximation and we drop the tildes on the state vector and the hamiltonian matrices appendix b derivation of the discrete adjoint scheme we seek to determine a scheme for evolving the lagrange multiplier adjoint variables to satisfy the first order optimality conditions 42 in the following let r s denote the usual kronecker delta function the terms t 3 j to t 6 j in 38 enforce the relations between the stage variables 30 33 according to t 3 j m 1 n 0 u n 1 j u n j m n 1 j 2 b 1 t 4 j m 1 n 0 u n 2 j u n j h 2 snu n 1 j sn 1 u n 2 j knv n 1 j kn 1 v n 2 j m n 2 j 2 b 2 t 5 j m 1 n 0 v n 1 j v n j h 2 kn 1 2 u n 1 j sn 1 2 v n 1 j n n 1 j 2 b 3 t 6 j m 1 n 0 v n 2 j v n j h 2 kn 1 2 u n 1 j sn 1 2 v n 1 j n n 2 j 2 b 4 taking the derivative of 38 with respect to urj 0 lh urj jh urj nj n 1 j r n m j r m m n 1 j m n 2 j r n which gives the conditions mj jh umj nj n 1 j m n 1 j m n 2 j n 0 1 m 1 similarly differentiating 38 with respect to vrj gives 0 lh vrj jh vrj nj n 1 j r n m j r m n n 1 j n n 2 j r n 29 which leads to the conditions nj n 1 j n n 1 j n n 2 j m j jh vmj next we take the derivative of 38 with respect to u n 1 j lh u n 1 j jh u n 1 j 6 i 1 t ij u n 1 j 0 t 1 j u n 1 j h 2 stn n 1 j t 2 j u n 1 j h 2 ktn 1 2 n 1 j t 3 j u n 1 j m n 1 j t 4 j u n 1 j h 2 stnm n 2 j t 5 j u n 1 j h 2 ktn 1 2 n n 1 j t 6 j u n 1 j h 2 ktn 1 2 n n 2 j which using the fact that stn sn and ktn kn we may write as m n 1 j h 2 sn n 1 j m n 2 j h 2 kn 1 2 n 1 j n n 1 j n n 2 j jh u n 1 j repeating this procedure for the derivative with respect to u n 2 j gives lh u n 2 j jh u n 2 j 6 i 1 t ij u n 2 j 0 t 1 j u n 2 j h 2 stn 1 n 1 j t 2 j u n 2 j h 2 ktn 1 2 n 1 j t 4 j u n 2 j m n 2 j h 2 stn 1 m n 2 j t 3 j u n 2 j t 5 j u n 2 j t 6 j u n 2 j 0 30 which we may write compactly as m n 2 j h 2 sn 1 n 1 j m n 2 j h 2 kn 1 2 n 1 j jh u n 2 j taking the derivative of 38 with respect to v n 1 j gives the set of equations lh v n 1 j jh v n 1 j 6 i 1 t ij v n 1 j 0 t 1 j v n 1 j h 2 ktn n 1 j t 2 j v n 1 j h 2 stn 1 2 n 1 j t 3 j v n 1 j 0 t 4 j v n 1 j h 2 ktnm n 2 j t 5 j v n 1 j n n 1 j h 2 stn 1 2 n n 1 j t 6 j v n 1 j h 2 stn 1 2 n n 2 j which gives the condition n n 1 j h 2 sn 1 2 n 1 j n n 1 j n n 2 j h 2 kn n 1 j m n 2 j jh v n 1 j 31 similarly taking the derivative with respect to v n 2 j gives lh v n 2 j jh v n 2 j 6 i 1 t ij v n 2 j 0 t 1 j v n 2 j h 2 ktn 1 n 1 j t 2 j v n 2 j h 2 stn 1 2 n 1 j t 4 j v n 2 j h 2 ktn 1 m n 2 j t 6 j v n 2 j n n 2 j t 3 j v n 2 j t 5 j v n 2 j 0 giving n n 2 j h 2 sn 1 2 n 1 j h 2 kn 1 n 1 j m n 2 j jh v n 2 j in summary the first order optimality conditions 42 are satisfied if the follow ing equations hold nj n 1 j m n 1 j m n 2 j m j jh umj b 5 nj n 1 j n n 1 j n n 2 j m j jh vmj b 6 m n 1 j h 2 sn n 1 j m n 2 j h 2 kn 1 2 n 1 j n n 1 j n n 2 j jh u n 1 j b 7 m n 2 j h 2 sn 1 n 1 j m n 2 j h 2 kn 1 2 n 1 j jh u n 2 j b 8 n n 1 j h 2 sn 1 2 n 1 j n n 1 j n n 2 j h 2 kn n 1 j m n 2 j jh v n 1 j b 9 n n 2 j h 2 sn 1 2 n 1 j h 2 kn 1 n 1 j m n 2 j jh v n 2 j b 10 32 we now consider the following change of variables xnj n 1 j m n 2 j b 11 y n 1 j n 1 j n n 1 j n n 2 j b 12 y n 2 j n 1 j b 13 which upon substitution into b 7 b 10 gives the set of equations m n 1 j h 2 snx n j h 2 kn 1 2 y n 1 j jh u n 1 j b 14 m n 2 j h 2 sn 1 x n j h 2 kn 1 2 y n 2 j jh u n 2 j b 15 n n 1 j h 2 sn 1 2 y n 1 j h 2 knx n j jh v n 1 j b 16 n n 2 j h 2 sn 1 2 y n 2 j h 2 kn 1 x n j jh v n 2 j b 17 by adding b 14 b 15 m n 1 j m n 2 j h 2 sn sn 1 x n j kn 1 2 y n 1 j y n 2 j jh u n 1 j jh u n 2 j b 18 similarly by adding b 16 b 17 n n 1 j n n 2 j h 2 sn 1 2 y n 1 j y n 2 j kn kn 1 x n j jh v n 1 j jh v n 2 j b 19 thus b 5 b 6 can be rewritten as nj n 1 j h 2 sn sn 1 x n j kn 1 2 y n 1 j y n 2 j jh u n 1 j jh u n 2 j b 20 nj n 1 j h 2 sn 1 2 y n 1 j y n 2 j kn kn 1 x n j jh v n 1 j jh v n 2 j b 21 by combining xnj n 1 j m n 2 j and b 15 xnj n 1 j h 2 sn 1 x n j h 2 kn 1 2 y n 2 j jh u n 2 j b 22 33 similarly by combining y n 1 j n 1 j n n 1 j n n 2 j and b 19 y n 1 j n 1 j h 2 sn 1 2 y n 1 j y n 2 j kn kn 1 x n j jh v n 1 j jh v n 2 j b 23 the time stepping scheme is completed by the relation y n 2 n 1 j b 24 the scheme b 20 b 24 may be written in the form of lemma 1 by defining the slopes according to 46 49 this completes the proof of the lemma appendix c proof of corollary 1 by rearranging 44 and 45 n 1 j n j h 2 n 1 j n 2 j c 1 n 1 j n j h 2 n 1 j n 2 j c 2 hence b 1 b 2 1 2 and b 1 b 2 1 2 to express the stage variables in standard form we substitute c 1 into 50 and define x n 1 j x n 2 j x n j similarly we substitute c 2 into 51 and 52 resulting in x n 1 j n j h 2 n 1 j x n 2 j n j h 2 n 1 j y n 1 j n j y n 2 j n j h 2 n 1 j n 2 j from these relations we can identify a 11 a 21 1 2 and a 12 a 22 0 furthermore a 11 a 12 0 and a 21 a 22 1 2 for the case without forcing the formulae for the slopes 50 52 become n 1 j snx n 1 j kn 1 2 y n 1 j c 3 n 2 j sn 1 x n 2 j kn 1 2 y n 2 j c 4 n 1 j knx n 1 j sn 1 2 y n 1 j c 5 n 2 j kn 1 x n 2 j sn 1 2 y n 2 j c 6 they are consistent approximations of the time derivatives tn and tn re spectively the scheme is therefore a consistent approximation of the continuous adjoint system 34 appendix d computing the gradient of the discrete objective func tion given a solution that satisfies the saddle point conditions of 41 and 42 the gradient of lh satisfies dlh d r j 1 h r u v j 2 h r u v r 1 2 d the gradient of lh with respect to only gets a contribution from the terms in t q j that involve the matrices k and s let s n s r tn and k n k r tn we have t 1 j r h 2 m 1 n 0 s nu n 1 j k nv n 1 j s n 1 u n 2 j k n 1 v n 2 j n 1 j 2 t 2 j r h 2 m 1 n 0 k n 1 2 u n 1 j u n 2 j s n 1 2 v n 1 j v n 2 j n 1 j 2 t 3 j r 0 t 4 j r h 2 m 1 n 0 s nu n 1 j k nv n 1 j s n 1 u n 2 j k n 1 v n 2 j m n 2 j 2 t 5 j r h 2 m 1 n 0 k n 1 2 u n 1 j s n 1 2 v n 1 j n n 1 j 2 t 6 j r h 2 m 1 n 0 k n 1 2 u n 1 j s n 1 2 v n 1 j n n 2 j 2 we note that t 5 j t 6 j r h 2 m 1 n 0 k n 1 2 u n 1 j s n 1 2 v n 1 j n n 1 j n n 2 j 2 let xnj and y n i j be defined by b 11 b 13 we have t 4 j r h 2 m 1 n 0 s nu n 1 j k nv n 1 j s n 1 u n 2 j k n 1 v n 2 j x n j n 1 j 2 t 5 j t 6 j r h 2 m 1 n 0 k n 1 2 u n 1 j s n 1 2 v n 1 j y n 1 j n 1 j 2 thus t 1 j t 4 j r h 2 m 1 n 0 s nu n 1 j k nv n 1 j s n 1 u n 2 j k n 1 v n 2 j x n j 2 35 furthermore from the relation b 13 t 2 j t 5 j t 6 j r h 2 m 1 n 0 k n 1 2 u n 1 j s n 1 2 v n 1 j y n 1 j 2 h 2 m 1 n 0 k n 1 2 u n 2 j s n 1 2 v n 2 j y n 2 j 2 we can further simplify the expressions by recognizing that v n 1 v n 2 by collecting the terms lh r h 2 e 1 j 0 m 1 n 0 s nu n 1 j s n 1 u n 2 j k n k n 1 v n 1 j x n j 2 k n 1 2 u n 1 j s n 1 2 v n 1 j y n 1 j 2 k n 1 2 u n 2 j s n 1 2 v n 1 j y n 2 j 2 this completes the proof of the lemma references 1 mart n abadi paul barham jianmin chen zhifeng chen andy davis jeffrey dean matthieu devin sanjay ghemawat geoffrey irving michael isard et al tensorflow a system for large scale machine learning in 12 th usenix symposium on operating systems design and implementation osdi 16 pages 265 283 2016 2 j bezanson a edelman s karpinski and v b shah julia a fresh approach to numerical computing siam review 59 1 65 89 2017 3 a borz g ciarmella and m sprengel formulation and numerical solu tion of quantum control problems computational science and engineering siam 2017 4 t caneva t calarco and s montangero chopped random basis quan tum optimization physical review a 84 2 aug 2011 5 p de fouquieres s g schirmer s j glaser and ilya kuprov second order gradient ascent pulse engineering journal of magnetic resonance 212 2 412 417 oct 2011 6 l emsley and g bodenhausen gaussian pulse cascades new analyti cal functions for rectangular selective inversion and in phase excitation in nmr chem phys 165 6 469 476 1989 7 b ewing s j glaser and g p drobny development and optimization of shaped nmr pulses for the study of coupled spin systems chem phys 147 121 129 1990 36 8 g h golub and c f van loan matrix computations johns hopkins university press 1996 9 william w hager runge kutta methods in optimal control and the trans formed adjoint system numerische mathematik 87 2 247 282 dec 2000 10 e hairer c lubich and g wanner geometric numerical integration number 31 in springer series in computational mathematics springer verlag heidelberg 2 nd edition 2006 11 j r johansson p d nation and franco nori qutip 2 a python frame work for the dynamics of open quantum systems computer physics com munications 184 4 1234 1240 2013 12 n khaneja t reiss c kehlet t schulte herbruggen and s glaser optimal control of coupled spin dynamics design of nmr pulse sequences by gradient ascent algorithms j magnetic resonance 172 296 305 2005 13 n leung m abdelhafez jens koch and d schuster speedup for quan tum optimal control from automatic differentiation based on graphics pro cessing units phys rev a 95 0432318 2017 14 dennis lucarelli quantum optimal control via gradient ascent in function space and the time bandwidth quantum speed limit physical review a 97 6 jun 2018 15 s machnes e asse mat d tannor and f k wilhelm tunable flexible and efficient optimization of control pulses for practical qubits physical review letters 120 15 apr 2018 16 m nielsen and i chuang quantum computation and quantum informa tion cambridge university press 2000 17 j nocecdal and s j wright numerical optimization springer 2 nd edition 2006 18 sina ober blo baum discrete mechanics and optimal control phd thesis university of paderborn 2008 19 j m sanz serna symplectic runge kutta schemes for adjoint equa tions automatic differentiation optimal control and more siam review 58 1 3 33 2016 20 yunong shi nelson leung pranav gokhale zane rossi david i schus ter henry hoffmann and frederic t chong optimized compilation of aggregated instructions for realistic quantum computers proceedings of the twenty fourth international conference on architectural support for programming languages and operating systems asplos 19 2019 37 21 a wa chter and l t biegler on the implementation of an interior point filter line search algorithm for large scale nonlinear programming mathe matical programming 106 1 25 57 mar 2006 22 d b zax g goelman and s vega amplitude modulated composite pulses j magn reson 80 2 375 382 1988 38 1 introduction 2 generalized gates 3 real valued formulation 3 1 time integration 3 2 time step restrictions for accuracy and stability 4 discretizing the objective function and its gradient 4 1 discretizing the objective function 4 2 the discrete adjoint approach 5 quadratic b splines with carrier waves 6 numerical optimization 6 1 a cnot gate on a single qudit with guard levels 6 2 the hessian of the objective function 7 comparing juqbox with qutip pulse optim and grape tf 7 1 setup of simulation codes 7 2 numerical results 8 conclusions appendix a the hamiltonian in a rotating frame of reference appendix b derivation of the discrete adjoint scheme appendix c proof of corollary 1 appendix d computing the gradient of the discrete objective function