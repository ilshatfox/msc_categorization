bayesian mixed effect sparse tensor response regression model with joint estimation of activation and connectivity daniel spencer rajarshi guhaniyogi raquel prado department of statistics baskin school of engineering uc santa cruz santa cruz ca 95064 november 12 2021 abstract brain activation and connectivity analyses in task based functional magnetic resonance imaging fmri experiments with multiple subjects are currently at the forefront of data driven neuroscience in such ex periments interest often lies in understanding activation of brain voxels due to external stimuli and strong association or connectivity between the measurements on a set of pre specified group of brain voxels also known as regions of interest roi this article proposes a joint bayesian additive mixed modeling framework that simultaneously assesses brain ac tivation and connectivity patterns from multiple subjects in particular fmri measurements from each individual obtained in the form of a multi dimensional array tensor at each time are regressed on functions of the stimuli we impose a low rank parafac decomposition on the tensor regression coefficients corresponding to the stimuli to achieve parsimony multiway stick breaking shrinkage priors are employed to infer activation patterns and associated uncertainties in each voxel further the model introduces region specific random effects which are jointly modeled with a bayesian gaussian graphical prior to account for the connectivity among pairs of rois empirical investigations under various simulation studies demonstrate the effectiveness of the method as a tool to simultaneously assess brain activation and connectivity the method is then applied to a multi subject fmri dataset from a balloon analog risk taking experiment in order to make inference about how the brain processes risk 1 introduction of late rapid advancements in different imaging modalities have generated mas sive neuroimaging data which are key in understanding how the human brain functions for the present article our motivation is mainly drawn from multi subject functional mri fmri studies in the context of an fmri scan the 1 ar x iv 1 90 4 00 14 8 v 1 st at a p 3 0 m ar 2 01 9 brain at a single point in time is envisioned as a three dimensional tensor par titioned into small cubes known as voxels lazar 2008 a relative measure of oxygen in the blood referred to as the blood oxygen level dependent bold measure is obtained from every voxel in each scan typically acquired around every two seconds such scans can be taken when a subject is in a resting state without any conditions imposed when a subject is exposed to certain condi tions stimuli such as noises or videos or when a subject is actively involved in completing a task as oxygen is required to perform functions in the brain these readings are used to infer which parts of the brain are active in a given thought process expected activation patterns include local spatial dependence in the sense that voxels located next to each other tend to be jointly activated as well as non local dependencies in which groups of voxels in distant regions of the brain are activated by a given thought process in addition to determining brain activation linked with a given cognitive or sensorimotor function neuroscientists are often interested in the way different spatially adjacent groups of voxels referred to as regions of interest rois in the brain work together to process information these types of relationships between rois are collectively referred to as functional connectivity hutchi son et al 2013 the major contribution of this article is the proposal of a bayesian modeling framework that simultaneously detects voxel level activation and connectivity between different rois with precise characterization of uncer tainty for multi subject fmri data simultaneous analysis of multi subject 3 d fmri scans is a challenging problem due to the sheer amount of data our modeling framework addresses this issue by a mixed effects tensor response re gression analysis in which low rank tensor decompositions are combined with a multiway stick breaking shrinkage prior to achieve parsimony such framework provides a powerful and computationally feasible setting for inferring activation and connectivity in multi subject task related fmri studies several approaches have been proposed for the analysis of brain activation single subject frameworks in particular have a rich background for modeling activation the simplest of them fits a regression model at each voxel with the observed voxel specific fmri measure as response regressed on activation related predictors and identifies if the response is significantly associated with the predictors in that voxel friston et al 1995 penny et al 2011 after ac counting for multiple correction although conceptually simple this approach fails to accommodate spatial association across voxels another idea which addresses the sparse nature of fmri activation assigns the spike and slab prior on the regression coefficients brown et al 1998 yu et al 2018 across all voxels various approaches also account for spatial association in the neighbor ing voxels by inducing dependence among voxel specific regression coefficients using markov random fields zhang et al 2014 kalus et al 2014 smith and fahrmeir 2007 lee et al 2014 guhaniyogi et al 2017 proposes a tensor decomposition method with shrinkage priors to model activation in the setting with a scalar response and a tensor predictor guhaniyogi and spencer 2018 extends this to a tensor valued response and a scalar predictor without accounting for any inter regional connectivity this approach focuses substan 2 tially on the posterior contraction theory of tensor response regression models with a brief simulation study and real data analysis illustrating the approach merely for single subject fmri analysis other sophisticated approaches include spatially varying coefficient svc models which employ spatial basis functions to model activation related coefficients flandin and penny 2007 zhu et al 2014 besides being computationally expensive such models are sensitive to the selection of the basis functions and require specific knowledge to appro priately calibrate them more recently a class of approaches proposes joint modeling of bold measures across all voxels in the form of a tensor response li and zhang 2017 though potentially useful for inferring activation these approaches have not been developed for multi subject studies in order to overcome the computational challenge of having voxel level data analyzed for multiple subjects early approaches combined information across voxels either using generalized linear model glm parameter estimates or residual variance two stage methods by bowman et al 2008 and sanyal and ferreira 2012 fitted subject specific glms and then used regularization on the parameter estimates to determine activation mixture models and non parametric bayesian models have also been proposed to analyze inter and intra subject variability though they incur heavy computational cost while there is considerable literature on activation only models literature on bayesian functional connectivity has witnessed a few very distinct approaches to this end patel et al 2006 a and patel et al 2006 b discretized the fmri time series between regions based on whether they had elevated activity ac cording to a threshold and then compared joint and marginal probabilities of elevated activity bowman et al 2008 modeled similarity within and between regions of interest based on estimates of elements of the covariance in a two stage model a dirichlet process prior was used by zhang et al 2014 to cluster remote voxels together asserting that the clustering inferred an inherent connec tivity zhang et al 2014 went on to propose a dynamic functional connectivity model estimating connective phases and temporal transitions between them as mentioned above there are several bayesian modeling frameworks for assessing activation or connectivity separately however models incorporating both of them jointly in multi subject fmri studies with voxel level data are comparatively rare in the literature in the recent past kook et al 2017 proposes such a model in which a dirichlet process dp mixture model is used to classify voxels as active via discrete wavelet transformations the clustering of the voxels through time via the mixture components is then used to derive a measure of inter voxel connectivity within and between subjects while their model succinctly captures activation and connectivity the use of a dirichlet process may hinder computational efficiency variational bayes methods were used to speed up computation which provide approximate posterior results in a fraction of the time that a full markov chain monte carlo simulation would require our article proposes a multi subject bayesian tensor mixed effect model that estimates voxel wise activation and inter regional connectivity simultaneously through a novel adaptation of shrinkage priors to elaborate further the model 3 envisions bold measures over all voxels together for a subject at any time as a tensor response and regresses this tensor object on the activation related predictor in order to achieve substantial parsimony the coefficient tensor is assumed to possess a low rank parafac decomposition and a multiway stick breaking shrinkage prior is assigned on the tensor coefficient to shrink the cells corresponding to unimportant voxels close to zero while maintaining accurate estimation and uncertainty of cell coefficients related to important voxels one of the main advantages of using tensor representations is that these are able to capture local and non local spatial effects without explicitly introducing a spatial structure into the model this is an advantage with respect to approaches such as those in kook et al 2017 which model local spatial correlation among voxels using markov random field priors in addition our proposed model incorporates subject roi specific random effects with a gaussian graphical prior imposing regularization on the precision matrix of the effects between regions wang et al 2014 both the activation and connectivity parameters are then classified into zero and nonzero effect sizes using the sequential 2 means method proposed by li and pati 2017 as a result the model produces accurate measures of voxel wise activation and inter regional connectivity with interpretable effect sizes and uncertainty quantification without the need for fine tuning hyperparameters or basis functions in addition the model is scalable and computationally efficient enough to provide samples from the exact posterior distribution for 2 d slices or 3 d volumes of brain images as well as higher order tensor images the upcoming sections proceed as follows the model including the prior structure is set forth in section 2 section 3 discusses posterior inference section 4 empirically validates the model with simulation studies sensitivity to hyperparameter specification is also demonstrated to illustrate the robustness of the model section 5 describes the multi subject fmri data from the balloon analog risk taking experiment in detail finally section 6 presents a discussion of the results and describes some future extensions 2 methodology this section begins by setting the tensor notation and the parafac decompo sition structure the complete modeling framework including prior structure and hyperparameter specification is then detailed 2 1 notation and preliminaries a tensor a is a d way array also known as a d th order tensor of dimensions p 1 pd with i 1 id th cell entry denoted by a i 1 id r i 1 1 p 1 id 1 pd for vectors a 1 ad of lengths p 1 pd respectively define the outer product between the vectors denoted by a a 1 ad as a d way array with i 1 id th cell element a i 1 id d j 1 aj ij where aj ij is the ij th element of aj a is referred to as a rank 1 tensor with dimensions p 1 pd a rank r tensor a is obtained by summing r rank 1 4 tensors a r r 1 a 1 r ad r this is also referred to as the cp parafac decomposition of rank r kiers 2000 and is used due to its relative simplicity kolda and bader 2009 in what follows we will refer to aj r s as margins of the tensor a 2 2 model framework and prior structure let y i g t be the observed fmri data in brain region g for the ith subject at the tth time point y i g t is observed in the form of a tensor of dimensions p 1 g pd g in the context of fmri data analysis d is two or three depending on whether a single slice or the entire brain volume is analyzed to simultaneously measure activation due to stimulus at voxels in the gth brain region and connectivity among g brain regions we employ an additive mixed effect model with tensor valued fmri response and activation related predictor xi t r yi g t bgxi t di g ei g t 1 for subject i 1 n in region of interest g 1 g and time t 1 t elements in the error tensor ei g t are assumed to be normally distributed with mean 0 and shared variance 2 y though our framework can be extended to in corporate temporally correlated errors without loss of generality the response tensor yi g t in the proposed model is centered over each roi to eliminate the need for an intercept term the tensor coefficient bg rp 1 g pd g is used to infer the strength of the association between xi t and each voxel in yi g t in particular bg i 1 id 0 implies that the i 1 id th voxel in the gth roi is not activated by the stimulus in fact the activation pattern is typically sparse and localized with only a few nonzero elements in bg di g r are region and subject specific random effects which are jointly modeled to borrow information across rois in the present context the conditional distributions di g di g di g g 6 g g are investigated to assess the strength of connectivity between a pair of regions as part of the model development we impose prior distributions that favor conditional independence between most pairs di g and di g estimating connectivity only among a few pairs of regions as mentioned above the coefficient tensor bg rp 1 g pd g in equation 1 characterizes a sparse relationship between the tensor response and the time varying covariate xi t in region g in order to achieve parsimony in the number of estimated parameters bg is assumed to have a rank r parafac decompo sition bg r r 1 g 1 r g d r 2 with tensor margins g 1 r g d r the parafac tensor decomposition dra matically reduces the number of parameters inbg from d j 1 pj g tor d j 1 pj g 5 with the extent of the achieved parsimony being dependent on r note that a smaller value of r leads to parsimony and computational gain perhaps at the cost of inferential accuracy in contrast a choice of even moderately large r entails higher computation cost again using r as a model parameter of ten increases computation cost and is deemed unnecessary guhaniyogi et al 2017 in view of the earlier literature this article proposes fitting the model with various choices of r and chooses the one that yields the lowest deviance information criterion dic gelman et al 2014 more discussion on the choice of r is provided in section 4 a critical question remains how to devise a prior distribution on the low rank decomposition 2 to facilitate identifying geometric sub regions in the tensor response which share an association with the predictor additionally the model intends to build joint priors on region specific random effects di gs to assess connectivity patterns the next two sections propose careful elicitation of the prior distributions on bg and di g to achieve our stated goals 2 3 multiway stick breaking shrinkage prior on bg to as sess activation although the spike and slab priors for selective predictor inclusion george and mcculloch 1993 ishwaran et al 2005 possess attractive theoretical properties and an easy interpretation they often lose their appeal due to their inability to explore a large parameter space as a computationally convenient alternative an impressive variety of shrinkage priors carvalho et al 2010 armagan et al 2013 in the context of ordinary bayesian high dimensional regression have been developed shrinkage architecture relies on shrinking coefficients corresponding to unim portant predictors while maintaining accurate estimation with uncertainty for important predictor coefficients the existing shrinkage prior literature serves as a basis to the development of shrinkage priors on the tensor coefficients however constructing such a prior on bg presents additional challenges to elaborate on it notice that proposing a prior on a low rank parafac decom position ofbg is equivalent to specifying priors over tensor margins g j r since every cell coefficient in bg is a nonlinear function of the tensor margins careful construction of shrinkage priors on g j rs is important to impose desirable tail behavior of bg i 1 id parameters to this end this article employs a multi way stick breaking shrinkage prior onbg to ensure desirable tail behavior more specifically the following shrinkage prior is proposed on the tensor margins g j r n 0 g r gwg j r wg j r diag g j r 1 g j r pj where g j r exp 2 g j r 2 g j r iid gamma a b 6 for j 1 d and g 1 g this prior defines a set of rank specific scale parameters g r using a stick breaking construction of the form g r g r r 1 l 1 1 g l r 1 r 1 and g r 1 r 1 r 1 g r r 1 l 1 1 g l that achieves efficient shrinkage across ranks where g r iid beta 1 g the global scale parameters are modeled as 1 g iid ig a b flexibility in modeling tensor margins are accommodated by introducing w g j rs in fact integrating out w g j r and g j r yields a generalized double pareto shrinkage prior for the elements of g j r conditional on g r and g without constraints on the values for g r g where r 1 r identifiability issues arise in the posterior sampling for the variance terms for g j r bg in order to address this issue a stick breaking structure is imposed on g r s as described above in effect this prevents g r s from switching labels across ranks in which the variance of g j r may be close together the result of this constraint is a more stable mcmc for the posterior draws of g j r the tuning parameter g in the stick breaking construction assumes a crucial role in determining which tensor rank r is favored by data in particular g 0 favors small values of most g r a priori therefore a data dependent learning of g is essential in order to tune to the desired sparsity in bg section 2 5 dis cusses a model based choice of g along with the specific choices for a b a and b 2 4 bayesian graphical lasso prior for modeling connec tivity following wang et al 2012 to capture connectivity between different regions for individuals di gs are jointly modeled with a gaussian graphical lasso prior to be more precise di di 1 di g n 0 1 i 1 n p c 1 k l de kl g k 1 exp kk 2 1 p 3 where p is the class of all symmetric positive definite matrices and c is a normalization constant kl k l is a vector of upper triangular and diagonal entries of the precision matrix using properties of multivariate gaussian distribution a small value of kl stands for weak connectivity between rois k and l given the other rois in fact kl 0 k l implies that there is no connectivity between rois k and l given the other rois thus to favor shrinkage among off diagonal entries of for drawing inference on connectivity between pairs of rois the bayesian graphical lasso prior employs double exponential prior distributions on the off diagonal entries of this precision matrix the diagonals of are assigned exponential distributions let kl k l be a set of latent scale parameters using the popular scale 7 mixture representation of double exponential distributions wang et al 2012 we can write p p p d with p given by p c 1 k l 1 2 kl exp 2 kl 2 kl g k 1 2 exp 2 kk 1 p 4 where c is the normalizing constant which is an analytically intractable func tion of the mixing density of in the representation above is given by p c k l 2 2 exp 2 2 kl 5 the hierarchy is completed by adding a gamma prior on gamma a b finally an inverse gamma prior 2 y inverse gamma a b is used on the variance parameter 2 y 2 5 hyperparameter specification the hyperparameters g in the stick breaking construction play a key role in controlling the dimensionality of the model with smaller values effectively fa voring a low rank tensor factorization a discrete uniform prior is placed on the g parameters over 10 equally spaced values in the interval r d r 10 which will allow the data to dictate the level of sparsity appropriate for the prior guhaniyogi et al 2017 the posterior distribution of an g concentrated to ward the left end of the interval encourages parsimony while the posterior of an g concentrating at higher values permits a less sparse parafac decom position the chosen prior range of g works for various simulation studies and moderate perturbation of the prior range seems to produce robust inference the values chosen for a and b have a strong effect on the shrinkage properties of the generalized double pareto prior and setting a 3 and b 2 d a pre vents the prior for g j r from allowing for insufficient variance for bg i 1 id to detect nonzero coefficients similar to guhaniyogi et al 2017 the hyperpa rameters a and b are set to d 1 and r 1 d 1 respectively in order to prevent overshrinkage with higher tensor response dimensions following wang et al 2014 a and b are set to 1 and 0 01 respectively in order to preserve relative noninformativity of the gaussian graphical prior finally for both simulation studies and the real data analysis a and b were set to be 1 and log 0 95 respectively while these hyperparameters are specified to provide readers a specific set of choices and they produce desirable results we establish in sec tion 4 that the inference is fairly robust with moderate perturbation of these hyperparameters 8 3 posterior computation the model framework and prior structure allow sampling from the posterior distribution using the markov chain monte carlo mcmc algorithm outlined in the supplementary material web appendix a the posterior distributions of unknown quantities of interest are approximated by their empirical distributions from post burn in mcmc samples of particular interest in neuroscience is the assessment of whether a brain voxel is active or not which in our modeling framework translates to verifying whether bg i 1 id is nonzero for any voxel i 1 id it is well acknowledged that the problem of selecting important cell coefficients is a challenging task when bg is assigned a continuous shrinkage prior since none of the cell coeffi cients is exactly zero in any mcmc iteration following the recent sequential 2 means variable selection approach of li and pati 2017 we aim to address the problem of identifying significantly nonzero cell coefficients through post processing the posterior samples the approach is based on first obtaining a posterior distribution of the number of signals by sequentially clustering the signal and the noise cell coefficients together followed by estimating the signals from the posterior median in the interest of space we refer to section 2 2 of li and pati 2017 for more details about the algorithm in order to obtain an interpretable measure the connectivity between regions the partial correlation between regions is examined since the partial correlation accounts for the correlation between two regions after removing the influence of all other regions das et al 2017 it is expected to be the best measure of pairwise connections first the sequential two means variable selection method li and pati 2017 was used on the posterior samples of the precision matrix in order to select which precision elements were not equal to zero the resulting precision matrix estimate was transformed into the partial correlation using the prec 2 part function in the densparcorr package in r wang et al 2018 regions with nonzero partial correlations are said to be connected warnick et al 2018 4 simulation studies to validate the proposed methods we simulate synthetic data with similar struc ture to that found in data collected from human fmri studies the tensor responses are simulated considering a block experimental design from the likeli hood in 1 in each simulation study we construct g 10 different coefficient tensors corresponding to disjoint spaces hereafter referred to as regions for ease of visualization the coefficient tensors are created to be three dimensional but can be generalized to any arbitrary dimension d throughout the simula tion study a sample size of n 20 subjects is used with the number of time points per subject being fixed at t 100 the covariate xi t xt was set to be the same for all of the subjects without any loss of generality a block experimental design is employed to generate the 9 covariates which consists of several discrete epochs of activity rest periods with the activity representing a period of stimulus presentations and the rest referring to a state of rest or baseline these activity rest periods are alternated throughout the experiment to ensure that signal variation scanner sensitivity and subject movement have the similar effect throughout the experiment to simulate activity rest periods we use the stimulus indicator function zt as zt 1 for kp t kp p 2 k 0 1 0 otherwise for all t given a defined period p for the block design in our simulations p is set to be 30 next the canonicalhrf function in the neurosim package in r welvaert et al 2011 is used to convolve the stimulus indicator zt with the double gamma canonical hemodynamic response function hrf which cor rects for the expected delay between a stimulus and the resultant physiological response in the brain friston et al 1998 this hrf is set using the default function values in neurosim to have a delay of response relative to onset equal to 6 time steps a delay of undershoot relative to onset of 12 a dispersion of response equal to 0 9 a dispersion of undershoot equal to 0 9 and a scale of undershoot equal to 0 35 the resulting covariate xt is plotted in web figure 1 the dimensions of response tensor margins p 1 g p 2 g and p 3 g are drawn from a poisson distribution with a rate parameter of 10 for each region g this generated tensor regions that have margin lengths in the range between 5 and 16 producing 10 different regions with a mean of 1107 8 voxels in each region in order to demonstrate the effectiveness of the shrinkage component of the model the true tensor coefficient values were randomly assigned using the specifyregion function from neurosim this function allows us to define ten sors such that nonzero elements are spatially contiguous spheres in this simu lation the coefficient tensors are designed such that all elements took the value of either zero or one in real fmri data activation is typically observed in a small number of voxels regions therefore we set the sizes of the true activated cells in our simulated data to be no greater than 5 of the total tensor size the true values for a slice of one of the coefficient tensors can be seen in web figure 2 the contrast to noise ratio defined as bg v y for bg v 6 0 welvaert and rosseel 2013 was set to be equal to 1 which is proposed as a realistic value for neuroimaging data by rowe and logan 2004 the connectivity between tensor regions was simulated by setting two pairs of the ten regions to have a region wide correlation of 0 9 while all other regions were assigned correlations of zero a covariance matrix 1 was created from this correlation matrix and the region effects for subject i were simulated from a multivariate normal distribution with mean zero and covariance 1 the signal to noise ratio de fined as 1 i j 2 y was set to 5 a realistic value based on welvaert and rosseel 2013 this quantity can be thought of as the relative effect of the connectivity on the observed response tensors finally the observation level variance 2 y was set to be 1 10 competitors we fitted our proposed bayesian model to the simulated data using different choices of rank r in most of the real life applications smaller values of r are sufficient to attain the desired inference hence the model was tested for ranks 1 through 5 the performance of the proposed model is compared with an alternative approach that vectorizes the tensor response builds voxel specific regression model by regressing the response on predictors followed by jointly estimating the voxel specific regression coefficients using a shrinkage prior dis tribution more precisely if yi g t v 1 v 2 v 3 is the response at voxel v 1 v 2 v 3 in region g at time t for individual i our competing model proposes yi g t v 1 v 2 v 3 ind n b g v 1 v 2 v 3 xi t d i g 2 g n 0 gw g 6 where g b g v 1 v 2 v 3 v 1 1 p 1 g v 2 1 p 2 g v 3 1 p 3 g rp 1 g p 2 g p 3 g is the vector of coefficients and w g g v 1 v 2 v 3 v 1 1 p 1 g v 2 1 p 2 g v 3 1 p 3 g d i g s are jointly assigned a gaussian graphical prior similar to 3 the hierarchical specification is completed by assigning g gamma a b g v 1 v 2 v 3 exp 2 g 2 g gamma a b we coin this approach as vectorized gdp comparison with this reveals the advantage of retaining the tensor structure of the response as well as the advantage due to the parsimony offered by the parafac decomposition we also attempted to implement a spatially varying coefficient svc model zhang et al 2015 and found to be computationally demanding due to large matrix inversions in each mcmc step hence the comparison with svc is not reported comparison metrics mcmc is run for 1100 iterations for all competitors with a 100 burn in and the remaining used for inference the assessment of convergence is made by the raftery lewis diagnostic test implemented in the r package coda it shows a median effective sample size of 1 000 for the elements of bg in the rank 1 model decreasing to a median effective sample size of 684 in the rank 5 model after the burn in which seems sufficient for satisfactory inference comparisons among competitors are based on a a model fitting statistic b point estimation of bg s and c frequentist coverage and length of 95 credible intervals ci the accuracy of detecting active and inactive voxels for each competitor are also reported finally we compare competitors in terms of identifying connectivity between regions model fitting is compared using the deviance information criterion dic defined in gelman et al 2014 as dic 2 log p y b d x 2 y 2 pdic where pdic 2 log p y b d x 2 y 1 s s s 1 log p y b s ds x 2 s y is the posterior mean of any parameter s is the total number of post burn in poste rior samples the superscript s denotes sth post burn in posterior sample for a parameter y x are the collection of all responses and predictors respectively in order to correct for any outlier posterior draws the dic was calculated by 11 table 1 performance diagnostics based on 1 100 draws from the posterior dis tribution with multiple different models using the same simulated data for the dic rmse auc and 95 interval length and coverage the first 100 draws from the posterior distribution are discarded as a burn in parameters time hrs log dic rmse for b auc 95 credible interval lengths 95 credible interval coverage rank 1 309 3 13 21 8085 0 1890 0 5495 0 0298 0 3091 rank 2 618 5 24 21 8094 0 1184 0 8775 0 0336 0 8176 rank 3 927 6 20 21 8080 0 0807 0 9483 0 0364 0 8992 rank 4 1236 6 93 21 8310 0 0679 0 9880 0 0415 0 9247 rank 5 1545 7 84 21 8104 0 0681 0 9877 0 0432 0 9604 vectorized 11078 2 15 21 8286 0 1129 0 9096 0 2115 1 0000 thinning the posterior sample to every four draws after burn in for comparison between the models in terms of point estimation of bg s we compute square root of the mean squared error between the estimated tensor coefficient and true tensor coefficient g g 1 v rg b g v b 0 g v 2 where rg represents region g b 0 g v and b g v are the true and the posterior mean of the vthe cell coefficient in the gth region respectively given the posterior mean estimates of bg v sequential two means approach li and pati 2017 is employed to identify active and inactive voxels true positive rate tpr and false positive rate fpr are computed corresponding to different thresholds and the area under the receiving operating characteristic roc curve known as the auc is presented as a measure of how well the truely active and inactive voxels are detected by the proposed method finally uncertainty quantification by the competitors is assessed by length and coverage 95 posterior credible intervals we also report computation times for the competing models results performance measures for all the competitors are summarized in table 1 the proposed model with various ranks show significant improvement in terms of model fitting statistic over the vectorized gdp the tensor models also demon strate benefit in terms of point estimation and uncertainty quantification while all tensor models of rank more than 3 show close to nominal coverage vectorized gdp suffers from over coverage with a much wider 95 credible interval in fact tensor models corresponding to rank 3 4 5 show excellent detection of activated regions as is witnessed in figure 2 and auc column of table 1 although rank 4 and 5 models demonstrate marginally lower rmse and im proved coverage over the rank 3 model rank 3 model enjoys lowest model fitting statistic perhaps the rank 4 and 5 models are penalized for having a large number of parameters see table 1 overall tensor models with rank greater than 2 comprehensively outperform vectorized gdp as competitors similar to the tensor coefficient sequential two means method li and pati 2017 is used on the off diagonal elements of the precision matrix to recover the connectivity structure among regions in the simulated data all uncon nected regions are classified to have a partial correlation of zero and the con 12 nected regions have nonzero partial correlations the estimates are shown in web figure 3 importantly the assessment of connectivity appears to be accu rate and robust across tensor models of all ranks the underestimation of the partial correlation has two causes a relatively low signal to noise ratio and the shrinkage of the estimates that stems from the application of a strong shrinkage prior on the off diagonal hyperparameter sensitivity finally in order to test the robustness of the model to choices of the hyper parameters a grid of hyperparameter values was made by scaling each of the standard values for a b a b a b a and b defined in section 2 5 by 0 01 1 and 100 resulting in 6 561 different combinations of these 100 set tings were randomly sampled from the list and then tested with tensor model corresponding to rank 3 we graphed boxplots of the rmse as well as length and coverage of 95 ci for all these hyperparameter combinations these are available in web figure 4 of the supplementary material the results are fairly robust with all three metrics varying within a small range under all different hyperparameter combinations overall the simulation study reveals excellent recovery of activation and connectivity among regions by the proposed model although the computation time for the proposed model may a bit on the higher side the burden is somewhat lessened by the rapid mcmc convergence for the model parameters allowing accurate inference even with a small burn in 5 real data analysis we analyze data collected in a study examining the fmri scans of individuals undergoing a test which introduces risk taking scenarios this study is known as the balloon analog risk taking task experiment schonberg et al 2012 guhaniyogi and spencer 2018 also presented a brief analysis of this data though only a single subject is chosen for the analysis the data are avail able from the openfmri project and the openneuro platform at https openneuro org datasets ds 000001 versions 00006 app mriqc version 33 job 5978 f 5 dca 1 f 52600019 e 85 c 4 it consists of 16 individuals who were scanned using a 3 t siemens ag allegra mri machine in the ahmanson lovelace brain mapping center at ucla while in the scanner the subjects inflated simu lated balloons a trial is defined as a balloon that can be pumped a certain number of times each trial could end in one of two ways first the subject could cash out at any point during the trial and add the cumulative winnings for that balloon to their collective bank second upon pumping a balloon may explode and the participants would lose the cumulative winnings for that balloon and nothing would be added to their collective bank the subjects interacted with the simulation by pushing one of two buttons with their right pointer finger or right middle finger each trial began with winnings of 0 25 displayed below the balloon and each successive pump added 0 25 to the cu mulative winnings for that balloon the balloons were red green or blue in color and the maximum number of pumps for a balloon was drawn from a dis 13 https openneuro org datasets ds 000001 versions 00006 app mriqc version 33 job 5978 f 5 dca 1 f 52600019 e 85 c 4 https openneuro org datasets ds 000001 versions 00006 app mriqc version 33 job 5978 f 5 dca 1 f 52600019 e 85 c 4 https openneuro org datasets ds 000001 versions 00006 app mriqc version 33 job 5978 f 5 dca 1 f 52600019 e 85 c 4 crete uniform distribution between 1 and 8 12 or 16 depending on the color of the balloon intermittently subjects would be shown a grey control balloon with a maximum of 12 pumps that did not explode and did not have any asso ciated monetary value unlike with the colored balloons subjects did not have the option to cash out when inflating the control balloon each run for each subject was ten minutes in length during which each color balloon could be presented no more than 12 times using fsl smith et al 2004 the fmri scans were smoothed to correct for motion using a gaussian kernel with a full width half maximum fwhm of 5 mm and then mapped to the montreal neurological institute mni standard in order to compare scans between subjects with different brain sizes a slice of the brain at z 4 was then extracted from the larger response tensor for each subject this slice was chosen because it has large contiguous regions which should present a challenge when attempting to classify an appropriate number of active and inactive voxels in the brain the data were separated into 9 regions of interest based on the mni structural atlas evans et al 1994 the regions vary in size and the median number of voxels per region for each subject is 646 to measure the level of risk being processed by a subject at a given time begin with the centered number of pumps that an individual gave a treatment balloon before they cashed out or the balloon exploded it is assumed that the higher the number of pumps becomes the more risk is present to the individual this value was then convolved with the double gamma haemody namic response function which takes into account the physiological lag between stimulus and response and smooths the stepwise function for the centered num ber of pumps finally the centered convolved number of pumps on the control balloon is subtracted from the treatment series to provide a basis of comparison figure 1 shows the raw values for the centered number of control and treatment pumps as well as the convolved pump functions and the final values for the co variate that were used in these analyses the haemodynamic response function was defined using the default values given in the specifydesign function of the neurosim package in r the independent variable was then created as the difference between para metric modulation of the number of pumps on the treatment balloons and on the control balloons the same covariate is used in one of the analyses done in schonberg et al 2012 see figure 1 we fitted our proposed bayesian tensor mixed effect model with ranks r 1 2 3 4 5 with the prior structure specified in section 2 similar to simulation studies 1 100 samples were drawn from the joint posterior distribution of all of the parameters and the first 100 samples were discarded as a burn in measure the effectivesize function within the coda package in r is used to calculate median values for the effective sample size for the 1 000 posterior draws of the elements in all bg for the five different rank models see table 2 table 2 indicates fairly uncorrelated post burn in posterior samples to draw reliable posterior inference the posterior median tensors bg within the brain have been reorganized to their original positions and can be seen in figure 2 higher values of the 14 figure 1 the numeric values for the centered number of pumps for the control and treatment balloons their convolutions with the double gamma haemody namic response function and the final covariate used for these analyses coefficient means that there is more blood flow associated with higher levels of perceived risk larger positive values indicate that blood flow increases in these regions as risk increases larger negative values show regions that exhibit a decrease in blood flow as risk increases perhaps indicating that blood flows from these regions to the regions with increased blood flow similar to the simulation studies the vectorized gdp model competitor is also fitted to the data to assess the advantages of preserving the tensor structure of the brain image in our proposed model according to the deviance information criterion dic gelman et al 2014 given in table 2 rank 3 is the best performing tensor mixed effect model importantly rank 3 model also yields considerably smaller dic value than the vectorized gdp figure 2 shows that all the models considered generally agree in terms of the posterior activation results however the tensor models provide more differentiated estimates of activation strength than those obtained from the vectorized model particularly in the frontal lobe table 2 the median effective sample size and log deviance information criterion for the five rank models rank 1 rank 2 rank 3 rank 4 rank 5 vectorized median ess 1000 0000 974 2903 874 0009 845 8368 845 8359 1000 0000 log dic 22 5430 22 5442 22 5428 22 5552 22 5551 22 5455 the estimates for the partial correlations between regions shown in figure 3 indicate that the frontal lobe plays an important role in this task showing significant positive partial correlation with the insula parietal lobe and puta men and significant negative partial correlation with the occipital lobe this agrees with earlier experiments suggesting that the frontal lobe plays a role in the assessment of risk miller and milner 1985 15 figure 2 the posterior median results for the rank 1 through 5 models after using sequential 2 means to classify coefficient values as zero or nonzero for comparison vectorized model estimate is also included black regions were not analyzed as they were not included in any regions in the montreal neurological institute atlas 16 figure 3 the connected regions of the brain in the rank 3 model based on the partial correlation the partial correlation here was found after using the sequential two means method li and pati 2017 on the precision matrix ele ments 6 discussion bayesian literature on multi subject joint modeling of voxel level activation and roi level connectivity is quite sparse due to the sheer volume of data from mul tiple subjects seeking to fill this gap this article provides a bayesian joint mod eling framework for exact inference of voxel wise brain activation and functional connectivity between predefined rois in fmri data arising from multi subject experiments the proposed approach is based on a tensor mixed effect response model to ensure computational flexibility as well as parsimony parafac tensor decomposition is employed for representing tensor valued activation co efficients additionally bayesian graphical modeling components are used for ascertaining connectivity between rois the proposed model produces marked improvement over a vectorized response model both in terms of identifying point estimation and quantifying uncertainty in a statistically principled manner the robustness of the model to choices of hyperparameters and the flexibility of the modeling structure without using basis functions makes these models accessible to a wide range neuroscientists and statisticians alike the open source code have been written to generalize to tensors of any dimension which may prove useful in applications outside neuroimaging our proposed approach assumes several important extensions notably the parsimony in activation coefficients achieved by a parafac decomposition may appear to be restrictive in certain applications and can be replaced by a 17 more flexible tucker decomposition extensions of 1 that incorporate nonlin ear regional effects through time will also be explored finally investigation into model driven choices for subject specific haemodynamic response functions may improve upon the accuracy of the proposed approach in real data applications references armagan a dunson d b and lee j 2013 generalized double pareto shrinkage statistica sinica 23 119 6 bowman f d caffo b bassett s s and kilts c 2008 a bayesian hierarchical framework for spatial modeling of fmri data neuroimage 39 146 156 3 brown p j vannucci m and fearn t 1998 multivariate bayesian variable selection and prediction journal of the royal statistical society series b statistical methodology 60 627 641 2 carvalho c m polson n g and scott j g 2010 the horseshoe estimator for sparse signals biometrika 97 465 480 6 das a sampson a l lainscsek c muller l lin w doyle j c cash s s halgren e and sejnowski t j 2017 interpretation of the precision matrix and its application in estimating sparse brain connectivity during sleep spindles from human electrocorticography recordings neural computation 29 603 642 9 evans a c kamber m collins d and macdonald d 1994 an mri based probabilistic atlas of neuroanatomy in magnetic resonance scanning and epilepsy pages 263 274 springer 14 flandin g and penny w d 2007 bayesian fmri data analysis with sparse spatial basis function priors neuroimage 34 1108 1125 3 friston k j ashburner j frith c d poline j b heather j d and frackowiak r s 1995 spatial registration and normalization of images human brain mapping 3 165 189 2 friston k j fletcher p josephs o holmes a rugg m and turner r 1998 event related fmri characterizing differential responses neuroimage 7 30 40 10 gelman a carlin j b stern h s dunson d b vehtari a and rubin d b 2014 bayesian data analysis volume 2 crc press boca raton fl 6 11 15 george e i and mcculloch r e 1993 variable selection via gibbs sam pling journal of the american statistical association 88 881 889 6 18 guhaniyogi r qamar s and dunson d b 2017 bayesian tensor regres sion journal of machine learning research 18 1 31 2 6 8 guhaniyogi r and spencer d 2018 bayesian tensor response regression with an application to brain activation studies technical report ucsc 2 13 hutchison r m womelsdorf t allen e a bandettini p a calhoun v d corbetta m della penna s duyn j h glover g h gonzalez castillo j et al 2013 dynamic functional connectivity promise issues and interpretations neuroimage 80 360 378 2 ishwaran h rao j s et al 2005 spike and slab variable selection fre quentist and bayesian strategies the annals of statistics 33 730 773 6 kalus s sa mann p g and fahrmeir l 2014 classification of brain activation via spatial bayesian variable selection in fmri regression advances in data analysis and classification 8 63 83 2 kiers h a 2000 towards a standardized notation and terminology in mul tiway analysis journal of chemometrics a journal of the chemometrics society 14 105 122 5 kolda t g and bader b w 2009 tensor decompositions and applications siam review 51 455 500 5 kook j h guindani m zhang l and vannucci m 2017 npbayes fmri non parametric bayesian general linear models for single and multi subject fmri data statistics in biosciences pages 1 19 3 4 lazar n 2008 the statistical analysis of functional mri data springer science business media 2 lee k j jones g l caffo b s and bassett s s 2014 spatial bayesian variable selection models on functional magnetic resonance imaging time series data bayesian analysis online 9 699 2 li h and pati d 2017 variable selection using shrinkage priors computa tional statistics data analysis 107 107 119 4 9 12 17 25 26 li l and zhang x 2017 parsimonious tensor response regression journal of the american statistical association pages 1 16 3 miller l and milner b 1985 cognitive risk taking after frontal or temporal lobectomyii the synthesis of phonemic and semantic information neuropsy chologia 23 371 379 15 patel r s bowman f d and rilling j k 2006 a a bayesian approach to determining connectivity of the human brain human brain mapping 27 267 276 3 19 patel r s bowman f d and rilling j k 2006 b determining hierarchi cal functional networks from auditory stimuli fmri human brain mapping 27 462 470 3 penny w d friston k j ashburner j t kiebel s j and nichols t e 2011 statistical parametric mapping the analysis of functional brain images elsevier 2 rowe d b and logan b r 2004 a complex way to compute fmri acti vation neuroimage 23 1078 1092 10 sanyal n and ferreira m a 2012 bayesian hierarchical multi subject mul tiscale analysis of functional mri data neuroimage 63 1519 1531 3 schonberg t fox c r mumford j a congdon e trepel c and pol drack r a 2012 decreasing ventromedial prefrontal cortex activity during sequential risk taking an fmri investigation of the balloon analog risk task frontiers in neuroscience 6 13 14 smith m and fahrmeir l 2007 spatial bayesian variable selection with ap plication to functional magnetic resonance imaging journal of the american statistical association 102 417 431 2 smith s m jenkinson m woolrich m w beckmann c f behrens t e johansen berg h bannister p r de luca m drobnjak i flitney d e et al 2004 advances in functional and structural mr image analysis and implementation as fsl neuroimage 23 s 208 s 219 14 wang h et al 2012 bayesian graphical lasso models and efficient posterior computation bayesian analysis 7 867 886 7 8 wang x nan b zhu j and koeppe r 2014 regularized 3 d functional regression for brain image data via haar wavelets the annals of applied statistics 8 1045 4 8 wang y kang j kemmer p b and guo y 2018 densparcorr dens based method for partial correlation estimation in large scale brain net works r package version 1 1 9 warnick r guindani m erhardt e allen e calhoun v and vannucci m 2018 a bayesian approach for estimating dynamic functional network connectivity in fmri data journal of the american statistical association 113 134 151 9 welvaert m durnez j moerkerke b verdoolaege g and rosseel y 2011 neurosim an r package for generating fmri data journal of statistical software 44 1 18 10 welvaert m and rosseel y 2013 on the definition of signal to noise ratio and contrast to noise ratio for fmri data plos one 8 e 77089 10 20 yu c h prado r ombao h and rowe d 2018 a bayesian vari able selection approach yields improved detection of brain activation from complex valued fmri journal of the american statistical association pages 1 16 2 zhang j li x li c lian z huang x zhong g zhu d li k jin c hu x et al 2014 inferring functional interaction and transition patterns via dynamic bayesian variable partition models human brain mapping 35 3314 3331 3 zhang l guindani m and vannucci m 2015 bayesian models for func tional magnetic resonance imaging data analysis wiley interdisciplinary re views computational statistics 7 21 41 11 zhang l guindani m versace f and vannucci m 2014 a spatio temporal nonparametric bayesian variable selection model of fmri data for clustering correlated time courses neuroimage 95 162 175 2 3 zhu h fan j and kong l 2014 spatially varying coefficient model for neuroimaging data with jump discontinuities journal of the american statistical association 109 1084 1098 3 a web appendix a this posterior sampling algorithm can be done efficiently by sampling the region specific variables in parallel 1 draw g via a griddy gibbs algorithm as follows a for each possible value of g draw a sample of size m from the pos terior distributions of r g and g b evaluate the posterior density using each of these individual samples using the previous iteration values for all other parameters c average these densities together for each possible value for g in the grid and then sample one value using the averaged densities as weights 2 using the posterior full conditional kernel of p g r g r wg r g r g pj 2 g r 1 g r r r pj 2 exp 1 g 1 g r d j 1 tg j rw 1 g j r g j r r k r 1 1 g k k 1 r 1 g d j 1 tg j rw 1 g j r g j r 21 draw s g r for sample s using a metropolis hastings step with a normal pro posal distribution with mean s 1 g r and variance 0 01 2 the value for the variance was chosen such that the datasets tested showed decent mixing after drawing g 1 g r 1 set g r g r r 1 k 1 1 g k and set g r 1 r 1 r 1 g r 3 draw each g from a generalized inverse gaussian distribution gig where a r pj 2 r r 1 1 r d j 1 r j w r 1 j r j 2 b 4 draw each r g j from a gamma a pj b 1 g r g pj 1 r gj 5 draw each r g j from a generalized inverse gaussian distribution gig where 1 2 r g 2 j g g r r g 2 j 6 when d 2 draw each r g j z from a normal distribution with variance 1 g r g r g j z n x 2 t r g j r g j 2 y 1 and mean xt r g j y g t i 2 y where y g t i y g t i d g i 1 xt 6 r g 1 g 2 7 draw each di from a normal distribution di 1 di g di n i m 22 where m tv 2 y 1 and i m v t y i v t 2 y where t is the number of time steps in the fmri scan v is a diagonal matrix where vii is equal to the number of voxels in region i and y i v t y i 1 y i g y i g yi g bx 8 for each region g draw g from a gamma n 2 1 sgg 2 9 draw from a multivariate normal distribution with covariance sgg 1 g g diag 1 g g 1 and mean l sg g set g g g g and g g g t 1 g g 10 for i g draw ug i from an inverse gaussian distribution with mean 2 g i and shape 2 set g i i g 1 ug i 11 draw from a gamma a b distribution where a a g g 1 2 b b i j ij 2 following this algorithm the mcmc converges rapidly to the region of the maximum likelihood estimator 23 b web figure 1 figure 4 values for the covariate xt in the simulated data 24 c web figure 2 figure 5 rank model estimates and true value for a single slice of a three dimensional coefficient tensor estimates are found using the sequential two means variable selection method li and pati 2017 25 d web figure 3 figure 6 estimates of the partial correlation for all possible region pairs after using the sequential 2 means method from li and pati 2017 the true partial correlation values for all region pairs are shown for comparison 26 e web figure 4 figure 7 boxplots for the 95 interval coverage interval length and square root of the mean squared error for the 100 randomly selected hyperparameter settings 27 1 introduction 2 methodology 2 1 notation and preliminaries 2 2 model framework and prior structure 2 3 multiway stick breaking shrinkage prior on bold 0 mu mumu bbbbbb g to assess activation 2 4 bayesian graphical lasso prior for modeling connectivity 2 5 hyperparameter specification 3 posterior computation 4 simulation studies 5 real data analysis 6 discussion a web appendix a b web figure 1 c web figure 2 d web figure 3 e web figure 4