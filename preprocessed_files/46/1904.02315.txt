thick families of geodesics and differentiation chris gartland abstract the differentiation theory of lipschitz functions taking values in a banach space with the radon nikody m property rnp originally developed by cheeger kleiner has proven to be a powerful tool to prove non bilipschitz embeddability of metric spaces into these banach spaces important examples of metric spaces to which this theory applies include nonabelian carnot groups and laakso spaces in search of a metric characterization of the rnp ostro vskii found another class of spaces that do not bilipschitz embed into rnp spaces namely spaces containing thick families of geodesics our first result is that any metric space containing a thick family of geodesics also contains a subset and a probability measure on that subset which satisfies a weakened form of rnp lipschitz differentiability a corollary is a new nonembeddability result our second main result is that if the metric space is a nonrnp banach space a subset consisting of a thick family of geodesics can be constructed to satisfy true rnp differentiability an intriguing question is whether this dif ferentiation criterion or some weakened form of it such as the one we prove in the first result actually characterizes general metric spaces non bilipschitz embeddable into rnp banach spaces contents 1 introduction 2 1 1 historical background 2 1 2 summary of results and discussion of proof methods 3 1 3 outline 6 2 preliminaries 7 3 inverse systems of nested graphs 8 3 1 axioms and terminology 9 3 2 elementary consequences of axioms 11 3 3 existence of inverse system 13 4 asymptotic local properties of xi i 0 and special subsets of x 17 4 1 deep points and their natural scales 17 4 2 points having a noneuclidean tangent 18 5 approximation of functions on x via xi 19 5 1 conditional expectation 19 5 2 the derivative and fundamental theorem of calculus 22 6 maximal operator and l 1 l 1 w inequality 24 7 proof of weak form of rnp differentiability theorem 7 1 25 8 application to non bilipschitz embeddability 27 9 inverse limit of graphs in nonrnp spaces 28 9 1 generalized diamond systems 28 thanks to jeremy tyson and mikhail ostrovskii for helpful comments in the preparation of this article 1 ar x iv 1 90 4 02 31 5 v 2 m at h m g 2 j un 2 01 9 2 chris gartland 9 2 proof of theorem 1 6 29 10 questions 34 references 36 1 introduction 1 1 historical background in che 99 cheeger introduced the notion of a lip schitz differentiable structure on a metric measure space and proved that every dou bling space satisfying a poincare inequality henceforth pi space admits one such a structure allows one to differentiate real valued lipschitz functions almost every where with respect to an atlas of rk valued lipschitz functions k can vary from chart to chart we ll call metric measure spaces admitting this structure lipschitz differentiability spaces cheeger notes in theorem 14 3 of che 99 that lipschitz differentiability spaces which bilipschitz embed into a finite dimensional euclidean space must have every tangent cone see section 2 for background on tangent cones at almost every point be bilipschitz equivalent to rk the same rk that the chart containing the point maps to and that nonabelian carnot groups and laakso spaces violate this condition in ck 09 cheeger and kleiner generalize the result from che 99 and prove that pi spaces admit rnp lipschitz differentiable struc tures which generalize lipschitz differentiable structures in the sense that every lipschitz function taking values in any banach space with the rnp is differentiable almost everywhere a banach space b has the rnp if any lipschitz map r b is differentiable lebesgue almost everywhere or equivalently if for every probability space and for every martingale mn b if supn mn l b then mn converges almost surely for reference on rnp spaces see chapter 2 of pis 16 specifically theorem 2 9 and remark 2 17 such metric measure spaces will be referred to as rnp lipschitz differentiability spaces in theorem 1 6 of ck 09 the authors note that again any such metric measure space bilipschitz embed ding into an rnp space must have every tangent cone at almost every point be bilipschitz equivalent to rk thus nonabelian carnot groups and laakso spaces do not bilipschitz embed even into any rnp space for a metric measure space we call the phenomenon of admitting an rnp differentiable structure and violating the condition the every tangent cone at almost every point is bilipschitz equivalent to rk the differentiation nonembeddability criterion into rnp spaces occasionally we will also use the terms true rnp differentiable structure or true differentiation nonembeddability criterion to distinguish them from a weaker version we introduce in theorem 1 3 it s been known since at least 1973 that lipschitz maps from separable banach spaces to rnp spaces are in a suitable sense differentiable almost everywhere this is due independently to aronszajn aro 76 christensen chr 73 and mankiewicz man 73 see section 6 6 of bl 00 it follows that the rnp is inherited under bilip schitz embeddability of banach spaces since it is inherited under linear bilipschitz embeddability it is then natural to ask for a purely metric characterization of the rnp one that does not rely on the linear structure this question was asked by bill johnson in 2009 and answered in 2014 by ostrovksii see ost 14 a with the following theorem thick families of geodesics and differentiation 3 theorem 1 1 corollary 1 5 ost 14 a a banach space does not have the rnp if and only if it contains a bilipschitz copy of a metric space containing a thick family of geodesics in particular a new criterion for non bilipschitz embeddability of metric spaces into rnp banach spaces was discovered ostrovskii went on to give a simple proof that laakso spaces contain thick families of geodesics this turned out to be a much shorter and more natural way to prove their nonembeddability into rnp spaces compared to the differentiation nonembeddability criterion on the other hand according to another intriguing result of ostrovskii no carnot group can contain a thick family of geodesics this is due to li s proof section 7 1 of li 14 of the nontrivial markov convexity of carnot groups the fact that markov convexity is inherited under bilipschitz embeddings and the following result of ostrovskii see definition 2 1 theorem 1 2 theorem 1 5 of ost 14 b metric spaces containing a thick family of geodesics have no nontrivial markov convexity so although containing a thick family of geodesics is a necessary condition for the non bilipschitz embeddability of banach spaces into rnp banach spaces the same is not true of general metric spaces even geodesic metric spaces such as carnot groups our motivation for this article is to study the relationship between these two criteria for non bilipschitz embeddability into rnp spaces and more gener ally to find a characterization of metric spaces that do not embed into rnp spaces to this end we prove two results the first is that any metric space containing a thick family of geodesics also contains a subset and a probability measure on that subset which satisfies a weakened form of the differentiation nonembeddability cri terion see theorem 1 3 our second result theorem 1 6 is that any nonrnp banach space contains a bilipschitz copy of a metric measure space satisfying the true differentiation nonembeddability criterion 1 2 summary of results and discussion of proof methods 1 2 1 summary of results the type of differentiable structure we construct is weaker than the true rnp differentiable structure because the almost everywhere approximation of rnp valued lipschitz functions by their derivative only holds on some sequence of scales tending to 0 instead of all scales more specifically we prove theorems 4 7 and 7 1 which can be summarized as theorem 1 3 summary of theorems 4 7 and 7 1 for any complete metric space m containing a thick family of geodesics there exist a compact subset x borel probability measure on x lipschitz map x 0 1 borel subset s x a sequence of scales ri x 0 for almost every x x and a nonprincipal ultrafilter u x on n for each x s such that 4 7 s 0 and for every x s the tangent cone t ri x u x x x does not topologically embed into r 7 1 for every rnp space b and lipschitz map f x b for almost every x x f is differentiable at x with respect to along the sequence of scales ri x i 0 the map is the single chart in the weak rnp lipschitz differentiable atlas as a corollary we obtain a new proof of nonembeddability into rnp spaces 4 chris gartland corollary 1 4 a metric space m containing a thick family of geodesics does not bilipschitz embed into any rnp space the proof is the same as for the differentiation nonembeddability criterion into rnp spaces theorem 1 6 from ck 09 proof let b be an rnp space and assume there is a bilipschitz map g m b we may assume m is complete let x m s ri x and u x be as in the statement of the theorem since s 0 there exist a point x s and a nonprincipal ultrafilter u x such that f is differentiable at x along ri x i 0 with respect to and t ri x u x x x does not topologically embed into r f being differentiable with respect to at x along ri x i 0 implies that there exists a unique linear map f x r b such that for every nonprincipal ultrafilter u the blowup of f at x fx t ri x u x x b exists and factors though the blowup of at x x t ri x u x x r and f x r b that is fx f x x since t ri x u x x x does not topologically embed into r x cannot be bilipschitz which by the factorization implies fx cannot be bilipschitz in turn implying f cannot be bilipschitz theorem 1 3 actually proves a stronger statement corollary 1 5 we postpone the proof till section 8 we chose to give a separate proof corollary 1 4 because it is easier and requires no knowledge of carnot groups corollary 1 5 a complete metric space m containing a thick family of geodesics does not bilipschitz embed into the product metric space g b where g is a carnot group and b is an rnp space at the time of this writing theorems 1 1 and 1 2 were the only known nontrivial means by which one could prove nonembeddability of thick families of geodesics into metric spaces suppose g is a nonabelian carnot group such as the heisenberg group and b is an rnp which is not super reflexive such as 1 then g embeds into no rnp space by the differentiation nonembeddability criterion so theorem 1 1 does not apply to g b and b has no nontrivial markov convexity so theorem 1 2 does not apply to g b that non super reflexive spaces have no nontrivial markov convexity follows from the fundamental theorem of mendel naor on markov convexity theorem 1 3 of mn 13 and pisier s renorming theorem theorem 11 37 of pis 16 thus corollary 1 5 is a genuinely new nonembeddability result in our second result theorem 1 6 we restrict our attention from a general met ric containing a thick family of geodesics to a nonrnp banach space b this is indeed a restriction since every such b contains a thick family of geodesics by ost 14 a as previously stated in this setting we prove that the subset x and measure can be constructed to satisfy the true rnp differentiation nonembed dability criterion not just the weakened form described in theorem 1 3 that it satisfies the true rnp differentiation criterion is a consequence of the fact that it is an inverse limit of an admissible system of graphs defined in ck 15 in that article cheeger and kleiner proved that such spaces are pi spaces they also gave a necessary and sufficient condition for these spaces to satisfy the differentiation nonembeddability criterion into rnp spaces stated in theorem 10 2 of ck 15 we verify this condition for our subset x b and thus our result can be viewed as a converse to theorem 10 2 thick families of geodesics and differentiation 5 theorem 1 6 every nonrnp banach space contains a bilipschitz copy of a met ric measure space satisfying the differentiation nonembeddability criterion the metric measure space is an inverse limit of admissible graphs as in ck 15 with noneuclidean tangent cones at almost every point 1 2 2 proof methods the subset x of a metric space m containing a thick family of geodesics from theorem 1 3 is constructed as an inverse limit of graphs cheeger and kleiner proved in ck 15 that inverse limits of certain admissible inverse systems of graphs such as laakso spaces are pi spaces and hence rnp lipschitz differentiability spaces it is this result which lead us to believe that x could be constructed to satisfy some kind of rnp lipschitz differentiability however our space x cannot be constructed to be a pi space in any obvious way and thus the theory of ck 09 does not apply we are required to construct derivatives of rnp valued lipschitz functions and prove their defining approximation property by hand to do so we use only the almost sure differentiability of lipschitz maps r b and the almost sure convergence of b valued martingales for rnp spaces which are quite classical compared to the asymptotic norming property of rnp spaces used in ck 09 we also make heavy use of the uniformly topology on banach spaces of lipschitz functions in contrast to the sobolev space techniques employed in ck 09 and ck 15 apart from these differences in proof techniques the inverse systems of graphs we consider are fundamentally different from the admissible systems in ck 15 for two reasons firstly in ck 15 the graphs are equipped with geodesic metrics and the metrics on our graphs are only geodesic along directed edge paths in fact the inverse limit space need not even be quasiconvex while pi spaces are always quasiconvex secondly in ck 15 the lengths of edges in the sequence of graphs decrease by a constant factor m 2 in each stage of the sequence independent of the stage or edge in our graphs the edge lengths decrease by factors going to we make frequent use of this rapid decay in a number of independent results such as 3 10 3 11 and lemma 3 9 loosely the rapid decay in edge length allows us to well control the local geometry near a point along scales proportional to the lengths of edges containing the projections of the point at the cost of control over the geometry along other scales which would be necessary to prove true rnp differentiability the uniform topology on lipschitz algebras has been studied before within the context of lipschitz differentiability spaces for example in sch 14 schioppa showed how to associate a weaver derivation which involves continuity with re spect to uniform topology to an alberti representation and alberti representations were demonstrated by bate in bat 15 to be intimately connected to lipschitz dif ferentiability schioppa constructs the partial derivative of a function by taking its derivative along curve fragments and averaging them together with respect to the alberti representation our procedure for constructing the derivative of a func tion see theorem 5 8 is very similar in nature indeed lemma 4 8 gives alberti representations of i which after taking a suitable limit give rise to an alberti representation of we also note that in bat 15 bate gives necessary and suf ficient conditions for a collection of alberti representations to induce a lipschitz differentiable structure on a metric measure space using what he called universality see definition 7 1 from bat 15 our representation from lemma 4 8 will generally fail this property or at least doesn t obviously satisfy it we don t actually provide 6 chris gartland an example which is consistent with our discussion that the space x d is not a true lipschitz differentiability space again we don t actually provide an example of this we believe it is possible to find a weakened form of universality corresponding to the weakened form of differentiation from theorem 7 1 the construction of the inverse limit of admissible graphs x of theorem 1 6 is achieved by fine tuning two of the aspects of ostrovskii s construction of a thick family of geodesics in nonrnp spaces his construction is also essentially an inverse limit of a system of graphs but the system is not admissible in the sense of ck 15 for two reasons firstly the metrics on his system are not uniformly quasiconvex which is a necessary condition for a metric space to be a pi space secondly the lengths of edges in a graph in an admissible system must be constant but in the system of ost 14 a the ratio of lengths of two edges in a graph may become unbounded the second obstacle is easily overcome in the following way the length of an edge in a graph in the system from ost 14 a corresponds to the coefficient i of some convex combination z 1 z 1 nzn with z zi and z zi 1 by density of the dyadic rationals in 0 1 we may make small adjustments zi z i to obtain z q 1 z 1 qnz n with each qi a dyadic rational all while maintaining z z i and z z i 1 we then split up the convex combination into terms whose coefficients have numerator equal to 1 for example 1 2 z 1 1 4 z 2 1 4 z 3 1 4 z 1 1 4 z 1 1 4 z 2 1 4 z 3 the edges corresponding to this convex combination now all have length 1 4 the first obstacle can be overcome by constructed xi with rapidly decreasing edge length similar to construction in the proof of theorem 3 11 using the rapid decrease in edge length to control the quasiconvexity of the graphs is similar to the proof of lemma 3 8 1 3 outline section 2 sets notation and terminology and defines thick families of geodesics sections 3 7 are concerned with the proof of theorem 1 3 section 8 contains the proof of corollary 1 5 section 9 contains the construction of the inverse limit of graphs in nonrnp banach spaces from theorem 1 6 and section 10 contains some relevant questions for an efficient reading of sections 3 7 we advise the reader to start with section 3 skip ahead to section 7 and then refer back to the between sections as they are needed to understand the proof of theorem 7 1 in section 3 we give the axioms for thick inverse systems of graphs whose inverse limit we are able to prove the weak form of differentiation of also included in this section are frequently used consequences of the axioms and a proof of one of the main theorems of the article theorem 3 11 this theorem asserts the existence of the thick inverse system of graphs in any metric space containing a thick family of geodesics in section 4 we define the set s and prove s 0 we also include results on asymptotic local geometry of the graphs section 5 covers the use of conditional expectation in approximating functions on x via functions on xi also in this section is the definition of the derivative of rnp space valued lip schitz functions on x a relevant maximal operator and corresponding maximal inequality are defined and proved in section 6 section 7 contains the proof of the main theorem theorem 7 1 the weak form of differentiability thick families of geodesics and differentiation 7 2 preliminaries let m d be a metric space and p q m a p q geodesic is an isometric embedding from some closed bounded interval into m mapping the left endpoint of the interval to p and the right endpoint to q d is said to be geodesic if there exists a p q geodesic for every p q m the next definition concerns thick families of geodesics informally a family of geodesics is concatenation closed if for any 1 2 in the family the geodesic obtained by concatenating an initial segment of 1 and a terminal segment of 2 also belongs to the family informally a concatenation closed family of p q geodesics is thick if for any geodesic in the family and any finite set of points f in the image of there is another geodesic in the family that intersects at each point of f but possibly more points and so that the deviation of from between their points of intersection adds up to at least definition 2 1 we follow ost 14 c a family of p q geodesics with common domain a b is said to be concatenation closed if for every c a b and 1 2 with 1 c 2 c the concatenated curve defined by t 1 t if t a c t 2 t if t c b also belongs to given 0 a concatenation closed family of p q geodesics sharing a common domain a b is said to be thick or an thick family of geodesics if for every and a t 0 t 1 tk b there exist a q 0 s 1 q 1 s 2 sj qj b and such that ti qi qi qi j i 1 d si si a concatenation closed family of p q geodesics sharing a common domain a b is said to be thick or a thick family of geodesics if it is thick for some 0 example 2 2 laakso lang plaut diamond space the following space was in spired by constructions of laakso in laa 00 but first appeared in lp 01 we inductively define a sequence of metric spaces which are graphs equipped with the path metric l 0 is defined to be i 0 1 as a graph it has two vertices 0 and 1 and one edge li 1 is obtained from li by replacing each edge of li with a copy of the graph show in figure 1 the edges are weighted so that the diameter of each li is 1 there are canonical 1 lipschitz maps li 1 li and l is defined to be the inverse limit of this system the collection of all 0 1 geodesics in l is a 1 2 thick family of geodesics for every 0 when equipped with a certain measure l also becomes an rnp lipschitz differentiability space with a single differentiable chart given by the canonical map l l 0 i r throughout b will denote a general banach space in places where differentiation or martingale convergence is involved it may be necessary to assume that b is an rnp space and in such cases the assumption will be stated whenever x a is a measure space and p 1 the lebesgue space lp x a of equivalence classes of real valued functions will be denoted lp when dealing with b valued functions we use the notation lp b see chap ter 1 of pis 16 for background on bochner measurable functions integrals and conditional expectations 8 chris gartland figure 1 l 1 the first graph of the laakso lang plaut diamond graphs each new graph li 1 is obtained from li by replacing each edge with a copy of l 1 scaled down so that the diameter of li 1 remains 1 given two metric spaces x dx and y dy and a lipschitz map f x y we define lip f supx 6 y dy f x f y dx x y for a metric space x d with basepoint x 0 define lip 0 x b to be the banach space of lipschitz functions f x b satisfying f x 0 0 equipped with the norm f lip 0 x b lip f when b r we suppress notation and simply write lip 0 x note that when diam x 1 f lip 0 x b f unif we shall generally find ourselves in this situation given a point x x a sequence ri i 0 decreasing to 0 and a nonprincipal ultrafilter u on n we define the tangent cone of x at x t ri ux x to be the ultralimit of the sequence of pointed spaces x x 1 ri d given a lipschitz map x b the blowup of f at x fx t ri u x x is the ultralimit of the sequence of maps 1 ri f f x f x x x 1 ri d b if it exists the ultralimit exists if the limit exists in the usual sense or if b is finite dimensional a finite metric graph or just graph is a metric space x equipped with a finite set of vertices v x and a finite set of edges e x satisfying some properties v x x and e x p x the power set of x each e e x is isometric to a compact interval a b and under any isometry a b e a and b get mapped to vertices called the vertices of e and no other point c a b gets mapped to a vertex if e 1 e 2 e x with e 1 6 e 2 then e 1 e 2 is empty or e 1 e 2 consists of one or two vertices the graph is directed if each edge is equipped with a direction which is simply an ordering of its two vertices the first vertex is called the source and the second is called the sink we say that the edge is directed from the source to the sink if a is a borel subset of a finite graph a denotes its length measure if x y are points in a finite graph x y denotes the distance between x and y with respect to the length metric the metric given by the infimal length of paths between x and y a length minimizing path from x to y will be denoted x y so that x y x y and is frequently referred to as a shortest path since shortest paths need not be unique the notation x y does not unambiguously define one set but it should be clear from context what is begin referred to in any case as far as this article is concerned the nonuniqueness of shortest paths don t pose any problems 3 inverse systems of nested graphs we begin this section by listing some axioms for a thick inverse system of nested metric graphs see definition 3 1 we introduce thick inverse systems for thick families of geodesics and differentiation 9 v 0 e v 1 e e figure 2 a directed edge e of xi shown in black v 0 e v 1 e e 0 e 1 e figure 3 the directed subdivision of e in x i terminal subedges e 0 and e 1 are shown in blue and nonterminal subedges are shown in black v 0 e v 1 e e 0 e 1 e e op x xop figure 4 the set i 1 i 1 e in xi 1 terminal intervals are shown in blue nonterminal intervals are shown in black and cir cles are shown in orange examples of subedges e and opposite subedge e op are labeled as are example point and opposite point x and xop shown in red two reasons one we are able to prove our differentiation theorem theorem 1 3 for the inverse limit of these systems and two we are able to prove that a thick inverse system can be found in any metric space containing a thick family of geodesics see theorem 3 11 3 1 axioms and terminology definition 3 1 an inverse system of nested metric measure directed graphs sat isfying the following axioms a 1 a 6 and equipped with the measure from definition 3 2 will be called a thick inverse system we use the notation x 0 d 0 x 1 d 1 for a system of nested metric directed graphs the maps xi 1 xi are denoted i 1 i let i 0 and j i and define j i i 1 i i 2 i 1 j j 1 xj xi graph and length axioms a 1 x 0 has two vertices denoted 0 and 1 and one edge directed from 0 to 1 with length 1 we identify x 0 with i 0 1 a 2 there is a directed subdivision of xi denoted x i satisfying the properties below it will be helpful to refer to figures 2 3 and 4 while reading a 2 i for each edge e e x i i 1 i 1 e e e op where either e op e or e op is an edge having the same source and sink vertices as e but 10 chris gartland whose interior is disjoint from the rest of xi 1 e op is called the op posite edge of e in xi 1 we may write eop or e op depending on the presence of other super or subscripts we also define e op op e for future use we note that with respect to the length metric the diameter of i 1 i 1 e equals e thus with respect to d 3 1 diam i 1 i 1 e e given a point x e we similarly define xop to be the unique point of e op for which i 1 i x op x and call xop the opposite point of x in xi 1 if e op e then xop x we may also write xop depending on the presence of other super or subscripts again we also define xop op x if e op e we call i 1 i 1 e an interval it is an interval topo logically if e op 6 e we call i 1 i 1 e a circle it is a circle topologically ii if e 0 and e 1 are terminal edges in the subdivision of some edge e e xi meaning they share a vertex with e then i 1 i 1 e 0 and i 1 i 1 e 1 are intervals so not circles we refer to these edges of x i and xi 1 as terminal intervals sometimes terminal edges of xi 1 and also as terminal subintervals sometimes terminal subedges of e we note that a subedge e e x i of e is not a terminal subinterval if and only if it is contained in the interior of e metric axioms a 3 for any i 0 d is geodesic when restricted to any directed edge path of xi meaning there is an isometry from a compact interval to this edge path a 4 i 1 i xi 1 x i acts identically on any e e x i e xi 1 and it collapses any e op e xi 1 e x i isometrically onto e thickness axiom suppose e e x i is an edge such that i 1 i 1 e is a circle for any t e let top e op denote the opposite point define the height of e by ht e maxp e d p p op the height is between 0 and e and is a measure of how close the circle is to being to a standard circle it equals e if and only if the circle is isometric to a standard circle of diameter e a 5 there is a constant 0 independent of i such that ht e e for every e e x i a 6 let p be a directed edge path from 0 to 1 in x i and let ecirc p denote the set of edges e p along the path for which i 1 i 1 e is a circle then there is a constant 0 independent of i and p such that ecirc p measure definition definition 3 2 define i i 0 to be the unique sequence of probability measures satisfying the following recursion 0 is length lebesgue measure on x 0 0 1 restricted to any edge of xi 1 i 1 is a constant multiple of length measure and for any e e x i i 1 e i e if e op e and i 1 e i 1 e op 1 2 i e if e op 6 e thick families of geodesics and differentiation 11 3 2 elementary consequences of axioms throughout this subsection fix a thick inverse system using the same notation as in the previous subsection we begin with a proposition that lists without proof some elementary consequences of the axioms we use these facts often and without mention then we prove some less immediate facts about the metric structure that will be needed for subsequent results proposition 3 3 the following are true the map i 1 i xi 1 xi is a projection onto xi xi 1 i 1 i xi idxi i 1 i is direction preserving and by induction the same is true for j i j i thus j i restricted to any directed edge path is an isometry the restriction of i to any interval or circle of xi is a constant multiple with constant 1 of length measure i 1 i i 1 i definition 3 4 for any i 0 define ei mine e xi e and ei maxe e x i e e i the maximum is well defined because each graph has finitely many edges definition 3 5 for any j i 0 and x xj define ei x and e i x to be edges of xi and x i respectively containing j i x these edges are unique except when x is a vertex and the set of vertices form a measure 0 set lemma 3 6 if i i 0 is a positive decreasing sequence with 0 1 2 and if ei i then for any j i 0 and xi xi diam j i 1 xi 2 i ei xi proof assume i e i and xi are as above let xj j i 1 xi and for k i j set xk j k xj by 3 1 d xk xk 1 e k xk by a repeated application of the definition of ei we have e k xk e i e i 1 e k ei xi i k 1 i ei xi where the least inequality holds since ek k and k is decreasing then we have d xi xj j 1 k i d xk xk 1 j 1 k i i k 1 i ei xi 2 i ei xi where the last inequality holds since i 0 1 2 definition 3 7 for any i 0 e e xi and e e x i with e a nonterminal subedge of e define di e e d e xi e this is positive by compactness and since e belongs to the interior of e since it is nonterminal define di e to be the minimum of di e e over all nonterminal e e and define di to be the minimum of di e over all e e xi define d i maxe e d i where the max is over all nonterminal edges e e x i lemma 3 8 if di 1 2 and i 0 1 1 2 d i l then lip j i j 1 k ilip k 1 k i 0 1 1 2 d i l for any j i 0 proof it suffices to prove lip k 1 k 1 1 2 d k let xk 1 yk 1 xk 1 and set xk k 1 k xk 1 yk k 1 k yk 1 we need to show that d xk 1 yk 1 1 2 dk d xk yk we consider two cases either xk and yk belong to the same edge of xk or they belong to different edges assume they belong to the same edge then there are again two cases either xk 1 and yk 1 belong to opposite edges of a circle or they belong to a directed edge path the conclusion holds in 12 chris gartland this second case since the map k 1 k is an isometry on directed edges paths so we get an ever better bound of 1 now suppose they belong to opposite edges of a circle without loss of generality assume yk 1 e and xk 1 e op for some e e x k then yk 1 yk and a shortest path between them xk 1 yk 1 passes through one of the vertices of the circle say v then since xk and v belong to an edge d xk v v xk recall that p q denotes the distance with respect to the length metric and since v and yk belong to an edge so d v yk yk v without loss of generality assume v xk yk v this implies xk v yk in turn implying xk v yk xk yk v then we have d xk 1 yk 1 d v yk 1 d xk 1 v d v yk d v xk yk v xk v yk xk d yk xk our conclusion holds in this case again with an ever better bound of 1 finally assume that xk and yk do not belong to the same edge of xk we consider three cases now both points belong to a terminal interval of xk neither point does or one does and the other does not our conclusion holds the first case since k 1 k acts identically on xk so yk 1 yk and xk 1 xk and terminal intervals belong to xk by definition assume the second case holds e k xk and e k yk are nonterminal by assumption then by definition of d k since yk and xk do not belong to the same edge of xk e k yk e k xk d kd xk yk then we have d xk 1 yk 1 d xk yk d xk 1 xk d yk 1 yk d xk yk e k xk e k yk d xk yk 2 dkd xk yk 1 2 d k d xk yk and our desired conclusion holds in this case for the third and final case assume without loss of generality that yk belongs to a terminal interval and xk does not then we get yk 1 yk and e k xk d kd xk yk making the obvious adjustments to the argument above yields d xk 1 yk 1 d xk 1 yk d xk yk d xk 1 xk d xk yk e k xk d xk yk dkd xk yk 1 d k d xk yk lemma 3 9 if xk 1 yk 1 xk 1 do not belong to opposite open edges of a cir cle then d k 1 k xk 1 k 1 k yk 1 1 1 2 d k d xk 1 yk 1 loosely k 1 k collapses circles but is close to an isometry away from them proof let xk 1 yk 1 xk 1 and set xk k 1 k xk 1 yk k 1 k yk 1 as before there are two cases either xk and yk belong to the same edge of xk or they belong to different edges assume they belong to the same edge again as before there are two cases either xk 1 and yk 1 belong to opposite edges of a circle or they belong to a directed edge path the first case doesn t hold by assumption and the conclusion holds in this second case since the map k 1 k is an isometry on directed edges paths so we get an ever better bound of 1 finally assume that xk and yk do not belong to the same edge of xk as before three cases both points belong to a terminal interval of xk neither point does or one does and the other does not our conclusion holds the first case since k 1 k acts identically on xk so yk 1 yk and xk 1 xk and intervals belong to xk by definition assume the second case holds e k xk and e k yk are nonterminal by thick families of geodesics and differentiation 13 assumption then by definition of dk since yk and xk do not belong to the same edge of xk e k yk e k xk d kd xk yk then we have d xk 1 yk 1 d xk xk 1 d xk yk d yk yk 1 e k xk d xk yk e k yk 1 2 d k d xk yk and our desired conclusion holds in this case for the third and final case assume without loss of generality that yk belongs to a terminal interval and xk does not then we get yk 1 yk and e k xk d kd xk yk making the obvious adjustments to the argument above yields d xk 1 yk 1 d xk 1 yk d xk xk 1 d xk yk e k xk d xk yk 1 d k d xk yk remark 3 10 note that since 1 1 2 1 if the hypotheses of lemma 3 9 are satisfied then 3 2 k 0 1 d k l 3 3 existence of inverse system let m be a metric space theorem 3 11 if m contains a thick family of geodesics then for any positive sequence i i 0 m contains a thick inverse system with e i d i i for every i see definitions 3 1 3 4 and 3 7 proof assume m contains an thick family of geodesics for some 0 let i i 0 be a positive sequence we ll construct the inverse sequence x 0 x 1 inductively let be any element of and set x 0 equal to the image of in m equip x 0 with the necessary graph structure assume xi xi 1 and i i 1 have been constructed for some i 0 satisfy the graph metric and thickness axioms and also satisfy the additional hypothesis that the geodesic parametrization of each directed 0 1 edge path belongs to for each edge e e xi let v 0 e and v 1 e denote the source and sink vertices of e respectively e is mapped isometrically onto ie d 0 v 0 e d v 1 e 1 via i 0 denote the inverse of this map e ie e xi note that for any geodesic parametrization of a 0 1 edge path whose image contains e we must have ie e so e extends to a geodesic parametrization of a directed 0 1 edge path now we provide a more quantitative reformulation of definition 2 1 by a par tition t of an interval a b we mean a finite subset of a b equipped with the order induced from a b such that the least element is a and the greatest element is b for any t t other than b we define t to be the immediate successor of t and we simply define b b and for any t t other than a we define t to be the immediate predecessor of t and we simply define a a for each partition t e of ie and e with e t e e t e define the deviations of t e e and t e respectively dev t e e t t e max s t t d e s e s dev t e sup e e te e te dev t e e note that dev t e e 14 chris gartland for any fixed partition t e of ie let t e sup 2 and e sup 2 denote a partition of ie and a geodesic in respectively with 3 3 t esup 2 t e 3 4 esup 2 t e sup 2 e t e sup 2 3 5 dev t esup 2 e sup 2 1 2 sup t t e dev t now we can always choose t e sup 2 and e sup 2 such that the above properties remain true and also such that for every t t e sup 2 3 6 e t t esup 2 t t or e t t esup 2 t t to see this take any t e sup 2 and e sup 2 as above and let t t e sup 2 if maxs t t d e s e s 0 then e and e sup 2 agree on all of t t and we are done otherwise let smax argmaxs t t d e s e s then by continuity there exists a largest nonempty open subinterval a b of t t containing smax such that e a b esup 2 a b since it is the largest e a e sup 2 a and e b e sup 2 b we add these new points a and b to the partition t e sup 2 and modify e sup 2 so that it agrees with e on t a b t and remains unchanged on a b this new curve still belongs to because is concatenation closed it is clear that 3 3 3 4 and 3 5 remain valid and that we gain 3 6 we use the partition t e sup 2 of ie to subdivide e into smaller edges by taking the image of t e sup 2 under e to be new vertices each new subedge equals e t t for a unique t t e sup 2 denote this edge et and recall the height of et defined in the thickness axioms ht et max s t t d e s e sup 2 s set 4 and split the new subedges of e up into two groups ee and ee where e t e belongs to ee if ht et et and et belongs to ee if ht et et name the collection of corresponding time intervals t e sup 2 and t e sup 2 it follows from definition 2 1 and the observation that e extends to a geodesic in that for any 0 1 directed edge path p and any choice of partition t e for each e p e p dev t esup 2 e sup 2 2 it follows from this that 2 e p et ee ht et et ee ht et e p et ee et et ee et thick families of geodesics and differentiation 15 e p e et ee et e p et ee et implying 3 7 ep 2 where 8 and ep e pe e now that the preliminaries have been established we are ready to choose a specific partition of e and apply the above results set ei mine e xi e and for each e e xi subdivide e into three edges e 0 emid e 1 such that e 0 min 2 e i e i e 1 set di e d emid xi e since emid belongs to the interior of e compactness gives us d i e 0 then set di mine e xi d i e and i min i e i i d i now for each e e xi choose a partition t e of ie a b d 0 v 0 e d v 1 e 1 such that 3 8 a a min 2 e i e i b b this implies e a a e 0 e b b e 1 and e t t emid for t t e a b b and for any t t e a b b 3 9 t t i for each e e xi fix t esup 2 t e and e sup 2 as before as explained in the previous paragraph t e sup 2 induces a subdivision of e doing this for each e gives us the total subdivided graph x i by 3 8 and 3 9 any subedge e t e satisfies et i e i so e i i as required furthermore any nonterminal subedge e t of e is contained in emid by definition and so by 3 9 we get et i i d i implying di i as required it remains to construct xi 1 and i 1 i we explain how to use segments of the curve e sup 2 as new edges to add to our graph x i to obtain xi 1 let e e xi there are three options for a subedge e e x i of e e is a terminal subedge meaning e e 0 e t or e t 1 for t d 0 v 0 e d v 1 e 1 e et for some t t e sup 2 d 0 v 0 e d v 1 e 1 meaning ht et et or e et for some t t e sup 2 d 0 v 0 e d v 1 e 1 meaning ht et et in the first two cases we set e op e so that i 1 i 1 e is a circle and in the third case set e op e t op e sup 2 t t so that the intersection of the interiors of et and etop is empty i 1 i 1 e is a circle and ht et et we define i 1 i in the unique way so that a 4 holds it is clear that the graph axioms metric axioms and a 5 hold our additional hypothesis that the geodesic parametrization of every 0 1 directed edge path belongs to also holds again using concatenation closed it remains to verify axiom a 6 to verify a 6 we fix a path p and compute ecirc p for each e p set ecirc e e ecirc p e e then by 3 7 and 3 8 ecirc p e p ecirc e e p ee e e e 0 e 1 16 chris gartland e p ee e 0 e 1 3 8 e p ee 2 e 2 e ep 3 7 2 from here till the end of section 7 fix a complete metric space m d containing a thick family of geodesics a positive sequence i i 0 decreasing to 0 quickly enough so that 0 1 2 and i 0 1 1 2 i l for some l this also implies i i and a thick inverse system afforded to us by the theorem definition 3 12 denote the closure of x i 0 xi inside m as x we fix 0 i x 0 x to be the basepoint by lemma 3 8 the maps j i are uniformly l lipschitz so we get l lipschitz extensions i x xi summarizing 3 10 j i i 1 lip j i l we also extend the definitions of ei x and e i x see definition 3 5 in the obvious way when x x remark 3 13 by lemma 3 6 we get 3 11 j i i 1 xi xi diam j i 1 xi 2 i ei xi since each xi d is a finite graph each xi d is compact and thus totally bounded then 3 11 together with our choice that i 0 imply x is totally bounded then since m is complete x is compact the maps i x xi are each l lipschitz and act identically on xi x these two facts imply for any p q x 3 12 d p q lim i d i p i q this implies that the maps i generate the topology on x i e the topology on x is the weakest one such that each map i is continuous equivalently the subalgebra of c x consisting of those continuous functions that factor through some i is dense we denote this subalgebra by cunif x the compatibility condition of the probability measures i 1 i i 1 i gives us a well defined bounded positive linear functional on cunif x by density this extends to a unique positive linear functional on all of c x definition 3 14 define to be the radon measure representing the linear functional on c x is a probability measure uniquely characterized by 3 13 i 0 i i remark 3 15 although we won t make explicit use it we believe it is worth men tioning the following fact the metric space x and maps i i 0 satisfy the universal property of an inverse limit space this means that for any metric space y and uniformly lipschitz sequence of maps fi i 0 fi y xi there exists a unique lipschitz map f y x such that i f fi for any i thick families of geodesics and differentiation 17 4 asymptotic local properties of xi i 0 and special subsets of x 4 1 deep points and their natural scales recall the definition of terminal intervals of xi 1 from axiom a 2 ii definition 4 1 we define the set of deep points d to be all those x x such that i 1 x eventually in i does not belong to a terminal interval of xi 1 d is a g and hence borel set theorem 4 2 d 1 proof let e be an edge of xi and e 0 and e 1 its terminal subintervals by definition 3 2 and definition 3 4 i 1 e 0 e 1 i 1 e 0 i 1 e 1 2 ei i e summing over all e e xi we get that the total measure of the union of terminal intervals in e xi 1 is bounded by 2 e i since i e i i i borel cantelli implies that the set of x x such that i 1 x eventually in i does not belong to a terminal interval in xi 1 has measure 1 4 1 1 structure of ii 1 1 e we now discuss some geometric properties of ii 1 1 e while reading this section it will be helpful to refer to figure 4 for a picture of what ii 1 1 e typically looks like definition 4 3 given a deep point or more generally a nonvertex x and i 0 define ri x ei x we call ri x the sequence of natural scales of x at x lemma 4 4 for any deep point x and r 1 bi rri x i x is eventually in i depending on x and r contained in ii 1 1 ei 1 x where b i indicates a ball in the space xi d proof let x d and r 1 set xi i x and assume i is large enough so that e i 1 x is not a terminal interval then by definition 3 7 d xi 1 xi 1 ei 1 x e i 1 x d i 1 ri x d i 1 ri x i 1 combining this with 3 10 yields d xi xi ii 1 1 ei 1 x 1 l d xi 1 xi 1 ei 1 x ri x l i 1 thus as soon as i is large enough so that i 1 1 lr we get bi rri xi ii 1 1 ei 1 x lemma 4 5 1 there exists c 1 such that for any i 0 and e e xi 1 i restricted to i i 1 1 e is c doubling with respect to the length metric 2 for any shortest path x y ii 1 1 e i br x 4 i x y where r x y proof let i 0 and e e xi 1 recall the definition of circles and intervals from axiom a 2 i by the discussion there ii 1 1 e e e ii 1 1 e consists of a sequence of intervals and circles glued together in a directed way along alternating sink and source vertices this sequence begins and ends with terminal intervals defined in axiom a 2 ii with respect to the length metric and length measure ii 1 1 e is doubling this follows by analyzing the worst case scenario for a ball this scenario occurs near points where two circles are glued together it is possible to have a geodesic ball of radius r such that the geodesic ball of radius 2 r has 4 times the length this implies length measure is doubling with doubling constant 4 let c 0 1 such that i 1 restricted to e 18 chris gartland equals c times length measure and for any e e e x i 1 i restricted to ii 1 1 e ii 1 1 e equals c or c 2 times length measure c if it s an interval c 2 if it s a circle it follows that i restricted to i i 1 1 e is bounded above by c times length measure and below by c 2 times length measure since length measure it doubling with doubling constant 4 this implies i is doubling with doubling constant bounded by 8 this isn t sharp the second statement can also be observed by examining the worst case scenario where x is a vertex shared by two adjacent circles and y belongs to one of these circles then br x will consist of four copies of an interval of length r x y and the i measure of any of these new intervals is the same as that of x y this implies the second statement remark 4 6 it s also clear from the description of ii 1 1 ei 1 x given in the preceding section that if x y i 1 i 1 e and x and y do not belong to opposite edges of a circle then x and y belong to a directed and thus geodesic edge path and so d x y y x on the other hand if y bi rri x xi and xi and y belong to opposite edges of a circle then y xi ei x in either case we have for r 1 and i sufficiently large 4 1 y birri x xi y xi rri x 4 2 points having a noneuclidean tangent theorem 4 7 there exists a borel s x such that s 0 and for all x s there exists a nonprincipal ultrafilter u x depending on x on n such that the tangent cone t ri x u x x x does not embed even topologically into r before beginning the proof of the theorem we require a lemma lemma 4 8 for each i 0 there is a finite set of directed 0 1 edge paths of xi pi and a probability measure pi on pi such that for every edge e e xi i e e p pi e p pi p and it follows that for any a e e xi borel 4 2 i a p pi pi p a p proof the proof is by induction on i the base case i 0 holds trivially with p 0 x 0 p 0 x 0 assume the statement holds for some i 0 let p pi let pop be the unique 0 1 directed edge path in xi 1 such that e p if and only if e op pop for every e e x i let pi 1 p pop p pi for each p pi define pi 1 pop pi 1 p 12 pi p if pop 6 p and pi 1 pop pi 1 p pi p if pop p by definition 3 2 pi 1 pi 1 satisfies the desired property remark 4 9 this lemma gives an alberti representation of the measure i in bat 15 bate used a property he called universality of alberti representations to characterize lipschitz differentiability spaces our representation of the measure which can be constructed by taking limits of the representations of i will generally fail this universality condition which is consistent with our discussion in section 1 2 2 that x d is not a true lipschitz differentiability space thick families of geodesics and differentiation 19 proof of theorem 4 7 let i 0 and ecirc x i the set of edges e e x i such that i 1 i 1 e is a circle set si i 1 ecirc x i so si is closed by 3 13 4 2 and axiom a 6 si 3 13 i ecirc x i 4 2 p pi pi p ecirc x i p a 6 p pi pi p because of this we set s lim supi si an f and hence borel set and get s 0 by definition s has the following property for any x s there is a subsequence ij x of i for which ij x x ecirc x ij x thus each pointed metric space x 1 rij x d x contains a circle whose height see axiom a 5 for definition of height is bounded below by and the point x belongs to this circle let u x be any nonprincipal ultrafilter on n containing ij x j 0 which exists by zorn s lemma then the u x ultralimit of this sequence of pointed metric spaces must also contain such a circle and the point x will again belong to this circle which obviously doesn t topologically embed into r remark 4 10 as described in the proof each of the pointed spaces x 1 rij x d x contain a circle of height which contains x let e and eop be the opposite edges of this circle we can extend e in both directions to a 0 1 edge path since eop has the same vertices as e this also extends eop to a 0 1 edge path unioning the circle e eop with the extension to a 0 1 edge path results in a space consisting of two 0 1 geodesics whose union contains a circle of height and that coincide with each other outside that circle passing to the ultralimit we see that the tangent cone t ri x u x x x contains two bi infinite geodesics whose union contains a circle of height and that coincide with each other outside that circle both geodesics get mapped down isometrically onto r under the blowup 0 x t ri x u x x x r 5 approximation of functions on x via xi we begin this section by introducing our fundamental tool for approximating functions on x by functions on xi the conditional expectation the main results are theorems 5 2 and 5 6 we then use this tool to define the derivative of lipschitz functions on x the main result on the derivative is theorem 5 8 5 1 conditional expectation let i 0 and j i i 1 definition 5 1 the conditional expectation is a bounded linear map eji l 1 j b l 1 i b uniquely characterized by the identity 5 1 xi eji h d i xj ji hd j for all h l 1 j b and l i it is a standard tool in probability theory whose existence can be proven by elementary theorems of measure theory see chapter 1 of pis 16 for background it follows from lp lq duality that the conditional expectation is also contractive from lp j b lp i b for any p 1 the majority of this section is dedicated to proving the following theorem 20 chris gartland theorem 5 2 for every i 0 e i maps lip 0 x b into lip 0 xi b with operator norm bounded by l 2 such a result does not hold for general metric measure spaces easy examples on 0 1 show that conditional expectation need not preserve lipschitz or even continuous functions but will in our specific instance the proof will come at the end of this subsection and is preceded by several lemmas we give an outline of the proof structure here show that for every j eji lip 0 xj b lip 0 xi b has operator norm uniformly bounded by l noting that eji e i 1 i e i 2 i 1 e j j 1 to prove the previous item it suf fices to consider the case j i 1 and prove that ei 1 i lip 0 xi 1 b lip 0 xi b 1 i because by 3 2 we obtain 5 2 eji lip 0 xj lip 0 xi j 1 k i 1 k l for every j i 0 this is accomplished with lemma 5 3 extend the domain to x by approximating with maps factoring through some xi lemma 5 4 we gain another factor of l here 5 1 1 explicit formula for and boundedness of ei 1 i lemma 5 3 for each i 0 and h lip 0 xi 1 b 5 3 ei 1 i h p h p h pop 2 recall the definition of pop from axiom a 2 i furthermore ei 1 i lip 0 xi 1 lip 0 xi 1 i proof let i 0 and h lip 0 xi 1 it is a relatively simple exercise to check that 5 3 satisfies 5 1 using definition 3 2 we now bound the operator norm let x y xi no two points of xi xi 1 can belongs to opposite edges of a circle in xi 1 so also x op and yop do not belong to opposite edges of a circle thus the hypotheses for lemma 3 9 are met then ei 1 i h x e i 1 i h y h x h xop h y h yop 2 h x h y 2 h xop h yop 2 h lip 0 xi 1 2 d x y d xop yop lemma 3 9 h lip 0 xi 1 2 d x y 1 2 i d x y 1 i h lip 0 xi 1 d x y 5 1 2 extending domain to lip 0 x b for y a metric space and k 1 we say a subspace v lip 0 y b is k uniformly dense in lip 0 y b if the closure with respect to the topology of uniform convergence of compacta equivalently pointwise convergence on any dense subset of the ball of radius k in v contains the unit ball of lip 0 y b each banach space lip 0 xi b can be identified as a closed subspace of lip 0 x b by pulling back under the map i denote the image of this identification by thick families of geodesics and differentiation 21 lip 0 xi b we then obtain the nonclosed subspace i lip 0 xi b lip 0 x b we note that for any f lip 0 xi b f lip 0 xi b f i lip 0 x b f lip 0 xi b i lip l f lip 0 xi b so that the embeddings lip 0 xi b lip 0 x b are uniformly bounded but not isometric lemma 5 4 for any banach space b i lip 0 xi b lip 0 x b is l uniformly dense proof let f be in the unit ball of lip 0 x b let gi be the restriction to xi of f then gi belongs to the unit ball of lip 0 xi b then gi i belongs to the ball of radius l of i lip 0 xi b clearly gi i converges pointwise to f on the dense subset x proof of theorem 5 2 let i 0 let f be in the unit ball of lip 0 x b let fj be a sequence in the ball of radius l of i lip 0 xi b converging uniformly to f which exists by lemma 5 4 then since e i is bounded on l e i fj converges uniformly to e i f furthermore for every j by lemma 5 3 and 5 2 e i fj lip 0 xi b l fj lip 0 x b l 2 this implies e i f lip 0 xi b l 2 5 1 3 measure representation of conditional expectation we conclude our dis cussion of conditional expectation with a small theorem we will use once in the proof of theorem 7 1 we begin with a standard but useful martingale convergence lemma lemma 5 5 for any lipschitz map h x r not necessarily vanishing at 0 and i 0 e i h is lipschitz and e i h i h uniformly proof let h x r be lipschitz so that h h 0 lip 0 x then theorem 5 2 implies h e i h h 0 h 0 is lipschitz the stone weierstrass theorem for algebras of continuous functions implies j c xj is uniformly dense in c x where c xj is defined to be the continuous real valued functions on x factoring through xj then since e i h i h since it is eventually constant for all h j c xj since supi e i l l 1 and since and i are fully supported on x and xi the claim fol lows theorem 5 6 for each i 0 and p xi there exists a unique borel probability measure p supported on i 1 p such that for any h c x b 5 4 e i h p i 1 p hd p proof let p xi first we assume b r since by lemma 5 5 and the usual stone weierstrass theorem e i preserves continuous functions and has uniform uniform operator norm 1 since and i are fully supported the map h 7 e i h p is a norm 1 linear functional on c x further if h 0 e i h p 0 thus our linear functional is represented by a probability measure p on x it remains to show p is supported on i 1 p consider the lipschitz function hp x r defined by hp x d x i 1 p this function vanishes on i 1 p and is strictly positive on x i 1 p thus it suffices to show 22 chris gartland e i hp p 0 let 0 by lemma 5 5 e i hp i hp uniformly so there exists j i such that e j hp x for all x j i 1 p since hp vanishes on i 1 p since e j hp is a lipchitz function on xj we may apply 5 3 this was originally stated for functions vanishing at 0 but easily extends to the general case and induction to conclude eji e j hp p since e j e j i e i we take 0 and obtain the desired conclusion for b r now we extend to general b define a map e c x b c xi bweak by e h p i 1 p hd p where bweak indicated the space b equipped with the weak topology we need to show e e i which we already know holds for b r first let us quickly verify that e indeed maps into the desired space let h c x b and b b by an elementary property of the bochner integral see chapter 1 of pis 16 especially 1 7 and the fact that e e i on real valued continuous functions b e h e b h e i b h we already know e i maps real valued continuous functions to real valued continuous functions so this shows b e h is continuous completing our verification by another elementary fact on b valued conditional expectation again see see chapter 1 of pis 16 1 7 e i b h b e i h i almost everywhere for every b b thus i almost everywhere b e h b e i h for every b b implying e h e i h i almost everywhere but since both e h and e i h are continuous functions from xi into the hausdorff space bweak and since i is fully supported e h e i h everywhere 5 2 the derivative and fundamental theorem of calculus we define the derivative of lipschitz functions on x in this section to do so we must and do assume that b has the rnp we also prove an inequality in theorem 5 9 that should be thought of as an adapted version of the fundamental theorem of calculus definition 5 7 for any hi j lip 0 xj b since xi is a finite graph equipped with a measure mutually absolutely continuous with length measure and with a distance geodesic on edges the fact that b has the rnp allows us to take the derivative of hi i almost everywhere defined by the usual formula h i x limt 0 hi x t hi x t we make sense of x t for t small by identifying the directed edge contained x with an interval and the limit is an almost everywhere norm limit equivalently h i is characterized by 5 5 lim r 0 sup y bir x hi y hi x h i x y x r 0 for i almost every x xi where 0 the map hi 7 h i is a linear contraction lip 0 x b l b theorem 5 8 there exists a unique bounded linear map h 7 h lip 0 x b l b called the derivative that 1 satisfies e i h i h almost everywhere 2 restricts to the usual derivative on j lip 0 xj b 3 has operator norm bounded by l 2 proof note that uniqueness and the second statement already follow from the first statement let h lip 0 x b with h lip 0 x b 1 and for any i thick families of geodesics and differentiation 23 0 let hi e i h so that hi lip 0 xi b l 2 by theorem 5 2 then the intermediate averages x 7 hi x t hi x t are uniformly in t l i b bounded by l 2 the dct then implies that hi t hi t t 0 h i in l 1 i b then since the conditional expectation ei 1 i l 1 i 1 b l 1 i b is continuous ei 1 i h i 1 e i 1 i lim t 0 hi 1 t hi 1 t lim t 0 ei 1 i hi 1 t hi 1 t lim t 0 ei ii hi 1 t ei ii hi 1 t lim t 0 hi t hi t h i the second to last equality says that conditional expectation commutes with pre composition with a translation which can be directly verified by 5 3 thus the sequence h i i 0 forms a martingale uniformly bounded in l b by l 2 since b has the rnp property the martingale converges almost everywhere to some function in l b with norm bounded by l 2 we define h to be this limit theorem 5 9 fundamental theorem of calculus for all g lip 0 x b i 1 e e xi 1 and x y ii 1 1 e e i g y e i g x 2 y x x y e i g d i proof let g i e and x y be as above set gi e i g first assume that x and y belong to a directed edge path then the usual lebesgue fundamental theorem of calculus implies y x g ids gi y gi x where for any positive radon on xi and f l 1 xi b y x fd is interpreted as x y fd if x y along the path and y x fd if y x if x and y don t belong to a directed edge path there exists an intermediate point z on the shortest path from x to y such that the path is directed from x to z and then anti directed from z to y or vice versa we then still have y x g ids gi y gi x if we interpret y x fd as x z fd y z fd if x z and y z or z x fd z y fd if z x and z y for future use we also note that y x fd x y f d as explained in the proof of lemma 4 5 i restricted to x y ii 1 1 e is bounded below by c 2 times length measure and above by c times length measure this implies that for any f l 1 i with f 0 we have 1 2 x y fds y x x y fd i 2 x y fds combining the last two paragraphs yields gi y gi x y x g ids x y g i ds 2 y x x y g i d i 2 y x x y e i g d i 2 y x x y e i g d i 24 chris gartland 6 maximal operator and l 1 l 1 w inequality definition 6 1 let i 0 and hi l 1 i for any nonvertex xi xi and i 0 define mi hi xi sup yi ii 1 1 ei 1 xi xi yi hi d i now let h l 1 and set hi e i h for any nonvertex x x set xi i x and define the maximal function 6 1 m h x sup i 0 mi hi xi theorem 6 2 maximal inequality there exists a constant c 1 such that for any h l 1 b and p 1 6 2 m h l 1 w cp p 1 h lp b proof as is typical the proof is an application of a relevant covering lemma lemma 6 3 which we state and prove following this proof this lemma is a com bination of the vitali covering lemma for doubling metric measure spaces and the covering lemma for atoms in a filtration of finite algebras let h l 1 b hi e i h and p 1 after making the usual covering lemma to maximal inequality argument we will have a c 1 independent of h or p given to us by lemma 6 3 such that m h l 1 w c h l 1 where h is doob s maximal function h x supi 0 hi x by doob s maximal inequality see theorem 1 25 of pis 16 h lp p p 1 h lp b combining these two inequalities with the simple inequality h l 1 h lp yields the desired conclusion lemma 6 3 covering lemma let be a collection of closed subsets of x such that for each there is an i 1 a not necessarily directed shortest path p q xi and an edge e xi 1 such that i 1 p q p q is completely contained in ii 1 1 e then there exists a subfamily such that the sets in are essentially pairwise disjoint for each there exists a closed set containing denoted c such that c and c c proof first consider the collection of sets e i 1 1 e this set cov ers by assumption it is a collection of atoms in the filtration ai i 0 where ai is the algebra onx generated by preimages of edges in e xi under the map i thus we may find an essentially disjoint subcollection that still covers we con sider a single one these sets i 1 1 e let e be the collection of those with p q ii 1 1 e since preimages under i preserve unions and essential dis jointness it suffices to work directly with the paths p q p q is contained in a thick families of geodesics and differentiation 25 geodesic ballbr p where r p q by lemma 4 5 i br p 4 i p q by the 5 r covering lemma we can then find a pairwise disjoint subcollection of br p e say br p e such that b 5 r p e covers br p e and thus covers e we set e e i 1 p q p q e by lemma 4 5 i b 5 r p i b 8 r p 43 i br p we set e e e c 4 43 and c b 5 r p 7 proof of weak form of rnp differentiability theorem 7 1 for each deep point x d x a full measure set recall the natural scale ri x ei x where ei x is the unique edge ofxi containing i x let 0 theorem 7 1 for every rnp space b and lipschitz map f x b for almost every x x f is differentiable at x with respect to along the sequence of scales ri x i 0 more specifically for almost every x d and any r 1 lim sup i sup y brri x x f y f x f x y x ri x 0 where f is the derivative of f from theorem 5 8 proof let b be an rnp space f x b lipschitz and r 1 the conclusion of the theorem is clearly invariant under postcomposition of f with a translation so we may assume f lip 0 x b for each n 0 let fn e n f n lip 0 x b see section 5 1 for relevant definitions let lim sup i sup y brri x x f y f x f x y x ri x so is a function of x for every x the triangle inequality implies lim sup n lim sup i sup y brri x x f y f x fn y fn x ri x fn y fn x f n x y x ri x f n x f x y x ri x for almost every x and every fixed n the second term equals 0 by 5 5 and so lim sup n lim sup i sup y brri x x f y f x fn y fn x ri x f n x f x y x ri x lim sup n lim sup i sup y brri x x f y f x fn y fn x ri x lr f n x f x by theorem 5 8 the second term here also equals 0 for almost every x and so lim sup n lim sup i sup y brri x x f y f x fn y fn x ri x let kn f fn so that supn k n l b supn kn lip 0 x b 2 l 2 f lip 0 x b and k n n 0 almost everywhere again by theorem 5 8 this means k n 26 chris gartland boundedly converges to 0 and we will apply the dct theorem later it suffices to prove lim sup n lim sup i sup y brri x x kn y kn x ri x 0 define yi i y and xi i x then by theorem 5 6 e i kn yi e i kn xi i 1 yi knd yi i 1 xi knd xi furthermore for any y i 1 yi and x i 1 xi we have d y yi ri x d y yi ri x 2 i by 3 11 which together with the previous equation and triangle inequality gives us kn y kn x ri x 1 ri x i 1 yi kn kn y d yi 1 ri x i 1 yi knd yi i 1 xi knd xi 1 ri x i 1 xi kn kn x d xi e i kn yi e i kn xi ri x 4 kn lip 0 x b i e i kn yi e i kn xi ri x 4 2 l 2 f lip 0 x b i so it suffices to prove that lim sup n lim sup i sup yi bi 2 rri x xi e i kn yi e i kn xi ri x 0 for almost every x where bi indicates a ball in the space xi d since 2 rri x rri x iri x by lemma 4 4 for almost every x if i is sufficiently large depending on r and x then bi 2 rri x xi is completely contained in i i 1 1 ei 1 x thus by theorem 5 9 for such i and any yi bi 2 rri x xi e i kn yi e i kn xi ri x 2 yi xi ri x xi yi e i k n d i by 4 1 since yi bi 2 rri x xi i i 1 1 ei 1 x yi xi 2 rri x and so 4 r xi yi e i k n d i by the definition of m the maximal operator defined by 6 1 we get 4 r m k n x then it suffices to show that lim sup n m k n x 0 for almost every x x thick families of geodesics and differentiation 27 for this it suffices to show that lim sup n m k n l 1 w 0 we have by the dct and theorem 6 2 lim sup n m k n l 1 w dct lim sup n m k n l 1 w theorem 6 2 lim sup n 2 c k n l 2 b dct 0 8 application to non bilipschitz embeddability in this section we apply theorem 1 3 to prove a new negative bilipschitz em beddability result corollary 1 5 proof of corollary 1 5 we ll proceed by contradiction let g be a carnot group b an rnp space m a metric space containing a thick family of geodesics and f f 1 f 2 m g b a bilipschitz map we may assume m is complete then we let x m s x and be as in theorem 1 3 and from here on consider f to be restricted to x let g rk be the abelianization map satisfies a well known unique lifting property given any lipschitz map r rk there exists a unique lipschitz lift r g meaning precomposing with f gives a lipschitz map idb f 1 f 2 f 1 f 2 x rk b into an rnp space by theorem 1 3 f 1 f 2 satisfies the weak form of differentiability almost everywhere pick a point x s of differentiability which exists since s 0 and an ultrafilter u x given to us by theorem 1 3 this means the blowup f 1 f 2 x t ri x u x x x rk b exists and factors as f 1 f 2 x f 1 x f 2 x x where x t ri x u x x x r is the blowup of and f 1 x r rk and f 2 x r b are linear breaking these into components gives us the two factorizations f 1 x f 1 x x 8 1 f 2 x f 2 x x let us consider the blowup map f 1 x it turns out that both blowups f 1 x t ri x u x x x t ri x u x f 1 x g g and f 1 x g t ri x u x f 1 x g rk exist and thus f 1 x f 1 x f 1 x exists because the target space g is proper and t ri x u x f 1 x g g becauseg is proper and self similar similar reasoning implies f 1 x g r k exists and f 1 x thus our first factorization can be re expressed as 8 2 f 1 x f 1 x x by remark 4 10 there are two geodesics r t ri x u x x x whose combined image forms a circle of height that coincide with each other outside that circle and satisfy x x idr using these equations 8 2 and 8 1 yields f 1 x f 1 x f 1 x 28 chris gartland f 2 x f 2 x f 2 x since f 1 are lipschitz the unique lifting property of implies f 1 x f 1 x combining these yields f 1 f 2 x f 1 f 2 x since f 1 f 2 is bilipschitz so is f 1 f 2 x thus this is a contradiction since the combined image of two equal geodesics would be a line and could not contain even topologically a circle 9 inverse limit of graphs in nonrnp spaces in this section we modify the thick family of geodesics construction in ost 14 a to obtain an embedding of an inverse limit of an admissible system of graphs into any nonrnp banach space to do so we use the following characterization of nonrnp spaces see theorem 2 7 of pis 16 for any nonrnp space b there exist a 0 and an open convex subset c of the unit ball of b such that for every c c c co c b 4 c 9 1 generalized diamond systems definition 9 1 a generalized diamond system is an inverse system of con nected metric graphs 32 x 2 21 x 1 10 x 0 satisfying d 1 x 0 has two vertices and one edge of length 1 we identify x 0 with i 0 1 d 2 for any vertex v v xi i 1 i 1 v consists of a single vertex of xi 1 we identify this vertex with v and consider v xi as a subset of v xi 1 d 3 there exist an mi and a subdivision x i of xi so that i for vertex v v x i i 1 i 1 v consists of one or two vertices of xi 1 if u v are adjacent vertices in x i then at most one of i 1 i 1 u i 1 i 1 v consists of two vertices ii each edge e e xi is subdivided into 2 mi edges of x i of equal length iii i 1 i xi 1 x i is open simplicial and an isometry on every edge iv for any edge e e x i i 1 i 1 e consists of one or two edges and if e is a terminal subedge of e meaning it shares a vertex with e then i 1 i 1 e consists of only one edge a generalized diamond system admits a canonical sequence of borel probability measures i i 0 satisfying d 4 0 is lebesgue measure on i d 5 restricted to each edge of xi i is a constant multiple of length measure d 6 for each e e x i if i 1 i 1 e consists of two edges then the i 1 measure of each of these edges equals 1 2 i e and if i 1 i 1 e consists of one edge then the i 1 measure of this edge equals i e remark 9 2 with a small adjustment these axioms imply the axioms of an ad missible inverse system from ck 15 the only problem is that in ck 15 each edge of xi is subdivided into m edges of x i where m is independent of i and our subdivisions are into 2 mi subedges where mi can depend on i to conform to thick families of geodesics and differentiation 29 the ck 15 axiom we can augment our inverse system by inserting extra graphs x j i between xi and xi 1 that are simply subdivisions of xi into 2 j subedges for 1 j mi the maps between them are identity maps this new system will now be an admissible inverse system with subdivision parameter 2 and the inverse limit of the original system and augmented system will be the same thus by theorem 1 1 of ck 15 the inverse limit x d of a generalized diamond system is a pi space there is one last axiom for a generalized diamond system which implies 10 3 from ck 15 holds almost everywhere d 7 for any edge e e xi every point in i 1 i 1 e 1 2 is at most 2 edge lengths of xi 1 away from a vertex of degree 4 where e 1 2 denotes the middle half of e 9 2 proof of theorem 1 6 proof of theorem 1 6 we begin by making some reductions first notice that it suffices to embed into b r for any nonrnp space b this is because we may pick any closed codimension 1 subspace b b which is also necessarily a nonrnp space and get b b r let b be a nonrnp space in a slight abuse of notation we ll use to stand for both the norm on b and the norm on b r but this shouldn t cause any confusion we ll construct a sequence of subsets xi i 0 of b r and maps i 1 i xi 1 xi such that xi di is a connected metric graph and 32 x 2 21 x 1 10 x 0 is a generalized diamond system where di denotes the intrinsic metric on xi shortest path metric where path length is measured with respect to ambient banach space the construction will be such that there exist a 0 and i such that xi is 1 i quasiconvex in b r meaning idi x y x y di x y for all x y xi furthermore the construction will be such that for any v v xi v xi 1 i 1 i v v see axiom d 2 for the identification of v xi as a subset of v xi 1 by density of the the vertices in the inverse limit space this implies that the closure of iv xi in b r is 1 bilipschitz equivalent to the inverse limit of 32 x 2 21 x 1 10 x 0 previously we introduced geodesics as isometric maps on intervals but in this proof it will be more convenient to consider the image of these maps instead of the map itself for this reason we use the term geodesic path to mean the image of a geodesic map additionally if p and q are points in a graph we previously used the notation p q to denote the distance between p and q with respect to the length metric but such notation will cause problems in this proof since we are working in a normed space instead we will use the term intrinsic metric which has the same meaning as length metric and notation for this distance will be set subsequently 9 2 1 model graph let 0 and let c be an open convex subset of the unit ball of b such that 0 c and c co c b 4 c for every c c where br x is the closed unit ball of radius r centered at x we describe how to construct a graph for each c c that will serve as a building block for the graphs xi let c c we ll form two piecewise affine geodesic paths from 0 0 to c 1 denoted 0 c and 1 c the reader should refer to figure 6 for a helpful visual of the construction since c c c 1 c 1 kck for some j 0 1 and 30 chris gartland c 1 ck c with 1 k 1 and c cj 4 c 4 note that since c cj belong to the unit ball of b c 12 since c is open we may assume each j is a dyadic rational with common denominator 2 n by density of dyadic rationals in 0 1 additionally by splitting up terms of the form m 2 n cj into the m fold sum 1 2 n cj 1 2 n cj 1 2 n cj we may assume j 2 nc and k 2 nc for some nc 1 independent of j of course we do not have that cj are distinct but that is no issue 0 c consists of a piecewise affine interpolation between 2 2 nc 1 vertices v 0 v 1 v 1 v 2 v 2 v 2 nc v 2 nc these vertices are such that v 0 0 0 and for each j v j vj 1 2 nc 1 c 1 and vj v j 2 nc 1 cj 1 likewise 1 c consists of a piecewise affine interpolation between 2 2 nc 1 vertices w 0 w 1 w 1 w 2 w 2 w 2 nc w 2 nc these vertices are such that w 0 0 0 and for each j w j wj 1 2 nc 1 cj 1 and wj w j 2 nc 1 c 1 notice the flipping of primed and unprimed terms it follows that vj wj for each j and that v 2 nc c 1 w 2 nc these are indeed geodesic paths because the vectors c cj all have norm 1 in b and we take an norm direct sum an isometry from these geodesics paths onto the interval 0 1 is provided by projection onto the second coordinate 0 c is equipped with a graph structure the vertex set is the ordered set v 0 v 1 v 1 v 2 v 2 v 2 nc v 2 nc and there is one edge between consecutive vertices consisting of the line segment between them 1 c is similarly equipped with a graph structure we let c 0 c 1 c since 0 c and 1 c intersect only on their vertices c inherits an induced graph structure the vertex set is v 0 w 0 0 0 v 1 w 1 v 1 w 1 v 2 nc w 2 nc v 2 nc w 2 nc c 1 see figure 6 for an example of c for 2 nc 4 loosely c is made up of a sequence of parallelograms increasing in the r direction of b r such that adjacent parallelograms share a common vertex because of this for any two points of x y c belonging to distinct parallelograms the extrinsic distance x y and intrinsic distance din x y agree we claim that each of these parallelograms is 1 c quasiconvex then this claim together with the preceding sentence imply that c is 1 c quasiconvex proof of claim consider one of the parallelograms of c it has vertices vj 1 wj 1 v j w j vj wj for some j first notice that translations and dilations don t change the quasiconvexity constant of parallelograms so we may perform such modifications to ours to obtain one that is easier to calculate with translate the parallelogram by vj 1 wj 1 so that one of the vertices is 0 0 and the other vertices are 2 nc 1 c 1 2 nc 1 cj 1 and 2 nc 1 c cj 2 then scale by 2 nc 1 so that the vertices are 0 0 c 1 cj 1 and c cj 2 now we label the edges let e 1 be the edge between 0 0 and c 1 e 2 the edge between 0 0 and cj 1 e 3 the edge between c 1 and c cj 2 and e 4 be the edge between cj 1 and c cj 2 figure 5 shows an example of this parallelogram and it will be helpful to keep this picture in mind while reading the remaining proof of the claim note that e 1 e 3 is a subpath of the geodesic path corresponding to 0 c and e 2 e 4 is a subpath of the geodesic path corresponding to 1 c so the intrinsic and extrinsic distance agree on these subsets let x and y be elements of the parallelogram as just mentioned if x and y belong to e 1 e 3 or both belong to e 2 e 3 then the intrinsic and extrinsic distance between x and y agree suppose then that x belongs to e 1 and y belongs to e 2 then x c 1 for some 0 1 y cj 1 for some 0 1 and the intrinsic distance between x and y is thick families of geodesics and differentiation 31 e 1 e 2 4 c e 3 e 4 0 0 c 1 cj 1 c cj 2 figure 5 the parallelogram with vertices 0 0 c 1 cj 1 and c cj 2 the horizontal axis is in the b direction of b r and the vertical axis is in the r direction the extrinsic and intrinsic distance between any two points on e 1 e 3 or any two points on e 2 c 4 agree the extrinsic distance between the two vertices c 1 cj 1 is 4 c all edge lengths are 1 without loss of generality assume so that the intrinsic distance between x and y din x y is bounded by 2 then the extrinsic distance between x and y is x y c 1 cj 1 c cj c max c cj c max c cj c max c cj max 4 c 2 c cdin x y showing that the quasiconvexity constant is bounded above by 1 c in this case by symmetry we get the same upper bound if x belongs to e 3 and y belongs to e 4 there is one remaining case since the rest of the cases follow from this one by symmetry in which x belongs to e 1 and y belongs to e 4 in this case x c 1 for some 0 1 y cj 1 c 1 for some 0 1 and we use the trivial bound din x y 2 for the intrinsic distance then for the extrinsic distance we have x y c 1 cj 1 c 1 1 c c cj 1 max 1 c c cj 1 max c cj 1 1 max 4 c 1 1 2 c cdin x y this completes the proof of the 1 c quasiconvexity of the parallelogram end proof of claim 32 chris gartland v 0 w 0 0 0 v 1 w 1 v 1 w 1 v 2 w 2 v 2 w 2 v 3 w 3 v 3 w 3 v 4 w 4 v 4 w 4 c 1 figure 6 the model graph c the geodesic path 0 c is shown in orange and the geodesic path 1 c is shown in blue the horizontal axis is in the b direction of b r and the vertical axis is in the r direction since 0 c 1 c and 0 0 c 1 are all geodesics with endpoints 0 0 and c 1 there are unique isometries 0 c 0 0 c 1 and 1 c 0 0 c 1 fixing the endpoints if we let 0 0 c 1 denote the subdivision of 0 0 c 1 into subedges of length 2 nc 1 the maps are graph isomorphisms combining these gives us a map c c 0 0 c 1 which is open simplicial and an isometry on every edge furthermore the preimage of any edge in 0 0 c 1 consists of two edges of c let 0 0 t 0 t 1 t 1 t 2 t 2 t 2 nc t 2 nc c 1 be the ordered vertex set of 0 0 c 1 then 1 c tj vj wj a single vertex and 1 c t j vj w j a set of two vertices finally if j 6 0 2 nc the vertex vj wj has degree four so every point in c is at most two edge lengths away from a vertex of degree four thus c c 0 0 c 1 satisfies the conditions listed for i 1 i in axioms d 2 d 3 and d 7 for any 0 r 0 b 0 b and a b we let 0 a b 0 be the image of a under the invertible similarity b 7 0 b b 0 0 c b 0 and 0 0 0 c 1 b 0 inherit graph structures from c and 0 0 c 1 respectively and there is also thick families of geodesics and differentiation 33 an induced map 0 c b 0 0 c b 0 0 0 0 c 1 b 0 that like c satisfies axioms d 2 d 3 and d 7 9 2 2 inductive construction of xi for the base case let x 0 0 i b r for the inductive hypothesis assume that the inverse system xi ii 1 xi 1 10 x 0 and x i 1 have been constructed and satisfy axioms d 1 d 7 from definition 9 1 for e e xi let v 0 e and v 1 e denote the terminal vertices of e assume that the inverse system satisfies the additional properties p 1 for all e e xi e equals the line segment joining v 0 e to v 1 e that is e v 0 e v 1 e 1 t v 0 e tv 1 e t 0 1 p 2 for all e e xi e is parallel to an associated vector c 1 c 1 that is v 1 e v 0 e c 1 for some r and c c furthermore 2 ni for some ni 1 ni depends on i but not on e it follows that every edge of xi has length 2 ni now we need to construct xi 1 x i and i 1 i xi 1 x i let e e xi and c c and ni 1 such that v 1 e v 0 e 2 ni c 1 subdivide e into into 3 subedges the middle one having length 1 2 e and the terminal ones having length 1 4 e let e 0 and e 1 denote the terminal subedges and e 1 2 the middle subedge note that for any x e 1 2 and y xi e 9 1 di x y e 4 2 ni 2 let i 2 so that i choose n to be large enough so that 9 2 2 n i 2 2 subdivide e 1 2 into 2 n edges of equal length so now e is divided into a total of 2 n 2 subedges and two of them e 0 and e 1 are marked as terminal subedges doing this for every e e xi gives us a subdivison x i of xi let f be a subedge of e 1 2 then v 1 f v 0 f 2 ni 1 n c 1 we create xi 1 by replacing f with the graph 2 ni 1 n c v 0 f which has the same vertices as f thus xi 1 consists of the union of e 0 e 1 2 ni 1 n c v 0 f over all f e 1 2 and e e xi with each e 0 and e 1 subdivided into subedges so that every edge of xi 1 has equal length xi 1 satisfies p 1 and p 2 since there are only finitely many e e xi and thus finitely many c c associated to e we may choose the subdivision parameter nc of section 9 2 1 independent of c x i is simply the subdivision of x i into subedges all having length the same as any edge of xi 1 for any e 0 e 1 and f e 1 2 let e 0 e 1 and f denote the subdivisions in x i let 2 ni 1 n c v 0 f 2 ni 1 n c v 0 f f be the map defined in section 9 2 1 we paste all these maps along with all the identity maps e 0 e 0 e 1 e 1 together to obtain the quotient map i 1 i xi 1 x i then i 1 i satisfies axioms d 2 d 3 and d 7 because each map 2 ni 1 n c v 0 f does the map i 1 i is a 1 lipschitz quotient with respect to the metrics di 1 and di furthermore it has the property that if x y xi 1 and i 1 i x and i 1 i y do not belong to the same edge of x i then 9 3 di 1 x y di i 1 i x i 1 i y 34 chris gartland set i 1 minc c where the minimum is over each c 1 associated to an edge e of xi since there are only finitely many edges of xi the minimum is well defined and i 1 we now check that xi 1 is 1 i 1 quasiconvex let x y xi 1 first consider the case i 1 i x and i 1 i y belong to the same edge f of x i with v 1 f v 0 f 2 ni c 1 for some c c then x and y both belong to 2 ni 1 n c v 0 f on which the intrinsic distance is 1 c quasiconvex so the desired conclusion holds in this case now assume i 1 i x and i 1 i y do not belong to the same edge of x i but do belong to the same edge of xi then the intrinsic and extrinsic distance between x and y and the intrinsic and extrinsic distance between i 1 i x and i 1 i y are all equal finally assume i 1 i x and i 1 i y do not belong to the same edge of xi we consider two subcases both x and y belong to terminal subedges of e f e xi or one does not belong to a terminal subedge in the first case if both x and y belong to terminal subedges of xi then i 1 i acts identically on x and y and so di 1 x y di i 1 i x i 1 i y 1 i i 1 i x i 1 i y x y by the inductive hypothesis and so the conclusion holds now assume without loss of generality that i 1 i x e 1 2 for some e e xi and y xi 1 i 1 i 1 e then we get 9 4 di i 1 i x i 1 i y i 1 i x i 1 i y idi x y 9 1 i e 4 i 2 ni 2 since i 1 i acts identically on the vertices of x i the di 1 diameter of any fiber of i 1 i is at most the length of an edge of x i which is 2 ni 1 n this implies 9 5 i 1 i x x i 1 i y y 2 ni 1 n thus x y i 1 i x i 1 i y i 1 i x x y i 1 i y 9 5 idi i 1 i x i 1 i y 2 ni n 9 2 idi i 1 i x i 1 i y i 2 ni 2 9 4 idi i 1 i x i 1 i y i di i 1 i x i 1 i y di i 1 i x i 1 i y 9 3 di 1 x y i 1 di 1 x y 10 questions as far as we are aware the following questions remain open a positive answer to q 1 implies a positive answer to q 2 a positive answer to q 2 implies a positive answer to q 3 assuming the metric space is separable and a positive answer to q 3 implies positive answers to q 4 and q 5 in the following we always mean complete metric space s when we say metric space s there are easy counterexamples if completeness is not assumed q 1 is the differentiation nonembeddability criterion a necessary condition for the non bilipschitz embeddability of metric spaces into rnp spaces thick families of geodesics and differentiation 35 q 2 is some weak form of the differentiation nonembeddability criterion such as that of theorem 1 3 a necessary condition for the non bilipschitz em beddability of metric spaces into rnp spaces q 3 are the only obstructions to bilipschitz embeddability of metric spaces into rnp spaces local q 4 does every discrete metric space bilipschitz embed into some rnp space q 5 is there a universal constant c such that if a metric space bilipschitz embeds into an rnp space then it c bilipschitz embeds into an possibly larger rnp space technically the differentiation nonembeddability criterion is for metric measure spaces not metric spaces so we need to be more specific about q 1 and similarly for q 2 if a complete metric space m does not embed into any rnp space does there exist a borel measure on m so that m satisfies the differentiation nonembeddability criterion defined in section 1 1 q 3 can be stated more specifically as if every point in a metric space has a neighborhood that bilipschitz embeds into an rnp space does the entire metric space embed into an rnp space that q 1 implies q 2 and q 3 implies q 4 are immediate to see that q 1 implies q 3 suppose we have a separable metric space that locally embeds into rnp spaces by using a partition of unity type argument and by taking a countable 1 direct sum of the rnp spaces we can find a globally defined lipschitz map into a single rnp space that is locally bilipschitz then the blowup of this map at any point where it exists must also be bilipschitz and so no differentiation criterion can hold thus by q 1 the entire metric space must bilipschitz embed into some rnp space the statement of q 2 is not specific enough to prove that q 2 implies q 3 but for any reasonable notion of differentiability the same argument of q 1 implies q 3 should work now we show that q 3 implies q 5 we first need the following result there is a constant c such that for any metric space x if every bounded subset of x bilipschitz embeds into an rnp space with distortion at most d then the entire space embeds into an rnp space with distortion at most cd to see this pick a base point 0 x rnp spaces bn and d bilipschitz embeddings n b 2 n 0 bn define a new map x bn 1 r note that the target has rnp by x d x 0 2 i 1 2 i 1 i 1 x 2 i d 0 x 2 i 1 i x d 0 x if 2 i 1 d 0 x 2 i it is shown in the proof of theorem 1 2 from ost 12 that there is a constant c such that is cd bilipschitz this gluing procedure was also used earlier in the proof of theorem 1 1 of bau 07 now assume q 5 is false for each n n pick a metric space xn that bilipschitz embeds into some rnp space but with distortion never less than n by the previous discussion there is a universal constant c such that if every bounded subset of xn bilipschitz embeds into an rnp space with distortion less than cn then the entire space would bilipschitz embed into an rnp space with distortion at most n a contradiction thus there is a bounded subset yn of xn that bilipschitz embeds into an rnp space but never with constant less than cn taking a metric disjoint union of these bounded spaces yn n 1 yields a space failing q 3 36 chris gartland references aro 76 n aronszajn differentiability of lipschitzian mappings between banach spaces studia math 57 1976 no 2 147 190 mr 0425608 bat 15 david bate structure of measures in lipschitz differentiability spaces j amer math soc 28 2015 no 2 421 482 mr 3300699 bau 07 florent baudier metrical characterization of super reflexivity and linear type of banach spaces arch math basel 89 2007 no 5 419 429 mr 2363693 bl 00 yoav benyamini and joram lindenstrauss geometric nonlinear functional analysis vol 1 american mathematical society colloquium publications vol 48 american mathematical society providence ri 2000 mr 1727673 che 99 j cheeger differentiability of lipschitz functions on metric measure spaces geom funct anal 9 1999 no 3 428 517 mr 1708448 chr 73 jens peter reus christensen measure theoretic zero sets in infinite dimensional spaces and applications to differentiability of lipschitz mappings publ de p math lyon 10 1973 no 2 29 39 actes du deuxie me colloque d analyse fonctionnelle de bordeaux univ bordeaux 1973 i pp 29 39 mr 0361770 ck 09 jeff cheeger and bruce kleiner differentiability of lipschitz maps from metric measure spaces to banach spaces with the radon nikody m property geom funct anal 19 2009 no 4 1017 1028 mr 2570313 ck 15 inverse limit spaces satisfying a poincare inequality anal geom metr spaces 3 2015 15 39 mr 3300718 laa 00 t j laakso ahlfors q regular spaces with arbitrary q 1 admitting weak poincare inequality geom funct anal 10 2000 no 1 111 123 mr 1748917 li 14 sean li coarse differentiation and quantitative nonembeddability for carnot groups j funct anal 266 2014 no 7 4616 4704 mr 3170215 lp 01 urs lang and conrad plaut bilipschitz embeddings of metric spaces into space forms geom dedicata 87 2001 no 1 3 285 307 mr 1866853 man 73 piotr mankiewicz on the differentiability of lipschitz mappings in fre chet spaces stu dia math 45 1973 15 29 mr 0331055 mn 13 manor mendel and assaf naor markov convexity and local rigidity of distorted metrics j eur math soc jems 15 2013 no 1 287 337 mr 2998836 ost 12 m i ostrovskii embeddability of locally finite metric spaces into banach spaces is finitely determined proc amer math soc 140 2012 no 8 2721 2730 mr 2910760 ost 14 a mikhail ostrovskii radon nikody m property and thick families of geodesics j math anal appl 409 2014 no 2 906 910 mr 3103207 ost 14 b mikhail i ostrovskii metric spaces nonembeddable into banach spaces with the radon nikody m property and thick families of geodesics fund math 227 2014 no 1 85 96 mr 3247034 ost 14 c on metric characterizations of the radon nikody m and related properties of banach spaces j topol anal 6 2014 no 3 441 464 mr 3217866 pis 16 gilles pisier martingales in banach spaces cambridge studies in advanced mathemat ics vol 155 cambridge university press cambridge 2016 mr 3617459 sch 14 andrea schioppa derivations and alberti representations proquest llc ann arbor mi 2014 thesis ph d new york university mr 3279153 1 introduction 1 1 historical background 1 2 summary of results and discussion of proof methods 1 3 outline 2 preliminaries 3 inverse systems of nested graphs 3 1 axioms and terminology 3 2 elementary consequences of axioms 3 3 existence of inverse system 4 asymptotic local properties of xi i 0 and special subsets of x 4 1 deep points and their natural scales 4 2 points having a noneuclidean tangent 5 approximation of functions on x via xi 5 1 conditional expectation 5 2 the derivative and fundamental theorem of calculus 6 maximal operator and l 1 l 1 w inequality 7 proof of weak form of rnp differentiability theorem 7 1 8 application to non bilipschitz embeddability 9 inverse limit of graphs in nonrnp spaces 9 1 generalized diamond systems 9 2 proof of theorem 1 6 10 questions references