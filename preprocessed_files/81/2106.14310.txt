optimal control of closed quantum systems via b splines with carrier waves n anders petersson and fortino garcia abstract we consider the optimal control problem of determining electromagnetic pulses for implementing logical gates in a closed quantum system where the hamiltonian models the dynamics of coupled superconducting qudits the quantum state is governed by schro dinger s equation which we formulate in terms of the real and imaginary parts of the state vector and solve by the sto rmer verlet scheme which is a symplectic partitioned runge kutta method a novel parameterization of the control functions based on b splines with carrier waves is introduced the carrier waves are used to trigger the resonant frequencies in the system hamiltonian and the b spline functions specify their amplitude and phase this approach allows the number of control parameters to be independent of and significantly smaller than the number of time steps for integrating schro dinger s equation we present numerical examples of how the proposed technique can be combined with an interior point l bfgs algorithm for realizing quantum gates and generalize our approach to calculate risk neutral controls that are resilient to noise in the hamiltonian model the proposed method is also shown to compare favorably with qutip pulse optim and grape tensorflow key words quantum control b splines symplectic runge kutta method ode constrained optimization quantum computing ams subject classifications 49 m 25 65 d 07 65 l 06 81 q 93 1 introduction we consider the quantum optimal control problem of deter mining electromagnetic pulses for implementing unitary gates in a quantum computer a truncated modal expansion of schro dinger s equation is used to model the quantum system in which the state of the quantum system is described by the state vector 1 cn the elements of the state vector are complex probability amplitudes where the magnitude squared of each element represents the probability that the quantum system occupies the corresponding energy level 20 because the probabilities must sum to one the state vector is normalized such that 22 1 the evolution of the state vector in the time interval t 0 t is governed by schro dinger s equation 1 1 d dt ih t 0 0 t t 0 g here i 1 is the imaginary unit and g is the initial state the hamiltonian matrix h t cn n scaled such that planck s constant becomes 1 is hermitian and is assumed to be of the form h t hs hc t 1 2 where hs and hc are the system and control hamiltonians respectively the control hamiltonian models the action of external control fields on the quantum system the submitted to the editors on june 29 2021 funding this work was supported in part by llnl laboratory directed research and devel opment project 20 erd 028 and in part by doe office of advanced scientific computing research under the advanced research in quantum computing program award 2019 llnl scw 1683 center for applied scientific computing llnl livermore ca 94550 usa peters son 1 llnl gov department of applied mathematics university of colorado boulder co 80309 usa fortino garcia colorado edu 1 this paper uses conventional matrix vector notation for finite dimensional systems it is equiv alent to the bra ket notation that often is used in quantum physics 1 ar x iv 2 10 6 14 31 0 v 1 qu an t ph 2 7 ju n 20 21 mailto petersson 1 llnl gov mailto petersson 1 llnl gov mailto fortino garcia colorado edu time dependence in the control hamiltonian is parameterized by the control vector rd as a result the state vector depends implicitly on through schro dinger s equation to justify the truncation of the modal expansion of schro dinger s equation we divide the state vector into e 0 essential levels and g 0 guard levels such that e g n the population of the highest guard levels need to be small to minimize coupling to even higher energy levels which are excluded from the model the goal of the quantum optimal control problem is to determine the parameter vector such that the time dependence in the hamiltonian matrix leads to a solu tion of schro dinger s equation such that t vtgg where vtg is the target gate transformation the gate transformation should be satisfied for all initial conditions in the essential subspace of the state vector a basis of this subspace is provided by the matrix u 0 rn e the definitions of u 0 and vtg are described in appendix a to account for any initial condition in the essential subspace we define the solu tion operator matrix u cn e each column of this matrix satisfies 1 1 leading to schro dinger s equation in matrix form 1 3 du t dt ih t u t 0 0 t t u 0 u 0 the overlap between the target gate matrix and the solution operator matrix at the final time is defined by ot u t vtg f where f denotes the frobenious matrix scalar product because u 0 spans an e dimensional subspace of initial condi tions we have ot e the difference between u t and vtg can be measured by the target gate infidelity 13 16 17 18 23 1 4 j 1 ut 1 1 e 2 ut vtg f 2 ut u t note that the target gate infidelity is invariant to global phase differences between ut and vtg in quantum physics the global phase of a state is considered irrelevant because it can not be measured the leakage of population to the guard states can be measured by the objective function 1 5 j 2 u 1 t t 0 u t wu t f dt where w is a diagonal n n positive semi definite weight matrix the elements in w are zero for all essential states and are positive for the guard states the elements of w are typically larger for higher energy levels in the model for the quantum control problem with guard states we formulate the optimization problem as min g j 1 ut j 2 u 1 6 du dt ih t u 0 0 t t u 0 u 0 1 7 min q max q 1 2 d 1 8 for a discussion of the solvability of the quantum control problem see for example borzi et al 4 2 there are several different approaches to numerically determine controls that yield high fidelity quantum logic gates perhaps some of the simplest approaches to imple ment are gradient free optimization methods such as the crab algorithm 5 the crab algorithm is constructed by choosing a functional approximation of the control functions lagrange polynomials fourier basis etc to truncate the infinite dimen sional control problem into a finite dimensional multivariate optimization problem this optimization problem is solved using a direct search method without the need for a gradient which typically comes at the cost of slower convergence compared to gradient based techniques unless the number of control parameters is small for gradient based approaches there are broadly two classes of methods for com puting the gradient of the objective function the first accumulates the gradient by forward time stepping as is done in the goat algorithm 18 this approach allows the gradient of the objective function to be calculated exactly but requires d 1 schro dinger systems to be solved when the control functions depend on d parameters this makes the method computationally expensive when the number of parameters is large the second approach for computing the gradient solves an adjoint equation backwards in time this approach together with the use of a second order accurate magnus scheme 12 leads to the grape algorithm 14 16 of note is that a stair step approximation of the control functions is imposed such that each control function is constant within each time step as a consequence the time step determines both the numerical accuracy of the state vector and the number of control parameters with q control functions and m time steps of size h the control functions are thus described by d m q parameters for problems in which the duration of the gate is long or the quantum state is highly oscillatory it is clear that the size of the pa rameter space becomes very large which may hamper the convergence of the grape algorithm as seen with the crab algorithm the total number of parameters can be reduced by instead expanding the control functions in terms of basis functions by using the chain rule the gradient from the grape algorithm can then be used to calculate the gradient with respect to the coefficients in the basis function expansion this approach is implemented in the grafs algorithm 17 where the control functions are expanded in terms of slepian sequences many other parameterizations of quantum control functions have been proposed in the literature for example cubic splines 7 gaussian pulse cascades 6 and fourier expansions 25 this paper presents a different approach based on parameterizing the control functions by b spline basis functions with carrier waves our approach relies on the observation that transitions between the energy levels in a quantum system are triggered by resonance at frequencies that can be determined by inspection of the system hamiltonian the carrier waves are used to specify the frequency spectra of the control functions while the b spline functions specify their envelope and phase we find that this approach allows the number of control parameters to be independent of and significantly smaller than the number of time steps for integrating schro dinger s equation the remainder of the paper is organized as follows in section 2 we introduce a hamiltonian model and discuss the resonant frequencies needed to trigger transitions between the states in the system these resonant frequencies naturally motivate us to parameterize the control functions using b splines with carrier waves details of this parameterization are presented in section 3 in section 4 we introduce a real valued formulation of schro dinger s equation and present the symplectic sto rmer verlet scheme that we use for its time integration to achieve an exact gradient of 3 the discrete objective function we apply the first discretize then optimize approach based on the sto rmer verlet scheme in section 5 we outline the construction of a discrete adjoint time integration method section 6 presents numerical examples we illustrate how the proposed technique combined with the interior point l bfgs algorithm 21 from the ipopt package 24 is used to optimize control functions for multi level qudit gates we additionally consider a simple noise model and risk neutral optimization to illustrate the construction of controls that are robust to uncertainty in the hamiltonian the proposed scheme is implemented in the julia 2 programming language in an open source package called juqbox jl 8 in section 7 we compare the performance of juqbox jl and two implementations of the grape algorithm concluding remarks are given in section 8 2 hamiltonian model several hamiltonian models exist for describing the quantum physics of super conducting circuits 3 19 in this paper we consider a composite quantum system with q 1 subsystems qubits qudits where the system hamiltonian satisfies hs q q 1 qa qaq q 2 a qa qaqaq p q pqa papa qaq 2 1 in this model q is the ground state transition frequency and q is the self kerr coefficient of subsystem q the cross kerr coefficient between subsystems p and q is denoted pq furthermore subsystem q is assumed to have nq 2 energy levels with lowering operator aq the lowering operator is constructed using kronecker products aq inq inq 1 aq inq 1 in 1 r n n n q q 1 nq 2 2 where in denotes the n n identity matrix and the single system lowering matrix satisfies aq 0 1 nq 1 0 r nq nq 2 3 we consider a control hamiltonian with real valued control functions that are param eterized by the control vector hc t q q 1 fq t aq a q fq t 2 re dq t e i r qt 2 4 where r q is the drive frequency in subsystem q 2 1 rotating wave approximation to slow down the time scales in the state vector we apply a rotating frame transformation in schro dinger s equation through the unitary change of variables t r t t where r t 1 q q exp i r qt a qaq 2 5 4 and 1 q qcq cq cq 1 c 1 note that we use r q as the frequency of rotation in subsystem q the system hamiltonian transforms into hrws hs r qa qaq then the rotating wave approximation is applied to transform the control hamilton ian here we substitute the laboratory frame control function fq t from 2 4 and neglect terms oscillating with frequencies 2 r q as a result the hamiltonians 2 1 and 2 4 transform into see appendix b for details hrws q q 1 qa qaq q 2 a qa qaqaq p q qpa qaqa pap 2 6 hrwc t q q 1 dq t aq d q t a q 2 7 where q q r q is called the detuning frequency the main advantages of the rotating frame approximation are the reduction of the spectral radius in the system hamiltonian 2 6 and the absence of the highly oscillatory factor exp i r qt in the control hamiltonian 2 7 in the following we assume that the rotating wave approximation has already been performed and the tilde on the state vector will be suppressed we additionally note that the target unitary vtg is similarly transformed into the rotating frame via v rwtg r t vtg 2 2 resonant frequencies to simplify the presentation we restrict our analy sis to a bipartite quantum system i e q 2 the system hamiltonian 2 6 is diagonal and we denote its elements by hrws j k j j k 0 otherwise j 2 q 1 qjq q 2 jq jq 1 12 j 1 j 2 2 8 for jq 0 nq 1 and where j j 2 j 1 is a multi index let us consider the case when the control functions dk t oscillate with carrier wave frequencies 1 2 and amplitude where 0 1 these assumptions give hrwc t h 1 t h 1 t 2 k 1 ei ktak e i kta k 2 9 we make an asymptotic expansion of the solution of schro dinger s equation 1 1 0 1 o 2 the zero th and first order terms satisfy d 0 dt ihrws 0 0 0 0 g 2 10 d 1 dt ihrws 1 f t 1 0 0 2 11 because the system hamiltonian is diagonal 2 10 is a decoupled system of ordinary differential equation that is solved by 0 j t gje i jt the right hand side of 2 11 satisfies f t ih 1 t 0 t which can be written f t q k 1 f k t f k t i ei ktak e i kta k 0 t 2 12 5 because the matrix hrws is diagonal the system for the first order perturbation 2 11 is also decoupled we are interested in cases when 1 j t grows in time corresponding to resonance let ek denote the k th unit vector and denote a shifted multi index by j e 1 j 2 j 1 1 and j e 2 j 2 1 j 1 lemma 2 1 the perturbation of the state vector 1 j t grows linearly in time when the carrier wave frequencies and the initial condition satisfy k j ek j gj ek 6 0 jk 0 nk 2 2 13 k j j ek gj ek 6 0 jk 1 nk 1 2 14 for k 1 2 proof see appendix c we can evaluate the conditions for resonance by inserting the hamiltonian ele ments from 2 8 into 2 13 and 2 14 for k 1 and j 2 0 n 2 1 resonance occurs in 1 j t when 1 1 1 j 1 12 j 2 gj e 1 6 0 j 1 0 n 1 2 1 1 j 1 1 12 j 2 gj e 1 6 0 j 1 1 n 1 1 2 15 for k 2 and j 1 0 n 1 1 the resonant cases are 2 2 2 j 2 12 j 1 gj e 2 6 0 j 2 0 n 2 2 2 2 j 2 1 12 j 1 gj e 2 6 0 j 2 1 n 2 1 2 16 for example when n 1 3 n 2 3 and gj 6 0 j the carrier wave frequencies 1 1 1 12 1 2 12 1 1 1 1 12 1 1 2 12 2 2 2 12 2 2 12 2 2 2 2 12 2 2 2 12 lead to resonance since schro dinger s equation conserves total probability the linear growth in time only occurs for short times thus each resonant frequency corresponds to the initia tion of a transition between two energy levels in the quantum system 3 quadratic b splines with carrier waves motivated by the results from the previous section we parameterize the rotating frame control functions using basis functions that act as envelopes for carrier waves with fixed frequencies dk t nf n 1 dk n t dk n t nb b 1 s b t k b n e it k n k 1 q 3 1 here k n r is the nth carrier wave frequency for system k these frequencies are chosen to match the resonant frequencies in the system hamiltonian 2 6 as outlined above the complex coefficients kb n k r b n i k i b n are control parameters that are to be determined through optimization corresponding to a total of d 2 qnbnf real valued parameters it is convenient to also define the real valued functions pk n t nb b 1 s b t k r b n qk n t nb b 1 s b t k i b n 3 2 6 fig 1 the real part of a quadratic b spline control function with zero carrier fre quency dashed black the solid colored lines are the individual b spline wavelets such that dk n t pk n t iqk n t exp it k n the basis functions s b t are chosen to be piece wise quadratic b spline wavelets see figure 1 centered on a uniform grid in time 3 3 b b 1 5 b 1 nb t nb 2 the basis function s b t has local support for t b 1 5 b 1 5 thus for any fixed time t a control function will get contributions from at most three b spline wavelets allowing the control functions to be evaluated very efficiently we also remark that the control function 3 1 can be evaluated at any time t 0 t importantly this allows the time integration scheme to be chosen independently of the parameterization of the control function and allows the number of control parameters to be chosen independently of the number of time steps for integrating schro dinger s equation 4 real valued formulation a real valued formulation of schro dinger s equa tion 1 1 is given by 4 1 u v s t k t k t s t u v fu u v t fv u v t u 0 v 0 gu gv where u re v im k re h s im h because the matrix h is hermitian kt k and st s note that the matrix s is unrelated to the matrix overlap function sv the real valued formulation of schro dinger s equation is a time dependent hamiltonian system corresponding to the hamiltonian functional 4 2 h u v t uts t v 1 2 utk t u 1 2 vtk t v in general s t 6 0 which makes the hamiltonian system non separable in terms of the real valued formulation let the columns of the solution operator matrix in 1 3 satisfy u u 1 iv 1 u 2 iv 2 ue ive here uj vj satisfy 7 4 1 subject to the initial conditions gvj 0 and g u j ej where j jq jq 1 j 1 is a multi index such that jq 0 1 mq 1 and mq is the number of essential levels of subsystem q the columns in the target gate matrix vtg d 1 de correspond to vtg d u 1 id v 1 d u 2 id v 2 d u e id v e d u j re dj d v j im dj using the real valued notation the two parts of the objective function 1 6 can be written j 1 ut 1 1 e 2 sv ut 2 4 3 j 2 u 1 t e 1 j 0 t 0 uj t ivj t w uj t ivj t 2 dt 4 4 where sv ut e 1 j 0 uj t ivj t duj id v j 2 4 5 4 1 time integration let tn nh for n 0 1 m be a uniform grid in time where h t m is the time step also let un u tn and vn v tn denote the numerical solution on the grid we use a partitioned runge kutta prk scheme 12 to discretize the real valued formulation of schro dinger s equation u 0 gu v 0 gv 4 6 un 1 un h s i 1 bui n i vn 1 vn h s i 1 bvi n i 4 7 n i fu un i v n i tn c u i h n i fv un i v n i tn c v i h 4 8 un i un h s j 1 auij n j v n i vn h s j 1 avij n j 4 9 here s 1 is the number of stages the stage variables un i and v n i are set in a bold font to indicate that they are unrelated to the solution operator matrix u t and the target gate matrix vtg the sto rmer verlet scheme is a two stage prk method s 2 that is symplectic time reversible and second order accurate 12 it combines the trapezoidal and the implicit midpoint rules with butcher coefficients au 11 a u 12 0 a u 21 a u 22 1 2 av 11 a v 21 1 2 av 12 a v 22 0 4 10 bu 1 b u 2 1 2 cu 1 0 c u 2 1 b v 1 b v 2 1 2 cv 1 c v 2 1 2 4 11 4 2 time step restrictions for accuracy and stability for simplicity in the following we consider a single qubit system q 1 and note that it can be extended to multiple systems in a straightforward manner the accuracy in the nu merical solution of schro dinger s equation is essentially determined by resolving each of two fundamental time scales on the grid in time the first time scale corresponds 8 to the resonance frequencies in the control functions for triggering desired transitions between energy levels in the quantum system as discussed in section 2 2 in the hamiltonian model 2 6 and 2 7 the angular transition frequencies between the essential energy levels with detuning frequency 1 are 1 n 1 n 1 n 0 nf 1 the second time scale is due to the harmonic oscillation of the phase in the state vector recall that the hamiltonian h cn n is hermitian so that if is a real eigenvalue of h then the system matrix ih has the eigenvalue i thus the harmonic oscillation corresponding to the eigenvalue of largest magnitude of h gives the shortest period a straightforward bound on the eigenvalue of largest magnitude of the hamiltonian 2 6 and 2 7 can be obtained using gershgorin s circle theorem 11 h 1 2 n 1 n 2 2 d n 1 max here we have used that the control function is bounded by d maxt d 1 t for a given parameter vector in the interval 0 t t to resolve the shortest period in the solution of schro dinger s equation by at least cp time steps requires h 2 cp max max maxn 1 n 4 12 the value of cp that is needed to obtain a given accuracy in the numerical solution depends on the order of accuracy the duration of the time integration as well as the details of the time stepping scheme for second order accurate methods such as the sto rmer verlet method acceptable accuracy for engineering applications can often achieved with cp 40 with the sto rmer verlet method we note that the time stepping can become unstable if cp 2 corresponding to a sampling rate below the nyquist limit 5 discretizing the objective function and its gradient as discussed in the introduction a powerful and efficient method to compute the gradient of the objective function is through the adjoint state method to that end there are two approaches to compute the adjoint equation the first is the first optimize then discretize approach in which the continuous adjoint equation is derived and then discretized independently of the forward state equation the second is the first discretize then optimize approach in which a discretization is chosen for both the state equation and the objective function with the chosen discretization the karush kuhn tucker kkt conditions 15 applied to a discrete lagrangian yield an appro priate adjoint discretization scheme which provides an exact discrete gradient here we follow the first discretize then optimize approach as the former may yield in consistent gradients in the following we present a brief summary of the results of this approach for the reader interested in the technical details of the derivation of the discrete adjoint scheme we refer to 22 recall that the sto rmer verlet scheme applied to the real valued schro dinger equation 4 1 is a partitioned runge kutta prk scheme essentially combining the trapezoidal and midpoint rules for the real and imaginary parts of the state vector respectively for the discretization of the guard level integral term in 4 4 we use the corresponding trapezoidal and midpoint rules as follows j h 2 u v h 2 t e 1 j 0 m 1 n 0 u n 1 j wu n 1 j u n 2 j wu n 2 j 2 v n 1 j wv n 1 j 9 here the superscript h on j h 2 denotes the discretized objective function we note that the trace infidelity term j 1 in 4 3 is a terminal condition with the discrete analogue j h 1 j 1 thus we have the discrete version of the total objective function 1 6 as gh j h 1 j h 2 with these choices a first discretize then optimize approach leads to a partitioned runge kutta prk scheme that is a consistent approximation of the continuous adjoint equation the adjoint prk scheme is closely related to the sto rmer verlet scheme however the roles of the trapezoidal and midpoint rules are swapped for example the state variables u are evolved with the trapezoidal rule in sto rmer verlet but the corresponding multiplier variables are evolved with the midpoint rule in the adjoint prk scheme in addition the time dependent matrices for the adjoint scheme are evaluated at slightly different time levels see 22 for further details 6 numerical optimization our numerical solution of the optimal control problem is based on the general purpose optimization package ipopt 24 this open source library implements a primal dual barrier approach for solving large scale nonlinear programming problems i e it minimizes an objective function subject to inequality barrier constraints on the parameter vector since the hessian of the objective function is costly to calculate we use the l bfgs algorithm 21 in ipopt which only relies on the objective function and its gradient to be evaluated inequality constraints that limit the amplitude of the parameter vector are enforced internally by ipopt the routines for evaluating the objective function and its gradient are imple mented in the julia programming language 2 which provides a convenient interface to ipopt given a parameter vector the routine for evaluating the objective func tion solves the schro dinger equation with the sto rmer verlet scheme and evaluates the objective function gh by accumulation the routine for evaluating the gra dient first applies the sto rmer verlet scheme to calculate terminal conditions for the state variables it then proceeds by accumulating the gradient gh by simultaneous reversed time stepping of the discrete adjoint scheme and the sto rmer verlet scheme these two fundamental routines together with many support functions are imple mented in the software package juqbox jl 8 this package was used to generate the numerical results below 6 1 a cnot gate on two qudits with guard levels to test our methods on a quantum optimal control problem we consider realizing a cnot gate on two qudits with two essential energy levels and one guard level each the qudits are modeled in the rotating frame of reference with detuning frequencies 1 2 0 using the system and control hamiltonians 2 6 and 2 7 respectively we set the fundamental frequencies as 1 2 4 10595 2 2 4 81526 ghz and the self and cross kerr coefficients as 1 2 0 2198 1 2 0 2252 and 12 2 0 01 ghz we parameterize the four control functions using b splines with carrier waves and choose the frequencies to be the transition frequencies 1 1 2 1 0 1 2 1 2 2 2 and 1 3 2 3 12 while there are additional resonant frequencies in the system they are sufficiently close to the above set to trigger all desired transitions in the system we discourage population of the second excited states in each qubit using a weight matrix w in j h 2 such that the weights have a value of two for each guard level see 1 5 additionally we use the convergence stopping criteria j h 1 10 4 as an acceptable gate infidelity corresponding to a gate fidelity exceeding 99 99 we use d 1 14 basis functions per frequency and control function resulting in a total of 10 a ipopt convergence history b population of the essential states fig 2 the cnot gate on two qudits d 168 parameters the amplitudes of the control functions are limited by the constraint 6 1 max 1 r d r max where we have set max 5 mhz and enforce the control functions to begin and end at zero we set the gate duration to t 75 ns and estimate the time step using the technique in section 4 2 to guarantee at least cp 40 time steps per period we use m 1 458 time steps corresponding to h 5 144 10 2 ns as initial guess for the elements of the parameter vector we use a random number generator with a uniform distribution in 0 max 100 in figure 2 a we present the convergence history of the optimization we show the objective function g decomposed into j h 1 and j h 2 together with the norm of the dual infeasibility g z used by ipopt to monitor convergence see 24 for details in this case ipopt converges to a solution with gate infidelity j h 1 9 79 10 5 in 124 iterations moreover j h 2 3 58 10 3 and the population of the guard states remains small with a maximum population below 2 41 10 3 for all times and initial conditions the evolution of the population of the essential states during the cnot gate are presented in figure 2 b and the optimized control functions are shown in figure 3 6 2 risk neutral controls in practice the entries of the hamiltonian may have some uncertainty especially for higher energy levels and it is desirable to de sign control pulses that are more robust to noise there are several ways to design noise resilient controls including robust optimization methods in which a min max problem is solved 9 or risk neutral averse optimization approaches that minimize the expectation of a utility function based on the original objective function subject to uncertain parameters 10 in this section we consider a risk neutral strategy to design a 0 2 swap gate on a single qubit q 1 with three essential levels and one guard level let unif max max be a uniform random variable for some max 0 as a simple example we consider the uncertain system hamiltonian hus h rw s h where 11 fig 3 the control functions in the rotating frame for qubit k 1 top and qubit k 2 bottom for realizing a cnot gate with a fidelity exceeding 99 99 hrws is given by 2 6 and h is a diagonal perturbation h 2 0 100 10 here no perturbation is imposed on the control hamiltonian 2 7 from these as sumptions follow that the uncertain system hamiltonian has expectation e hus hrws we may correspondingly update the original objective function g hrws to the risk neutral utility function g e g hus given the simple form of the random variable we may compute g by quadrature e g hus max max g hus d m k 1 wkg hus k 6 2 where wk and k are the weights and collocation points of a quadrature rule for the following example we compare the optimal control obtained using the standard optimization procedure no noise and a risk neutral control in which the utility function 6 2 is computed using the gauss legendre quadrature with n 9 collocation points and max 10 mhz we set the gate duration to t 300 ns the maximum allowable amplitude to max 2 12 mhz the fundamental frequency to 1 2 4 10336 ghz with detuning frequency 1 0 and the self kerr coefficient to 1 2 0 2198 ghz the control functions are constructed using two carrier waves with frequencies 1 1 0 and 1 2 1 for both the noise free nf and risk neutral rn cases in each case we use d 1 12 splines per control and carrier wave frequency for a total of d 48 splines we additionally constrain the controls to start and end at zero we set the tolerance for l bfgs to 10 5 the maximum iteration count to 150 and use a maximum of five previous iterates to approximate the hessian at each iteration for the noise free and risk neutral optimized control functions we use the perturbed hamiltonian hus to evaluate the objective function g for evenly spaced 12 fig 4 infidelity objective j 1 and guard level objective j 2 as function of in hus here nf and rn correspond to the noise free and risk neutral cases fig 5 control functions without carrier waves for the cases noise free top and risk neutral bottom here pk n t and qk n t are defined in 3 2 in the range 30 30 mhz the results are shown in figure 4 from figure 4 we note that the optimal control corresponding to the noise free approach obtains the smallest infidelity for 0 but it grows rapidly for 0 by comparison the optimal control found with the risk neutral approach is much less sensitive to noise we plot the control functions for both cases in figure 5 note that the risk neutral controls bottom panel have larger amplitudes compared to the noise free controls top panel indicating a potential drawback of the risk neutral approach however a more systematic study of this issue is needed and left for future work 7 code comparison here we compare the proposed method as implemented in the juqbox jl package 8 with two python implementations of the grape algo rithm the pulse optim method from the qutip 13 framework and the grape tf 13 code tf is short for tensorflow 1 the latter code provides an enhanced imple mentation of the grape algorithm as described by leung et al 16 it is callable from qutip and shares a similar problem setup with the pulse optim function as a test problem we consider optimizing the control functions for a set of swap gates on a single qudit that transforms 0 d the corresponding target gate transformation ve equals the permutation matrix that swaps columns 0 and d in a d 1 d 1 matrix to evaluate the amount of leakage to higher energy levels we add one guard level g 1 and evolve a total of n d 2 states in schro dinger s equation note that the guard level is left unspecified in the target gate transformation we implement the swap gates on a multi level qudit with transition frequency 1 2 4 8 ghz and self kerr coefficient 1 2 0 22 ghz we apply the rotating wave approximation with detuning 1 0 and model the dynamics with the system hamiltonian 2 6 as a realistic model for current superconducting quantum devices we impose the control amplitude restrictions maxt d t c c 2 9 mhz 7 1 in the rotating frame of reference 7 1 setup of simulation codes qutip pulse optim can minimize the target gate fidelity j 1 but does not suppress occupation of higher energy states thus it does not minimize terms of the type j 2 as a proxy for j 2 we append one additional energy level to the simulation and measure its occupation as an estimate of leakage to higher energy states in pulse optim the control functions are discretized on the same grid in time as schro dinger s equation and no smoothness conditions are imposed on the control functions grape tf also discretizes the control functions on the same grid in time as schro dinger s equation it minimizes an objective function that consists of a number of user configurable parts in our test we minimize the gate infidelity j 1 and the occupation of one guard forbidden energy level similar to j 2 to smooth the con trol functions in time the objective function also includes terms to minimize their first and second time derivatives the gradient of the objective function is calculated us ing the automatic differentiation ad technique as implemented in the tensorflow package in juqbox we trigger the first d transition frequencies in the system hamiltonian by using d carrier waves in the control functions with frequencies 1 k k 1 1 k 1 2 nf nf d for all three codes a pseudo random number generator is used to construct the initial guesses for the parameter vector the pulse optim and juqbox simulations were run on a macbook pro with a 2 6 ghz intel icore 7 processor to utilize the gpu acceleration in tensorflow the grape tf simulations were run on one node of the pascal machine at livermore computing where each node has an intel xeon e 5 2695 v 4 processor with two nvidia p 100 gpus 7 2 numerical results a swap gate where the control functions meet the control amplitude bounds 7 1 can only be realized if the gate duration is sufficiently long furthermore the minimum gate duration increases with d for each value of d we used numerical experiments to determine a duration td such that at least two 14 of the three simulation codes could find a solution with a small gate infidelity for juqbox we estimated the number of time steps using the technique in section 4 2 with cp 80 the number of control parameters follow from d 2 nfd 1 where nf d is the number of carrier wave frequencies used and d 1 is the number of b splines per control functions we use d 1 10 for d 3 4 5 and d 1 20 for d 6 for pulse optim and grape tf we calculate the number of time steps based on the shortest transition period corresponding to the highest transition frequency in the system we then use 40 time steps per shortest transition period to resolve the control functions for both grape methods there are 2 control parameters per time step the main simulation parameters are given in table 1 time steps parameters d td ns juqbox grape juqbox grape 3 140 14 787 4 480 60 8 960 4 215 37 843 7 568 80 15 136 5 265 69 962 11 661 100 23 322 6 425 157 082 22 441 240 44 882 table 1 gate duration number of time steps m and total number of control parameters d in the 0 d swap gate simulations the number of time steps and control parameters are the same for pulse optim and grape tensorflow optimization results for the pulse optim grape tf and juqbox codes are pre sented in figure 6 the pulse optim code generates piecewise constant control func tions that are very noisy and may therefore be hard to realize experimentally to obtain a realistic estimate of the resulting dynamics we interpolate the optimized control functions on a grid with 20 times smaller time step and use the mesolve function in qutip to calculate the evolution of the system from each initial state we then evaluate the gate infidelity using the states at the final time since the control functions from grape tf and juqbox are significantly smoother we report the gate fidelities as calculated by those codes for the 0 3 0 4 and 0 5 swap gates all three codes produce control functions with very small gate infidelities the most significant difference between the codes occurs for the d 6 swap gate here the grape tf code fails to produce a small gate infidelity after running for almost 23 hours and the pulse optim code results in a gate fidelity that is about 2 orders of magnitude larger than juqbox while pulse optim and juqbox require comparable amounts of cpu time to converge the grape tf code is between 50 100 times slower despite the gpu acceleration to compare the smoothness of the optimized control functions we study the fourier spectra of the laboratory frame control functions see figure 7 note that pulse optim produces a significantly noisier control function compared to the other two codes the control function from grape tf is significantly smoother even though its spectrum includes some noticeable peaks at frequencies that do not correspond to transition frequencies in the system the juqbox simulation results in a laboratory frame control function where each peak in the spectrum corresponds to a transition frequency in the hamiltonian 15 a final gate infidelity b cpu times sec fig 6 gate infidelity a and cpu timings b for realizing a swap 0 d gate using pulse optim po grape tensorflow g tf and juqbox jb a qutip pulse optim b grape tensorflow c juqbox fig 7 magnitude of the fourier spectrum of the laboratory frame control function for the 0 5 swap gate on a single qudit 8 conclusions in this paper we developed numerical methods for optimizing control functions for realizing logical gates in closed quantum systems where the state is governed by schro dinger s equation by asymptotic expansion we calculated the resonant frequencies in the system hamiltonian corresponding to transitions between energy levels in the state vector we introduced a novel parameterization of the control 16 functions using b spline basis functions that act as envelopes for carrier waves with frequencies that match the transition frequencies this approach allows the number of control parameters to be independent of and significantly smaller than the number of time steps for integrating schro dinger s equation the objective function in the optimal control problem consists of two parts the infidelity of the final gate transformation and a time integral for evaluating leakage to higher energy levels we apply a first discretize then optimize approach and outline the derivation of the discrete adjoint equation that is solved to efficiently calculate the gradient of the objective function to demonstrate our approach we optimized the control functions for a cnot gate on two coupled qudits resulting in a gate fidelity exceeding 99 99 based on a simple noise model we also generalized the proposed method to calculate risk neutral controls that are resilient to uncertainties in the hamiltonian model the results are promising and indicate that a more systematic study of optimization under uncertainty can yield controls that are robust to noise in quantum systems we finally compared the performance of the proposed method implemented in the juqbox package 8 and two implementations of the grape algorithm the pulse optim method in qutip 13 and grape tensorflow 16 the codes were compared on a set of swap gates on a single qudit here juqbox was found to run 50 100 times faster than grape tensorflow and produce control functions that are significantly smoother than pulse optim in future work we intend to generalize our approach to solve optimal control problems for larger quantum systems acknowledgment we would like to thank prof daniel appelo for bringing the sto rmer verlet method to our attention we also thank dr bjo rn sjo green for fruitful discussions on resonant frequencies this work was performed under the auspices of the u s department of energy by lawrence livermore national laboratory under contract de ac 52 07 na 27344 this is contribution llnl jrnl 823853 the views and opinions of the authors do not necessarily reflect those of the u s government or lawrence livermore national security llc neither of whom nor any of their employees make any endorsements express or implied warranties or representations or assume any legal liability or re sponsibility for the accuracy completeness or usefulness of the information contained herein appendix a composite quantum systems and essential states to simplify the notation we assume a bipartite quantum system q 2 the case q 1 is trivial and q 2 follows by straightforward generalizations let the number of energy levels in the subsystems be n 1 and n 2 respectively for a total of n n 1 n 2 states in the coupled system we use the canonical unit vectors e nq j r nq for j 0 nq 1 as a basis for subsystem q where the superscript indicates its size these basis vectors can be used to describe the total state of the coupled system n 2 1 j 2 0 n 1 1 j 1 0 j 2 j 1 e n 2 j 2 e n 1 j 1 n 1 k 0 ke n k a 1 here cn denotes the one dimensional representation of the two dimensional state vector using a natural ordering of the elements i e k j 2 j 1 for k j 1 n 1 j 2 kind j 2 j 1 the mapping k kind j 2 j 1 is invertible for k 0 n 1 17 we classify the energy levels in the total state vector as either essential or guarded levels the unitary gate transformation is only specified for the essential levels the guard levels are retained to justify the truncation of the modal expansion of schro dinger s equation and to avoid leakage of probability to even higher energy levels let the number of essential energy levels in the subsystems be m 1 and m 2 re spectively where 0 mq nq similar to the total state vector we use the canonical unit vectors as a basis for the essential subspace of each subsystem the total number of essential levels equals e m 1 m 2 let the essential energy levels in the total state vector be represented by the essential state vector similar to the full state vector we flatten its two dimensional indexing using a natural ordering m 2 1 i 2 0 m 1 1 i 1 0 i 2 i 1 e m 2 i 2 e m 1 i 1 e 1 0 e e c e a 2 where i 1 m 1 i 2 ind i 2 i 1 the elements in the essential state vector are defined from the total state vector by i 2 i 1 i 2 i 1 for i 1 0 m 1 1 and i 2 0 m 2 1 the initial condition for the solution operator matrix u t in schro dinger s equa tion 1 3 needs to span a basis for the e dimensional essential state space here we use the canonical basis consisting of the unit vectors e e let the columns of the initial condition matrix be u 0 g 0 g 1 ge 1 rn e because the total probabilities in each column vector gk must sum to one the basis vectors in the total state space become g u 0 e e gk 1 k kind i 2 i 1 0 otherwise for 0 1 e 1 a 3 here i 2 b m 1 c and i 1 m 1 i 2 the target gate matrix ve ce e defines the unitary transformation between the essential levels in the initial and final states t ve 0 for all 0 ce because ve is unitary each of its columns has norm one to preserve total probabilities we define the target gate transformation according to vtg u 0 ve cn e a 4 this implies that each column of vtg also has norm one appendix b the hamiltonian in a rotating frame of reference the time dependent and unitary change of variables t r t t where r r i results in the transformed schro dinger equation b 1 d dt ih t h t r t h t r t ir t r t the rotating frame of reference is introduced by taking the unitary transformation to be the matrix 2 5 because both r t and the system hamiltonian 2 1 are diagonal rhsr hs the time derivative of the transformation can be written r t 1 q q i r qa qaq 1 q q exp i r qta qaq b 2 18 where denotes the kronecker sum c d c id ic d therefore r t r t 1 q q i r qa qaq q q 1 i r qa qaq b 3 as a result the first term in the hamiltonian 2 1 is modified by the term ir t r t after noting that raqr e i r qtaq the transformed hamiltonian can be written as hrws q q 1 qa qaq q 2 a qa qaqaq p q qpa qaqa pap b 4 h c t q q 1 fq t e i r qtaq e i r qta q b 5 where q q r q is the detuning frequency the above system hamiltonian corresponds to 2 6 to slow down the time scales in the control hamiltonian we want to absorb the highly oscillatory factors exp i r qt into fq t because the control function fq t is real valued this can only be done in an approximate fashion we make the ansatz fq t 2 re dq t e i r qt dq t e i r qt d q t e i r qt b 6 where d q denotes the complex conjugate of dq by substituting this expression into the transformed control hamiltonian b 5 we get h c t q q 1 dq t aq d q t a q d q t e 2 i r qtaq dq t e 2 i r qta q the rotating frame approximation follows by ignoring terms that oscillate with fre quency 2 i r q resulting in the approximate control hamiltonian 2 7 appendix c conditions for resonance consider the scalar function y t 1 j t it satisfies an ordinary differential equation of the form dy t dt jy t c e i t k r c 1 we are interested in cases when y t grows in time corresponding to resonance con ditions for resonance are provided in the following lemma lemma c 1 let r and r be constants the solution of the scalar ordinary differential equation dy t dt i y t cei t y 0 y 0 c 2 is given by y t y 0 e i t cte i t 0 y 0 e i t ic ei t e i t otherwise c 3 corresponding to resonance the function y t grows linearly in time when 0 and c 6 0 19 proof follows by direct evaluation we proceed by analyzing the right hand side of 2 11 it can be shown that the forcing function f k t is of the form f k j t igj ek jk 1 e i k j ek t jk 0 k t jk 1 nk 2 igj ek jk e i k j ek t jk nk 1 c 4 where k t igj ek jk 1 e i k j ek t igj ek jk e i k j ek t the right hand side satisfies f t f 1 t f 2 t the first set of frequencies and coefficients on the right hand side of c 1 satisfy 1 k j ek c 1 igj ek jk 1 for k 1 2 and jk 0 nk 2 the second set of frequencies and coefficients are 2 k j ek c 2 igj ek jk for k 1 2 and jk 1 nk 1 from lemma c 1 component 1 j t is in resonance if j 1 0 c 1 6 0 or j 2 0 c 2 6 0 these conditions are equivalent to 2 13 and 2 14 which proves lemma 2 1 references 1 m abadi p barham j chen z chen a davis j dean m devin s ghemawat g irving m isard et al tensorflow a system for large scale machine learning in 12 th usenix symposium on operating systems design and implementation osdi 16 2016 pp 265 283 2 j bezanson a edelman s karpinski and v b shah julia a fresh approach to nu merical computing siam review 59 2017 pp 65 89 3 a blais a l grimsmo s m girvin and a wallraff circuit quantum electrodynamics rev mod phys 93 2021 p 025005 4 a borz g ciarmella and m sprengel formulation and numerical solution of quantum control problems computational science and engineering siam 2017 5 t caneva t calarco and s montangero chopped random basis quantum optimization physical review a 84 2011 6 l emsley and g bodenhausen gaussian pulse cascades new analytical functions for rectangular selective inversion and in phase excitation in nmr chem phys 165 1989 pp 469 476 7 b ewing s j glaser and g p drobny development and optimization of shaped nmr pulses for the study of coupled spin systems chem phys 147 1990 pp 121 129 8 f garcia and n a petersson juqbox jl github 2021 9 x ge h ding h rabitz and r b wu robust quantum control in games an adversarial learning approach physical review a 101 2020 p 052317 10 x ge and r b wu risk sensitive optimization for robust quantum controls arxiv preprint arxiv 2104 01323 2021 11 g h golub and c f v loan matrix computations johns hopkins university press 1996 12 e hairer c lubich and g wanner geometric numerical integration no 31 in springer series in computational mathematics springer verlag heidelberg 2 nd ed 2006 13 j johansson p nation and f nori qutip 2 a python framework for the dynamics of open quantum systems computer physics communications 184 2013 pp 1234 1240 14 n khaneja t reiss c kehlet t schulte herbruggen and s glaser optimal control of coupled spin dynamics design of nmr pulse sequences by gradient ascent algorithms j magnetic resonance 172 2005 pp 296 305 15 h w kuhn and a w tucker nonlinear programming in traces and emergence of non linear programming springer 2014 pp 247 258 20 16 n leung m abdelhafez j koch and d schuster speedup for quantum optimal control from automatic differentiation based on graphics processing units phys rev a 95 2017 p 0432318 17 d lucarelli quantum optimal control via gradient ascent in function space and the time bandwidth quantum speed limit physical review a 97 2018 18 s machnes e asse mat d tannor and f k wilhelm tunable flexible and efficient optimization of control pulses for practical qubits physical review letters 120 2018 19 e magesan and j m gambetta effective hamiltonian models of the cross resonance gate phys rev a 101 2020 p 052308 20 m nielsen and i chuang quantum computation and quantum information cambridge university press 2000 21 j nocecdal and s j wright numerical optimization springer 2 nd ed 2006 22 n a petersson f m garcia a e copeland y l rydin and j l dubois discrete adjoints for accurate numerical optimization with application to quantum control arxiv preprint arxiv 2001 01013 2020 23 y shi n leung p gokhale z rossi d i schuster h hoffmann and f t chong optimized compilation of aggregated instructions for realistic quantum computers pro ceedings of the twenty fourth international conference on architectural support for pro gramming languages and operating systems asplos 19 2019 24 a wa chter and l t biegler on the implementation of an interior point filter line search algorithm for large scale nonlinear programming mathematical programming 106 2006 pp 25 57 25 d b zax g goelman and s vega amplitude modulated composite pulses j magn reson 80 1988 pp 375 382 21 1 introduction 2 hamiltonian model 2 1 rotating wave approximation 2 2 resonant frequencies 3 quadratic b splines with carrier waves 4 real valued formulation 4 1 time integration 4 2 time step restrictions for accuracy and stability 5 discretizing the objective function and its gradient 6 numerical optimization 6 1 a cnot gate on two qudits with guard levels 6 2 risk neutral controls 7 code comparison 7 1 setup of simulation codes 7 2 numerical results 8 conclusions appendix a composite quantum systems and essential states appendix b the hamiltonian in a rotating frame of reference appendix c conditions for resonance references